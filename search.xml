<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>About Me</title>
    <url>/2020/07/21/about/</url>
    <content><![CDATA[<h2 id="Skykey"><a href="#Skykey" class="headerlink" title="Skykey"></a>Skykey</h2><h3 id="Hello-World-ğŸ‘‹"><a href="#Hello-World-ğŸ‘‹" class="headerlink" title="Hello,World! ğŸ‘‹"></a>Hello,World! ğŸ‘‹</h3><p>Hi, Iâ€™m Skykey ğŸ˜‰, a programmer ğŸ‘¨ğŸ»â€ğŸ’» from China ğŸ‡¨ğŸ‡³. Iâ€™m an open-source profession and always develop in Cpp/Qt. Currently, Iâ€™m working on <a href="https://github.com/QtDocumentCN/QtDocumentCN">QtDocCN</a>. Besides programming, I like delicious food ğŸ¥—ğŸ¥©ğŸŒ®ğŸ£ and doing sports ğŸƒâ›¹ï¸â€â™‚ï¸ğŸ‹ğŸ¼â€â™‚ï¸.</p>
<span id="more"></span>

<p>â€‹    <img align="right" alt="GIF" src="https://media.giphy.com/media/iIqmM5tTjmpOB9mpbn/giphy.gif" /></p>
<p><strong>Current Status Quo</strong></p>
<ul>
<li>ğŸ‘¨ğŸ»â€ğŸ’» Iâ€™m currently working on <a href="https://github.com/QtDocumentCN/QtDocumentCN">QtDocCN</a>.</li>
<li>ğŸŒ± Iâ€™m currently learning C++/Qt.</li>
<li>ğŸ¤”  I hope to be a linux system development programmer. ğŸ§</li>
<li>ğŸ’¬ Ask me about anything and I would like to answer.</li>
<li>ğŸ“« Please email via <a href="zcxzxlc@163.com">zcxzxlc@163.com</a> to reach me.</li>
</ul>
<hr>
<p><img src="https://github-readme-stats.vercel.app/api?username=skykeyjoker&show_icons=true&hide_border=true" alt="stats"></p>
<p><img src="https://gitee.com/skykeyjoker/PicCloud/raw/master/img/dino.gif" alt="dino"></p>
]]></content>
  </entry>
  <entry>
    <title>C++å¹¶å‘ç¼–ç¨‹</title>
    <url>/2021/04/22/C++%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="C-Concurrency"><a href="#C-Concurrency" class="headerlink" title="C++ Concurrency"></a>C++ Concurrency</h1><h2 id="0x00-æ¦‚å¿µ"><a href="#0x00-æ¦‚å¿µ" class="headerlink" title="0x00 æ¦‚å¿µ"></a>0x00 æ¦‚å¿µ</h2><p>CPP11æ ‡å‡†ä»¥æ¥ï¼ŒC++è¯­è¨€å¼€å§‹æ”¯æŒå¤šçº¿ç¨‹æ¨¡å‹ã€‚å€ŸåŠ©å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå¯ä»¥å¼€å‘å‡ºæ›´å¥½çš„å¹¶å‘ç³»ç»Ÿã€‚</p>
<span id="more"></span>

<h3 id="å¹¶å‘ä¸å¹¶è¡Œ"><a href="#å¹¶å‘ä¸å¹¶è¡Œ" class="headerlink" title="å¹¶å‘ä¸å¹¶è¡Œ"></a>å¹¶å‘ä¸å¹¶è¡Œ</h3><ul>
<li>å¹¶å‘(Concurrent)ï¼šå¦‚æœå¤šä¸ªé˜Ÿåˆ—å¯ä»¥äº¤æ›¿ä½¿ç”¨æŸå°å’–å•¡æœºï¼Œåˆ™è¿™ä¸€è¡Œä¸ºå°±æ˜¯å¹¶å‘çš„ã€‚</li>
<li>å¹¶è¡Œ(Parallel)ï¼šå¦‚æœå­˜åœ¨å¤šå°å’–å•¡æœºå¯ä»¥è¢«å¤šä¸ªé˜Ÿåˆ—äº¤æ›¿ä½¿ç”¨ï¼Œåˆ™å°±æ˜¯å¹¶è¡Œã€‚</li>
</ul>
<img src="https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/con_and_par.jpg" alt="img" style="zoom:80%;" />

<p>å¹¶å‘å’Œå¹¶è¡Œéƒ½æ˜¯åœ¨å¤šä»»åŠ¡çš„ç¯å¢ƒä¸‹çš„è®¨è®ºã€‚å¹¶è¡Œå…¶å®æ˜¯å¹¶å‘çš„å­é›†ï¼Œä»–ä»¬çš„åŒºåˆ«åœ¨äºæ˜¯å¦å…·æœ‰å¤šä¸ªå¤„ç†å™¨ã€‚</p>
<p>è¿›ç¨‹ä¸çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„åŸºæœ¬æ¦‚å¿µã€‚</p>
<blockquote>
<ul>
<li><strong>è¿›ç¨‹</strong>(process)ï¼šè®¡ç®—æœºå·²è¿è¡Œçš„ç¨‹åºã€‚è¿›ç¨‹æ˜¯ç¨‹åºçš„åŸºæœ¬æ‰§è¡Œå®ä½“ï¼›</li>
<li><strong>çº¿ç¨‹</strong>(thread)ï¼šæ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚</li>
</ul>
</blockquote>
<p>ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‰€å†™çš„ç¨‹åºåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œã€‚ä¸€ä¸ªè¿›ç¨‹è‡³å°‘ä¼šåŒ…å«ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™ä¸ªçº¿ç¨‹æˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸º==ä¸»çº¿ç¨‹==ã€‚</p>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç éƒ½æ˜¯åœ¨è¿›ç¨‹çš„ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œé™¤éå¼€å‘è€…åœ¨ç¨‹åºä¸­åˆ›å»ºäº†æ–°çš„çº¿ç¨‹ã€‚</p>
<p>ä»»åŠ¡åœ¨ä½•æ—¶å æœ‰å¤„ç†å™¨ï¼Œé€šå¸¸æ˜¯ç”±æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ç­–ç•¥å†³å®šçš„ã€‚å½“å¼€å‘è·¨å¹³å°è½¯ä»¶æ—¶ï¼Œä¸åº”å¯¹è°ƒåº¦ç­–ç•¥åšä»»ä½•å‡è®¾ï¼Œè€Œåº”è¯¥æŠ±æœ‰â€œç³»ç»Ÿå¯èƒ½ä»¥ä»»æ„é¡ºåºæ¥è°ƒåº¦æˆ‘çš„ä»»åŠ¡â€è¿™æ ·çš„æƒ³æ³•ã€‚</p>
<h3 id="å¹¶å‘ç³»ç»Ÿçš„æ€§èƒ½"><a href="#å¹¶å‘ç³»ç»Ÿçš„æ€§èƒ½" class="headerlink" title="å¹¶å‘ç³»ç»Ÿçš„æ€§èƒ½"></a>å¹¶å‘ç³»ç»Ÿçš„æ€§èƒ½</h3><p>å¼€å‘å¹¶å‘ç³»ç»Ÿæœ€ä¸»è¦çš„åŠ¨æœºå°±æ˜¯æå‡ç³»ç»Ÿæ€§èƒ½ï¼ˆ<em>äº‹å®ä¸Šï¼Œè¿™æ˜¯ä»¥å¢åŠ å¤æ‚åº¦ä¸ºä»£ä»·çš„</em>ï¼‰ã€‚</p>
<p><strong>é˜¿å§†è¾¾å°”å®šå¾‹</strong>å‘Šè¯‰æˆ‘ä»¬å°†ç³»ç»Ÿå¹¶è¡Œä¹‹åæ€§èƒ½æ”¶ç›Šçš„ä¸Šé™ã€‚</p>
<h2 id="0x01-C-ä¸å¹¶å‘ç¼–ç¨‹"><a href="#0x01-C-ä¸å¹¶å‘ç¼–ç¨‹" class="headerlink" title="0x01 C++ä¸å¹¶å‘ç¼–ç¨‹"></a>0x01 C++ä¸å¹¶å‘ç¼–ç¨‹</h2><h3 id="C-æ ‡å‡†ç‰¹æ€§çš„è·¯çº¿å›¾"><a href="#C-æ ‡å‡†ç‰¹æ€§çš„è·¯çº¿å›¾" class="headerlink" title="C++æ ‡å‡†ç‰¹æ€§çš„è·¯çº¿å›¾"></a>C++æ ‡å‡†ç‰¹æ€§çš„è·¯çº¿å›¾</h3><p><img src="https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/cpp_timeline.png" alt="img"></p>
<h3 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h3><h4 id="åˆ›å»ºçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h4><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 01_hello_thread.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span> <span class="comment">// â‘ </span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std; <span class="comment">// â‘¡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123; <span class="comment">// â‘¢</span></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Hello World from new thread.&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">thread <span class="title">t</span><span class="params">(hello)</span></span>; <span class="comment">// â‘£</span></span><br><span class="line">  t.<span class="built_in">join</span>(); <span class="comment">// â‘¤</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>ä¸ºäº†ä½¿ç”¨å¤šçº¿ç¨‹çš„æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦<code>#include &lt;thread&gt;</code>å¤´æ–‡ä»¶ã€‚</li>
<li>ä¸ºäº†ç®€åŒ–å£°æ˜ï¼Œæœ¬æ–‡ä¸­çš„ä»£ç éƒ½å°†<code>using namespace std;</code>ã€‚</li>
<li>æ–°å»ºçº¿ç¨‹çš„å…¥å£æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œå®ƒå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ã€‚</li>
<li>åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼å°±æ˜¯æ„é€ ä¸€ä¸ª<code>thread</code>å¯¹è±¡ï¼Œå¹¶æŒ‡å®šå…¥å£å‡½æ•°ã€‚ä¸æ™®é€šå¯¹è±¡ä¸ä¸€æ ·çš„æ˜¯ï¼Œæ­¤æ—¶ç¼–è¯‘å™¨ä¾¿ä¼šä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œå¹¶åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œæˆ‘ä»¬çš„å…¥å£å‡½æ•°ã€‚</li>
<li>å…³äº<code>join</code>å‡½æ•°åœ¨ä¸‹æ–‡ä¸­è®²è§£ã€‚</li>
</ol>
</blockquote>
<p>==thread==å¯ä»¥å’Œ==callable==ç±»å‹ä¸€èµ·å·¥ä½œï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç›´æ¥ç”¨<em>lambda</em>æ¥å†™çº¿ç¨‹é€»è¾‘ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 02_lambda_thread.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">thread <span class="title">t</span><span class="params">([] &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    cout &lt;&lt; <span class="string">&quot;Hello World from lambda thread.&quot;</span> &lt;&lt; endl;</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">  t.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥==ä¼ é€’å‚æ•°==ç»™å…¥å£å‡½æ•°ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 03_thread_argument.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hello</span><span class="params">(string name)</span> </span>&#123;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Welcome to &quot;</span> &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">thread <span class="title">t</span><span class="params">(hello, <span class="string">&quot;https://paul.pub&quot;</span>)</span></span>;</span><br><span class="line">  t.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”šè‡³å¯ä»¥ä¼ é€’ä¸€ä¸ªç±»æˆå‘˜å‡½æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾buyæ˜¯ä¸€ä¸ªå¯è°ƒç”¨çš„å‡½æ•°å¯¹è±¡ï¼Œå®ƒå³å¯èƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯å‡½æ•°å¯¹è±¡</span></span><br><span class="line"><span class="function">std::thread <span class="title">Annie</span><span class="params">(buy)</span></span>;</span><br><span class="line"><span class="comment">// Annieä¼šå»æ‰§è¡Œbuy()</span></span><br><span class="line"><span class="function">std::thread <span class="title">Bob</span><span class="params">(buy, book, food)</span></span>;</span><br><span class="line"><span class="comment">// Bobä¼šå»æ‰§è¡Œbuy(book, food)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡è®¾buyæ˜¯Consumerçš„ä¸€ä¸ªå¯è°ƒç”¨çš„æˆå‘˜å‡½æ•°</span></span><br><span class="line">Consumer Clara;</span><br><span class="line"><span class="function">std::thread <span class="title">action</span><span class="params">(buy, std::ref(Clara), phone)</span></span>;</span><br><span class="line"><span class="comment">// Claraä¼šå»æ‰§è¡ŒConsumer.buy(phone)</span></span><br></pre></td></tr></table></figure>



<p>åº”æ³¨æ„ï¼Œ<strong>å‚æ•°ä»¥æ‹·è´çš„å½¢å¼ä¼ é€’</strong>ã€‚å¯¹äºæ‹·è´è€—æ—¶çš„å¯¹è±¡å¯èƒ½éœ€è¦ä¼ é€’æŒ‡é’ˆæˆ–è€…å¼•ç”¨ç±»å‹ä½œä¸ºå‚æ•°ã€‚ä½†æ˜¯ä¼ é€’æŒ‡é’ˆå’Œå¼•ç”¨ï¼Œè¿˜åº”è€ƒè™‘å‚æ•°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong>å½“åˆ›å»ºäº†ä¸€ä¸ªï¼ˆéç©ºçš„ï¼‰çº¿ç¨‹å¯¹è±¡æ—¶ï¼Œå¯¹åº”çº¿ç¨‹å°±ä¼šæ‰§è¡Œã€‚</p>
<h4 id="joinä¸detach"><a href="#joinä¸detach" class="headerlink" title="joinä¸detach"></a>joinä¸detach</h4><ul>
<li>ä¸»è¦API</li>
</ul>
<table>
<thead>
<tr>
<th>API</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>join</td>
<td>ç­‰å¾…çº¿ç¨‹å®Œæˆå…¶æ‰§è¡Œ</td>
</tr>
<tr>
<td>detach</td>
<td>å…è®¸çº¿ç¨‹ç‹¬ç«‹æ‰§è¡Œ</td>
</tr>
</tbody></table>
<p>çº¿ç¨‹å¯åŠ¨ä¹‹åï¼Œå¿…é¡»å†³å®šç­‰å¾…ç›´æ¥å®ƒç»“æŸï¼ˆ==join==ï¼‰ï¼Œè¿˜æ˜¯è®©ä»–ç‹¬ç«‹è¿è¡Œï¼ˆ==detach==ï¼‰ï¼Œå¿…é¡»äºŒè€…é€‰å…¶ä¸€ã€‚è‹¥åœ¨==thread==å¯¹è±¡<strong>é”€æ¯çš„æ—¶å€™</strong>è¿˜æ²¡æœ‰åšå†³å®šï¼Œåˆ™==thread==å¯¹è±¡åœ¨ææ„å‡½æ•°å°†è°ƒç”¨==std::terminate()==ä»è€Œå¯¼è‡´è¿›ç¨‹å¼‚å¸¸é€€å‡ºã€‚</p>
<ul>
<li><code>join</code>ï¼šè°ƒç”¨æ­¤æ¥å£æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼ˆå½“ç„¶ï¼Œå¾ˆå¯èƒ½ç›®æ ‡çº¿ç¨‹åœ¨æ­¤å¤„è°ƒç”¨ä¹‹å‰å°±å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œä¸è¿‡è¿™ä¸è¦ç´§ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœç›®æ ‡çº¿ç¨‹çš„ä»»åŠ¡éå¸¸è€—æ—¶ï¼Œä½ å°±è¦è€ƒè™‘å¥½æ˜¯å¦éœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šç­‰å¾…å®ƒäº†ï¼Œå› æ­¤è¿™å¾ˆå¯èƒ½ä¼šå¯¼è‡´ä¸»çº¿ç¨‹å¡ä½ã€‚</li>
<li><code>detach</code>ï¼š<code>detach</code>æ˜¯è®©ç›®æ ‡çº¿ç¨‹æˆä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ˆdaemon threadsï¼‰ã€‚ä¸€æ—¦<code>detach</code>ä¹‹åï¼Œç›®æ ‡çº¿ç¨‹å°†ç‹¬ç«‹æ‰§è¡Œï¼Œå³ä¾¿å…¶å¯¹åº”çš„<code>thread</code>å¯¹è±¡é”€æ¯ä¹Ÿä¸å½±å“çº¿ç¨‹çš„æ‰§è¡Œã€‚å¹¶ä¸”ï¼Œä½ æ— æ³•å†ä¸ä¹‹é€šä¿¡ã€‚</li>
</ul>
<h4 id="ç®¡ç†å½“å‰çº¿ç¨‹"><a href="#ç®¡ç†å½“å‰çº¿ç¨‹" class="headerlink" title="ç®¡ç†å½“å‰çº¿ç¨‹"></a>ç®¡ç†å½“å‰çº¿ç¨‹</h4><ul>
<li>ä¸»è¦API</li>
</ul>
<table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">yield</td>
<td align="left">C++11</td>
<td align="left">è®©å‡ºå¤„ç†å™¨ï¼Œé‡æ–°è°ƒåº¦å„æ‰§è¡Œçº¿ç¨‹</td>
</tr>
<tr>
<td align="left">get_id</td>
<td align="left">C++11</td>
<td align="left">è¿”å›å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ id</td>
</tr>
<tr>
<td align="left">sleep_for</td>
<td align="left">C++11</td>
<td align="left">ä½¿å½“å‰çº¿ç¨‹çš„æ‰§è¡Œåœæ­¢æŒ‡å®šçš„æ—¶é—´æ®µ</td>
</tr>
<tr>
<td align="left">sleep_until</td>
<td align="left">C++11</td>
<td align="left">ä½¿å½“å‰çº¿ç¨‹çš„æ‰§è¡Œåœæ­¢ç›´åˆ°æŒ‡å®šçš„æ—¶é—´ç‚¹</td>
</tr>
</tbody></table>
<p>ä¸Šé¢æ˜¯ä¸€äº›åœ¨çº¿ç¨‹å†…éƒ¨ä½¿ç”¨çš„APIï¼Œå®ƒä»¬ç”¨æ¥å¯¹å½“å‰çº¿ç¨‹åšä¸€äº›æ§åˆ¶ã€‚</p>
<ul>
<li><code>yield</code> é€šå¸¸ç”¨åœ¨è‡ªå·±çš„ä¸»è¦ä»»åŠ¡å·²ç»å®Œæˆçš„æ—¶å€™ï¼Œæ­¤æ—¶å¸Œæœ›è®©å‡ºå¤„ç†å™¨ç»™å…¶ä»–ä»»åŠ¡ä½¿ç”¨ã€‚</li>
<li><code>get_id</code> è¿”å›å½“å‰çº¿ç¨‹çš„idï¼Œå¯ä»¥ä»¥æ­¤æ¥æ ‡è¯†ä¸åŒçš„çº¿ç¨‹ã€‚</li>
<li><code>sleep_for</code> æ˜¯è®©å½“å‰çº¿ç¨‹åœæ­¢ä¸€æ®µæ—¶é—´ã€‚</li>
<li><code>sleep_until</code> å’Œ<code>sleep_for</code>ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯ä»¥å…·ä½“çš„æ—¶é—´ç‚¹ä¸ºå‚æ•°ã€‚è¿™ä¸¤ä¸ªAPIéƒ½ä»¥<a href="https://en.cppreference.com/w/cpp/header/chrono">chrono</a> APIï¼ˆç”±äºç¯‡å¹…æ‰€é™ï¼Œè¿™é‡Œä¸å±•å¼€è¿™æ–¹é¢å†…å®¹ï¼‰ä¸ºåŸºç¡€ã€‚</li>
</ul>
<p>ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 04_thread_self_manage.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_time</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> now = chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">auto</span> <span class="keyword">in_time_t</span> = chrono::system_clock::<span class="built_in">to_time_t</span>(now);</span><br><span class="line"></span><br><span class="line">  std::stringstream ss;</span><br><span class="line">  ss &lt;&lt; <span class="built_in">put_time</span>(<span class="built_in">localtime</span>(&amp;<span class="keyword">in_time_t</span>), <span class="string">&quot;%Y-%m-%d %X&quot;</span>);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;now is: &quot;</span> &lt;&lt; ss.<span class="built_in">str</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sleep_thread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  this_thread::<span class="built_in">sleep_for</span>(chrono::<span class="built_in">seconds</span>(<span class="number">3</span>));</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;[thread-&quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot;] is waking up&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop_thread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[thread-&quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot;] print: &quot;</span> &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">print_time</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function">thread <span class="title">t1</span><span class="params">(sleep_thread)</span></span>;</span><br><span class="line">  <span class="function">thread <span class="title">t2</span><span class="params">(loop_thread)</span></span>;</span><br><span class="line"></span><br><span class="line">  t1.<span class="built_in">join</span>();</span><br><span class="line">  t2.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print_time</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">now is: 2019-10-13 10:17:48</span><br><span class="line">[thread-0x70000cdda000] print: 0</span><br><span class="line">[thread-0x70000cdda000] print: 1</span><br><span class="line">[thread-0x70000cdda000] print: 2</span><br><span class="line">[thread-0x70000cdda000] print: 3</span><br><span class="line">[thread-0x70000cdda000] print: 4</span><br><span class="line">[thread-0x70000cdda000] print: 5</span><br><span class="line">[thread-0x70000cdda000] print: 6</span><br><span class="line">[thread-0x70000cdda000] print: 7</span><br><span class="line">[thread-0x70000cdda000] print: 8</span><br><span class="line">[thread-0x70000cdda000] print: 9</span><br><span class="line">[thread-0x70000cd57000] is waking up</span><br><span class="line">now is: 2019-10-13 10:17:51</span><br></pre></td></tr></table></figure>



<h4 id="ä¸€æ¬¡è°ƒç”¨"><a href="#ä¸€æ¬¡è°ƒç”¨" class="headerlink" title="ä¸€æ¬¡è°ƒç”¨"></a>ä¸€æ¬¡è°ƒç”¨</h4><ul>
<li>ä¸»è¦API</li>
</ul>
<table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">call_once</td>
<td align="left">C++11</td>
<td align="left">å³ä¾¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¹Ÿèƒ½ä¿è¯åªè°ƒç”¨æŸä¸ªå‡½æ•°ä¸€æ¬¡</td>
</tr>
<tr>
<td align="left">once_flag</td>
<td align="left">C++11</td>
<td align="left">ä¸<code>call_once</code>é…åˆä½¿ç”¨</td>
</tr>
</tbody></table>
<p>åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰äº›ä»»åŠ¡éœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¸”æˆ‘ä»¬åªå¸Œæœ›å®ƒæ‰§è¡Œä¸€æ¬¡ï¼Œä¾‹å¦‚èµ„æºçš„åˆå§‹åŒ–ä»»åŠ¡ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨åˆ°ä¸Šé¢çš„æ¥å£ã€‚è¿™ä¸ªæ¥å£ä¼šä¿è¯ï¼Œå³ä¾¿åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œç›¸åº”çš„å‡½æ•°ä¹Ÿåªä¼šè°ƒç”¨ä¸€æ¬¡ã€‚</p>
<p>ä¸‹é¢å°±æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼šæœ‰ä¸‰ä¸ªçº¿ç¨‹éƒ½ä¼šä½¿ç”¨<code>init</code>å‡½æ•°ï¼Œä½†æ˜¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹çœŸæ­£æ‰§è¡Œå®ƒã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 05_call_once.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Initialing...&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="comment">// Do something...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">(once_flag* flag)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">call_once</span>(*flag, init);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  once_flag flag;</span><br><span class="line"></span><br><span class="line">  <span class="function">thread <span class="title">t1</span><span class="params">(worker, &amp;flag)</span></span>;</span><br><span class="line">  <span class="function">thread <span class="title">t2</span><span class="params">(worker, &amp;flag)</span></span>;</span><br><span class="line">  <span class="function">thread <span class="title">t3</span><span class="params">(worker, &amp;flag)</span></span>;</span><br><span class="line"></span><br><span class="line">  t1.<span class="built_in">join</span>();</span><br><span class="line">  t2.<span class="built_in">join</span>();</span><br><span class="line">  t3.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="å¹¶å‘ä»»åŠ¡"><a href="#å¹¶å‘ä»»åŠ¡" class="headerlink" title="å¹¶å‘ä»»åŠ¡"></a>å¹¶å‘ä»»åŠ¡</h4><p>ä¸‹é¢ä»¥ä¸€ä¸ªå¹¶å‘ä»»åŠ¡ä¸ºç¤ºä¾‹è®²è§£å¦‚ä½•å¼•å…¥å¤šçº¿ç¨‹ã€‚</p>
<p>ä»»åŠ¡ç¤ºä¾‹ï¼šç°åœ¨å‡è®¾æˆ‘ä»¬éœ€è¦è®¡ç®—æŸä¸ªèŒƒå›´å†…æ‰€æœ‰è‡ªç„¶æ•°çš„å¹³æ–¹æ ¹ä¹‹å’Œï¼Œä¾‹å¦‚<code>[1, 10e8]</code>ã€‚</p>
<p>åœ¨å•çº¿ç¨‹æ¨¡å‹ä¸‹ï¼Œæˆ‘ä»¬çš„ä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 06_naive_multithread.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAX = <span class="number">10e8</span>; <span class="comment">// â‘ </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">double</span> sum = <span class="number">0</span>; <span class="comment">// â‘¡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123; <span class="comment">// â‘¢</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = min; i &lt;= max; i++) &#123;</span><br><span class="line">    sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serial_task</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123; <span class="comment">// â‘£</span></span><br><span class="line">  <span class="keyword">auto</span> start_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">worker</span>(<span class="number">0</span>, MAX);</span><br><span class="line">  <span class="keyword">auto</span> end_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">auto</span> ms = chrono::duration_cast&lt;chrono::milliseconds&gt;(end_time - start_time).<span class="built_in">count</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Serail task finish, &quot;</span> &lt;&lt; ms &lt;&lt; <span class="string">&quot; ms consumed, Result: &quot;</span> &lt;&lt; sum &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ol>
<li>é€šè¿‡ä¸€ä¸ªå¸¸é‡æŒ‡å®šæ•°æ®èŒƒå›´ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒæ•´ã€‚</li>
<li>é€šè¿‡ä¸€ä¸ªå…¨å±€å˜é‡æ¥å­˜å‚¨ç»“æœã€‚</li>
<li>é€šè¿‡ä¸€ä¸ªä»»åŠ¡å‡½æ•°æ¥è®¡ç®—å€¼ã€‚</li>
<li>ç»Ÿè®¡ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ã€‚</li>
</ol>
<p>è¿™æ®µç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Serail task finish, 6406 ms consumed, Result: 2.10819e+13</span><br></pre></td></tr></table></figure>

<p>å¾ˆæ˜¾ç„¶ï¼Œä¸Šé¢å•çº¿ç¨‹çš„åšæ³•æ€§èƒ½å¤ªå·®äº†ã€‚æˆ‘ä»¬çš„ä»»åŠ¡å®Œå…¨æ˜¯å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ã€‚å¹¶ä¸”ä»»åŠ¡å¾ˆå®¹æ˜“åˆ’åˆ†ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±å°è¯•ä»¥å¤šçº¿ç¨‹çš„æ–¹å¼æ¥æ”¹é€ åŸå…ˆçš„ç¨‹åºã€‚</p>
<p>æ”¹é€ åçš„ç¨‹åºå¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 06_naive_multithread.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">concurrent_task</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> start_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> concurrent_count = thread::<span class="built_in">hardware_concurrency</span>(); <span class="comment">// â‘ </span></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;hardware_concurrency: &quot;</span> &lt;&lt; concurrent_count &lt;&lt; endl;</span><br><span class="line">  vector&lt;thread&gt; threads;</span><br><span class="line">  min = <span class="number">0</span>;</span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t &lt; concurrent_count; t++) &#123; <span class="comment">// â‘¡</span></span><br><span class="line">    <span class="keyword">int</span> range = max / concurrent_count * (t + <span class="number">1</span>);</span><br><span class="line">    threads.<span class="built_in">push_back</span>(<span class="built_in">thread</span>(worker, min, range)); <span class="comment">// â‘¢</span></span><br><span class="line">    min = range + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : threads) &#123;</span><br><span class="line">    t.<span class="built_in">join</span>(); <span class="comment">// â‘£</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> end_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">auto</span> ms = chrono::duration_cast&lt;chrono::milliseconds&gt;(end_time - start_time).<span class="built_in">count</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Concurrent task finish, &quot;</span> &lt;&lt; ms &lt;&lt; <span class="string">&quot; ms consumed, Result: &quot;</span> &lt;&lt; sum &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ol>
<li><code>thread::hardware_concurrency()</code>å¯ä»¥è·å–åˆ°å½“å‰ç¡¬ä»¶æ”¯æŒå¤šå°‘ä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚</li>
<li>æ ¹æ®å¤„ç†å™¨çš„æƒ…å†µå†³å®šçº¿ç¨‹çš„æ•°é‡ã€‚</li>
<li>å¯¹äºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½é€šè¿‡<code>worker</code>å‡½æ•°æ¥å®Œæˆä»»åŠ¡ï¼Œå¹¶åˆ’åˆ†ä¸€éƒ¨åˆ†æ•°æ®ç»™å®ƒå¤„ç†ã€‚</li>
<li>ç­‰å¾…æ¯ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸã€‚</li>
</ol>
<p>å¾ˆå¥½ï¼Œä¼¼ä¹å¾ˆç®€å•å°±å®Œæˆäº†å¹¶å‘çš„æ”¹é€ ã€‚ç„¶åæˆ‘ä»¬è¿è¡Œä¸€ä¸‹è¿™ä¸ªç¨‹åºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hardware_concurrency: 16</span><br><span class="line">Concurrent task finish, 6246 ms consumed, Result: 1.78162e+12</span><br></pre></td></tr></table></figure>

<p>å¾ˆæŠ±æ­‰ï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™é‡Œçš„æ€§èƒ½å¹¶æ²¡æœ‰æ˜æ˜¾çš„æå‡ã€‚æ›´ä¸¥é‡çš„æ˜¯ï¼Œè¿™é‡Œçš„ç»“æœæ˜¯é”™è¯¯çš„ã€‚</p>
<p>è¦ææ¸…æ¥šä¸ºä»€ä¹ˆç»“æœä¸æ­£ç¡®æˆ‘ä»¬éœ€è¦æ›´å¤šçš„èƒŒæ™¯çŸ¥è¯†ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äºç°ä»£çš„å¤„ç†å™¨æ¥è¯´ï¼Œä¸ºäº†åŠ é€Ÿå¤„ç†çš„é€Ÿåº¦ï¼Œæ¯ä¸ªå¤„ç†å™¨éƒ½ä¼šæœ‰è‡ªå·±çš„é«˜é€Ÿç¼“å­˜ï¼ˆCacheï¼‰ï¼Œè¿™ä¸ªé«˜é€Ÿç¼“å­˜æ˜¯ä¸æ¯ä¸ªå¤„ç†å™¨ç›¸å¯¹åº”çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<blockquote>
<p>äº‹å®ä¸Šï¼Œç›®å‰å¤§éƒ¨åˆ†CPUçš„ç¼“å­˜å·²ç»ä¸åªä¸€å±‚ã€‚</p>
</blockquote>
<img src="https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/cpu.png" alt="img" style="zoom:80%;" />

<p>å¤„ç†å™¨åœ¨è¿›è¡Œè®¡ç®—çš„æ—¶å€™ï¼Œé«˜é€Ÿç¼“å­˜ä¼šå‚ä¸å…¶ä¸­ï¼Œä¾‹å¦‚æ•°æ®çš„è¯»å’Œå†™ã€‚è€Œé«˜é€Ÿç¼“å­˜å’Œç³»ç»Ÿä¸»å­˜ï¼ˆMemoryï¼‰æ˜¯æœ‰å¯èƒ½å­˜åœ¨ä¸ä¸€è‡´çš„ã€‚å³ï¼šæŸä¸ªç»“æœè®¡ç®—åä¿å­˜åœ¨å¤„ç†å™¨çš„é«˜é€Ÿç¼“å­˜ä¸­äº†ï¼Œä½†æ˜¯æ²¡æœ‰åŒæ­¥åˆ°ä¸»å­˜ä¸­ï¼Œæ­¤æ—¶è¿™ä¸ªå€¼å¯¹äºå…¶ä»–å¤„ç†å™¨å°±æ˜¯ä¸å¯è§çš„ã€‚</p>
<p>äº‹æƒ…è¿˜è¿œä¸æ­¢è¿™ä¹ˆç®€å•ã€‚æˆ‘ä»¬å¯¹äºå…¨å±€å˜é‡å€¼çš„ä¿®æ”¹ï¼š<code>sum += sqrt(i);</code>è¿™æ¡è¯­å¥ï¼Œå®ƒå¹¶éæ˜¯åŸå­çš„ã€‚å®ƒå…¶å®æ˜¯å¾ˆå¤šæ¡æŒ‡ä»¤çš„ç»„åˆæ‰èƒ½å®Œæˆã€‚å‡è®¾åœ¨æŸä¸ªè®¾å¤‡ä¸Šï¼Œè¿™æ¡è¯­å¥é€šè¿‡ä¸‹é¢è¿™å‡ ä¸ªæ­¥éª¤æ¥å®Œæˆã€‚å®ƒä»¬çš„æ—¶åºå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/multithread.png" alt="img" style="zoom:80%;" />

<p>åœ¨æ—¶é—´ç‚¹açš„æ—¶å€™ï¼Œæ‰€æœ‰çº¿ç¨‹å¯¹äº<code>sum</code>å˜é‡çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>ä½†æ˜¯åœ¨æ—¶é—´ç‚¹bä¹‹åï¼Œthread3ä¸Šå·²ç»å¯¹<code>sum</code>è¿›è¡Œäº†èµ‹å€¼ã€‚è€Œè¿™ä¸ªæ—¶å€™å…¶ä»–å‡ ä¸ªçº¿ç¨‹ä¹ŸåŒæ—¶åœ¨å…¶ä»–å¤„ç†å™¨ä¸Šä½¿ç”¨äº†è¿™ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å®ƒä»¬æ‰€ä½¿ç”¨çš„å€¼å°±æ˜¯æ—§çš„ï¼ˆé”™è¯¯çš„ï¼‰ã€‚æœ€åå¾—åˆ°çš„ç»“æœä¹Ÿè‡ªç„¶æ˜¯é”™çš„ã€‚</p>
<h3 id="ç«äº‰æ¡ä»¶ä¸ä¸´ç•ŒåŒº"><a href="#ç«äº‰æ¡ä»¶ä¸ä¸´ç•ŒåŒº" class="headerlink" title="ç«äº‰æ¡ä»¶ä¸ä¸´ç•ŒåŒº"></a>ç«äº‰æ¡ä»¶ä¸ä¸´ç•ŒåŒº</h3><p>å½“å¤šä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œåªè¦æœ‰ä¸€ä¸ªä»»åŠ¡ä¼šä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±å¯èƒ½ä¼šå‘ç”Ÿé—®é¢˜ã€‚æ­¤æ—¶ç»“æœä¾èµ–äºè¿™äº›ä»»åŠ¡æ‰§è¡Œçš„ç›¸å¯¹æ—¶é—´ï¼Œè¿™ç§åœºæ™¯ç§°ä¸º<a href="https://en.wikipedia.org/wiki/Race_condition"><strong>ç«äº‰æ¡ä»¶</strong>ï¼ˆrace conditionï¼‰</a>ã€‚</p>
<p>è®¿é—®å…±äº«æ•°æ®çš„ä»£ç ç‰‡æ®µç§°ä¹‹ä¸º<strong>ä¸´ç•ŒåŒº</strong>ï¼ˆcritical sectionï¼‰ã€‚å…·ä½“åˆ°ä¸Šé¢è¿™ä¸ªç¤ºä¾‹ï¼Œä¸´ç•ŒåŒºå°±æ˜¯è¯»å†™<code>sum</code>å˜é‡çš„åœ°æ–¹ã€‚</p>
<p>è¦é¿å…ç«äº‰æ¡ä»¶ï¼Œå°±éœ€è¦å¯¹ä¸´ç•ŒåŒºè¿›è¡Œæ•°æ®ä¿æŠ¤ã€‚</p>
<p>å¾ˆè‡ªç„¶çš„ï¼Œç°åœ¨æˆ‘ä»¬èƒ½å¤Ÿç†è§£å‘ç”Ÿç«äº‰æ¡ä»¶æ˜¯å› ä¸ºè¿™äº›çº¿ç¨‹åœ¨åŒæ—¶è®¿é—®å…±äº«æ•°æ®ï¼Œå…¶ä¸­æœ‰äº›çº¿ç¨‹çš„æ”¹åŠ¨æ²¡æœ‰è®©å…¶ä»–çº¿ç¨‹çŸ¥é“ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨é”™è¯¯çš„åŸºç¡€ä¸Šè¿›è¡Œå¤„ç†ï¼Œç»“æœè‡ªç„¶ä¹Ÿå°±æ˜¯é”™è¯¯çš„ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚æœä¸€æ¬¡åªè®©ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«æ•°æ®ï¼Œè®¿é—®å®Œäº†å†è®©å…¶ä»–çº¿ç¨‹æ¥ç€è®¿é—®ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…é—®é¢˜çš„å‘ç”Ÿäº†ã€‚</p>
<p>æ¥ä¸‹æ¥ä»‹ç»çš„APIæä¾›çš„å°±æ˜¯è¿™æ ·çš„åŠŸèƒ½ã€‚</p>
<h3 id="äº’æ–¥ä½“ä¸é”"><a href="#äº’æ–¥ä½“ä¸é”" class="headerlink" title="äº’æ–¥ä½“ä¸é”"></a>äº’æ–¥ä½“ä¸é”</h3><h4 id="mutex"><a href="#mutex" class="headerlink" title="mutex"></a>mutex</h4><p>å¼€å‘å¹¶å‘ç³»ç»Ÿçš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†æå‡æ€§èƒ½ï¼šå°†ä»»åŠ¡åˆ†æ•£åˆ°å¤šä¸ªçº¿ç¨‹ï¼Œç„¶ååœ¨ä¸åŒçš„å¤„ç†å™¨ä¸ŠåŒæ—¶æ‰§è¡Œã€‚è¿™äº›åˆ†æ•£å¼€æ¥çš„çº¿ç¨‹é€šå¸¸ä¼šåŒ…å«ä¸¤ç±»ä»»åŠ¡ï¼š</p>
<ol>
<li>ç‹¬ç«‹çš„å¯¹äºåˆ’åˆ†ç»™è‡ªå·±çš„æ•°æ®çš„å¤„ç†</li>
<li>å¯¹äºå¤„ç†ç»“æœçš„æ±‡æ€»</li>
</ol>
<p>å…¶ä¸­ç¬¬1é¡¹ä»»åŠ¡å› ä¸ºæ¯ä¸ªçº¿ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œä¸å­˜åœ¨ç«äº‰æ¡ä»¶çš„é—®é¢˜ã€‚è€Œç¬¬2é¡¹ä»»åŠ¡ï¼Œç”±äºæ‰€æœ‰çº¿ç¨‹éƒ½å¯èƒ½å¾€æ€»ç»“æœï¼ˆä¾‹å¦‚ä¸Šé¢çš„<code>sum</code>å˜é‡ï¼‰æ±‡æ€»ï¼Œè¿™å°±éœ€è¦åšä¿æŠ¤äº†ã€‚åœ¨æŸä¸€ä¸ªå…·ä½“çš„æ—¶åˆ»ï¼Œåªåº”å½“æœ‰ä¸€ä¸ªçº¿ç¨‹æ›´æ–°æ€»ç»“æœï¼Œå³ï¼šä¿è¯æ¯ä¸ªçº¿ç¨‹å¯¹äºå…±äº«æ•°æ®çš„è®¿é—®æ˜¯â€œäº’æ–¥â€çš„ã€‚<code>mutex</code> å°±æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ã€‚</p>
<p><code>mutex</code>æ˜¯<strong>mut</strong>ual <strong>ex</strong>clusionï¼ˆäº’æ–¥ï¼‰çš„ç®€å†™ã€‚</p>
<ul>
<li>ä¸»è¦API</li>
</ul>
<table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mutex</td>
<td align="left">C++11</td>
<td align="left">æä¾›åŸºæœ¬äº’æ–¥è®¾æ–½</td>
</tr>
<tr>
<td align="left">timed_mutex</td>
<td align="left">C++11</td>
<td align="left">æä¾›äº’æ–¥è®¾æ–½ï¼Œå¸¦æœ‰è¶…æ—¶åŠŸèƒ½</td>
</tr>
<tr>
<td align="left">recursive_mutex</td>
<td align="left">C++11</td>
<td align="left">æä¾›èƒ½è¢«åŒä¸€çº¿ç¨‹é€’å½’é”å®šçš„äº’æ–¥è®¾æ–½</td>
</tr>
<tr>
<td align="left">recursive_timed_mutex</td>
<td align="left">C++11</td>
<td align="left">æä¾›èƒ½è¢«åŒä¸€çº¿ç¨‹é€’å½’é”å®šçš„äº’æ–¥è®¾æ–½ï¼Œå¸¦æœ‰è¶…æ—¶åŠŸèƒ½</td>
</tr>
<tr>
<td align="left">shared_timed_mutex</td>
<td align="left">C++14</td>
<td align="left">æä¾›å…±äº«äº’æ–¥è®¾æ–½å¹¶å¸¦æœ‰è¶…æ—¶åŠŸèƒ½</td>
</tr>
<tr>
<td align="left">shared_mutex</td>
<td align="left">C++17</td>
<td align="left">æä¾›å…±äº«äº’æ–¥è®¾æ–½</td>
</tr>
</tbody></table>
<p>å¾ˆæ˜æ˜¾ï¼Œåœ¨è¿™äº›ç±»ä¸­ï¼Œ<code>mutex</code>æ˜¯æœ€åŸºç¡€çš„APIã€‚å…¶ä»–ç±»éƒ½æ˜¯åœ¨å®ƒçš„åŸºç¡€ä¸Šçš„æ”¹è¿›ã€‚æ‰€ä»¥è¿™äº›ç±»éƒ½æä¾›äº†ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”å®ƒä»¬çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>lock</td>
<td>é”å®šäº’æ–¥ä½“ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œåˆ™é˜»å¡</td>
</tr>
<tr>
<td>try_lock</td>
<td>å°è¯•é”å®šäº’æ–¥ä½“ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œç›´æ¥è¿”å›</td>
</tr>
<tr>
<td>unlock</td>
<td>è§£é”äº’æ–¥ä½“</td>
</tr>
</tbody></table>
<p>è¿™ä¸‰ä¸ªæ–¹æ³•æä¾›äº†åŸºç¡€çš„é”å®šå’Œè§£é™¤é”å®šçš„åŠŸèƒ½ã€‚ä½¿ç”¨<code>lock</code>æ„å‘³ç€ä½ æœ‰å¾ˆå¼ºçš„æ„æ„¿ä¸€å®šè¦è·å–åˆ°äº’æ–¥ä½“ï¼Œè€Œä½¿ç”¨<code>try_lock</code>åˆ™æ˜¯è¿›è¡Œä¸€æ¬¡å°è¯•ã€‚è¿™æ„å‘³ç€å¦‚æœå¤±è´¥äº†ï¼Œä½ é€šå¸¸è¿˜æœ‰å…¶ä»–çš„è·¯å¾„å¯ä»¥èµ°ã€‚</p>
<p>åœ¨è¿™äº›åŸºç¡€åŠŸèƒ½ä¹‹ä¸Šï¼Œå…¶ä»–çš„ç±»åˆ†åˆ«åœ¨ä¸‹é¢ä¸‰ä¸ªæ–¹é¢è¿›è¡Œäº†æ‰©å±•ï¼š</p>
<ul>
<li><strong>è¶…æ—¶</strong>ï¼š<code>timed_mutex</code>ï¼Œ<code>recursive_timed_mutex</code>ï¼Œ<code>shared_timed_mutex</code>çš„åç§°éƒ½å¸¦æœ‰<code>timed</code>ï¼Œè¿™æ„å‘³ç€å®ƒä»¬éƒ½æ”¯æŒè¶…æ—¶åŠŸèƒ½ã€‚å®ƒä»¬éƒ½æä¾›äº†<code>try_lock_for</code>å’Œ<code>try_lock_until</code>æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«å¯ä»¥æŒ‡å®šè¶…æ—¶çš„æ—¶é—´é•¿åº¦å’Œæ—¶é—´ç‚¹ã€‚å¦‚æœåœ¨è¶…æ—¶çš„æ—¶é—´èŒƒå›´å†…æ²¡æœ‰èƒ½è·å–åˆ°é”ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­ç­‰å¾…ã€‚</li>
<li><strong>å¯é‡å…¥</strong>ï¼š<code>recursive_mutex</code>å’Œ<code>recursive_timed_mutex</code>çš„åç§°éƒ½å¸¦æœ‰<code>recursive</code>ã€‚å¯é‡å…¥æˆ–è€…å«åšå¯é€’å½’ï¼Œæ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼ŒåŒä¸€æŠŠé”å¯ä»¥é”å®šå¤šæ¬¡ã€‚è¿™å°±é¿å…äº†ä¸€äº›ä¸å¿…è¦çš„æ­»é”ã€‚</li>
<li><strong>å…±äº«</strong>ï¼š<code>shared_timed_mutex</code>å’Œ<code>shared_mutex</code>æä¾›äº†å…±äº«åŠŸèƒ½ã€‚å¯¹äºè¿™ç±»äº’æ–¥ä½“ï¼Œå®é™…ä¸Šæ˜¯æä¾›äº†ä¸¤æŠŠé”ï¼šä¸€æŠŠæ˜¯å…±äº«é”ï¼Œä¸€æŠŠæ˜¯äº’æ–¥é”ã€‚ä¸€æ—¦æŸä¸ªçº¿ç¨‹è·å–äº†äº’æ–¥é”ï¼Œä»»ä½•å…¶ä»–çº¿ç¨‹éƒ½æ— æ³•å†è·å–äº’æ–¥é”å’Œå…±äº«é”ï¼›ä½†æ˜¯å¦‚æœæœ‰æŸä¸ªçº¿ç¨‹è·å–åˆ°äº†å…±äº«é”ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†è·å–åˆ°äº’æ–¥é”ï¼Œä½†æ˜¯è¿˜æœ‰è·å–åˆ°å…±äº«é”ã€‚è¿™é‡Œäº’æ–¥é”çš„ä½¿ç”¨å’Œå…¶ä»–çš„äº’æ–¥ä½“æ¥å£å’ŒåŠŸèƒ½ä¸€æ ·ã€‚è€Œå…±äº«é”å¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°ï¼ˆä½¿ç”¨å…±äº«é”çš„æ¥å£è§ä¸‹é¢çš„è¡¨æ ¼ï¼‰ã€‚å…±äº«é”é€šå¸¸ç”¨åœ¨<a href="https://en.wikipedia.org/wiki/Readers%E2%80%93writers_problem">è¯»è€…å†™è€…æ¨¡å‹</a>ä¸Šã€‚</li>
</ul>
<p>ä½¿ç”¨å…±äº«é”çš„æ¥å£å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>lock_shared</td>
<td>è·å–äº’æ–¥ä½“çš„å…±äº«é”ï¼Œå¦‚æœæ— æ³•è·å–åˆ™é˜»å¡</td>
</tr>
<tr>
<td>try_lock_shared</td>
<td>å°è¯•è·å–å…±äº«é”ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œç›´æ¥è¿”å›</td>
</tr>
<tr>
<td>unlock_shared</td>
<td>è§£é”å…±äº«é”</td>
</tr>
</tbody></table>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å€ŸåŠ©åˆšå­¦åˆ°çš„<code>mutex</code>æ¥æ”¹é€ æˆ‘ä»¬çš„å¹¶å‘ç³»ç»Ÿï¼Œæ”¹é€ åçš„ç¨‹åºå¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 07_mutex_lock.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAX = <span class="number">10e8</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> mutex exclusive;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">concurrent_worker</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = min; i &lt;= max; i++) &#123;</span><br><span class="line">    exclusive.<span class="built_in">lock</span>(); <span class="comment">// â‘ </span></span><br><span class="line">    sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">    exclusive.<span class="built_in">unlock</span>(); <span class="comment">// â‘¡</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">concurrent_task</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> start_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> concurrent_count = thread::<span class="built_in">hardware_concurrency</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;hardware_concurrency: &quot;</span> &lt;&lt; concurrent_count &lt;&lt; endl;</span><br><span class="line">  vector&lt;thread&gt; threads;</span><br><span class="line">  min = <span class="number">0</span>;</span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t &lt; concurrent_count; t++) &#123;</span><br><span class="line">    <span class="keyword">int</span> range = max / concurrent_count * (t + <span class="number">1</span>);</span><br><span class="line">    threads.<span class="built_in">push_back</span>(<span class="built_in">thread</span>(concurrent_worker, min, range)); <span class="comment">// â‘¢</span></span><br><span class="line">    min = range + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threads.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    threads[i].<span class="built_in">join</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> end_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">auto</span> ms = chrono::duration_cast&lt;chrono::milliseconds&gt;(end_time - start_time).<span class="built_in">count</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Concurrent task finish, &quot;</span> &lt;&lt; ms &lt;&lt; <span class="string">&quot; ms consumed, Result: &quot;</span> &lt;&lt; sum &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåªæœ‰ä¸‰ä¸ªåœ°æ–¹éœ€è¦å…³æ³¨ï¼š</p>
<ol>
<li>åœ¨è®¿é—®å…±äº«æ•°æ®ä¹‹å‰åŠ é”</li>
<li>è®¿é—®å®Œæˆä¹‹åè§£é”</li>
<li>åœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨å¸¦é”çš„ç‰ˆæœ¬</li>
</ol>
<p>æ‰§è¡Œä¹‹åç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hardware_concurrency: 16</span><br><span class="line">Concurrent task finish, 74232 ms consumed, Result: 2.10819e+13</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸‹ç»“æœæ˜¯å¯¹äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å´å‘ç°è¿™ä¸ªç‰ˆæœ¬æ¯”åŸå…ˆå•çº¿ç¨‹çš„ç‰ˆæœ¬æ€§èƒ½è¿˜è¦å·®å¾ˆå¤šã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸ºåŠ é”å’Œè§£é”æ˜¯æœ‰ä»£ä»·çš„ï¼Œè¿™é‡Œè®¡ç®—æœ€è€—æ—¶çš„åœ°æ–¹åœ¨é”é‡Œé¢ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œç›¸æ¯”äºå•çº¿ç¨‹æ¨¡å‹ï¼Œå®ƒä¸ä½†æ˜¯ä¸²è¡Œçš„ï¼Œè¿˜å¢åŠ äº†é”çš„è´Ÿæ‹…ï¼Œå› æ­¤å°±æ›´æ…¢äº†ã€‚</p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå‰é¢è¯´å¤šçº¿ç¨‹ç³»ç»Ÿä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œè€Œä¸”å¹¶éå¤šçº¿ç¨‹ç³»ç»Ÿä¸€å®šå°±æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>ä¸è¿‡ï¼Œå¯¹äºè¿™é‡Œçš„é—®é¢˜æ˜¯å¯ä»¥æ”¹è¿›çš„ã€‚æˆ‘ä»¬ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼šæˆ‘ä»¬åˆ’åˆ†ç»™æ¯ä¸ªçº¿ç¨‹çš„æ•°æ®å…¶å®æ˜¯ç‹¬ç«‹çš„ï¼Œå¯¹äºæ•°æ®çš„å¤„ç†æ˜¯è€—æ—¶çš„ï¼Œä½†å…¶å®è¿™éƒ¨åˆ†é€»è¾‘æ¯ä¸ªçº¿ç¨‹å¯ä»¥å•ç‹¬å¤„ç†ï¼Œæ²¡å¿…è¦åŠ é”ã€‚åªæœ‰åœ¨æœ€åæ±‡æ€»æ•°æ®çš„æ—¶å€™è¿›è¡Œä¸€æ¬¡é”ä¿æŠ¤å°±å¯ä»¥äº†ã€‚</p>
<p>äºæ˜¯æˆ‘ä»¬æ”¹é€ <code>concurrent_worker</code>ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 08_improved_mutex_lock.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">concurrent_worker</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">double</span> tmp_sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = min; i &lt;= max; i++) &#123;</span><br><span class="line">    tmp_sum += <span class="built_in">sqrt</span>(i); <span class="comment">// â‘ </span></span><br><span class="line">  &#125;</span><br><span class="line">  exclusive.<span class="built_in">lock</span>(); <span class="comment">// â‘¡</span></span><br><span class="line">  sum += tmp_sum;</span><br><span class="line">  exclusive.<span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç çš„æ”¹å˜åœ¨äºä¸¤å¤„ï¼š</p>
<ol>
<li>é€šè¿‡ä¸€ä¸ªå±€éƒ¨å˜é‡ä¿å­˜å½“å‰çº¿ç¨‹çš„å¤„ç†ç»“æœ</li>
<li>åœ¨æ±‡æ€»æ€»ç»“è¿‡çš„æ—¶å€™è¿›è¡Œé”ä¿æŠ¤</li>
</ol>
<p>è¿è¡Œä¸€ä¸‹æ”¹è¿›åçš„ç¨‹åºï¼Œå…¶ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hardware_concurrency: 16</span><br><span class="line">Concurrent task finish, 451 ms consumed, Result: 2.10819e+13</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ€§èƒ½ä¸€ä¸‹å°±æå‡äº†å¥½å¤šå€ã€‚æˆ‘ä»¬ç»ˆäºä½“éªŒåˆ°å¤šçº¿ç¨‹å¸¦æ¥çš„å¥½å¤„äº†ã€‚</p>
<p>æˆ‘ä»¬ç”¨é”çš„<strong>ç²’åº¦</strong>ï¼ˆgranularityï¼‰æ¥æè¿°é”çš„èŒƒå›´ã€‚<strong>ç»†ç²’åº¦</strong>ï¼ˆfine-grainedï¼‰æ˜¯æŒ‡é”ä¿æŠ¤è¾ƒå°çš„èŒƒå›´ï¼Œ<strong>ç²—ç²’åº¦</strong>ï¼ˆcoarse-grainedï¼‰æ˜¯æŒ‡é”ä¿æŠ¤è¾ƒå¤§çš„èŒƒå›´ã€‚å‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œæˆ‘ä»¬åº”è¯¥ä¿è¯é”çš„ç²’åº¦å°½å¯èƒ½çš„ç»†ã€‚å¹¶ä¸”ï¼Œä¸åº”è¯¥åœ¨è·å–é”çš„èŒƒå›´å†…æ‰§è¡Œè€—æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚æ‰§è¡ŒIOã€‚å¦‚æœæ˜¯è€—æ—¶çš„è¿ç®—ï¼Œä¹Ÿåº”è¯¥å°½å¯èƒ½çš„ç§»åˆ°é”çš„å¤–é¢ã€‚</p>
<blockquote>
<p>In general, a lock should be held for only the minimum possible time needed to perform the required operations.</p>
<p>â€“ã€ŠC++ Concurrency in Actionã€‹</p>
</blockquote>
<h4 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h4><p>æ­»é”æ˜¯å¹¶å‘ç³»ç»Ÿå¾ˆå¸¸è§çš„ä¸€ç±»é—®é¢˜ã€‚</p>
<p>æ­»é”æ˜¯æŒ‡ï¼šä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„è¿ç®—å•å…ƒï¼Œæ¯ä¸€æ–¹éƒ½åœ¨ç­‰å¾…å…¶ä»–æ–¹é‡Šæ”¾èµ„æºï¼Œä½†æ˜¯æ‰€æœ‰æ–¹éƒ½ä¸æ„¿æ„é‡Šæ”¾èµ„æºã€‚ç»“æœæ˜¯æ²¡æœ‰ä»»ä½•ä¸€æ–¹èƒ½ç»§ç»­æ¨è¿›ä¸‹å»ï¼Œäºæ˜¯æ•´ä¸ªç³»ç»Ÿæ— æ³•å†ç»§ç»­è¿è½¬ã€‚</p>
<p>æ­»é”åœ¨ç°å®ä¸­ä¹Ÿå¾ˆå¸¸è§ï¼Œä¾‹å¦‚ï¼šä¸¤ä¸ªå­©å­åˆ†åˆ«æ‹¿ç€ç©å…·çš„ä¸€åŠç„¶åå“­ç€è¦ä»å¯¹æ–¹æ‰‹é‡Œå¾—åˆ°å¦å¤–ä¸€åŠç©å…·ï¼Œä½†æ˜¯è°éƒ½ä¸è‚¯è®©æ­¥ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç¼–ç¨‹ç¤ºä¾‹ã€‚</p>
<p>ç°åœ¨å‡è®¾æˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªé“¶è¡Œçš„ç³»ç»Ÿï¼Œè¿™ä¸ªç³»ç»ŸåŒ…å«äº†è½¬è´¦çš„åŠŸèƒ½ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>Account</code>ç±»æ¥æè¿°é“¶è¡Œè´¦å·ã€‚ç”±äºè¿™ä»…ä»…æ˜¯ä¸€ä¸ªæ¼”ç¤ºä½¿ç”¨çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›ä»£ç è¶³å¤Ÿçš„ç®€å•ã€‚<code>Account</code>ç±»ä»…ä»…åŒ…å«åç§°å’Œé‡‘é¢ä¸¤ä¸ªå­—æ®µã€‚</p>
<p>å¦å¤–ï¼Œä¸ºäº†æ”¯æŒå¹¶å‘ï¼Œè¿™ä¸ªç±»åŒ…å«äº†ä¸€ä¸ª<code>mutex</code>å¯¹è±¡ï¼Œç”¨æ¥ä¿æŠ¤è´¦å·é‡‘é¢ï¼Œåœ¨è¯»å†™è´¦å·é‡‘é¢æ—¶éœ€è¦å…ˆåŠ é”ä¿æŠ¤ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 09_deadlock_bank_transfer.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Account</span>(string name, <span class="keyword">double</span> money): <span class="built_in">mName</span>(name), <span class="built_in">mMoney</span>(money) &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">changeMoney</span><span class="params">(<span class="keyword">double</span> amount)</span> </span>&#123;</span><br><span class="line">    mMoney += amount;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">string <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mName;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mMoney;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">mutex* <span class="title">getLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;mMoneyLock;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  string mName;</span><br><span class="line">  <span class="keyword">double</span> mMoney;</span><br><span class="line">  mutex mMoneyLock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>Account</code>ç±»å¾ˆç®€å•ï¼Œæˆ‘æƒ³å°±ä¸ç”¨å¤šåšè¯´æ˜äº†ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªæè¿°é“¶è¡Œçš„<code>Bank</code>ç±»ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 09_deadlock_bank_transfer.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addAccount</span><span class="params">(Account* account)</span> </span>&#123;</span><br><span class="line">    mAccounts.<span class="built_in">insert</span>(account);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">transferMoney</span><span class="params">(Account* accountA, Account* accountB, <span class="keyword">double</span> amount)</span> </span>&#123;</span><br><span class="line">    <span class="function">lock_guard <span class="title">guardA</span><span class="params">(*accountA-&gt;getLock())</span></span>; <span class="comment">// â‘ </span></span><br><span class="line">    <span class="function">lock_guard <span class="title">guardB</span><span class="params">(*accountB-&gt;getLock())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (amount &gt; accountA-&gt;<span class="built_in">getMoney</span>()) &#123; <span class="comment">// â‘¡</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    accountA-&gt;<span class="built_in">changeMoney</span>(-amount); <span class="comment">// â‘¢</span></span><br><span class="line">    accountB-&gt;<span class="built_in">changeMoney</span>(amount);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">totalMoney</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> a : mAccounts) &#123;</span><br><span class="line">      sum += a-&gt;<span class="built_in">getMoney</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  set&lt;Account*&gt; mAccounts;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é“¶è¡Œç±»ä¸­è®°å½•äº†æ‰€æœ‰çš„è´¦å·ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªæ–¹æ³•ç”¨æ¥æŸ¥è¯¢æ•´ä¸ªé“¶è¡Œçš„æ€»é‡‘é¢ã€‚</p>
<p>è¿™å…¶ä¸­ï¼Œæˆ‘ä»¬æœ€ä¸»è¦è¦å…³æ³¨è½¬è´¦çš„å®ç°ï¼š<code>transferMoney</code>ã€‚è¯¥æ–¹æ³•çš„å‡ ä¸ªå…³é”®ç‚¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåœ¨ä¿®æ”¹æ¯ä¸ªè´¦å·ä¹‹å‰ï¼Œéœ€è¦è·å–ç›¸åº”çš„é”ã€‚</li>
<li>åˆ¤æ–­è½¬å‡ºè´¦æˆ·é‡‘é¢æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿæ­¤æ¬¡è½¬è´¦å¤±è´¥ã€‚</li>
<li>è¿›è¡Œè½¬è´¦ã€‚</li>
</ol>
<p>æœ‰äº†é“¶è¡Œå’Œè´¦æˆ·ç»“æ„ä¹‹åå°±å¯ä»¥å¼€å‘è½¬è´¦ç³»ç»Ÿäº†ï¼ŒåŒæ ·çš„ï¼Œç”±äºæ˜¯ä¸ºäº†æ¼”ç¤ºæ‰€ç”¨ï¼Œæˆ‘ä»¬çš„è½¬è´¦ç³»ç»Ÿä¹Ÿä¼šå°½å¯èƒ½çš„ç®€å•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 09_deadlock_bank_transfer.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">randomTransfer</span><span class="params">(Bank* bank, Account* accountA, Account* accountB)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">double</span> randomMoney = ((<span class="keyword">double</span>)<span class="built_in">rand</span>() / RAND_MAX) * <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">if</span> (bank-&gt;<span class="built_in">transferMoney</span>(accountA, accountB, randomMoney)) &#123;</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;Transfer &quot;</span> &lt;&lt; randomMoney &lt;&lt; <span class="string">&quot; from &quot;</span> &lt;&lt; accountA-&gt;<span class="built_in">getName</span>()</span><br><span class="line">           &lt;&lt; <span class="string">&quot; to &quot;</span> &lt;&lt; accountB-&gt;<span class="built_in">getName</span>()</span><br><span class="line">           &lt;&lt; <span class="string">&quot;, Bank totalMoney: &quot;</span> &lt;&lt; bank-&gt;<span class="built_in">totalMoney</span>() &lt;&lt; endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;Transfer failed, &quot;</span></span><br><span class="line">           &lt;&lt; accountA-&gt;<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; has only $&quot;</span> &lt;&lt; accountA-&gt;<span class="built_in">getMoney</span>() &lt;&lt; <span class="string">&quot;, but &quot;</span></span><br><span class="line">           &lt;&lt; randomMoney &lt;&lt; <span class="string">&quot; required&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œç„¶åé€šè¿‡é“¶è¡Œè¿›è¡Œè½¬è´¦ã€‚</p>
<p>æœ€åæˆ‘ä»¬åœ¨<code>main</code>å‡½æ•°ä¸­åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œäº’ç›¸åœ¨ä¸¤ä¸ªè´¦å·ä¹‹é—´æ¥å›è½¬è´¦ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 09_deadlock_bank_transfer.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">Account <span class="title">a</span><span class="params">(<span class="string">&quot;Paul&quot;</span>, <span class="number">100</span>)</span></span>;</span><br><span class="line">  <span class="function">Account <span class="title">b</span><span class="params">(<span class="string">&quot;Moira&quot;</span>, <span class="number">100</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  Bank aBank;</span><br><span class="line">  aBank.<span class="built_in">addAccount</span>(&amp;a);</span><br><span class="line">  aBank.<span class="built_in">addAccount</span>(&amp;b);</span><br><span class="line"></span><br><span class="line">  <span class="function">thread <span class="title">t1</span><span class="params">(randomTransfer, &amp;aBank, &amp;a, &amp;b)</span></span>;</span><br><span class="line">  <span class="function">thread <span class="title">t2</span><span class="params">(randomTransfer, &amp;aBank, &amp;b, &amp;a)</span></span>;</span><br><span class="line"></span><br><span class="line">  t1.<span class="built_in">join</span>();</span><br><span class="line">  t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„é“¶è¡Œè½¬è´¦ç³»ç»Ÿå°±å¼€å‘å®Œæˆäº†ã€‚ç„¶åç¼–è¯‘å¹¶è¿è¡Œï¼Œå…¶ç»“æœå¯èƒ½åƒä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Transfer 13.2901 from Paul to Moira, Bank totalMoney: 20042.6259 from Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer failed, Moira has only $34.7581, but 66.3208 required</span><br><span class="line">Transfer failed, Moira has only $34.7581, but </span><br><span class="line">Transfer 93.191 from 53.9176 required</span><br><span class="line">Transfer 60.6146 from Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer 49.7304 from Moira to Paul, Bank totalMoney: 200Paul to Moira, Bank totalMoney: </span><br><span class="line">Transfer failed, Moira has only $17.6041, but 18.1186 required</span><br><span class="line">Transfer failed, Moira has only $17.6041, but 18.893 required</span><br><span class="line">Transfer failed, Moira has only $17.6041, but 34.7078 required</span><br><span class="line">Transfer failed, Moira has only $17.6041, but 33.9569 required</span><br><span class="line">Transfer 12.7899 from 200</span><br><span class="line">Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer failed, Moira has only $63.9373, but 80.9038 required</span><br><span class="line">Transfer 50.933 from Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer failed, Moira has only $13.0043, but 30.2056 required</span><br><span class="line">Transfer failed, Moira has only $Transfer 59.123 from Paul to Moira, Bank totalMoney: 200</span><br><span class="line">Transfer 29.0486 from Paul to Moira, Bank totalMoney: 20013.0043, but 64.7307 required</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ è¿è¡Œäº†è¿™ä¸ªç¨‹åºï¼Œä½ ä¼šå‘ç°å¾ˆå¿«å®ƒå°±å¡ä½ä¸åŠ¨äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>å› ä¸ºå‘ç”Ÿäº†æ­»é”ã€‚</p>
<p>æˆ‘ä»¬ä»”ç»†æ€è€ƒä¸€ä¸‹è¿™ä¸¤ä¸ªçº¿ç¨‹çš„é€»è¾‘ï¼šè¿™ä¸¤ä¸ªçº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶è·å–å…¶ä¸­ä¸€ä¸ªè´¦å·çš„é”ï¼Œç„¶ååˆæƒ³è·å–å¦å¤–ä¸€ä¸ªè´¦å·çš„é”ï¼Œæ­¤æ—¶å°±å‘ç”Ÿäº†æ­»é”ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/deadlock.png" alt="img"></p>
<p>å½“ç„¶ï¼Œå‘ç”Ÿæ­»é”çš„åŸå› è¿œä¸æ­¢ä¸Šé¢è¿™ä¸€ç§æƒ…å†µã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹äº’ç›¸<code>join</code>å°±å¯èƒ½å‘ç”Ÿæ­»é”ã€‚è¿˜æœ‰åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¯¹ä¸€ä¸ªä¸å¯é‡å…¥çš„äº’æ–¥ä½“ï¼ˆä¾‹å¦‚<code>mutex</code>è€Œé<code>recursive_mutex</code>ï¼‰å¤šæ¬¡åŠ é”ä¹Ÿä¼šæ­»é”ã€‚</p>
<p>ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œæˆ‘å¯ä¸ä¼šè¿™ä¹ˆå‚»ï¼Œå†™å‡ºè¿™æ ·çš„ä»£ç ã€‚ä½†å®é™…ä¸Šï¼Œå¾ˆå¤šæ—¶å€™æ˜¯ç”±äºä»£ç çš„æ·±å±‚æ¬¡åµŒå¥—å¯¼è‡´äº†æ­»é”çš„å‘ç”Ÿï¼Œç”±äºè°ƒç”¨å…³ç³»çš„å¤æ‚å¯¼è‡´å‘ç°è¿™ç±»é—®é¢˜å¹¶ä¸å®¹æ˜“ã€‚</p>
<p>å¦‚æœä»”ç»†çœ‹ä¸€ä¸‹ä¸Šé¢çš„è¾“å‡ºï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿˜æœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼šè¿™é‡Œçš„è¾“å‡ºæ˜¯ä¹±çš„ã€‚ä¸¤ä¸ªçº¿ç¨‹çš„è¾“å‡ºæ··æ‚åœ¨ä¸€èµ·äº†ã€‚ç©¶å…¶åŸå› ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼šä¸¤ä¸ªçº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶è¾“å‡ºï¼Œæ²¡æœ‰åšå¥½éš”ç¦»ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ¥é€æ­¥è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚</p>
<p>å¯¹äºè¾“å‡ºæ··ä¹±çš„é—®é¢˜å¾ˆå¥½è§£å†³ï¼Œä¸“é—¨ç”¨ä¸€æŠŠé”æ¥ä¿æŠ¤è¾“å‡ºé€»è¾‘å³å¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 10_improved_bank_transfer.cpp</span></span><br><span class="line"></span><br><span class="line">mutex sCoutLock;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">randomTransfer</span><span class="params">(Bank* bank, Account* accountA, Account* accountB)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">double</span> randomMoney = ((<span class="keyword">double</span>)<span class="built_in">rand</span>() / RAND_MAX) * <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">if</span> (bank-&gt;<span class="built_in">transferMoney</span>(accountA, accountB, randomMoney)) &#123;</span><br><span class="line">      sCoutLock.<span class="built_in">lock</span>();</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;Transfer &quot;</span> &lt;&lt; randomMoney &lt;&lt; <span class="string">&quot; from &quot;</span> &lt;&lt; accountA-&gt;<span class="built_in">getName</span>()</span><br><span class="line">          &lt;&lt; <span class="string">&quot; to &quot;</span> &lt;&lt; accountB-&gt;<span class="built_in">getName</span>()</span><br><span class="line">          &lt;&lt; <span class="string">&quot;, Bank totalMoney: &quot;</span> &lt;&lt; bank-&gt;<span class="built_in">totalMoney</span>() &lt;&lt; endl;</span><br><span class="line">      sCoutLock.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      sCoutLock.<span class="built_in">lock</span>();</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;Transfer failed, &quot;</span></span><br><span class="line">           &lt;&lt; accountA-&gt;<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; has only &quot;</span> &lt;&lt; accountA-&gt;<span class="built_in">getMoney</span>() &lt;&lt; <span class="string">&quot;, but &quot;</span></span><br><span class="line">           &lt;&lt; randomMoney &lt;&lt; <span class="string">&quot; required&quot;</span> &lt;&lt; endl;</span><br><span class="line">      sCoutLock.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="é€šç”¨é”å®šç®—æ³•"><a href="#é€šç”¨é”å®šç®—æ³•" class="headerlink" title="é€šç”¨é”å®šç®—æ³•"></a>é€šç”¨é”å®šç®—æ³•</h4><ul>
<li>ä¸»è¦API</li>
</ul>
<table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">lock</td>
<td align="left">C++11</td>
<td align="left">é”å®šæŒ‡å®šçš„äº’æ–¥ä½“ï¼Œè‹¥ä»»ä½•ä¸€ä¸ªä¸å¯ç”¨åˆ™é˜»å¡</td>
</tr>
<tr>
<td align="left">try_lock</td>
<td align="left">C++11</td>
<td align="left">è¯•å›¾é€šè¿‡é‡å¤è°ƒç”¨ try_lock è·å¾—äº’æ–¥ä½“çš„æ‰€æœ‰æƒ</td>
</tr>
</tbody></table>
<p>è¦é¿å…æ­»é”ï¼Œéœ€è¦ä»”ç»†çš„æ€è€ƒå’Œè®¾è®¡ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>æœ‰ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„åŸåˆ™å¯ä»¥é¿å…æ­»é”ï¼Œå³ï¼šå¯¹æ‰€æœ‰çš„é”è¿›è¡Œæ’åºï¼Œæ¯æ¬¡ä¸€å®šè¦æŒ‰ç…§é¡ºåºæ¥è·å–é”ï¼Œä¸å…è®¸ä¹±åºã€‚ä¾‹å¦‚ï¼šè¦è·å–æŸä¸ªç©å…·ï¼Œä¸€å®šè¦å…ˆæ‹¿åˆ°é”Aï¼Œå†æ‹¿åˆ°é”Bï¼Œæ‰èƒ½ç©ç©å…·ã€‚è¿™æ ·å°±ä¸ä¼šæ­»é”äº†ã€‚</p>
<p>è¿™ä¸ªåŸåˆ™è™½ç„¶ç®€å•ï¼Œä½†å´ä¸å®¹æ˜“éµå®ˆã€‚å› ä¸ºæ•°æ®å¸¸å¸¸æ˜¯åˆ†æ•£åœ¨å¾ˆå¤šåœ°æ–¹çš„ã€‚</p>
<p>ä¸è¿‡å¥½æ¶ˆæ¯æ˜¯ï¼ŒC++ 11æ ‡å‡†ä¸­ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å·¥å…·æ¥é¿å…å› ä¸ºå¤šæŠŠé”è€Œå¯¼è‡´çš„æ­»é”ã€‚æˆ‘ä»¬åªè¦ç›´æ¥è°ƒç”¨è¿™äº›æ¥å£å°±å¯ä»¥äº†ã€‚è¿™ä¸ªå°±æ˜¯ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªå‡½æ•°ã€‚å®ƒä»¬éƒ½æ”¯æŒä¼ å…¥å¤šä¸ª<a href="https://en.cppreference.com/w/cpp/named_req/Lockable">Lockable</a>å¯¹è±¡ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨å®ƒæ¥æ”¹é€ ä¹‹å‰æ­»é”çš„è½¬è´¦ç³»ç»Ÿï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 10_improved_bank_transfer.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">transferMoney</span><span class="params">(Account* accountA, Account* accountB, <span class="keyword">double</span> amount)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">lock</span>(*accountA-&gt;<span class="built_in">getLock</span>(), *accountB-&gt;<span class="built_in">getLock</span>());    <span class="comment">// â‘ </span></span><br><span class="line">  <span class="function">lock_guard <span class="title">lockA</span><span class="params">(*accountA-&gt;getLock(), adopt_lock)</span></span>;  <span class="comment">// â‘¡</span></span><br><span class="line">  <span class="function">lock_guard <span class="title">lockB</span><span class="params">(*accountB-&gt;getLock(), adopt_lock)</span></span>;  <span class="comment">// â‘¢</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (amount &gt; accountA-&gt;<span class="built_in">getMoney</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  accountA-&gt;<span class="built_in">changeMoney</span>(-amount);</span><br><span class="line">  accountB-&gt;<span class="built_in">changeMoney</span>(amount);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåªæ”¹åŠ¨äº†3è¡Œä»£ç ã€‚</p>
<ol>
<li>è¿™é‡Œé€šè¿‡<code>lock</code>å‡½æ•°æ¥è·å–ä¸¤æŠŠé”ï¼Œæ ‡å‡†åº“çš„å®ç°ä¼šä¿è¯ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚</li>
<li><code>lock_guard</code>åœ¨ä¸‹é¢æˆ‘ä»¬è¿˜ä¼šè¯¦ç»†ä»‹ç»ã€‚è¿™é‡Œåªè¦çŸ¥é“å®ƒä¼šåœ¨è‡ªèº«å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„èŒƒå›´å†…é”å®šäº’æ–¥ä½“å³å¯ã€‚åˆ›å»º<code>lock_guard</code>çš„ç›®çš„æ˜¯ä¸ºäº†åœ¨<code>transferMoney</code>ç»“æŸçš„æ—¶å€™é‡Šæ”¾é”ï¼Œ<code>lockB</code>ä¹Ÿæ˜¯ä¸€æ ·ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¼ é€’äº† <code>adopt_lock</code>è¡¨ç¤ºï¼šç°åœ¨æ˜¯å·²ç»è·å–åˆ°äº’æ–¥ä½“äº†çš„çŠ¶æ€äº†ï¼Œä¸ç”¨å†æ¬¡åŠ é”ï¼ˆå¦‚æœä¸åŠ <code>adopt_lock</code>å°±æ˜¯äºŒæ¬¡é”å®šäº†ï¼‰ã€‚</li>
</ol>
<p>è¿è¡Œä¸€ä¸‹è¿™ä¸ªæ”¹é€ åçš„ç¨‹åºï¼Œå…¶è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 17.5974 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 59.2104 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 49.6379 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 63.6373 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 51.8742 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 50.0081 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 86.1041 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 51.3278 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 66.5754 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 32.1867 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 62.0039 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 98.7819 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 27.046 required</span><br><span class="line">Transfer failed, Paul has only $1.76243, but 62.9155 required</span><br><span class="line">Transfer 98.8478 from Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer 80.0722 from Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer 73.7035 from Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer 34.4476 from Moira to Paul, Bank totalMoney: 200</span><br><span class="line">Transfer failed, Moira has only $10.0142, but 61.3033 required</span><br><span class="line">Transfer failed, Moira has only $10.0142, but 24.5595 required</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨è¿™ä¸ªè½¬è´¦ç¨‹åºä¼šä¸€ç›´è¿è¡Œä¸‹å»ï¼Œä¸ä¼šå†æ­»é”äº†ã€‚è¾“å‡ºä¹Ÿæ˜¯æ­£å¸¸çš„äº†ã€‚</p>
<h4 id="é€šç”¨äº’æ–¥ç®¡ç†"><a href="#é€šç”¨äº’æ–¥ç®¡ç†" class="headerlink" title="é€šç”¨äº’æ–¥ç®¡ç†"></a>é€šç”¨äº’æ–¥ç®¡ç†</h4><ul>
<li>ä¸»è¦API</li>
</ul>
<table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">lock_guard</td>
<td align="left">C++11</td>
<td align="left">å®ç°ä¸¥æ ¼åŸºäºä½œç”¨åŸŸçš„äº’æ–¥ä½“æ‰€æœ‰æƒåŒ…è£…å™¨</td>
</tr>
<tr>
<td align="left">unique_lock</td>
<td align="left">C++11</td>
<td align="left">å®ç°å¯ç§»åŠ¨çš„äº’æ–¥ä½“æ‰€æœ‰æƒåŒ…è£…å™¨</td>
</tr>
<tr>
<td align="left">shared_lock</td>
<td align="left">C++14</td>
<td align="left">å®ç°å¯ç§»åŠ¨çš„å…±äº«äº’æ–¥ä½“æ‰€æœ‰æƒå°è£…å™¨</td>
</tr>
<tr>
<td align="left">scoped_lock</td>
<td align="left">C++17</td>
<td align="left">ç”¨äºå¤šä¸ªäº’æ–¥ä½“çš„å…æ­»é” RAII å°è£…å™¨</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">é”å®šç­–ç•¥</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">defer_lock</td>
<td align="left">C++11</td>
<td align="left">ç±»å‹ä¸º <code>defer_lock_t</code>ï¼Œä¸è·å¾—äº’æ–¥çš„æ‰€æœ‰æƒ</td>
</tr>
<tr>
<td align="left">try_to_lock</td>
<td align="left">C++11</td>
<td align="left">ç±»å‹ä¸º<code>try_to_lock_t</code>ï¼Œå°è¯•è·å¾—äº’æ–¥çš„æ‰€æœ‰æƒè€Œä¸é˜»å¡</td>
</tr>
<tr>
<td align="left">adopt_lock</td>
<td align="left">C++11</td>
<td align="left">ç±»å‹ä¸º<code>adopt_lock_t</code>ï¼Œå‡è®¾è°ƒç”¨æ–¹å·²æ‹¥æœ‰äº’æ–¥çš„æ‰€æœ‰æƒ</td>
</tr>
</tbody></table>
<p>äº’æ–¥ä½“ï¼ˆ<code>mutex</code>ç›¸å…³ç±»ï¼‰æä¾›äº†å¯¹äºèµ„æºçš„ä¿æŠ¤åŠŸèƒ½ï¼Œä½†æ˜¯æ‰‹åŠ¨çš„é”å®šï¼ˆè°ƒç”¨<code>lock</code>æˆ–è€…<code>try_lock</code>ï¼‰å’Œè§£é”ï¼ˆè°ƒç”¨<code>unlock</code>ï¼‰äº’æ–¥ä½“æ˜¯è¦è€—è´¹æ¯”è¾ƒå¤§çš„ç²¾åŠ›çš„ï¼Œæˆ‘ä»¬éœ€è¦ç²¾å¿ƒè€ƒè™‘å’Œè®¾è®¡ä»£ç æ‰è¡Œã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦ä¿è¯ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œè§£é”è¦å’ŒåŠ é”é…å¯¹ï¼Œå› ä¸ºå‡è®¾å‡ºç°ä¸€æ¡è·¯å¾„å¯¼è‡´è·å–é”ä¹‹åæ²¡æœ‰æ­£å¸¸é‡Šæ”¾ï¼Œå°±ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿã€‚å¦‚æœè€ƒè™‘æ–¹æ³•è¿˜å¯ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™æ ·çš„ä»£ç å†™èµ·æ¥ä¼šå¾ˆè´¹åŠ²ã€‚</p>
<p>é‰´äºè¿™ä¸ªåŸå› ï¼Œæ ‡å‡†åº“å°±æä¾›äº†ä¸Šé¢çš„è¿™äº›APIã€‚å®ƒä»¬éƒ½ä½¿ç”¨äº†å«åšRAIIçš„ç¼–ç¨‹æŠ€å·§ï¼Œæ¥ç®€åŒ–æˆ‘ä»¬æ‰‹åŠ¨åŠ é”å’Œè§£é”çš„â€œä½“åŠ›æ´»â€ã€‚</p>
<p>è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https://en.cppreference.com/w/cpp/thread/lock_guard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">int</span> g_i = <span class="number">0</span>;</span><br><span class="line">std::mutex g_i_mutex;  <span class="comment">// â‘ </span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">safe_increment</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(g_i_mutex)</span></span>;  <span class="comment">// â‘¡</span></span><br><span class="line">  ++g_i;</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; g_i &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  <span class="comment">// â‘¢</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;main: &quot;</span> &lt;&lt; g_i &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="function">std::thread <span class="title">t1</span><span class="params">(safe_increment)</span></span>; <span class="comment">// â‘£</span></span><br><span class="line">  <span class="function">std::thread <span class="title">t2</span><span class="params">(safe_increment)</span></span>;</span><br><span class="line"> </span><br><span class="line">  t1.<span class="built_in">join</span>();</span><br><span class="line">  t2.<span class="built_in">join</span>();</span><br><span class="line"> </span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;main: &quot;</span> &lt;&lt; g_i &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç ä¸­ï¼š</p>
<ol>
<li>å…¨å±€çš„äº’æ–¥ä½“<code>g_i_mutex</code>ç”¨æ¥ä¿æŠ¤å…¨å±€å˜é‡<code>g_i</code></li>
<li>è¿™æ˜¯ä¸€ä¸ªè®¾è®¡ä¸ºå¯ä»¥è¢«å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨çš„æ–¹æ³•ã€‚å› æ­¤éœ€è¦é€šè¿‡äº’æ–¥ä½“æ¥è¿›è¡Œä¿æŠ¤ã€‚è¿™é‡Œæ²¡æœ‰è°ƒç”¨<code>lock</code>æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨<code>lock_guard</code>æ¥é”å®šäº’æ–¥ä½“ã€‚</li>
<li>åœ¨æ–¹æ³•ç»“æŸçš„æ—¶å€™ï¼Œå±€éƒ¨å˜é‡<code>std::lock_guard&lt;std::mutex&gt; lock</code>ä¼šè¢«é”€æ¯ï¼Œå®ƒå¯¹äº’æ–¥ä½“çš„é”å®šä¹Ÿå°±è§£é™¤äº†ã€‚</li>
<li>åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</li>
</ol>
<h4 id="RAII"><a href="#RAII" class="headerlink" title="RAII"></a>RAII</h4><p>ä¸Šé¢çš„å‡ ä¸ªç±»ï¼ˆ<code>lock_guard</code>ï¼Œ<code>unique_lock</code>ï¼Œ<code>shared_lock</code>ï¼Œ<code>scoped_lock</code>ï¼‰éƒ½ä½¿ç”¨äº†ä¸€ä¸ªå«åšRAIIçš„ç¼–ç¨‹æŠ€å·§ã€‚</p>
<p>RAIIå…¨ç§°æ˜¯Resource Acquisition Is Initializationï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯ï¼šèµ„æºè·å–å³åˆå§‹åŒ–ã€‚</p>
<p>RAIIæ˜¯ä¸€ç§<a href="http://www.stroustrup.com/bs_faq2.html#finally">C++ç¼–ç¨‹æŠ€æœ¯</a>ï¼Œå®ƒå°†å¿…é¡»åœ¨ä½¿ç”¨å‰è¯·æ±‚çš„èµ„æºï¼ˆä¾‹å¦‚ï¼šåˆ†é…çš„å †å†…å­˜ã€æ‰§è¡Œçº¿ç¨‹ã€æ‰“å¼€çš„å¥—æ¥å­—ã€æ‰“å¼€çš„æ–‡ä»¶ã€é”å®šçš„äº’æ–¥ä½“ã€ç£ç›˜ç©ºé—´ã€æ•°æ®åº“è¿æ¥ç­‰â€”â€”ä»»ä½•å­˜åœ¨å—é™ä¾›ç»™ä¸­çš„äº‹ç‰©ï¼‰çš„ç”Ÿå‘½å‘¨æœŸä¸ä¸€ä¸ªå¯¹è±¡çš„ç”Ÿå­˜å‘¨æœŸç›¸ç»‘å®šã€‚ RAIIä¿è¯èµ„æºå¯ç”¨äºä»»ä½•ä¼šè®¿é—®è¯¥å¯¹è±¡çš„å‡½æ•°ã€‚å®ƒäº¦ä¿è¯æ‰€æœ‰èµ„æºåœ¨å…¶æ§åˆ¶å¯¹è±¡çš„ç”Ÿå­˜æœŸç»“æŸæ—¶ï¼Œä»¥è·å–é¡ºåºçš„é€†åºé‡Šæ”¾ã€‚ç±»ä¼¼åœ°ï¼Œè‹¥èµ„æºè·å–å¤±è´¥ï¼ˆæ„é€ å‡½æ•°ä»¥å¼‚å¸¸é€€å‡ºï¼‰ï¼Œåˆ™ä¸ºå·²æ„é€ å®Œæˆçš„å¯¹è±¡å’ŒåŸºç±»å­å¯¹è±¡æ‰€è·å–çš„æ‰€æœ‰èµ„æºï¼Œä¼šä»¥åˆå§‹åŒ–é¡ºåºçš„é€†åºé‡Šæ”¾ã€‚è¿™æœ‰æ•ˆåœ°åˆ©ç”¨äº†è¯­è¨€ç‰¹æ€§ä»¥æ¶ˆé™¤å†…å­˜æ³„æ¼å¹¶ä¿è¯å¼‚å¸¸å®‰å…¨ã€‚</p>
<p>RAII å¯æ€»ç»“å¦‚ä¸‹:</p>
<ul>
<li>å°†æ¯ä¸ªèµ„æºå°è£…å…¥ä¸€ä¸ªç±»ï¼Œå…¶ä¸­ï¼š<ul>
<li>æ„é€ å‡½æ•°è¯·æ±‚èµ„æºï¼Œå¹¶å»ºç«‹æ‰€æœ‰ç±»ä¸å˜å¼ï¼Œæˆ–åœ¨å®ƒæ— æ³•å®Œæˆæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œ</li>
<li>ææ„å‡½æ•°é‡Šæ”¾èµ„æºå¹¶å†³ä¸æŠ›å‡ºå¼‚å¸¸ï¼›</li>
</ul>
</li>
<li>å§‹ç»ˆç»ç”± RAII ç±»çš„å®ä¾‹ä½¿ç”¨æ»¡è¶³è¦æ±‚çš„èµ„æºï¼Œè¯¥èµ„æº<ul>
<li>è‡ªèº«æ‹¥æœ‰è‡ªåŠ¨å­˜å‚¨æœŸæˆ–ä¸´æ—¶ç”Ÿå­˜æœŸï¼Œæˆ–</li>
<li>å…·æœ‰ä¸è‡ªåŠ¨æˆ–ä¸´æ—¶å¯¹è±¡çš„ç”Ÿå­˜æœŸç»‘å®šçš„ç”Ÿå­˜æœŸ</li>
</ul>
</li>
</ul>
<p>å›æƒ³ä¸€ä¸‹ä¸Šæ–‡ä¸­çš„<code>transferMoney</code>æ–¹æ³•ä¸­çš„ä¸‰è¡Œä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">lock</span>(*accountA-&gt;<span class="built_in">getLock</span>(), *accountB-&gt;<span class="built_in">getLock</span>());</span><br><span class="line"><span class="function">lock_guard <span class="title">lockA</span><span class="params">(*accountA-&gt;getLock(), adopt_lock)</span></span>;</span><br><span class="line"><span class="function">lock_guard <span class="title">lockB</span><span class="params">(*accountB-&gt;getLock(), adopt_lock)</span></span>;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½¿ç”¨<code>unique_lock</code>è¿™ä¸‰è¡Œä»£ç è¿˜æœ‰ä¸€ç§ç­‰ä»·çš„å†™æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">unique_lock <span class="title">lockA</span><span class="params">(*accountA-&gt;getLock(), defer_lock)</span></span>;</span><br><span class="line"><span class="function">unique_lock <span class="title">lockB</span><span class="params">(*accountB-&gt;getLock(), defer_lock)</span></span>;</span><br><span class="line"><span class="built_in">lock</span>(*accountA-&gt;<span class="built_in">getLock</span>(), *accountB-&gt;<span class="built_in">getLock</span>());</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„è¿™é‡Œ<code>lock</code>æ–¹æ³•çš„è°ƒç”¨ä½ç½®ã€‚è¿™é‡Œå…ˆå®šä¹‰<code>unique_lock</code>æŒ‡å®šäº†<code>defer_lock</code>ï¼Œå› æ­¤å®é™…æ²¡æœ‰é”å®šäº’æ–¥ä½“ï¼Œè€Œæ˜¯åˆ°ç¬¬ä¸‰è¡Œæ‰è¿›è¡Œé”å®šã€‚</p>
<p>æœ€åï¼Œå€ŸåŠ©<code>scoped_lock</code>ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸‰è¡Œä»£ç åˆæˆä¸€è¡Œï¼Œè¿™ç§å†™æ³•ä¹Ÿæ˜¯ç­‰ä»·çš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">scoped_lock <span class="title">lockAll</span><span class="params">(*accountA-&gt;getLock(), *accountB-&gt;getLock())</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>scoped_lock</code>ä¼šåœ¨å…¶ç”Ÿå‘½å‘¨æœŸèŒƒå›´å†…é”å®šäº’æ–¥ä½“ï¼Œé”€æ¯çš„æ—¶å€™è§£é”ã€‚åŒæ—¶ï¼Œå®ƒå¯ä»¥é”å®šå¤šä¸ªäº’æ–¥ä½“ï¼Œå¹¶ä¸”é¿å…æ­»é”ã€‚</p>
<p>ç›®å‰ï¼Œåªè¿˜æœ‰<code>shared_lock</code>æˆ‘ä»¬æ²¡æœ‰æåˆ°ã€‚å®ƒä¸å…¶ä»–å‡ ä¸ªç±»çš„åŒºåˆ«åœ¨äºï¼šå®ƒæ˜¯ä»¥å…±äº«çš„æ–¹å¼é”å®šäº’æ–¥ä½“ã€‚</p>
<h4 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h4><table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">condition_variable</td>
<td align="left">C++ 11</td>
<td align="left">æä¾›ä¸ std::unique_lock å…³è”çš„æ¡ä»¶å˜é‡</td>
</tr>
<tr>
<td align="left">condition_variable_any</td>
<td align="left">C++ 11</td>
<td align="left">æä¾›ä¸ä»»ä½•é”ç±»å‹å…³è”çš„æ¡ä»¶å˜é‡</td>
</tr>
<tr>
<td align="left">notify_all_at_thread_exit</td>
<td align="left">C++ 11</td>
<td align="left">å®‰æ’åˆ°åœ¨æ­¤çº¿ç¨‹å®Œå…¨ç»“æŸæ—¶å¯¹ notify_all çš„è°ƒç”¨</td>
</tr>
<tr>
<td align="left">cv_status</td>
<td align="left">C++ 11</td>
<td align="left">åˆ—å‡ºæ¡ä»¶å˜é‡ä¸Šå®šæ—¶ç­‰å¾…çš„å¯èƒ½ç»“æœ</td>
</tr>
</tbody></table>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥æ”¹è¿›ã€‚é‚£å°±æ˜¯ï¼šè½¬è´¦é‡‘é¢ä¸è¶³çš„æ—¶å€™ï¼Œç¨‹åºç›´æ¥è¿”å›äº†<code>false</code>ã€‚è¿™å¾ˆéš¾è¯´æ˜¯ä¸€ä¸ªå¥½çš„ç­–ç•¥ã€‚å› ä¸ºï¼Œå³ä¾¿è™½ç„¶å½“å‰è´¦å·é‡‘é¢ä¸è¶³ä»¥è½¬è´¦ï¼Œä½†åªè¦åˆ«çš„è´¦å·åˆè½¬è´¦è¿›æ¥ä¹‹åï¼Œå½“å‰è¿™ä¸ªè½¬è´¦æ“ä½œä¹Ÿè®¸å°±å¯ä»¥ç»§ç»­æ‰§è¡Œäº†ã€‚</p>
<p>è¿™åœ¨å¾ˆå¤šä¸šåŠ¡ä¸­æ˜¯å¾ˆå¸¸è§çš„ä¸€ä¸ªéœ€æ±‚ï¼šæ¯ä¸€æ¬¡æ“ä½œéƒ½è¦æ­£ç¡®æ‰§è¡Œï¼Œå¦‚æœæ¡ä»¶ä¸æ»¡è¶³å°±åœä¸‹æ¥ç­‰å¾…ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³ä¹‹åå†ç»§ç»­ã€‚è€Œä¸æ˜¯ç›´æ¥è¿”å›ã€‚</p>
<p>æ¡ä»¶å˜é‡æä¾›äº†ä¸€ä¸ªå¯ä»¥è®©å¤šä¸ªçº¿ç¨‹é—´åŒæ­¥åä½œçš„åŠŸèƒ½ã€‚è¿™å¯¹äº<a href="https://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem">ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</a>å¾ˆæœ‰æ„ä¹‰ã€‚åœ¨è¿™ä¸ªæ¨¡å‹ä¸‹ï¼š</p>
<ul>
<li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±äº«ä¸€ä¸ªå·¥ä½œåŒºã€‚è¿™ä¸ªåŒºé—´çš„å¤§å°æ˜¯æœ‰é™çš„ã€‚</li>
<li>ç”Ÿäº§è€…æ€»æ˜¯äº§ç”Ÿæ•°æ®æ”¾å…¥å·¥ä½œåŒºä¸­ï¼Œå½“å·¥ä½œåŒºæ»¡äº†ã€‚å®ƒå°±åœä¸‹æ¥ç­‰æ¶ˆè´¹è€…æ¶ˆè´¹ä¸€éƒ¨åˆ†æ•°æ®ï¼Œç„¶åç»§ç»­å·¥ä½œã€‚</li>
<li>æ¶ˆè´¹è€…æ€»æ˜¯ä»å·¥ä½œåŒºä¸­æ‹¿å‡ºæ•°æ®ä½¿ç”¨ã€‚å½“å·¥ä½œåŒºä¸­çš„æ•°æ®å…¨éƒ¨è¢«æ¶ˆè´¹ç©ºäº†ä¹‹åï¼Œå®ƒä¹Ÿä¼šåœä¸‹æ¥ç­‰å¾…ç”Ÿäº§è€…å¾€å·¥ä½œåŒºä¸­æ”¾å…¥æ–°çš„æ•°æ®ã€‚</li>
</ul>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œå½“å®ƒä»¬å·¥ä½œçš„æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œå®ƒä»¬å¹¶ä¸æ˜¯ç›´æ¥æŠ¥é”™è¿”å›ï¼Œè€Œæ˜¯åœä¸‹æ¥ç­‰å¾…ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±å€ŸåŠ©äºæ¡ä»¶å˜é‡ï¼Œå†æ¬¡æ”¹é€ ä¹‹å‰çš„é“¶è¡Œè½¬è´¦ç³»ç»Ÿã€‚</p>
<p>è¿™ä¸ªæ”¹é€ ä¸»è¦åœ¨äºè´¦å·ç±»ã€‚æˆ‘ä»¬é‡ç‚¹æ˜¯è¦è°ƒæ•´<code>changeMoney</code>æ–¹æ³•ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 11_bank_transfer_wait_notify.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Account</span>(string name, <span class="keyword">double</span> money): <span class="built_in">mName</span>(name), <span class="built_in">mMoney</span>(money) &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">changeMoney</span><span class="params">(<span class="keyword">double</span> amount)</span> </span>&#123;</span><br><span class="line">    <span class="function">unique_lock <span class="title">lock</span><span class="params">(mMoneyLock)</span></span>; <span class="comment">// â‘¡</span></span><br><span class="line">    mConditionVar.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>, amount] &#123; <span class="comment">// â‘¢</span></span><br><span class="line">      <span class="keyword">return</span> mMoney + amount &gt; <span class="number">0</span>; <span class="comment">// â‘£</span></span><br><span class="line">    &#125;);</span><br><span class="line">    mMoney += amount;</span><br><span class="line">    mConditionVar.<span class="built_in">notify_all</span>(); <span class="comment">// â‘¤</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">string <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mMoney;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  string mName;</span><br><span class="line">  <span class="keyword">double</span> mMoney;</span><br><span class="line">  mutex mMoneyLock;</span><br><span class="line">  condition_variable mConditionVar; <span class="comment">// â‘ </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™å‡ å¤„æ”¹åŠ¨è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ol>
<li>è¿™é‡Œå£°æ˜äº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œç”¨æ¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´åä½œã€‚</li>
<li>è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>unique_lock</code>ï¼Œè¿™æ˜¯ä¸ºäº†ä¸æ¡ä»¶å˜é‡ç›¸é…åˆã€‚å› ä¸ºæ¡ä»¶å˜é‡ä¼šè§£é”å’Œé‡æ–°é”å®šäº’æ–¥ä½“ã€‚</li>
<li>è¿™é‡Œæ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªåœ°æ–¹ï¼šé€šè¿‡æ¡ä»¶å˜é‡è¿›è¡Œç­‰å¾…ã€‚æ­¤æ—¶ï¼šä¼šé€šè¿‡åé¢çš„lambdaè¡¨è¾¾å¼åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚å¦‚æœæ»¡è¶³åˆ™ç»§ç»­ï¼›å¦‚æœä¸æ»¡è¶³ï¼Œåˆ™<strong>æ­¤å¤„ä¼šè§£é”äº’æ–¥ä½“ï¼Œå¹¶è®©å½“å‰çº¿ç¨‹ç­‰å¾…</strong>ã€‚<strong>è§£é”</strong>è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå› ä¸ºåªæœ‰è¿™æ ·ï¼Œæ‰èƒ½è®©å…¶ä»–çº¿ç¨‹è·å–äº’æ–¥ä½“ã€‚</li>
<li>è¿™é‡Œæ˜¯æ¡ä»¶å˜é‡ç­‰å¾…çš„æ¡ä»¶ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰lambdaè¡¨è¾¾å¼ï¼Œè¯·è‡ªè¡Œç½‘ä¸Šå­¦ä¹ ï¼Œæˆ–è€…é˜…è¯»<a href="https://paul.pub/cpp-lambda-function-bind/">æˆ‘ä¹‹å‰å†™çš„æ–‡ç« </a>ã€‚</li>
<li>æ­¤å¤„ä¹Ÿå¾ˆé‡è¦ã€‚å½“é‡‘é¢å‘ç”Ÿå˜åŠ¨ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦é€šçŸ¥æ‰€æœ‰åœ¨æ¡ä»¶å˜é‡ä¸Šç­‰å¾…çš„å…¶ä»–çº¿ç¨‹ã€‚æ­¤æ—¶æ‰€æœ‰è°ƒç”¨<code>wait</code>çº¿ç¨‹éƒ½ä¼šå†æ¬¡å”¤é†’ï¼Œç„¶åå°è¯•è·å–é”ï¼ˆå½“ç„¶ï¼Œåªæœ‰ä¸€ä¸ªèƒ½è·å–åˆ°ï¼‰å¹¶å†æ¬¡åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚é™¤äº†<code>notify_all</code>è¿˜æœ‰<code>notify_one</code>ï¼Œå®ƒåªé€šçŸ¥ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚<code>wait</code>å’Œ<code>notify</code>å°±æ„æˆäº†çº¿ç¨‹é—´äº’ç›¸åä½œçš„å·¥å…·ã€‚</li>
</ol>
<p>è¯·æ³¨æ„ï¼š<code>wait</code>å’Œ<code>notify_all</code>è™½ç„¶æ˜¯å†™åœ¨ä¸€ä¸ªå‡½æ•°ä¸­çš„ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶å®ƒä»¬æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ‰§è¡Œçš„ï¼Œå› æ­¤å¯¹äºè¿™æ®µä»£ç ï¼Œéœ€è¦èƒ½å¤Ÿä»ä¸åŒçº¿ç¨‹çš„è§’åº¦å»æ€è€ƒä»£ç çš„é€»è¾‘ã€‚è¿™ä¹Ÿæ˜¯å¼€å‘å¹¶å‘ç³»ç»Ÿæ¯”è¾ƒéš¾çš„åœ°æ–¹ã€‚</p>
<p>æœ‰äº†ä¸Šé¢çš„æ”¹åŠ¨ä¹‹åï¼Œé“¶è¡Œçš„è½¬è´¦æ–¹æ³•å®ç°èµ·æ¥å°±å¾ˆç®€å•äº†ï¼Œä¸ç”¨å†è€ƒè™‘æ•°æ®ä¿æŠ¤çš„é—®é¢˜äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 11_bank_transfer_wait_notify.cpp</span><br><span class="line"></span><br><span class="line">void Bank::transferMoney(Account* accountA, Account* accountB, double amount) &#123;</span><br><span class="line">    accountA-&gt;changeMoney(-amount);</span><br><span class="line">    accountB-&gt;changeMoney(amount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œè½¬è´¦é€»è¾‘ä¹Ÿä¼šå˜å¾—ç®€å•ï¼Œä¸ç”¨å†ç®¡è½¬è´¦å¤±è´¥çš„æƒ…å†µå‘ç”Ÿã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 11_bank_transfer_wait_notify.cpp</span></span><br><span class="line"></span><br><span class="line">mutex sCoutLock;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">randomTransfer</span><span class="params">(Bank* bank, Account* accountA, Account* accountB)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">double</span> randomMoney = ((<span class="keyword">double</span>)<span class="built_in">rand</span>() / RAND_MAX) * <span class="number">100</span>;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">lock_guard <span class="title">guard</span><span class="params">(sCoutLock)</span></span>;</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;Try to Transfer &quot;</span> &lt;&lt; randomMoney</span><br><span class="line">           &lt;&lt; <span class="string">&quot; from &quot;</span> &lt;&lt; accountA-&gt;<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; accountA-&gt;<span class="built_in">getMoney</span>()</span><br><span class="line">           &lt;&lt; <span class="string">&quot;) to &quot;</span> &lt;&lt; accountB-&gt;<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; accountB-&gt;<span class="built_in">getMoney</span>()</span><br><span class="line">           &lt;&lt; <span class="string">&quot;), Bank totalMoney: &quot;</span> &lt;&lt; bank-&gt;<span class="built_in">totalMoney</span>() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    bank-&gt;<span class="built_in">transferMoney</span>(accountA, accountB, randomMoney);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹å®Œä¹‹åçš„ç¨‹åºè¿è¡Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Try to Transfer 13.72 from Moira(10.9287) to Paul(189.071), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 28.6579 from Paul(189.071) to Moira(10.9287), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 91.8049 from Paul(160.413) to Moira(39.5866), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 5.56383 from Paul(82.3285) to Moira(117.672), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 11.3594 from Paul(76.7646) to Moira(123.235), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 16.9557 from Paul(65.4053) to Moira(134.595), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 74.998 from Paul(48.4495) to Moira(151.55), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 65.3005 from Moira(151.55) to Paul(48.4495), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 90.6084 from Moira(86.25) to Paul(113.75), Bank totalMoney: 125.002</span><br><span class="line">Try to Transfer 99.6425 from Moira(70.6395) to Paul(129.36), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 55.2091 from Paul(129.36) to Moira(70.6395), Bank totalMoney: 200</span><br><span class="line">Try to Transfer 92.259 from Paul(74.1513) to Moira(125.849), Bank totalMoney: 200</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸‹æ¯”ä¹‹å‰éƒ½è¦å¥½äº†ã€‚</p>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><table>
<thead>
<tr>
<th align="left">API</th>
<th align="left">C++æ ‡å‡†</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">async</td>
<td align="left">C++11</td>
<td align="left">å¼‚æ­¥è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›ä¿æœ‰å…¶ç»“æœçš„<code>std::future</code></td>
</tr>
<tr>
<td align="left">future</td>
<td align="left">C++11</td>
<td align="left">ç­‰å¾…è¢«å¼‚æ­¥è®¾ç½®çš„å€¼</td>
</tr>
<tr>
<td align="left">packaged_task</td>
<td align="left">C++11</td>
<td align="left">æ‰“åŒ…ä¸€ä¸ªå‡½æ•°ï¼Œå­˜å‚¨å…¶è¿”å›å€¼ä»¥è¿›è¡Œå¼‚æ­¥è·å–</td>
</tr>
<tr>
<td align="left">promise</td>
<td align="left">C++11</td>
<td align="left">å­˜å‚¨ä¸€ä¸ªå€¼ä»¥è¿›è¡Œå¼‚æ­¥è·å–</td>
</tr>
<tr>
<td align="left">shared_future</td>
<td align="left">C++11</td>
<td align="left">ç­‰å¾…è¢«å¼‚æ­¥è®¾ç½®çš„å€¼ï¼ˆå¯èƒ½ä¸ºå…¶ä»– future æ‰€å¼•ç”¨ï¼‰</td>
</tr>
</tbody></table>
<p>è¿™ä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ¥ç†Ÿæ‚‰æ›´å¤šçš„å¯ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸­ä½¿ç”¨çš„å·¥å…·ï¼Œå®ƒä»¬éƒ½ä½äº<code>&lt;future&gt;</code>å¤´æ–‡ä»¶ä¸­ã€‚</p>
<h4 id="async"><a href="#async" class="headerlink" title="async"></a>async</h4><p>å¾ˆå¤šè¯­è¨€éƒ½æä¾›äº†å¼‚æ­¥çš„æœºåˆ¶ã€‚å¼‚æ­¥ä½¿å¾—è€—æ—¶çš„æ“ä½œä¸å½±å“å½“å‰ä¸»çº¿ç¨‹çš„æ‰§è¡Œæµã€‚</p>
<p>åœ¨C++11ä¸­ï¼Œ<code>async</code>ä¾¿æ˜¯å®Œæˆè¿™æ ·çš„åŠŸèƒ½çš„ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 12_async_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAX = <span class="number">10e8</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = min; i &lt;= max; i++) &#123;</span><br><span class="line">    sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span> f1 = <span class="built_in">async</span>(worker, <span class="number">0</span>, MAX);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Async task triggered&quot;</span> &lt;&lt; endl;</span><br><span class="line">  f1.<span class="built_in">wait</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Async task finish, result: &quot;</span> &lt;&lt; sum &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä»ç„¶æ˜¯æˆ‘ä»¬ä¹‹å‰ç†Ÿæ‚‰çš„ä¾‹å­ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦è¯´æ˜ï¼š</p>
<ol>
<li>è¿™é‡Œä»¥å¼‚æ­¥çš„æ–¹å¼å¯åŠ¨äº†ä»»åŠ¡ã€‚å®ƒä¼šè¿”å›ä¸€ä¸ª<code>future</code>å¯¹è±¡ã€‚<code>future</code>ç”¨æ¥å­˜å‚¨å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œå…³äº<code>future</code>æˆ‘ä»¬åœ¨åé¢<code>packaged_task</code>çš„ä¾‹å­ä¸­å†è¯¦ç»†è¯´æ˜ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬ä»…ä»…ç”¨å®ƒæ¥ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</li>
<li>æ­¤å¤„æ˜¯ç­‰å¾…å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</li>
</ol>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>async</code>æ˜¯å¯åŠ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œè¿˜æ˜¯ä»¥åŒæ­¥çš„æ–¹å¼ï¼ˆä¸å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼‰è¿è¡Œä»»åŠ¡ï¼Œè¿™ä¸€ç‚¹æ ‡å‡†æ˜¯æ²¡æœ‰æŒ‡å®šçš„ï¼Œç”±å…·ä½“çš„ç¼–è¯‘å™¨å†³å®šã€‚å¦‚æœå¸Œæœ›ä¸€å®šè¦ä»¥æ–°çš„çº¿ç¨‹æ¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œå¯ä»¥é€šè¿‡<code>launch::async</code>æ¥æ˜ç¡®è¯´æ˜ã€‚<code>launch</code>ä¸­æœ‰ä¸¤ä¸ªå¸¸é‡ï¼š</p>
<ul>
<li><code>async</code>ï¼šè¿è¡Œæ–°çº¿ç¨‹ï¼Œä»¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li><code>deferred</code>ï¼šè°ƒç”¨æ–¹çº¿ç¨‹ä¸Šç¬¬ä¸€æ¬¡è¯·æ±‚å…¶ç»“æœæ—¶æ‰æ‰§è¡Œä»»åŠ¡ï¼Œå³æƒ°æ€§æ±‚å€¼ã€‚</li>
</ul>
<p>é™¤äº†é€šè¿‡å‡½æ•°æ¥æŒ‡å®šå¼‚æ­¥ä»»åŠ¡ï¼Œè¿˜å¯ä»¥lambdaè¡¨è¾¾å¼çš„æ–¹å¼æ¥æŒ‡å®šã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 12_async_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> result = <span class="number">0</span>;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Async task with lambda triggered, thread: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">auto</span> f2 = <span class="built_in">async</span>(launch::async, [&amp;result]() &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Lambda task in thread: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= MAX; i++) &#123;</span><br><span class="line">      result += <span class="built_in">sqrt</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  f2.<span class="built_in">wait</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Async task with lambda finish, result: &quot;</span> &lt;&lt; result &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªlambdaè¡¨è¾¾å¼æ¥ç¼–å†™å¼‚æ­¥ä»»åŠ¡çš„é€»è¾‘ï¼Œå¹¶é€šè¿‡<code>launch::async</code>æ˜ç¡®æŒ‡å®šè¦é€šè¿‡ç‹¬ç«‹çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼ŒåŒæ—¶æˆ‘ä»¬æ‰“å°å‡ºäº†çº¿ç¨‹çš„idã€‚</p>
<p>è¿™æ®µä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Async task with lambda triggered, thread: 0x11290d5c0</span><br><span class="line">Lambda task in thread: 0x700007aa1000</span><br><span class="line">Async task with lambda finish, result: 2.10819e+13</span><br></pre></td></tr></table></figure>

<p>å¯¹äºé¢å‘å¯¹è±¡ç¼–ç¨‹æ¥è¯´ï¼Œå¾ˆå¤šæ—¶å€™è‚¯å®šå¸Œæœ›ä»¥å¯¹è±¡çš„æ–¹æ³•æ¥æŒ‡å®šå¼‚æ­¥ä»»åŠ¡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 12_async_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Worker</span>(<span class="keyword">int</span> min, <span class="keyword">int</span> max): <span class="built_in">mMin</span>(min), <span class="built_in">mMax</span>(max) &#123;&#125; <span class="comment">// â‘ </span></span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">work</span><span class="params">()</span> </span>&#123; <span class="comment">// â‘¡</span></span><br><span class="line">    mResult = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mMin; i &lt;= mMax; i++) &#123;</span><br><span class="line">      mResult += <span class="built_in">sqrt</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mResult;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> mMin;</span><br><span class="line">  <span class="keyword">int</span> mMax;</span><br><span class="line">  <span class="keyword">double</span> mResult;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">Worker <span class="title">w</span><span class="params">(<span class="number">0</span>, MAX)</span></span>;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Task in class triggered&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">auto</span> f3 = <span class="built_in">async</span>(&amp;Worker::work, &amp;w); <span class="comment">// â‘¢</span></span><br><span class="line">  f3.<span class="built_in">wait</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Task in class finish, result: &quot;</span> &lt;&lt; w.<span class="built_in">getResult</span>() &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç æœ‰ä¸‰å¤„éœ€è¦è¯´æ˜ï¼š</p>
<ol>
<li>è¿™é‡Œé€šè¿‡ä¸€ä¸ªç±»æ¥æè¿°ä»»åŠ¡ã€‚è¿™ä¸ªç±»æ˜¯å¯¹å‰é¢æåˆ°çš„ä»»åŠ¡çš„å°è£…ã€‚å®ƒåŒ…å«äº†ä»»åŠ¡çš„è¾“å…¥å‚æ•°ï¼Œå’Œè¾“å‡ºç»“æœã€‚</li>
<li><code>work</code>å‡½æ•°æ˜¯ä»»åŠ¡çš„ä¸»ä½“é€»è¾‘ã€‚</li>
<li>é€šè¿‡<code>async</code>æ‰§è¡Œä»»åŠ¡ï¼šè¿™é‡ŒæŒ‡å®šäº†å…·ä½“çš„ä»»åŠ¡å‡½æ•°ä»¥åŠç›¸åº”çš„å¯¹è±¡ã€‚è¯·æ³¨æ„è¿™é‡Œæ˜¯<code>&amp;w</code>ï¼Œå› æ­¤ä¼ é€’çš„æ˜¯å¯¹è±¡çš„æŒ‡é’ˆã€‚å¦‚æœä¸å†™<code>&amp;</code>å°†ä¼ å…¥<code>w</code>å¯¹è±¡çš„ä¸´æ—¶å¤åˆ¶ã€‚</li>
</ol>
<h4 id="packaged-task"><a href="#packaged-task" class="headerlink" title="packaged_task"></a>packaged_task</h4><p>åœ¨ä¸€äº›ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰å¾ˆå¤šçš„ä»»åŠ¡éœ€è¦è°ƒåº¦ã€‚è¿™æ—¶æˆ‘ä»¬å¸¸å¸¸ä¼šè®¾è®¡å‡ºä»»åŠ¡é˜Ÿåˆ—å’Œçº¿ç¨‹æ± çš„ç»“æ„ã€‚æ­¤æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>packaged_task</code>æ¥åŒ…è£…ä»»åŠ¡ã€‚</p>
<p><code>packaged_task</code>ç»‘å®šåˆ°ä¸€ä¸ªå‡½æ•°æˆ–è€…å¯è°ƒç”¨å¯¹è±¡ä¸Šã€‚å½“å®ƒè¢«è°ƒç”¨æ—¶ï¼Œå®ƒå°±ä¼šè°ƒç”¨å…¶ç»‘å®šçš„å‡½æ•°æˆ–è€…å¯è°ƒç”¨å¯¹è±¡ã€‚å¹¶ä¸”ï¼Œå¯ä»¥é€šè¿‡ä¸ä¹‹ç›¸å…³è”çš„<code>future</code>æ¥è·å–ä»»åŠ¡çš„ç»“æœã€‚è°ƒåº¦ç¨‹åºåªéœ€è¦å¤„ç†<code>packaged_task</code>ï¼Œè€Œéå„ä¸ªå‡½æ•°ã€‚</p>
<p><code>packaged_task</code>å¯¹è±¡æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå®ƒå¯ä»¥è¢«å°è£…æˆä¸€ä¸ª<code>std::fucntion</code>ï¼Œæˆ–è€…ä½œä¸ºçº¿ç¨‹å‡½æ•°ä¼ é€’ç»™<code>std::thread</code>ï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 13_packaged_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">concurrent_worker</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = min; i &lt;= max; i++) &#123;</span><br><span class="line">    sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">concurrent_task</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  vector&lt;future&lt;<span class="keyword">double</span>&gt;&gt; results; <span class="comment">// â‘ </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> concurrent_count = thread::<span class="built_in">hardware_concurrency</span>();</span><br><span class="line">  min = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; concurrent_count; i++) &#123; <span class="comment">// â‘¡</span></span><br><span class="line">    <span class="function">packaged_task&lt;<span class="title">double</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span>&gt; <span class="title">task</span><span class="params">(concurrent_worker)</span></span>; <span class="comment">// â‘¢</span></span><br><span class="line">    results.<span class="built_in">push_back</span>(task.<span class="built_in">get_future</span>()); <span class="comment">// â‘£</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> range = max / concurrent_count * (i + <span class="number">1</span>);</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(std::move(task), min, range)</span></span>; <span class="comment">// â‘¤</span></span><br><span class="line">    t.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    min = range + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;threads create finish&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; r : results) &#123;</span><br><span class="line">    sum += r.<span class="built_in">get</span>(); <span class="comment">// â‘¥</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> start_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> r = <span class="built_in">concurrent_task</span>(<span class="number">0</span>, MAX);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> end_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">auto</span> ms = chrono::duration_cast&lt;chrono::milliseconds&gt;(end_time - start_time).<span class="built_in">count</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Concurrent task finish, &quot;</span> &lt;&lt; ms &lt;&lt; <span class="string">&quot; ms consumed, Result: &quot;</span> &lt;&lt; r &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼š</p>
<ol>
<li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé›†åˆæ¥å­˜å‚¨<code>future</code>å¯¹è±¡ã€‚æˆ‘ä»¬å°†ç”¨å®ƒæ¥è·å–ä»»åŠ¡çš„ç»“æœã€‚</li>
<li>åŒæ ·çš„ï¼Œæ ¹æ®CPUçš„æƒ…å†µæ¥åˆ›å»ºçº¿ç¨‹çš„æ•°é‡ã€‚</li>
<li>å°†ä»»åŠ¡åŒ…è£…æˆ<code>packaged_task</code>ã€‚è¯·æ³¨æ„ï¼Œç”±äº<code>concurrent_worker</code>è¢«åŒ…è£…æˆäº†ä»»åŠ¡ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è·å–å®ƒçš„<code>return</code>å€¼ã€‚è€Œæ˜¯è¦é€šè¿‡<code>future</code>å¯¹è±¡æ¥è·å–ã€‚</li>
<li>è·å–ä»»åŠ¡å…³è”çš„<code>future</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶å­˜å…¥é›†åˆä¸­ã€‚</li>
<li>é€šè¿‡ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ä¼ å…¥éœ€è¦çš„å‚æ•°ã€‚</li>
<li>é€šè¿‡<code>future</code>é›†åˆï¼Œé€ä¸ªè·å–æ¯ä¸ªä»»åŠ¡çš„è®¡ç®—ç»“æœï¼Œå°†å…¶ç´¯åŠ ã€‚è¿™é‡Œ<code>r.get()</code>è·å–åˆ°çš„å°±æ˜¯æ¯ä¸ªä»»åŠ¡ä¸­<code>concurrent_worker</code>çš„è¿”å›å€¼ã€‚</li>
</ol>
<p>ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œçš„ç¤ºä¾‹åªä½¿ç”¨äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ä¾‹å­å’Œç»“æ„ã€‚ä½†åœ¨å®é™…ä¸Šçš„å·¥ç¨‹ä¸­ï¼Œè°ƒç”¨å…³ç³»é€šå¸¸æ›´å¤æ‚ï¼Œä½ å¯ä»¥å€ŸåŠ©äº<code>packaged_task</code>å°†ä»»åŠ¡ç»„è£…æˆé˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡<a href="https://en.wikipedia.org/wiki/Thread_pool">çº¿ç¨‹æ± </a>çš„æ–¹å¼è¿›è¡Œè°ƒåº¦ï¼š</p>
<p><img src="https://paul-pub.oss-cn-beijing.aliyuncs.com/2019/2019-11-26-cpp-concurrency/Thread_pool.svg" alt="img"></p>
<h4 id="promiseä¸future"><a href="#promiseä¸future" class="headerlink" title="promiseä¸future"></a>promiseä¸future</h4><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>concurrent_task</code>çš„ç»“æœæ˜¯é€šè¿‡<code>return</code>è¿”å›çš„ã€‚ä½†åœ¨ä¸€äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¸èƒ½è¿™ä¹ˆåšï¼šåœ¨å¾—åˆ°ä»»åŠ¡ç»“æœä¹‹åï¼Œå¯èƒ½è¿˜æœ‰ä¸€äº›äº‹æƒ…éœ€è¦ç»§ç»­å¤„ç†ï¼Œä¾‹å¦‚æ¸…ç†å·¥ä½œã€‚</p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œå°±å¯ä»¥å°†<code>promise</code>ä¸<code>future</code>é…å¯¹ä½¿ç”¨ã€‚è¿™æ ·å°±å¯ä»¥å°†è¿”å›ç»“æœå’Œä»»åŠ¡ç»“æŸä¸¤ä¸ªäº‹æƒ…åˆ†å¼€ã€‚</p>
<p>ä¸‹é¢æ˜¯å¯¹ä¸Šé¢ä»£ç ç¤ºä¾‹çš„æ”¹å†™ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 14_promise_future.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">concurrent_worker</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = min; i &lt;= max; i++) &#123;</span><br><span class="line">    sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">concurrent_task</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max, promise&lt;<span class="keyword">double</span>&gt;* result)</span> </span>&#123; <span class="comment">// â‘ </span></span><br><span class="line">  vector&lt;future&lt;<span class="keyword">double</span>&gt;&gt; results;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> concurrent_count = thread::<span class="built_in">hardware_concurrency</span>();</span><br><span class="line">  min = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; concurrent_count; i++) &#123;</span><br><span class="line">    <span class="function">packaged_task&lt;<span class="title">double</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span>&gt; <span class="title">task</span><span class="params">(concurrent_worker)</span></span>;</span><br><span class="line">    results.<span class="built_in">push_back</span>(task.<span class="built_in">get_future</span>()); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> range = max / concurrent_count * (i + <span class="number">1</span>);</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(std::move(task), min, range)</span></span>;</span><br><span class="line">    t.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    min = range + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;threads create finish&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; r : results) &#123;</span><br><span class="line">    sum += r.<span class="built_in">get</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  result-&gt;<span class="built_in">set_value</span>(sum); <span class="comment">// â‘¡</span></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;concurrent_task finish&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> start_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">  promise&lt;<span class="keyword">double</span>&gt; sum; <span class="comment">// â‘¢</span></span><br><span class="line">  <span class="built_in">concurrent_task</span>(<span class="number">0</span>, MAX, &amp;sum);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> end_time = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">auto</span> ms = chrono::duration_cast&lt;chrono::milliseconds&gt;(end_time - start_time).<span class="built_in">count</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Concurrent task finish, &quot;</span> &lt;&lt; ms &lt;&lt; <span class="string">&quot; ms consumed.&quot;</span> &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;Result: &quot;</span> &lt;&lt; sum.<span class="built_in">get_future</span>().<span class="built_in">get</span>() &lt;&lt; endl; <span class="comment">// â‘£</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç å’Œä¸Šé¢çš„ç¤ºä¾‹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸€æ ·çš„ã€‚åªæœ‰å°éƒ¨åˆ†å†…å®¹åšäº†æ”¹åŠ¨ï¼š</p>
<ol>
<li><code>concurrent_task</code>ä¸å†ç›´æ¥è¿”å›è®¡ç®—ç»“æœï¼Œè€Œæ˜¯å¢åŠ äº†ä¸€ä¸ª<code>promise</code>å¯¹è±¡æ¥å­˜æ”¾ç»“æœã€‚</li>
<li>åœ¨ä»»åŠ¡è®¡ç®—å®Œæˆä¹‹åï¼Œå°†æ€»ç»“è¿‡è®¾ç½®åˆ°<code>promise</code>å¯¹è±¡ä¸Šã€‚ä¸€æ—¦è¿™é‡Œè°ƒç”¨äº†<code>set_value</code>ï¼Œå…¶ç›¸å…³è”çš„<code>future</code>å¯¹è±¡å°±ä¼šå°±ç»ªã€‚</li>
<li>è¿™é‡Œæ˜¯åœ¨<code>main</code>ä¸­åˆ›å»ºä¸€ä¸ª<code>promoise</code>æ¥å­˜æ”¾ç»“æœï¼Œå¹¶ä»¥æŒ‡é’ˆçš„å½¢å¼ä¼ é€’è¿›<code>concurrent_task</code>ä¸­ã€‚</li>
<li>é€šè¿‡<code>sum.get_future().get()</code>æ¥è·å–ç»“æœã€‚ç¬¬2ç‚¹ä¸­å·²ç»è¯´äº†ï¼šä¸€æ—¦è°ƒç”¨äº†<code>set_value</code>ï¼Œå…¶ç›¸å…³è”çš„<code>future</code>å¯¹è±¡å°±ä¼šå°±ç»ªã€‚</li>
</ol>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>future</code>å¯¹è±¡åªæœ‰è¢«ä¸€ä¸ªçº¿ç¨‹è·å–å€¼ã€‚å¹¶ä¸”åœ¨è°ƒç”¨<code>get()</code>ä¹‹åï¼Œå°±æ²¡æœ‰å¯ä»¥è·å–çš„å€¼äº†ã€‚å¦‚æœä»å¤šä¸ªçº¿ç¨‹è°ƒç”¨<code>get()</code>ä¼šå‡ºç°æ•°æ®ç«äº‰ï¼Œå…¶ç»“æœæ˜¯æœªå®šä¹‰çš„ã€‚</p>
<p>å¦‚æœçœŸçš„éœ€è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸­è·å–<code>future</code>çš„ç»“æœï¼Œå¯ä»¥ä½¿ç”¨<code>shared_future</code>ã€‚</p>
<h3 id="task-basedå¹¶å‘ï¼šasync-packaged-task-promise"><a href="#task-basedå¹¶å‘ï¼šasync-packaged-task-promise" class="headerlink" title="task basedå¹¶å‘ï¼šasync, packaged_task, promise"></a>task basedå¹¶å‘ï¼šasync, packaged_task, promise</h3><h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h4><ul>
<li><strong>async</strong>ï¼šæä¾›æœ€é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚å¦‚æœä½ ä¸éœ€è¦æ§åˆ¶çº¿ç¨‹çš„è¿è¡Œæ—¶æœºï¼Œå°±é€‰è¿™ä¸ªã€‚</li>
<li><strong>packaged_task</strong>ï¼šæŠ½è±¡å±‚æ¬¡æ¯”<code>async</code>ä½ã€‚å¦‚æœä½ éœ€è¦æ§åˆ¶çº¿ç¨‹çš„è¿è¡Œæ—¶æœºï¼Œä¸”çº¿ç¨‹æ‰§è¡Œçš„ç»“æœå³ç›®æ ‡ç»“æœæ—¶ï¼Œé€‰è¿™ä¸ªã€‚</li>
<li><strong>promise</strong>ï¼šæŠ½è±¡å±‚æ¬¡æœ€ä½ã€‚å½“ä½ æƒ³åœ¨çº¿ç¨‹ä¸­è®¾ç½®ç›®æ ‡ç»“æœçš„å€¼ï¼Œé€‰è¿™ä¸ªã€‚</li>
</ul>
<h4 id="æ¯”è¾ƒ"><a href="#æ¯”è¾ƒ" class="headerlink" title="æ¯”è¾ƒ"></a>æ¯”è¾ƒ</h4><p><code>async</code>ã€<code>packaged_task</code>å’Œ<code>promise</code>ä¸‰è€…æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼šå®ƒä»¬éƒ½å¯ä»¥è¿”å›ä¸€ä¸ª<code>future</code>å¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¿™ä¸ª<code>future</code>çš„<code>get</code>æ–¹æ³•è·å–æœ€ç»ˆçš„ç»“æœã€‚</p>
<p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œåˆ†åˆ«ç”¨è¿™ä¸‰è€…å®ç°åŒæ ·çš„åŠŸèƒ½ï¼šå»¶æ—¶2ç§’åè¿”å›0ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">()</span>&gt; <span class="title">task</span><span class="params">([]()&#123; </span></span></span><br><span class="line"><span class="params"><span class="function">            std::chrono::milliseconds dura( <span class="number">2000</span>  );</span></span></span><br><span class="line"><span class="params"><span class="function">            std::this_thread::sleep_for( dura  );</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">return</span> <span class="number">0</span>; </span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;)</span></span>;</span><br><span class="line">    std::future&lt;<span class="keyword">int</span>&gt; f1 = task.<span class="built_in">get_future</span>();</span><br><span class="line">    std::<span class="built_in">thread</span>(std::<span class="built_in">move</span>(task)).<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    std::future&lt;<span class="keyword">int</span>&gt; f2 = std::<span class="built_in">async</span>(std::launch::async, []()&#123; </span><br><span class="line">            std::chrono::milliseconds <span class="built_in">dura</span>( <span class="number">2000</span>  );</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>( dura  );</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    std::promise&lt;<span class="keyword">int</span>&gt; p;</span><br><span class="line">    std::future&lt;<span class="keyword">int</span>&gt; f3 = p.<span class="built_in">get_future</span>();</span><br><span class="line">    std::<span class="built_in">thread</span>([](std::promise&lt;<span class="keyword">int</span>&gt; p)&#123; </span><br><span class="line">            std::chrono::milliseconds <span class="built_in">dura</span>( <span class="number">2000</span>  );</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>( dura  );</span><br><span class="line">            p.<span class="built_in">set_value</span>(<span class="number">0</span>); </span><br><span class="line">            &#125;,</span><br><span class="line">            std::<span class="built_in">move</span>(p)).<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Waiting...&quot;</span> &lt;&lt; std::flush;</span><br><span class="line">    f1.<span class="built_in">wait</span>();</span><br><span class="line">    f2.<span class="built_in">wait</span>();</span><br><span class="line">    f3.<span class="built_in">wait</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Done!\nResults are: &quot;</span></span><br><span class="line">        &lt;&lt; f1.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; f2.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; f3.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢è¿™æ®µä»£ç å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸‰è€…åˆ†åˆ«å·¥ä½œåœ¨ä¸åŒçš„æŠ½è±¡å±‚æ¬¡ä¸Šã€‚</p>
<ol>
<li><code>async</code>å±‚æ¬¡æœ€é«˜ï¼Œä½ åªéœ€è¦ç»™å®ƒæä¾›ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°±ä¼šè¿”å›ä¸€ä¸ª<code>future</code>å¯¹è±¡ã€‚æ¥ä¸‹æ¥å°±åªéœ€ç­‰å¾…ç»“æœäº†ã€‚</li>
<li><code>packaged_task</code>æ¬¡ä¹‹ï¼Œä½ åœ¨åˆ›å»ºäº†<code>packaged_task</code>åï¼Œè¿˜è¦åˆ›å»ºä¸€ä¸ª<code>thread</code>ï¼Œå¹¶æŠŠ<code>packaged_task</code>äº¤ç»™å®ƒæ‰§è¡Œã€‚</li>
<li><code>promise</code>å°±æœ€ä½äº†ã€‚åœ¨åˆ›å»ºäº†<code>thread</code>ä¹‹åï¼Œä½ è¿˜è¦æŠŠå¯¹åº”çš„<code>promise</code>ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚è¿™è¿˜æ²¡å®Œï¼Œåˆ«å¿˜äº†åœ¨å‡½æ•°ä¸­<strong>æ‰‹åŠ¨</strong>è®¾ç½®<code>promise</code>çš„å€¼ã€‚</li>
</ol>
<p>é‚£ä¹ˆæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç»“è®ºå°±å¾ˆæ¸…æ™°äº†ï¼š<code>async</code>æŠ½è±¡å±‚æ¬¡æœ€é«˜ï¼Œæ‰€ä»¥é™¤éä½ éœ€è¦å¯¹å¹¶å‘è¿‡ç¨‹è¿›è¡Œç»†ç²’åº¦çš„æ§åˆ¶ï¼ˆæ¯”å¦‚åœ¨ä¸€äº›åœºåˆä¸‹ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨<code>async</code>æ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆå±äºæ˜¯â€œä¸€äº›åœºåˆâ€å‘¢ï¼Ÿ</p>
<h4 id="async-VS-packaged-task-and-promise"><a href="#async-VS-packaged-task-and-promise" class="headerlink" title="async VS. packaged_task and promise"></a>async VS. packaged_task and promise</h4><p>å‰é¢å·²ç»çœ‹åˆ°ï¼Œ<code>async</code>ä¼šæ¥æ”¶ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª<code>future</code>ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‡½æ•°ä¼šè¢«å°±åœ°æ‰§è¡Œã€‚è¿™ä¹Ÿè®¸ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚é€šè¿‡ä¼ é€’<code>std::launch::defer</code>ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºç›´åˆ°è°ƒç”¨<code>future.get</code>æ‰å¼€å§‹æ‰§è¡Œ<code>async</code>ä¸­çš„å‡½æ•°ã€‚</p>
<p>å³ä½¿è¿™æ ·ï¼Œå¦‚æœä½ æƒ³æŠŠæ‰§è¡Œå‡½æ•°çš„æ—¶æœºå’Œè·å–futureå¯¹è±¡çš„æ—¶æœºåˆ†ç¦»ï¼Œæœ€å¥½è¿˜æ˜¯æ”¾å¼ƒç”¨<code>async</code>ï¼Œè€Œæ˜¯ä½¿ç”¨æ›´ä¸ºåº•å±‚çš„<code>packaged_task</code>å’Œ<code>promise</code>ã€‚</p>
<p>BTWï¼Œ<code>async</code>æœ‰ä¸€ä¸ªå¤æ€ªçš„ç‰¹æ€§ï¼Œå¦‚æœä½ æŠŠ<code>async</code>è¿”å›çš„<code>future</code>èµ‹å€¼ç»™ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼ˆæˆ–è€…æ²¡ç®¡å®ƒçš„è¿”å›å€¼ï¼‰ï¼Œå½“è¯¥å˜é‡ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œç¨‹åºä¼šä¸€ç›´é˜»å¡ç›´åˆ°<code>async</code>ä¸­çš„å‡½æ•°æ‰§è¡Œå®Œæ¯•ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    std::future&lt;<span class="keyword">int</span>&gt; tmp = std::<span class="built_in">async</span>(std::launch::async, []()&#123; </span><br><span class="line">            std::chrono::milliseconds <span class="built_in">dura</span>(VERY_LONG_TIME);</span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(dura);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// block here for VERY_LONG_TIME</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ„æ–™ä¹‹å¤–çš„è¡Œä¸ºä¼šåœ¨C++14ä¸­è¢«å–æ¶ˆæ‰ã€‚æ‰€ä»¥ä½ ç”¨çš„ç¼–è¯‘å™¨å¯èƒ½ä¸ä¼šé‡åˆ°è¿™é—®é¢˜ã€‚</p>
<h4 id="packaged-task-VS-promise"><a href="#packaged-task-VS-promise" class="headerlink" title="packaged_task VS. promise"></a>packaged_task VS. promise</h4><p>å‰©ä¸‹çš„ä¸¤ä¸ªä¹‹ä¸­æ€ä¹ˆé€‰å‘¢ï¼Ÿ</p>
<p><code>promise</code>çš„å±‚æ¬¡æ¯”<code>packaged_task</code>ä½ï¼Œæ‰€ä»¥<code>promise</code>æä¾›ç»™ç”¨æˆ·çš„æ§åˆ¶ç²’åº¦ä¹Ÿæ¯”<code>packaged_task</code>è¦ç»†ã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³è¦æ›´å½»åº•çš„æ§åˆ¶ï¼Œå°±é€‰æ‹©<code>promise</code>å§ã€‚</p>
<p><code>promise</code>å‡ ä¹å°±æ˜¯<code>future</code>çš„å¦ä¸€åŠã€‚å¯¹<code>promise</code>è°ƒç”¨<code>set_value</code>ï¼Œå°±å¦‚åŒå¯¹<code>future</code>è°ƒç”¨<code>set_value</code>ã€‚æ¯”èµ·<code>packaged_task</code>ï¼Œ<code>promise</code>å¹¶ä¸åœ¨æ„å‡½æ•°çš„è¿”å›å€¼â€”â€”æ¯•ç«Ÿå®ƒçš„å€¼éœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>set_value</code>è¿›è¡Œè®¾ç½®ã€‚</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>C++11</tag>
        <tag>C++14</tag>
        <tag>C++17</tag>
        <tag>C++å¹¶å‘</tag>
        <tag>å­¦ä¹ å¿ƒå¾—</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxä½å»¶è¿ŸæœåŠ¡å™¨è°ƒä¼˜</title>
    <url>/2022/01/27/Linux%E4%BD%8E%E5%BB%B6%E8%BF%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%B0%83%E4%BC%98/</url>
    <content><![CDATA[<h1 id="Linuxä½å»¶è¿ŸæœåŠ¡å™¨è°ƒä¼˜"><a href="#Linuxä½å»¶è¿ŸæœåŠ¡å™¨è°ƒä¼˜" class="headerlink" title="Linuxä½å»¶è¿ŸæœåŠ¡å™¨è°ƒä¼˜"></a>Linuxä½å»¶è¿ŸæœåŠ¡å™¨è°ƒä¼˜</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>æœ¬æ–‡åŸºäºé¥¶èŒå¤§ä½¬çš„ã€ŠLinuxä½å»¶è¿ŸæœåŠ¡å™¨ç³»ç»Ÿè°ƒä¼˜ã€‹ä¸€æ–‡æ€»ç»“æ•´ç†ï¼Œè‡ªè¡Œè¡¥å……äº†ä¸€äº›ç»†èŠ‚ã€‚å¤§ä½¬åšæ–‡æŒ‡è·¯ï¼š</p>
<p><a href="https://zhuanlan.zhihu.com/p/58669088">Linuxä½å»¶è¿ŸæœåŠ¡å™¨ç³»ç»Ÿè°ƒä¼˜</a></p>
<p>ä½å»¶è¿Ÿå…³é”®ä¸åœ¨äºä½ï¼Œè€Œåœ¨äº<strong>ç¨³å®š</strong>ï¼Œç¨³å®šå³å¯é¢„æœŸï¼Œå¯æŒæ§ï¼Œè¿™å¯¹é«˜é¢‘é¢†åŸŸæ¥è¯´å°¤å…¶é‡è¦ã€‚è°ˆåŠLinuxä½å»¶è¿ŸæŠ€æœ¯æ—¶ï¼Œäººä»¬ç»å¸¸æåˆ°â€œKernel Bypassâ€ï¼ˆå†…æ ¸æ—è·¯ï¼‰ï¼Œå³ç»•è¿‡å†…æ ¸ï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸å¤„ç†ä¸ä»…æ…¢ä¸”å»¶è¿Ÿä¸ç¨³å®šã€‚å› æ­¤ä¸€ä¸ªå»¶è¿Ÿè¦æ±‚å¾ˆé«˜çš„å®æ—¶ä»»åŠ¡æ˜¯ä¸èƒ½è§¦ç¢°å†…æ ¸çš„ï¼Œâ€œé¿å…è§¦ç¢°â€æ˜¯ä¸€ä¸ªæ¯”Bypassæ›´é«˜çš„è¦æ±‚ï¼šä¸èƒ½ä»¥<strong>ä»»ä½•</strong>æ–¹å¼è¿›å…¥å†…æ ¸ã€‚ä¸­æ–­ï¼ˆInterruptï¼‰æ˜¯è¿›å…¥å†…æ ¸çš„æ–¹å¼ä¹‹ä¸€ï¼Œæœ¬æ–‡çš„å…³é”®ç‚¹ä¹Ÿåœ¨äºé¿å…å…³é”®çº¿ç¨‹è¢«ä¸­æ–­ã€‚å³ä½¿ä¸­æ–­å‘ç”Ÿæ—¶çº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼Œä½†é‡æ–°å›åˆ°ç”¨æˆ·æ€åCPUç¼“å­˜è¢«æ±¡æŸ“äº†ï¼Œä¸‹ä¸€æ¬¡å¤„ç†è¯·æ±‚çš„å»¶è¿Ÿä¹Ÿä¼šå˜å¾—ä¸ç¨³å®šã€‚</p>
<h2 id="ç»‘å®šæ ¸å¿ƒ"><a href="#ç»‘å®šæ ¸å¿ƒ" class="headerlink" title="ç»‘å®šæ ¸å¿ƒ"></a>ç»‘å®šæ ¸å¿ƒ</h2><p>ä¸­æ–­æ˜¯CPU Coreæ”¶åˆ°çš„ï¼Œå¯ä»¥è®©å…³é”®çº¿ç¨‹<strong>ç»‘å®š</strong>åœ¨æŸä¸ªCoreä¸Šï¼Œç„¶åé¿å…å„ç§ä¸­æ–­æºï¼ˆIRQï¼‰å‘è¿™ä¸ªCoreå‘é€ä¸­æ–­ã€‚</p>
<p>ç»‘å®šç¨‹åºåœ¨ä¸€ä¸ªæ ¸ä¸Šè¿è¡Œï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š<code>taskset</code>å’Œ<code>sched_setaffinity</code>ã€‚</p>
<h3 id="CPU-Affinity"><a href="#CPU-Affinity" class="headerlink" title="CPU Affinity"></a>CPU Affinity</h3><p>ä¸­æ–‡è¯‘ä½œâ€œCPUäº²å’ŒåŠ›â€ï¼Œæ˜¯æŒ‡åœ¨CMPç»“æ„ä¸‹ï¼Œèƒ½å¤Ÿå°†ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ç»‘å®šåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œã€‚</p>
<h3 id="æŸ¥çœ‹è¿›ç¨‹åˆ†é…çš„CPU-Core"><a href="#æŸ¥çœ‹è¿›ç¨‹åˆ†é…çš„CPU-Core" class="headerlink" title="æŸ¥çœ‹è¿›ç¨‹åˆ†é…çš„CPU Core"></a>æŸ¥çœ‹è¿›ç¨‹åˆ†é…çš„CPU Core</h3><p>å¯ä»¥ä½¿ç”¨<code>taskset</code>å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">taskset -c -p &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æ„ï¼š</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">pid 17147&#x27;s current affinity list: 3-5</span><br></pre></td></tr></table></figure>

<p>è¯¥CPUäº²å’ŒåŠ›åˆ—è¡¨è¡¨æ˜è¯¥è¿›ç¨‹å¯èƒ½ä¼šè¢«å®‰æ’åœ¨3-5ä¸­ä»»æ„ä¸€ä¸ªCPU Coreä¸Šã€‚</p>
<p>æ›´å…·ä½“åœ°æŸ¥çœ‹æŸè¿›ç¨‹å½“å‰æ­£è¿è¡Œåœ¨å“ªä¸ªCPU Coreä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>top</code>å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">top -p &lt;uid&gt;</span><br></pre></td></tr></table></figure>

<h3 id="taskset"><a href="#taskset" class="headerlink" title="taskset"></a>taskset</h3><p>ä½¿ç”¨<code>taskset</code>å‘½ä»¤å°†è¿›ç¨‹ç»‘å®šåˆ°æŒ‡å®šæ ¸ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">taskset -cp &lt;core&gt; &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<p>å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">taskset -cp 1,2,3 31693</span><br></pre></td></tr></table></figure>

<p>è¯¥ä¾‹ä¼šå°†PIDä¸º31693çš„è¿›ç¨‹ç»‘å®šåˆ°1-3æ ¸ä¸Šè¿è¡Œã€‚</p>
<h3 id="sched-setaffinity"><a href="#sched-setaffinity" class="headerlink" title="sched_setaffinity"></a>sched_setaffinity</h3><p>ç¼–å†™ä»£ç æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>sched_setaffinity()</code>å‡½æ•°è®¾ç½®CPUäº²å’ŒåŠ›çš„æ©ç ï¼Œä»è€Œå°†è¯¥çº¿ç¨‹æˆ–è€…è¿›ç¨‹ä¸æŒ‡å®šçš„CPUç»‘å®šã€‚</p>
<p>ä¸€ä¸ªCPUçš„äº²å’ŒåŠ›æ©ç ç”¨ä¸€ä¸ª<code>cpu_set_t</code>ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªCPUé›†åˆï¼Œä¸‹é¢è¿™å‡ ä¸ªå®åˆ†åˆ«å¯¹æ©ç é›†è¿›è¡Œæ“ä½œï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CPU_ZERO</span>(<span class="keyword">cpu_set_t</span>* cpusetp);               <span class="comment">// æ¸…ç©ºä¸€ä¸ªé›†åˆ</span></span><br><span class="line"><span class="built_in">CPU_SET</span>(<span class="keyword">size_t</span> cpu, <span class="keyword">cpu_set_t</span>* cpusetp);    <span class="comment">// åŠ å…¥CPU Coreåˆ°é›†åˆ</span></span><br><span class="line"><span class="built_in">CPU_CLR</span>(<span class="keyword">size_t</span> cpu, <span class="keyword">cpu_set_t</span>* cpusetp);    <span class="comment">// ä»é›†åˆä¸­åˆ é™¤æŒ‡å®šçš„CPU Core</span></span><br><span class="line"><span class="built_in">CPU_ISSET</span>(<span class="keyword">size_t</span> cpu, <span class="keyword">cpu_set_t</span>* cpusetp);  <span class="comment">// æ£€æŸ¥ä¸€ä¸ªCPU Coreæ˜¯å¦åœ¨é›†åˆä¸­</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>sched_setaffinity()</code>ä¸<code>sched*_*getaffinity()</code>ç­‰å‡½æ•°éœ€è¦å¼•è¿›å¤´æ–‡ä»¶<code>sched.h</code>ã€‚</p>
<ul>
<li>å¤´æ–‡ä»¶ï¼š<code>sched.h</code></li>
<li><code>int sched_setaffinity(pid_t pid, size_t cpusetsize, const cpu_set_t* mask)</code><br>è¯¥å‡½æ•°å°†PIDä¸º<em>pid</em>çš„è¿›ç¨‹è®¾ç½®ä¸ºè¿è¡Œåœ¨<em>mask</em>æŒ‡å®šçš„CPU Coreä¸Šã€‚<br>* è‹¥<em>pid</em>ä¸º0ï¼Œåˆ™è¡¨ç¤ºæŒ‡å®šå½“å‰è¿›ç¨‹ã€‚<br>* <em>cpusetsize</em>ä¸º<em>mask</em>çš„å¤§å°ï¼Œé€šå¸¸ä¸º<code>sizeof(cpu_set_t)</code>ã€‚<br>* <em>cpuset</em>å³ç”¨<code>cpu_set_t</code>ç»“æ„ä½“è¡¨ç¤ºçš„CPU Coreé›†åˆã€‚<br>* å‡½æ•°è¿”å›0è¡¨ç¤ºæˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å›-1ã€‚</li>
<li><code>int sched_getaffinity(pid_t pid, size_t cpusetsize, cpu_set_t* mask)</code><br>å‡½æ•°è·å–PIDä¸º<em>pid</em>çš„è¿›ç¨‹CPUäº²å’ŒåŠ›æ©ç ï¼Œå¹¶ä¿å­˜åœ¨<em>mask</em>ç»“æ„ä½“ä¸­ï¼Œå³è·å¾—æŒ‡å®špidå½“å‰å¯ä»¥è¿è¡Œåœ¨å“ªäº›CPUä¸Šã€‚<br>* è‹¥<em>pid</em>ä¸º0ï¼Œåˆ™è¡¨ç¤ºæŒ‡å®šå½“å‰è¿›ç¨‹ã€‚<br>* <em>cpusetsize</em>ä¸º<em>mask</em>çš„å¤§å°ï¼Œé€šå¸¸ä¸º<code>sizeof(cpu_set_t)</code>ã€‚<br>* <em>cpuset</em>å³ç”¨<code>cpu_set_t</code>ç»“æ„ä½“è¡¨ç¤ºçš„CPU Coreé›†åˆã€‚<br>* å‡½æ•°è¿”å›0è¡¨ç¤ºæˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å›-1ã€‚</li>
</ul>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __USE_GNU</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// CPU Core Binded sched_setaffinity</span></span><br><span class="line">    <span class="keyword">cpu_set_t</span> mask;  <span class="comment">// CPU Core Set</span></span><br><span class="line">    <span class="built_in">CPU_ZERO</span>(&amp;mask);  <span class="comment">// Set Zero</span></span><br><span class="line">    <span class="built_in">CPU_SET</span>(<span class="number">6</span>, &amp;mask);  <span class="comment">// Add core to set</span></span><br><span class="line">    <span class="built_in">CPU_SET</span>(<span class="number">7</span>, &amp;mask);</span><br><span class="line">    <span class="built_in">CPU_SET</span>(<span class="number">8</span>, &amp;mask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="keyword">if</span>((rc = <span class="built_in">sched_setaffinity</span>(<span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(mask), &amp;mask))</span><br><span class="line">    &#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Warning: Set affinity failed!&quot;</span>&lt;&lt;<span class="built_in">strerror</span>(rc)&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">cpu_set_t</span> get;</span><br><span class="line">        <span class="keyword">if</span>((rc = <span class="built_in">sched_getaffinity</span>(<span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(get), &amp;get)))</span><br><span class="line">        &#123;</span><br><span class="line">             cout&lt;&lt;<span class="string">&quot;Waring: Could not get thread affinity.&quot;</span>&lt;&lt;endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">pid_t</span> pid = <span class="built_in">getpid</span>();</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Current PID: &quot;</span>&lt;&lt;pid&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">size_t</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="built_in">sysconf</span>(_SC_NPROCESSORS_CONF); ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">CPU_ISSUE</span>(i, &amp;get))</span><br><span class="line">                cout&lt;&lt;<span class="string">&quot;Running on processor: &quot;</span>&lt;&lt;i&lt;&lt;endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šè‹¥ä½¿ç”¨åˆ°pthreadï¼Œåˆ™éœ€è¦å°†pthread.hæ”¾åˆ°sched.hä¹‹åï¼Œå¹¶åœ¨sched.hä¹‹å‰å£°æ˜#define __USE_GNUï¼Œå¦åˆ™ä¼šå‡ºç°undefined reference CPU_ZEROç­‰é”™è¯¯ã€‚</p>
</blockquote>
<h2 id="å±è”½ç¡¬ä¸­æ–­ï¼ˆç¡¬ç›˜ã€ç½‘å¡ï¼‰"><a href="#å±è”½ç¡¬ä¸­æ–­ï¼ˆç¡¬ç›˜ã€ç½‘å¡ï¼‰" class="headerlink" title="å±è”½ç¡¬ä¸­æ–­ï¼ˆç¡¬ç›˜ã€ç½‘å¡ï¼‰"></a>å±è”½ç¡¬ä¸­æ–­ï¼ˆç¡¬ç›˜ã€ç½‘å¡ï¼‰</h2><p>ä¸­æ–­æºï¼ˆIRQï¼‰å‘CPU Coreå‘é€ä¸­æ–­ï¼ŒCPU Coreè°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åºå¯¹ä¸­æ–­è¿›ç¨‹å¤„ç†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å†™<code>/proc/irq/*/smp_affinity</code>æ–‡ä»¶ï¼Œé¿å…ä¸­æ–­æºï¼ˆIRQï¼‰å‘æŸäº›CPU Coreå‘é€ä¸­æ–­ã€‚è¯¥æ–¹æ³•å¯¹ç¡¬ç›˜ã€ç½‘å¡ç­‰è®¾å¤‡å¼•èµ·çš„ç¡¬ä¸­æ–­æœ‰æ•ˆã€‚</p>
<h3 id="æŸ¥çœ‹è®¾å¤‡ä¸­æ–­æ•°æ®"><a href="#æŸ¥çœ‹è®¾å¤‡ä¸­æ–­æ•°æ®" class="headerlink" title="æŸ¥çœ‹è®¾å¤‡ä¸­æ–­æ•°æ®"></a>æŸ¥çœ‹è®¾å¤‡ä¸­æ–­æ•°æ®</h3><p>é€šè¿‡æŸ¥çœ‹<code>/proc/interrupts</code>æ–‡ä»¶å¯æŸ¥çœ‹è®¾å¤‡ä¸­æ–­æ•°æ®ï¼š</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">           CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       </span><br><span class="line">  0:         17          0          0          0          0          0          0          0   IO-APIC   2-edge      timer</span><br><span class="line">  8:          0          0          0          0          0          1          0          0   IO-APIC   8-edge      rtc0</span><br><span class="line">  9:       4058        258        157         14        464        454         34        134   IO-APIC   9-fasteoi   acpi</span><br><span class="line"> 16:     137153      19574      11430      10138      47072      27502      15934      10113   IO-APIC  16-fasteoi   ahci[0000:05:00.0], xhci-hcd:usb1, nvkm</span><br><span class="line"> 17:         16          3          1          9         35          2          2          1   IO-APIC  17-fasteoi   snd_hda_intel:card1</span><br><span class="line"> 18:      88952       2170       1592       1253       4255       5430       1790       1738   IO-APIC  18-fasteoi   wlp3s0</span><br><span class="line"> 22:     172111       2954       2515       1897       5000       3684       2479       2513   IO-APIC  22-fasteoi   snd_hda_intel:card0</span><br><span class="line">NMI:          0          0          0          0          0          0          0          0   Non-maskable interrupts</span><br><span class="line">LOC:     395090     279787     239243     235695     233918      90471      94234      90479   Local timer interrupts</span><br><span class="line">SPU:          0          0          0          0          0          0          0          0   Spurious interrupts</span><br><span class="line">PMI:          0          0          0          0          0          0          0          0   Performance monitoring interrupts</span><br><span class="line">IWI:          0          0          0          1          1          1          0          3   IRQ work interrupts</span><br><span class="line">RTR:          6          0          0          0          0          0          0          0   APIC ICR read retries</span><br><span class="line">RES:       7425       5663       4375       3801       3051       2825       1963       1787   Rescheduling interrupts</span><br><span class="line">CAL:         31         29         24         22         36         28         34         31   Function call interrupts</span><br><span class="line">TLB:      10387      11374      10758      11769       7566       8508       8799       7195   TLB shootdowns</span><br><span class="line">TRM:          2          2          2          2          2          2          2          2   Thermal event interrupts</span><br><span class="line">THR:          0          0          0          0          0          0          0          0   Threshold APIC interrupts</span><br><span class="line">MCE:          0          0          0          0          0          0          0          0   Machine check exceptions</span><br><span class="line">MCP:         17         17         17         17         17         17         17         17   Machine check polls</span><br><span class="line">ERR:          0</span><br><span class="line">MIS:          0</span><br><span class="line">PIN:          0          0          0          0          0          0          0          0   Posted-interrupt notification event</span><br><span class="line">PIW:          0          0          0          0          0          0          0          0   Posted-interrupt wakeup event</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ä¸€åˆ—æ˜¯IRQå·</li>
<li>ç¬¬äºŒåˆ—å¼€å§‹è¡¨ç¤ºæŸCPUå†…æ ¸è¢«å¤šå°‘æ¬¡ä¸­æ–­ã€‚</li>
</ul>
<h3 id="SMP-AFFINITY"><a href="#SMP-AFFINITY" class="headerlink" title="SMP_AFFINITY"></a>SMP_AFFINITY</h3><p>SMPï¼Œå³symmetric multiprocessingï¼ˆå¯¹ç§°å¤šå¤„ç†å™¨ï¼‰ï¼Œé€šè¿‡å¤šä¸ªå¤„ç†å™¨å¤„ç†ç¨‹åºçš„æ–¹å¼ã€‚smp_affinityæ–‡ä»¶å¤„ç†ä¸€ä¸ªIRQçš„ä¸­æ–­äº²å’Œæ€§ã€‚åœ¨smp_affinityæ–‡ä»¶ç»“åˆæ¯ä¸ªIRQå·åœ¨<code>/proc/irq/&#123;IRQ_NUMBER&#125;/smp_affinity</code>æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å€¼æ˜¯ä¸€ä¸ª16è¿›åˆ¶æ©ç è¡¨ç¤ºç³»ç»Ÿçš„æ‰€æœ‰CPUæ ¸ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒSolarflareç½‘å¡çš„è®¾å¤‡åä¸ºeth1ï¼Œå…¶ä¸­æ–­å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep eth1 /proc/interrupts</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">64:    95218  168786727  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  IR-PCI-MSI-edge  eth1-0</span><br><span class="line">65:    38440  53649095   0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  IR-PCI-MSI-edge  eth1-1</span><br><span class="line">66:    6207   1011519    0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  IR-PCI-MSI-edge  eth1-ptp</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°eth1è®¾å¤‡å…±æœ‰ä¸‰ä¸ªIRQå·ï¼š64,65,66ï¼Œå…¶ç›¸å¯¹åº”çš„smp_afffinityæ–‡ä»¶æ—¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /proc/irq/64/smp_affinity</span><br><span class="line">cat /proc/irq/65/smp_affinity</span><br><span class="line">cat /proc/irq/66/smp_affinity</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000,00000000,00000000,0000000f</span><br><span class="line">0000,00000000,00000000,0000000f</span><br><span class="line">0000,00000000,00000000,0000000f</span><br></pre></td></tr></table></figure>

<p>smp_affinityæ˜¯16è¿›åˆ¶è¡¨ç¤ºï¼Œfå°±æ˜¯äºŒè¿›åˆ¶çš„1111ï¼Œè¡¨ç¤º0-3è¿™å››ä¸ªCPU Coreéƒ½ä¼šå‚ä¸å¤„ç†ä¸­æ–­ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æƒ³è¦æŒ‡å®šä»…0-1è¿™ä¸¤ä¸ªæ ¸å¿ƒå¤„ç†ä¸­æ–­ï¼Œåˆ™å¯ä»¥å†™å…¥å¦‚ä¸‹æ•°æ®åˆ°smp_affinityï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 3 &gt; /proc/irq/64/smp_affinity</span><br><span class="line"><span class="built_in">echo</span> 3 &gt; /proc/irq/65/smp_affinity</span><br><span class="line"><span class="built_in">echo</span> 3 &gt; /proc/irq/66/smp_affinity</span><br></pre></td></tr></table></figure>

<h2 id="å±è”½è½¯ä¸­æ–­ï¼ˆWork-queueï¼‰"><a href="#å±è”½è½¯ä¸­æ–­ï¼ˆWork-queueï¼‰" class="headerlink" title="å±è”½è½¯ä¸­æ–­ï¼ˆWork queueï¼‰"></a>å±è”½è½¯ä¸­æ–­ï¼ˆWork queueï¼‰</h2><p>workqueueæ˜¯è‡ªkernel2.6å¼•å…¥çš„ä¸€ç§ä»»åŠ¡æ‰§è¡Œæœºåˆ¶ï¼Œå’Œsoftirqï¼Œtaskletå¹¶ç§°ä¸‹åŠéƒ¨ï¼ˆbottom halfï¼‰ä¸‰å‰‘å®¢ã€‚workqueueåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œèƒ½å¤Ÿè¿›è¡Œç¡çœ ã€‚å¯ä»¥é€šè¿‡æ”¹å†™<code>/sys/devices/virtual/workqueue/*/cpumask</code>æ–‡ä»¶å®ç°å±è”½Work queueçš„è½¯ä¸­æ–­ã€‚</p>
<p><code>/sys/devices/virtual/workqueue/cpumask</code>æ–‡ä»¶ä¸­è®°å½•äº†å…¨å±€çš„cpumaskï¼Œå¯ä»¥å½±å“æ‰€æœ‰çš„workqueueã€‚æ–‡ä»¶å†…å®¹æ ¼å¼ä¸smp_affinityç›¸åŒï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /sys/devices/virtual/workqueue/cpumask</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000,00000000,00000000,00000007</span><br></pre></td></tr></table></figure>

<p>ä»£è¡¨0-2è¿™ä¸‰ä¸ªCPU Coreç”¨æ¥å¤„ç†work queueï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å†™å…¥â€fâ€æ¥ä»…è®©ä¸æ ¸å¿ƒè¿›ç¨‹æ— å…³çš„0-3è¿™å››ä¸ªCPU Coreå‚ä¸work queueå¤„ç†ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;f&#x27;</span> &gt; /sys/devices/virtual/workqueue/cpumask</span><br></pre></td></tr></table></figure>

<h2 id="å±è”½è½¯ä¸­æ–­ï¼ˆLocal-Timer-Interruptï¼‰"><a href="#å±è”½è½¯ä¸­æ–­ï¼ˆLocal-Timer-Interruptï¼‰" class="headerlink" title="å±è”½è½¯ä¸­æ–­ï¼ˆLocal Timer Interruptï¼‰"></a>å±è”½è½¯ä¸­æ–­ï¼ˆLocal Timer Interruptï¼‰</h2><p>Linuxçš„scheduler time sliceæ˜¯é€šè¿‡LOCå®ç°çš„ï¼Œå¦‚æœæˆ‘ä»¬è®©ä¸€ä¸ªçº¿ç¨‹ç‹¬å ä¸€ä¸ªCPU Coreï¼Œå°±ä¸éœ€è¦scheduleråœ¨è¿™ä¸ªCPU Coreä¸Šåˆ‡æ¢è¿›ç¨‹ã€‚å¯ä»¥é€šè¿‡<code>isolcpus</code>ç³»ç»Ÿå¯åŠ¨é€‰é¡¹éš”ç¦»ä¸€äº›æ ¸ï¼Œè®©ä»–ä»¬åªèƒ½è¢«ç»‘å®šçš„çº¿ç¨‹ä½¿ç”¨ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯ç”¨â€œadaptive-ticksâ€æ¨¡å¼ï¼Œè¾¾åˆ°å‡å°‘ç‹¬å çº¿ç¨‹æ”¶åˆ°LOCé¢‘ç‡çš„æ•ˆæœï¼Œè¿™å¯ä»¥é€šè¿‡<code>nohz_full</code>å’Œ<code>rcu_nocbs</code>å¯åŠ¨é€‰é¡¹å®ç°ã€‚</p>
<p>å‡è®¾ä»¤6-8ä¸‰ä¸ªæ ¸å¿ƒå±è”½è½¯ä¸­æ–­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿå¯åŠ¨é€‰é¡¹ä¸­åŠ å…¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nohz=on nohz_full=6-8 rcu_nocbs=6-8</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥adaptive-ticksæ¨¡å¼åï¼Œå¦‚æœCPU Coreä¸Šçš„running taskåªæœ‰ä¸€ä¸ªæ—¶ï¼Œç³»ç»Ÿå‘å…¶å‘é€çš„LOCé¢‘ç‡ä¼šæ˜¾è‘—é™ä½ï¼Œä½†LOCä¸èƒ½è¢«å®Œå…¨å±è”½ï¼Œç³»ç»Ÿå†…æ ¸çš„ä¸€äº›æ“ä½œæ¯”å¦‚è®¡ç®—CPUè´Ÿè½½ç­‰ä»ç„¶éœ€è¦å‘¨æœŸæ€§çš„LOCã€‚</p>
<h2 id="æ›´å¤š"><a href="#æ›´å¤š" class="headerlink" title="æ›´å¤š"></a>æ›´å¤š</h2><p>ä¸­æ–­å’Œsmp_affinityï¼š</p>
<p><a href="https://huataihuang.gitbooks.io/cloud-atlas/content/os/linux/kernel/cpu/interrupt_and_smp_affinity.html">ä¸­æ–­å’Œsmp_affinity</a></p>
<p>SolarFlareèµ„æºæ±‡æ€»ï¼š</p>
<p><a href="https://williamlfang.github.io/shared/2019-12-20-solarflare%E8%B5%84%E6%BA%90%E6%B1%87%E6%80%BB/">SolarFlareèµ„æºæ±‡æ€»</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ å¿ƒå¾—</tag>
        <tag>Linux</tag>
        <tag>ä½å»¶è¿Ÿç³»ç»Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>C++æ—¥æœŸä¸æ—¶é—´ç¼–ç¨‹ï¼ˆC++11-C++17ï¼‰</title>
    <url>/2021/05/19/C++%E6%97%A5%E6%9C%9F%E4%B8%8E%E6%97%B6%E9%97%B4%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="C-æ—¥æœŸä¸æ—¶é—´ç¼–ç¨‹ï¼ˆC-11-C-17ï¼‰"><a href="#C-æ—¥æœŸä¸æ—¶é—´ç¼–ç¨‹ï¼ˆC-11-C-17ï¼‰" class="headerlink" title="C++æ—¥æœŸä¸æ—¶é—´ç¼–ç¨‹ï¼ˆC++11-C++17ï¼‰"></a>C++æ—¥æœŸä¸æ—¶é—´ç¼–ç¨‹ï¼ˆC++11-C++17ï¼‰</h1><h2 id="0x00-å¯¼è¨€"><a href="#0x00-å¯¼è¨€" class="headerlink" title="0x00 å¯¼è¨€"></a>0x00 å¯¼è¨€</h2><p>æ—¥æœŸå’Œæ—¶é—´æ˜¯åœ¨ç¼–ç¨‹ä¸­å¸¸å¸¸æ¥è§¦åˆ°çš„ä¸œè¥¿ï¼Œè€ŒC++ä¹Ÿä¸ºç¨‹åºå‘˜æä¾›äº†å¼ºï¼ˆå¤ï¼‰å¤§ï¼ˆæ‚ï¼‰çš„æ—¥æœŸå’Œæ—¶é—´ç¼–ç¨‹çš„ç›¸å…³æ”¯æŒã€‚åœ¨C++20æ ‡å‡†ä¸­ï¼ŒC++çš„<code>chrono</code>åº“ç»§C++11æ ‡å‡†åä¹Ÿè¿æ¥äº†ç©ºå‰ç»åå¤§æ›´æ–°ï¼Œä½†æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ä¸»è¦é›†ä¸­åœ¨C++11è‡³C++17æ ‡å‡†ä¸­æ—¥æœŸå’Œæ—¶é—´ç›¸å…³çš„å†…å®¹ï¼ŒC++20æ ‡å‡†ä¸­çš„<code>chrono</code>æ–°ä¸œè¥¿å®Œå…¨å¯ä»¥å¦å¼€ä¸€ä¸ªå‘ã€‚</p>
<p>åœ¨ç¿»äº†Nç¯‡cppreferenceæ ‡å‡†ã€chromeçˆ½åƒæˆ‘800Mbçš„å†…å­˜ä¹‹åï¼Œæˆ‘æœæ–­å†³å®šæŠŠè¿™æ¬¡çš„å­¦ä¹ å¿ƒå¾—è®°ä¸‹æ¥ï¼Œä»¥é˜²ä»¥åå…¨éƒ¨å¿˜å…‰å…‰ï¼ˆå®åœ¨å¤ªå¤šäº†.jpgï¼‰ã€‚æœ¬ç‰‡å­¦ä¹ å¿ƒå¾—çº¯æ–°æ‰‹å‘ï¼Œæ±‚å¤§ä½¬è½»å–·ã€‚</p>
<span id="more"></span>

<h2 id="0x01-æ¦‚è®º"><a href="#0x01-æ¦‚è®º" class="headerlink" title="0x01 æ¦‚è®º"></a>0x01 æ¦‚è®º</h2><p>å…ˆç»™ä¸¤ä¸ªä¾‹å­ï¼š</p>
<ol>
<li>è·å–å½“å‰æ—¶é—´</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å®ç°1 **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">time_t</span> now = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Now is: &quot;</span> &lt;&lt; <span class="built_in">ctime</span>(&amp;now);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å®ç°2 **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">	<span class="keyword">time_t</span> time = chrono::system_clock::<span class="built_in">to_time_t</span>(now);</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Now is: &quot;</span> &lt;&lt; <span class="built_in">ctime</span>(&amp;time) &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è®¡ç®—æ—¶é—´å·®</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å®ç°1 **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">time_t</span> time1 = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000000</span>; i++) &#123;</span><br><span class="line">  		sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">time_t</span> time2 = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">double</span> time_diff = <span class="built_in">difftime</span>(time2, time1);</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;time1: &quot;</span> &lt;&lt; time1 &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;time2: &quot;</span> &lt;&lt; time2 &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;time_diff: &quot;</span> &lt;&lt; time_diff &lt;&lt; <span class="string">&quot;s&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å®ç°2 **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> start = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">	<span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000</span>; i++) &#123;</span><br><span class="line">    	sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">auto</span> end = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> time_diff = end - start;</span><br><span class="line">	<span class="keyword">auto</span> duration = chrono::duration_cast&lt;chrono::seconds&gt;(time_diff);</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Operation cost : &quot;</span> &lt;&lt; duration.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;s&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šæ–‡çš„ä¸¤ä¸ªè¦æ±‚éƒ½åˆ†åˆ«ç»™å‡ºäº†ä¸¤ç§å®ç°æ–¹æ³•ï¼Œé‚£æ¥ä¸‹æ¥è¦è¯´çš„äº‹æƒ…å·²ç»æ˜¾è€Œæ˜“è§äº†ï¼š</p>
<p><strong>C++ç»™å‡ºäº†ä¸¤ç±»æ—¥æœŸæ—¶é—´APIï¼Œåˆ†åˆ«æ˜¯ï¼š</strong></p>
<ul>
<li>C-Styleæ—¥æœŸæ—¶é—´åº“ï¼Œä¸»è¦ä½äº<code>&lt;ctime&gt;</code>å¤´æ–‡ä»¶ï¼ˆåŸCè¯­è¨€<code>&lt;time.h&gt;</code>å¤´æ–‡ä»¶çš„C++ç‰ˆæœ¬ï¼‰ä¸­ã€‚</li>
<li><code>chrono</code>åº“ï¼šC++11æ–°å¢çš„APIã€‚</li>
</ul>
<p>åœ¨C++11å¼•å…¥<code>chrono</code>åº“ä¹‹å‰ï¼ŒC++ç¨‹åºå‘˜åªèƒ½ä½¿ç”¨C-Styleçš„æ—¥æœŸæ—¶é—´åº“ã€‚ç„¶è€Œï¼ŒC-Styleæ—¥æœŸæ—¶é—´åº“æœ‰ç€é²œæ˜çš„ç¼ºç‚¹ï¼š<strong>ç²¾åº¦åªæœ‰ç§’çº§åˆ«</strong>ï¼ˆå½“æ—¶ï¼‰ï¼Œè¿™å¯¹äºå¯¹æ—¶é—´æœ‰ç€é«˜ç²¾åº¦è¦æ±‚çš„ç¨‹åºæ¥è¯´æ˜¯å®Œå…¨ä¸å¤Ÿç”¨çš„ã€‚è€ŒC++11å¼•å…¥çš„<code>chrono</code>åº“è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒæå¤§åœ°æ‰©å±•äº†å¯¹ç²¾åº¦çš„æ”¯æŒã€‚å½“ç„¶ï¼Œé’ˆå¯¹ä¹ æƒ¯C-Styleæ—¥æœŸæ—¶é—´åº“çš„ç¨‹åºå‘˜æ¥è¯´ï¼ŒC++17ä¹Ÿè¿›è¡Œäº†ç²¾åº¦çš„æ‰©å……ï¼Œè¯¦æƒ…è¯·è§ä¸‹æ–‡ã€‚</p>
<p>æœ¬æ–‡ä¹Ÿä¼šåˆ†ä¸ºC-Styleå’Œ<code>chrono</code>ä¸¤ä¸ªæ¿å—è¿›è¡Œè®²è§£ã€‚</p>
<h2 id="0x02-å¿…å¤‡çš„çŸ¥è¯†"><a href="#0x02-å¿…å¤‡çš„çŸ¥è¯†" class="headerlink" title="0x02 å¿…å¤‡çš„çŸ¥è¯†"></a>0x02 å¿…å¤‡çš„çŸ¥è¯†</h2><p>åœ¨æ­£å¼è¿›å…¥æ—¥æœŸæ—¶é—´åº“çš„è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå¤ä¹ ä¸€ä¸‹ä¸æ—¥æœŸæ—¶é—´ç›¸å…³çš„å¿…è¦çŸ¥è¯†ã€‚</p>
<h3 id="UTCæ—¶é—´"><a href="#UTCæ—¶é—´" class="headerlink" title="UTCæ—¶é—´"></a>UTCæ—¶é—´</h3><p><strong>åè°ƒä¸–ç•Œæ—¶</strong>ï¼ˆ<strong>C</strong>oordinated <strong>U</strong>niversial <strong>T</strong>imeï¼Œç®€ç§°<strong>UTC</strong>ï¼‰æ˜¯æœ€ä¸»è¦çš„æ—¶é—´æ ‡å‡†ï¼Œå…¶ä»¥åŸå­æ—¶ç§’é•¿ä¸ºåŸºç¡€ï¼Œåœ¨æ—¶åˆ»ä¸Šå°½é‡æ¥è¿‘äºæ ¼æ—å¨æ²»æ ‡å‡†æ—¶é—´ã€‚</p>
<p>åè°ƒä¸–ç•Œæ—¶æ˜¯ä¸–ç•Œä¸Šè°ƒèŠ‚æ—¶é’Ÿå’Œæ—¶é—´çš„ä¸»è¦æ—¶é—´æ ‡å‡†ï¼Œå®ƒä¸0åº¦ç»çº¿çš„å¹³å¤ªé˜³æ—¶ç›¸å·®ä¸è¶…è¿‡1ç§’ã€‚å› æ­¤UTCæ—¶é—´+8å³å¯è·å¾—åŒ—äº¬æ ‡å‡†æ—¶é—´ï¼ˆUTC+8ï¼‰ã€‚</p>
<h3 id="æœ¬åœ°æ—¶é—´"><a href="#æœ¬åœ°æ—¶é—´" class="headerlink" title="æœ¬åœ°æ—¶é—´"></a>æœ¬åœ°æ—¶é—´</h3><p>æœ¬åœ°æ—¶é—´ä¸å½“åœ°çš„æ—¶åŒºç›¸å…³ï¼Œä¾‹å¦‚ä¸­å›½å½“åœ°æ—¶é—´é‡‡ç”¨äº†åŒ—äº¬æ ‡å‡†æ—¶é—´ï¼ˆUTC+8ï¼‰.</p>
<h3 id="çºªå…ƒæ—¶é—´"><a href="#çºªå…ƒæ—¶é—´" class="headerlink" title="çºªå…ƒæ—¶é—´"></a>çºªå…ƒæ—¶é—´</h3><p><strong>çºªå…ƒæ—¶é—´</strong>ï¼ˆEpoch timeï¼‰åˆè¢«ç§°ä¸ºUnixæ—¶é—´ï¼ˆå¸¸ç”¨Linuxçš„å°ä¼™ä¼´å¯èƒ½ä¼šæ¯”è¾ƒç†Ÿæ‚‰ï¼‰ã€‚å®ƒè¡¨ç¤º1970å¹´1æœˆ1æ—¥00:00UTCä»¥æ¥æ‰€ç»å†çš„<strong>ç§’æ•°</strong>ï¼ˆä¸è€ƒè™‘é—°ç§’ï¼‰ã€‚</p>
<p>ä¾‹å¦‚åŒ—äº¬æ—¶é—´2021å¹´5æœˆ18æ—¥æ™šä¸Š9ç‚¹07åˆ†32ç§’çš„çºªå…ƒæ—¶é—´ä¸ºï¼š<code>1621372052</code>ã€‚</p>
<p>ä½œä¸ºä¸€ä¸ªæ•æ„Ÿçš„CPPç¨‹åºå‘˜ï¼Œä½ åº”è¯¥å¾ˆå¿«å°±æ„è¯†åˆ°è¿™ä¸ªå¤§æ•´æ•°åœ¨å‚¨å­˜ä¼šäº§ç”Ÿå¾ˆå¤šé—®é¢˜ï¼Œä¾‹å¦‚æº¢å‡ºã€‚ç„¶è€Œäº‹å®æ­£æ˜¯å¦‚æ­¤ï¼Œåœ¨ä¸€äº›å†å²æœºå™¨ä¸Šï¼Œä½¿ç”¨äº†32ä½çš„æœ‰ç¬¦å·æ•´æ•°æ¥å‚¨å­˜è¿™ä¸ªæ—¶é—´æˆ³ï¼Œå› æ­¤äº§ç”Ÿåœ¨ç»“æœå°±æ˜¯ï¼šåœ¨2038-01-19 03:14:07è¿™ä¸€åˆ»ï¼Œè¯¥å€¼ä¼šæº¢å‡ºã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœä½ å¯¹ä¸ºä»€ä¹ˆé€‰1970-1-1æ—¥é›¶ç‚¹åšä½çºªå…ƒæ—¶é—´èµ·ç‚¹ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªå¸–å­ï¼š</p>
<p><a href="https://stackoverflow.com/questions/1090869/why-is-1-1-1970-the-epoch-time">Why is 1/1/1970 the â€œepoch timeâ€?</a></p>
<h2 id="0x03-C-Style-æ—¥æœŸæ—¶é—´åº“"><a href="#0x03-C-Style-æ—¥æœŸæ—¶é—´åº“" class="headerlink" title="0x03 C-Style æ—¥æœŸæ—¶é—´åº“"></a>0x03 C-Style æ—¥æœŸæ—¶é—´åº“</h2><p>C-Styleæ—¥æœŸæ—¶é—´åº“ä¸»è¦ä½äº<code>&lt;ctime&gt;</code>å¤´æ–‡ä»¶ä¸­ï¼Œä¸‹é¢ç»™å‡ºå¤´æ–‡ä»¶ä¸­åŒ…å«çš„å¸¸ç”¨çš„<em>ç±»å‹</em>å’Œ<em>å‡½æ•°</em>ã€‚</p>
<h3 id="å¸¸ç”¨ç±»å‹ä¸å‡½æ•°"><a href="#å¸¸ç”¨ç±»å‹ä¸å‡½æ•°" class="headerlink" title="å¸¸ç”¨ç±»å‹ä¸å‡½æ•°"></a>å¸¸ç”¨ç±»å‹ä¸å‡½æ•°</h3><p><strong>ç±»å‹</strong></p>
<table>
<thead>
<tr>
<th>ç±»å‹å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>clock_t</td>
<td>è¿›ç¨‹è¿è¡Œæ—¶é—´</td>
</tr>
<tr>
<td>size_t</td>
<td>sizeofè¿ç®—ç¬¦è¿”å›çš„æ— ç¬¦å·æ•´æ•°ç±»å‹</td>
</tr>
<tr>
<td>time_t</td>
<td>ä»çºªå…ƒèµ·çš„æ—¶é—´ç±»å‹</td>
</tr>
<tr>
<td>tm</td>
<td>æ—¥å†æ—¶é—´ç±»å‹</td>
</tr>
<tr>
<td>timespec*(C++17)*</td>
<td>ä»¥ç§’å’Œçº³ç§’è¡¨ç¤ºçš„æ—¶é—´ï¼ˆC++17ï¼‰</td>
</tr>
</tbody></table>
<p><strong>å‡½æ•°</strong></p>
<table>
<thead>
<tr>
<th>å‡½æ•°å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>std::clock_t clock()</td>
<td>è¿”å›è‡ªç¨‹åºå¯åŠ¨æ—¶èµ·çš„åŸå§‹å¤„ç†å™¨æ—¶é’Ÿæ—¶é—´</td>
</tr>
<tr>
<td>std::time_t time(std::time_t* arg)</td>
<td>è¿”å›è‡ªçºªå…ƒèµ·è®¡çš„ç³»ç»Ÿå½“å‰æ—¶é—´</td>
</tr>
<tr>
<td>double difftime(std::time_t time_end, std::time_t time_beg)</td>
<td>è®¡ç®—æ—¶é—´ä¹‹é—´çš„å·®</td>
</tr>
<tr>
<td>int timespec_get(std::timespec* ts, int base)<em>(C++17)</em></td>
<td>è¿”å›åŸºäºç»™å®šæ—¶é—´åŸºåº•çš„æ—¥å†æ—¶é—´ï¼ˆC++17ï¼‰</td>
</tr>
<tr>
<td>char* ctime(const std::time_t* time)</td>
<td>è½¬æ¢ time_t å¯¹è±¡ä¸ºæ–‡æœ¬è¡¨ç¤º</td>
</tr>
<tr>
<td>char* asctime(const std::tm* time_ptr)</td>
<td>è½¬æ¢ tm å¯¹è±¡ä¸ºæ–‡æœ¬è¡¨ç¤º</td>
</tr>
<tr>
<td>std::size_t strftime(char* str, std::size_t count, const char* format, const std::tm* time)</td>
<td>è½¬æ¢ tm å¯¹è±¡åˆ°è‡ªå®šä¹‰çš„æ–‡æœ¬è¡¨ç¤º</td>
</tr>
<tr>
<td>std::size_t wcsftime( wchar_t* str, std::size_t count, const wchar_t* format, const std::tm* time)</td>
<td>è½¬æ¢ tm å¯¹è±¡ä¸ºå®šåˆ¶çš„å®½å­—ç¬¦ä¸²æ–‡æœ¬è¡¨ç¤º</td>
</tr>
<tr>
<td>std::tm* gmtime(const std::time_t* time)</td>
<td>å°†time_tè½¬æ¢æˆUTCè¡¨ç¤ºçš„æ—¶é—´</td>
</tr>
<tr>
<td>std::tm* localtime(const std::time_t *time)</td>
<td>å°†time_tè½¬æ¢æˆæœ¬åœ°æ—¶é—´</td>
</tr>
<tr>
<td>std::time_t mktime(std::tm* time)</td>
<td>å°†tmæ ¼å¼çš„æ—¶é—´è½¬æ¢æˆtime_tè¡¨ç¤ºçš„æ—¶é—´</td>
</tr>
</tbody></table>
<p>å‡½æ•°å’Œæ•°æ®ç±»å‹åˆå¤šåˆæ‚æœ‰æœ¨æœ‰ï¼Œåˆšå¼€å§‹æ¥è§¦çš„æ—¶å€™å¾ˆå®¹æ˜“å¼„æ··ä¸”ä¸å¤ªå®¹æ˜“è®°ä½ï¼Œè¿™é‡Œå€Ÿé‰´ä¸€ä¸‹å¤§ä½¬çš„ä¸€å¼ å›¾æ¥ç†è§£è®°å¿†ï¼š</p>
<p><img src="C:\Users\Skykey\Desktop\ctime.png"></p>
<p>è¿™å¹…å›¾ä¸­ï¼Œä»¥æ•°æ®ç±»å‹ä¸ºä¸­å¿ƒï¼Œå¸¦æ–¹å‘çš„å®å¿ƒç®­å¤´è¡¨ç¤ºè¯¥å‡½æ•°è¿”å›ç›¸åº”ç±»å‹çš„ç»“æœã€‚</p>
<ul>
<li>clockå‡½æ•°æ¯”è¾ƒç‰¹åˆ«ï¼Œå®ƒè¿”å›è¿›ç¨‹è¿è¡Œçš„æ—¶é—´ï¼Œå› è€Œæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚</li>
<li>time_tæè¿°çºªå…ƒæ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼Œä½¿ç”¨timeå‡½æ•°è·å¾—ã€‚</li>
<li>timespecç±»å‹åœ¨time_tçš„åŸºç¡€ä¸Šå¢åŠ äº†çº³ç§’çš„ç²¾åº¦ï¼Œéœ€è¦é€šè¿‡timespec_getå‡½æ•°è·å–ã€‚è¯¥ç±»å‹ä¸å‡½æ•°ä¸ºC++17æ–°å¢å†…å®¹ã€‚</li>
<li>tmæ˜¯æ—¥å†ç±»å‹ï¼ŒåŒ…å«äº†å¹´æœˆæ—¥ç­‰ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡gmtimeï¼Œlocaltimeå’Œmktimeå‡½æ•°è¿›è¡Œtime_tå’Œtmç±»å‹çš„ç›¸äº’è½¬åŒ–ã€‚</li>
<li>gmtimeå’Œlocaltimeä¸¤ä¸ªå‡½æ•°å­˜åœ¨æ—¶åŒºå·®å¼‚ç›¸å…³é—®é¢˜ã€‚</li>
<li>time_tå’Œtmç»“æ„éƒ½å¯ä»¥ç”¨å­—ç¬¦ä¸²æ ¼å¼è¾“å‡ºã€‚ctimeå’Œasctimeè¾“å‡ºçš„æ ¼å¼æ˜¯å›ºå®šçš„ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰æ ¼å¼ï¼Œéœ€è¦ä½¿ç”¨strftimeæˆ–è€…wcsftimeå‡½æ•°ã€‚</li>
</ul>
<h3 id="è®¡ç®—è¿›ç¨‹è¿è¡Œçš„æ—¶é—´"><a href="#è®¡ç®—è¿›ç¨‹è¿è¡Œçš„æ—¶é—´" class="headerlink" title="è®¡ç®—è¿›ç¨‹è¿è¡Œçš„æ—¶é—´"></a>è®¡ç®—è¿›ç¨‹è¿è¡Œçš„æ—¶é—´</h3><p>clockå‡½æ•°ä¼šè¿”å›ä»å…³è”åˆ°è¿›ç¨‹å¼€å§‹æ‰§è¡Œçš„å®ç°å®šä¹‰æ—¶æœŸçš„èµ·ï¼Œè¿›ç¨‹æ‰€ç”¨çš„ç²—ç•¥å¤„ç†å™¨æ—¶é—´ã€‚å°†æ­¤å€¼é™¤ä»¥<code>CLOCKS_PER_SEC</code>å¸¸é‡å¯è½¬æ¢ä¸ºç§’ã€‚</p>
<p>è¿™é‡Œç»™å‡ºcppreferenceä¸Šclockå‡½æ•°ç¤ºä¾‹çš„ç®€åŒ–ç‰ˆï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;threads.h&gt;</span> <span class="comment">// POSIX ä¸­çš„ pthread.h</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å‡½æ•° f() åšä¸€äº›è€—æ—¶çš„å·¥ä½œ</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>* thr_data)</span> <span class="comment">// POSIX ä¸­è¿”å› void*</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">double</span> d = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> n=<span class="number">0</span>; n&lt;<span class="number">10000</span>; ++n)</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> m=<span class="number">0</span>; m&lt;<span class="number">10000</span>; ++m)</span><br><span class="line">           d += d*n*m;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">clock_t</span> t1 = <span class="built_in">clock</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">thrd_t</span> thr1, thr2;  <span class="comment">// C11 ï¼›POSIX ä¸­ç”¨ pthread_t</span></span><br><span class="line">    <span class="built_in">thrd_create</span>(&amp;thr1, f, <span class="literal">NULL</span>); <span class="comment">// C11 ï¼› POSIX ä¸­ç”¨ pthread_create</span></span><br><span class="line">    <span class="built_in">thrd_create</span>(&amp;thr2, f, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">thrd_join</span>(thr1, <span class="literal">NULL</span>); <span class="comment">// C11 ï¼› POSIX ä¸­ç”¨ pthread_join</span></span><br><span class="line">    <span class="built_in">thrd_join</span>(thr2, <span class="literal">NULL</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">clock_t</span> t2 = <span class="built_in">clock</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">double</span> dur = <span class="number">1000.0</span>*(t2-t1)/CLOCKS_PER_SEC;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CPU time used (per clock(): %.2f ms\n&quot;</span>, dur);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½çš„è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CPU time used (per clock(): 1580.00 ms</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åº”å½“æ³¨æ„ï¼Œclockæ—¶é—´æˆ–è®¸ä¼šå¿«äºæˆ–æ…¢äºæŒ‚é’Ÿæ—¶é—´ï¼Œè¿™å–å†³äºæ“ä½œç³»ç»Ÿç»™äºˆç¨‹åºçš„æ‰§è¡Œèµ„æºã€‚åœ¨å•å¤„ç†å™¨çš„æƒ…å†µä¸‹ï¼Œè‹¥CPUä¸ºå…¶ä»–è¿›ç¨‹æ‰€å…±äº«ï¼Œclockå¯èƒ½æ…¢äºæŒ‚é’Ÿï¼Œè‹¥å½“å‰è¿›ç¨‹ä¸ºå¤šçº¿ç¨‹ï¼Œè€Œæœ‰æ›´å¤šèµ„æºå¯ç”¨ï¼Œclockæ—¶é—´å¯èƒ½ä¼šå¿«äºæŒ‚é’Ÿã€‚åœ¨å¤šå¤„ç†å™¨æƒ…å†µä¸‹ï¼Œè‹¥è¿›ç¨‹ä½¿ç”¨äº†å¤šçº¿ç¨‹ï¼Œé‚£ä¹ˆclockæ—¶é—´å¯èƒ½è¦æ…¢äºæŒ‚é’Ÿã€‚</p>
<h3 id="è·å–çºªå…ƒæ—¶é—´"><a href="#è·å–çºªå…ƒæ—¶é—´" class="headerlink" title="è·å–çºªå…ƒæ—¶é—´"></a>è·å–çºªå…ƒæ—¶é—´</h3><p>ä½¿ç”¨timeå‡½æ•°å¯ä»¥è·å–å‚¨å­˜äºtime_tç±»å‹è¿”å›å€¼é‡Œçš„çºªå…ƒæ—¶é—´ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">time_t</span> epoch_time = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;Epoch time: &quot;</span> &lt;&lt; epoch_time &lt;&lt;endl; </span><br></pre></td></tr></table></figure>

<p>åœ¨åŒ—äº¬æ—¶é—´2021å¹´5æœˆ18æ—¥æ™šä¸Š9ç‚¹07åˆ†32ç§’è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Epoch time: 1621372052</span><br></pre></td></tr></table></figure>



<h3 id="è®¡ç®—æ—¶é—´å·®"><a href="#è®¡ç®—æ—¶é—´å·®" class="headerlink" title="è®¡ç®—æ—¶é—´å·®"></a>è®¡ç®—æ—¶é—´å·®</h3><p>åœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦è®¡ç®—æ“ä½œæ‰€èŠ±è´¹çš„<strong>æ—¶é—´é•¿åº¦</strong>ã€‚å¯ä»¥çœ‹å‡ºï¼Œtime_tç»“æ„ä¸­å‚¨å­˜çš„æ˜¯<strong>æ—¶é—´ç‚¹</strong>ï¼Œè€Œé€šè¿‡å¸¸è¯†æˆ‘ä»¬å¾—çŸ¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ—¶é—´å·®ï¼ˆæ—¶é—´é•¿åº¦ï¼‰ = æ—¶é—´ç‚¹ - æ—¶é—´ç‚¹</span><br></pre></td></tr></table></figure>

<p>åœ¨C-Styleæ—¥æœŸæ—¶é—´åº“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡difftimeå‡½æ•°æ¥è®¡ç®—ä¸¤ä¸ªæ—¶é—´ç‚¹çš„å·®ã€‚</p>
<p>ä¸‹é¢ç»™å‡ºcppreferenceçš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::<span class="keyword">time_t</span> start = std::<span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">double</span> d;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// ä¸€äº›è€—æ—¶æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> n=<span class="number">0</span>; n&lt;<span class="number">10000</span>; ++n) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> m=<span class="number">0</span>; m&lt;<span class="number">100000</span>; ++m) &#123;</span><br><span class="line">           d += d*n*m;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Wall time passed: &quot;</span></span><br><span class="line">              &lt;&lt; std::<span class="built_in">difftime</span>(std::<span class="built_in">time</span>(<span class="literal">NULL</span>), start) &lt;&lt; <span class="string">&quot; s.\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Wall time passed: 7 s.</span><br></pre></td></tr></table></figure>



<h3 id="UTCæ—¶é—´ä¸æœ¬åœ°æ—¶é—´"><a href="#UTCæ—¶é—´ä¸æœ¬åœ°æ—¶é—´" class="headerlink" title="UTCæ—¶é—´ä¸æœ¬åœ°æ—¶é—´"></a>UTCæ—¶é—´ä¸æœ¬åœ°æ—¶é—´</h3><p>åœ¨C-Styleæ—¥æœŸæ—¶é—´åº“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨gmtimeå°†std::time_tçš„çºªå…ƒæ—¶é—´è½¬æ¢ä¸ºUTCæ—¶é—´ï¼Œä½¿ç”¨localtimeå°†çºªå…ƒæ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒºæ‰€ä»£è¡¨çš„æ—¥å†æ—¶é—´ã€‚</p>
<p>gmtimeä¸localtimeè¿”å›å€¼çš„ç±»å‹ä¸ºtmç»“æ„ï¼Œå³æ—¥å†æ—¶é—´çš„ç»“æ„æè¿°ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tm</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> tm_sec;</span><br><span class="line">  <span class="keyword">int</span> tm_min</span><br><span class="line">  <span class="keyword">int</span> tm_hour;</span><br><span class="line">  <span class="keyword">int</span> tm_mday;</span><br><span class="line">  <span class="keyword">int</span> tm_mon;</span><br><span class="line">  <span class="keyword">int</span> tm_year;</span><br><span class="line">  <span class="keyword">int</span> tm_wday;</span><br><span class="line">  <span class="keyword">int</span> tm_yday;</span><br><span class="line">  <span class="keyword">int</span> tm_isdst;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸¤ç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>tm_monè¡¨ç¤ºçš„èŒƒå›´ä¸º[0, 11]ã€‚è½¬æ¢æˆæ—¥å¸¸ä½¿ç”¨çš„æœˆä»½è¡¨ç¤ºéœ€è¦+1ã€‚</li>
<li>tm_yearè¡¨ç¤ºçš„æ˜¯è‡ª1900å¹´ä¹‹åæ‰€è¿‡çš„å¹´ä»½æ•°ã€‚è½¬æ¢æˆæ—¥å¸¸ä½¿ç”¨çš„å¹´ä»½è¡¨ç¤ºéœ€è¦+1900ã€‚</li>
</ul>
<p>ä¸‹é¢ç»™å‡ºç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">time_t</span> now = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">tm* gm_time = <span class="built_in">gmtime</span>(&amp;now);</span><br><span class="line">tm* local_time = <span class="built_in">localtime</span>(&amp;now);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;gmtime: &quot;</span> &lt;&lt; <span class="built_in">asctime</span>(gm_time);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;local_time: &quot;</span> &lt;&lt; <span class="built_in">asctime</span>(local_time);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">gmtime: Tue May <span class="number">18</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">48</span> <span class="number">2021</span></span><br><span class="line">local_time: Tue May <span class="number">18</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">48</span> <span class="number">2021</span></span><br></pre></td></tr></table></figure>



<h3 id="è¾“å‡ºæ—¶é—´å’Œæ—¥æœŸ"><a href="#è¾“å‡ºæ—¶é—´å’Œæ—¥æœŸ" class="headerlink" title="è¾“å‡ºæ—¶é—´å’Œæ—¥æœŸ"></a>è¾“å‡ºæ—¶é—´å’Œæ—¥æœŸ</h3><p>è·å–äº†æ—¶é—´ï¼Œæˆ‘ä»¬è‡ªç„¶æƒ³è¦å°†æ—¶é—´ä»¥å­—ç¬¦ä¸²çš„å½¢å¼æ‰“å°å‡ºæ¥ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨ctimeå‡½æ•°ã€‚</p>
<p>åº”æ³¨æ„çš„æ˜¯ï¼Œctimeå‡½æ•°æ‰“å°çš„æ ¼å¼æ˜¯å›ºå®šçš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Www Mmm dd hh:mm:ss yyyy\n</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">time_t</span> now = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;Now is: &quot;</span> &lt;&lt; <span class="built_in">ctime</span>(&amp;now);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Now is: Tue May 18 21:39:46 2021</span><br></pre></td></tr></table></figure>

<p>è€Œtmå‚¨å­˜çš„æ—¥æœŸæ—¶é—´ç»“æ„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨asctimeå‡½æ•°å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼ã€‚</p>
<p>ç„¶è€Œï¼Œctimeå’Œasctimeå‡½æ•°å…¶è¾“å‡ºçš„æ ¼å¼éƒ½æ˜¯å›ºå®šçš„ï¼Œåœ¨æœ‰æ ¼å¼è¦æ±‚çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§åšæ³•ï¼š</p>
<ol>
<li><p>æ‹†åˆ†tmç»“æ„ä½“çš„å­—æ®µï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">time_t now = time(nullptr);</span><br><span class="line">tm* t = localtime(&amp;now);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; &quot;Now is: &quot; &lt;&lt; t-&gt;tm_year + 1900 &lt;&lt; &quot;/&quot; &lt;&lt; t-&gt;tm_mon + 1&lt;&lt; &quot;/&quot; &lt;&lt; t-&gt;tm_mday &lt;&lt; &quot; &quot;;</span><br><span class="line">cout &lt;&lt; t-&gt;tm_hour &lt;&lt; &quot;:&quot; &lt;&lt; t-&gt;tm_min &lt;&lt; &quot;:&quot; &lt;&lt; t-&gt;tm_sec &lt;&lt; endl;</span><br></pre></td></tr></table></figure></li>
<li><p>ä½¿ç”¨strftimeæˆ–è€…wcsftimeå‡½æ•°æ¥æŒ‡å®šæ ¼å¼è¾“å‡ºã€‚å‡½æ•°æ ¼å¼å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡æ¡£ï¼š</p>
<p><a href="https://zh.cppreference.com/w/cpp/chrono/c/strftime">https://zh.cppreference.com/w/cpp/chrono/c/strftime</a></p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;locale&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::locale::<span class="built_in">global</span>(std::<span class="built_in">locale</span>(<span class="string">&quot;ja_JP.utf8&quot;</span>));</span><br><span class="line">    std::<span class="keyword">time_t</span> t = std::<span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">char</span> mbstr[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">if</span> (std::<span class="built_in">strftime</span>(mbstr, <span class="built_in"><span class="keyword">sizeof</span></span>(mbstr), <span class="string">&quot;%A %c&quot;</span>, std::<span class="built_in">localtime</span>(&amp;t))) &#123;</span><br><span class="line">        std::cout &lt;&lt; mbstr &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç«æ›œæ—¥ 2011å¹´12æœˆ27æ—¥ 17æ™‚39åˆ†03ç§’</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="C-17æ–°å†…å®¹timespecï¼Œè¿ˆå‘çº³ç§’ç²¾åº¦"><a href="#C-17æ–°å†…å®¹timespecï¼Œè¿ˆå‘çº³ç§’ç²¾åº¦" class="headerlink" title="C++17æ–°å†…å®¹timespecï¼Œè¿ˆå‘çº³ç§’ç²¾åº¦"></a>C++17æ–°å†…å®¹timespecï¼Œè¿ˆå‘çº³ç§’ç²¾åº¦</h3><p>çºªå…ƒæ—¶é—´çš„ç²¾åº¦åªæœ‰ç§’ï¼Œè¿™åœ¨å¾ˆå¤šæ—¶å€™æ˜¯ä¸å¤Ÿç”¨çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++17å¢åŠ timespecç±»å‹ï¼Œæä¾›äº†çº³ç§’çº§åˆ«çš„ç²¾åº¦ã€‚</p>
<p>ä¸€äº›ç†Ÿæ‚‰Cè¯­è¨€çš„æœ‹å‹å¯èƒ½ä¼šç«‹å³æ»¡å¤´é—®å·ï¼štimespecä¸æ˜¯åœ¨C11ï¼ˆæ³¨æ„çœ‹ï¼Œæ˜¯C11ï¼Œä¸æ˜¯CPP11ï¼‰å°±å·²ç»å¼•å…¥äº†ä¹ˆï¼Ÿ</p>
<p>ä½†äº‹å®çš„ç¡®å¦‚æ­¤ï¼Œä¸¥æ ¼çš„C++çš„C-Styleæ—¥æœŸæ—¶é—´åº“ï¼Œåœ¨C++17æ ‡å‡†æ‰æ­£å¼å¼•å…¥timespecç±»å‹ã€‚</p>
<p>timespecç±»å‹ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> &#123;</span></span><br><span class="line">  std::<span class="keyword">time_t</span> tv_sec;</span><br><span class="line">  <span class="keyword">long</span> tv_nsec;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­tv_nsecæˆå‘˜ä¿å­˜äº†çº³ç§’æ•°ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">timespec ts;</span><br><span class="line"><span class="built_in">timespec_get</span>(&amp;ts, TIME_UTC);</span><br><span class="line"><span class="keyword">char</span> buff[<span class="number">100</span>];</span><br><span class="line"><span class="built_in">strftime</span>(buff, <span class="keyword">sizeof</span> buff, <span class="string">&quot;%D %T&quot;</span>, std::<span class="built_in">gmtime</span>(&amp;ts.tv_sec));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Current time: %s.%09ld UTC\n&quot;</span>, buff, ts.tv_nsec);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Current time: <span class="number">05</span>/<span class="number">18</span>/<span class="number">21</span> <span class="number">13</span>:<span class="number">50</span>:<span class="number">58.667861100</span> UTC</span><br></pre></td></tr></table></figure>



<p>C-Styleæ—¥æœŸæ—¶é—´åº“è‡³æ­¤å·²åŸºæœ¬ç»“æŸï¼Œæ¥ä¸‹æ¥è®²è§£C++11èµ·æ–°å¢çš„chronoåº“ã€‚</p>
<hr>
<h2 id="0x04-chronoåº“"><a href="#0x04-chronoåº“" class="headerlink" title="0x04 chronoåº“"></a>0x04 chronoåº“</h2><p>chronoæ˜¯ä»¥å„ç§ç²¾åº¦è·Ÿè¸ªæ—¶é—´çš„ç±»å‹çš„çµæ´»æ±‡é›†ã€‚chronoåº“å®šä¹‰ä¸‰ç§ä¸»è¦ç±»å‹ä»¥åŠå·¥å…·å‡½æ•°å’Œå¸¸ç”¨çš„typedefï¼š</p>
<ul>
<li>æ—¶é’Ÿ</li>
<li>æ—¶é•¿</li>
<li>æ—¶é—´ç‚¹</li>
</ul>
<h3 id="æ—¶é’Ÿ"><a href="#æ—¶é’Ÿ" class="headerlink" title="æ—¶é’Ÿ"></a>æ—¶é’Ÿ</h3><p>C++11çš„chronoåº“ä¸»è¦åŒ…å«äº†ä¸‰ç§ç±»å‹çš„æ—¶é’Ÿï¼š</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>system_clock</td>
<td>æ¥è‡ªç³»ç»ŸèŒƒç•´å®æ—¶æ—¶é’Ÿçš„æŒ‚é’Ÿæ—¶é—´</td>
</tr>
<tr>
<td>steady_clock</td>
<td>å†³ä¸ä¼šè°ƒæ•´çš„å•è°ƒæ—¶é’Ÿ</td>
</tr>
<tr>
<td>high_resolution_clock</td>
<td>æ‹¥æœ‰å¯ç”¨çš„æœ€çŸ­å˜€å—’å‘¨æœŸçš„æ—¶é’Ÿ</td>
</tr>
</tbody></table>
<p>system_clockæ¥æºæ˜¯ç³»ç»Ÿæ—¶é’Ÿã€‚ç„¶è€Œåœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸Šï¼Œç³»ç»Ÿæ—¶é—´æ˜¯å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¢«è°ƒèŠ‚çš„ã€‚æ‰€ä»¥å¦‚æœç”¨æ¥è®¡ç®—ä¸¤ä¸ªæ—¶é—´ç‚¹çš„æ—¶é—´å·®ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚</p>
<p>steady_clockæ˜¯ä¸€ä¸ªå•è°ƒæ—¶é’Ÿã€‚æ­¤æ—¶é’Ÿçš„æ—¶é—´ç‚¹æ— æ³•å‡å°‘ï¼Œå› ä¸ºç‰©ç†åå‡ ä»¶å‘å‰ç§»åŠ¨ã€‚å› è€Œsteady_clockæ˜¯åº¦é‡é—´éš”çš„æœ€é€‚å®œçš„é€‰æ‹©ã€‚</p>
<p>high_resolution_clockè¡¨ç¤ºå®ç°æä¾›çš„æ‹¥æœ‰æœ€å°è®¡æ¬¡å‘¨æœŸçš„æ—¶é’Ÿã€‚å®ƒå¯ä»¥æ˜¯system_clockæˆ–steady_clockçš„åˆ«åï¼Œæˆ–è€…ç¬¬ä¸‰ä¸ªç‹¬ç«‹æ—¶é’Ÿã€‚</p>
<p>å¯¹äºhigh_resolution_clockï¼Œcppreferenceç»™å‡ºäº†ä»¥ä¸‹éœ€è¦æˆ‘ä»¬æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<p><a href="https://zh.cppreference.com/w/cpp/chrono/high_resolution_clock">https://zh.cppreference.com/w/cpp/chrono/high_resolution_clock</a></p>
<blockquote>
<p><code>high_resolution_clock</code> åœ¨ä¸åŒæ ‡å‡†åº“å®ç°ä¹‹é—´å®ç°ä¸ä¸€è‡´ï¼Œè€Œåº”è¯¥é¿å…ä½¿ç”¨å®ƒã€‚é€šå¸¸å®ƒåªæ˜¯ <a href="https://zh.cppreference.com/w/cpp/chrono/steady_clock">std::chrono::steady_clock</a> æˆ– <a href="https://zh.cppreference.com/w/cpp/chrono/system_clock">std::chrono::system_clock</a> çš„åˆ«åï¼Œä½†å®é™…æ˜¯å“ªä¸ªå–å†³äºåº“æˆ–é…ç½®ã€‚å®ƒæ˜¯ <code>system_clock</code> æ—¶ä¸æ˜¯å•è°ƒçš„ï¼ˆå³æ—¶é—´èƒ½åé€€ï¼‰ã€‚ä¾‹å¦‚å¯¹äº gcc çš„ libstdc++ å®ƒæ˜¯ <code>system_clock</code> ï¼Œå¯¹äº MSVC å®ƒæ˜¯ <code>steady_clock</code> ï¼Œè€Œå¯¹äº clang çš„ libc++ å®ƒå–å†³äºé…ç½®ã€‚</p>
<p>é€šå¸¸ç”¨æˆ·åº”è¯¥ç›´æ¥ä½¿ç”¨ <a href="https://zh.cppreference.com/w/cpp/chrono/steady_clock">std::chrono::steady_clock</a> æˆ– <a href="https://zh.cppreference.com/w/cpp/chrono/system_clock">std::chrono::system_clock</a> ä»£æ›¿ <code>std::chrono::high_resolution_clock</code> ï¼šå¯¹æ—¶é•¿åº¦é‡ä½¿ç”¨ <code>steady_clock</code> ï¼Œå¯¹å£é’Ÿæ—¶é—´ä½¿ç”¨ <code>system_clock</code> ã€‚</p>
</blockquote>
<p>å¯¹äºè¿™ä¸‰ä¸ªæ—¶é’Ÿç±»ï¼Œæœ‰ç€ä»¥ä¸‹å…±åŒçš„æˆå‘˜ï¼š</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>now()</td>
<td>é™æ€æˆå‘˜å‡½æ•°ï¼Œè¿”å›å½“å‰æ—¶é—´ï¼Œç±»å‹ä¸ºclock::time_point</td>
</tr>
<tr>
<td>time_point</td>
<td>æˆå‘˜ç±»å‹ï¼Œå½“å‰æ—¶é’Ÿçš„æ—¶é—´ç‚¹ç±»å‹ã€‚</td>
</tr>
<tr>
<td>duration</td>
<td>æˆå‘˜ç±»å‹ï¼Œæ—¶é’Ÿçš„æ—¶é•¿ç±»å‹ã€‚</td>
</tr>
<tr>
<td>rep</td>
<td>æˆå‘˜ç±»å‹ï¼Œæ—¶é’Ÿçš„tickç±»å‹ï¼Œç­‰åŒäºclock::duration::rep</td>
</tr>
<tr>
<td>period</td>
<td>æˆå‘˜ç±»å‹ï¼Œæ—¶é’Ÿçš„å•ä½ï¼Œç­‰åŒäºclock::duration::period</td>
</tr>
<tr>
<td>is_steady</td>
<td>é™æ€æˆå‘˜ç±»å‹ï¼šæ˜¯å¦æ˜¯ç¨³å®šæ—¶é’Ÿï¼Œå¯¹äºsteady_clockæ¥è¯´è¯¥å€¼ä¸€å®šæ˜¯true</td>
</tr>
</tbody></table>
<p>æ¯ä¸ªæ—¶é’Ÿç±»éƒ½æœ‰ç€ä¸€ä¸ªé™æ€æˆå‘˜å‡½æ•°<code>new()</code>æ¥è·å–å½“å‰æ—¶é—´ã€‚è¯¥å‡½æ•°çš„è¿”å›ç±»å‹åˆ™æ˜¯ç”±è¯¥æ—¶é’Ÿç±»çš„time_pointæè¿°ï¼Œä¾‹å¦‚<code>std::chrono::time_point&lt;std::chrono::system_clock&gt;</code>æˆ–è€…<code>std::chrono::time_point&lt;std::chrono::steady_clock&gt;</code>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨autoå…³é”®å­—æ¥ç®€å†™ï¼ˆautoæ˜¯ä¸ªå¥½æ–‡æ˜ï¼‰ã€‚</p>
<p>é˜…è¯»æ–‡æ¡£ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°system_clockæœ‰ç€ä¸å¦å¤–ä¸¤ä¸ªclockæ‰€ä¸å…·æœ‰çš„ç‰¹æ€§ï¼šå®ƒæ˜¯å”¯ä¸€æœ‰èƒ½åŠ›æ˜ å°„å…¶æ—¶é—´ç‚¹åˆ°C-Styleæ—¶é—´çš„C++æ—¶é’Ÿã€‚system_clockæä¾›äº†ä¸¤ä¸ªé™æ€æˆå‘˜å‡½æ•°æ¥ä¸std::time_tè¿›è¡Œäº’ç›¸è½¬æ¢ï¼š</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>to_time_t</td>
<td>è½¬æ¢ç³»ç»Ÿæ—¶é’Ÿæ—¶é—´ç‚¹ä¸º std::time_t</td>
</tr>
<tr>
<td>from_time_t</td>
<td>è½¬æ¢ std::time_t åˆ°ç³»ç»Ÿæ—¶é’Ÿæ—¶é—´ç‚¹</td>
</tr>
</tbody></table>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£å’Œè®°å¿†ï¼Œæˆ‘ä»¬ä¹Ÿç”¨ä¸€å‰¯å›¾æ¥æè¿°å‡ ç§æ—¶é—´ç±»å‹çš„è½¬æ¢ï¼š</p>
<p><img src="C:\Users\Skykey\Desktop\conversion.png"></p>
<h3 id="æ—¶é•¿"><a href="#æ—¶é•¿" class="headerlink" title="æ—¶é•¿"></a>æ—¶é•¿</h3><p>äººç±»å¯¹ç²¾åº¦çš„è¦æ±‚æ°¸æ— æ­¢å¢ƒã€‚C-Styleæ—¥æœŸæ—¶é—´åº“ä¸ºäº†æä¾›å¯¹çº³ç§’çš„ç²¾åº¦ï¼Œå¢åŠ äº†timespecç±»å‹åŠç›¸å…³çš„å‡½æ•°ã€‚é‚£å¦‚æœä»¥åå¯¹æ›´é«˜ç²¾åº¦çš„éœ€æ±‚è¶Šæ¥è¶Šé«˜ï¼ŒC++æ ‡å‡†åº“è¿˜è¦ä¸æ–­å¢åŠ æ›´å¤šçš„ç±»å‹å’Œé…å¥—å‡½æ•°å—ï¼Ÿè¿™æ˜æ˜¾æ˜¯ä¸€ä¸ªä¸åˆç†çš„è®¾è®¡ã€‚å› è€ŒC++æ ‡å‡†æå‡ºäº†ä¸€ä¸ªæ–°çš„è§£å†³æ€è·¯ï¼Œè€Œè¿™ä¸ªæ€è·¯æ¶‰åŠåˆ°äº†C++11å¼•å…¥çš„ä¸€ä¸ªæ–°çš„å¤´æ–‡ä»¶å’Œç±»å‹ï¼šratioã€‚</p>
<h4 id="ratio"><a href="#ratio" class="headerlink" title="ratio"></a>ratio</h4><p><code>std::ratio</code>å®šä¹‰åœ¨<code>&lt;ratio&gt;</code>æ–‡ä»¶ä¸­ï¼Œæä¾›äº†ç¼–è¯‘æœŸçš„æ¯”ä¾‹è®¡ç®—åŠŸèƒ½ã€‚</p>
<p><code>std::ratio</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;</span><br><span class="line">    std::<span class="keyword">intmax_t</span> Num,</span><br><span class="line">    std::<span class="keyword">intmax_t</span> Denom = <span class="number">1</span></span><br><span class="line">&gt; class ratio;</span><br></pre></td></tr></table></figure>

<p>ç±»æˆå‘˜Numå³ä¸ºåˆ†å­ï¼Œç±»æˆå‘˜Denomå³ä¸ºåˆ†æ¯ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡è°ƒç”¨ç±»æˆå‘˜æ¥è·å–ç›¸å…³å€¼ã€‚</p>
<p><code>&lt;ratio&gt;</code>å¤´æ–‡ä»¶è¿˜åŒ…å«äº†ï¼šratio_addï¼Œratio_subtractï¼Œratio_multiplyï¼Œratio_divideæ¥å®Œæˆåˆ†æ•°çš„åŠ å‡ä¹˜é™¤å››åˆ™è¿ç®—ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæƒ³è¦è®¡ç®—5/7 + 59/1023ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">ratio_add&lt;ratio&lt;<span class="number">5</span>, <span class="number">7</span>&gt;, ratio&lt;<span class="number">59</span>, <span class="number">1023</span>&gt;&gt; result;</span><br><span class="line"><span class="keyword">double</span> value = ((<span class="keyword">double</span>) result.num) / result.den;</span><br><span class="line">cout &lt;&lt; result.num &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; result.den &lt;&lt; <span class="string">&quot; = &quot;</span> &lt;&lt; value &lt;&lt; endl;</span><br></pre></td></tr></table></figure>



<p>å¯¹äºç¼–è¯‘æœŸæœ‰ç†æ•°ç®—æ•°çš„ç›¸å…³å†…å®¹ï¼Œå¯ä»¥åœ¨è¿™ç¯‡æ–‡æ¡£ä¸­æ‰¾åˆ°æ›´å¤šä¿¡æ¯ï¼š</p>
<p><a href="https://zh.cppreference.com/w/cpp/numeric/ratio">https://zh.cppreference.com/w/cpp/numeric/ratio</a></p>
<p>æœ‰äº†ratioä¹‹åï¼Œç»“åˆ<code>std::chrono::duration</code>ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥è¡¨ç¤ºä»»æ„ç²¾åº¦çš„å€¼äº†ã€‚</p>
<p>ä¾‹å¦‚ï¼Œç›¸å¯¹äºç§’æ¥è¯´ï¼Œæ¯«ç§’æ˜¯1/1,000ï¼Œå¾®ç§’æ˜¯1/1,000,000ï¼Œçº³ç§’æ˜¯1/1,000,000,000ã€‚é€šè¿‡ratioå°±å¯ä»¥è¿™æ ·è¡¨è¾¾ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">std::ratio&lt;<span class="number">1</span>, <span class="number">1000</span>&gt;       milliseconds;</span><br><span class="line">std::ratio&lt;<span class="number">1</span>, <span class="number">1000000</span>&gt;    microseconds;</span><br><span class="line">std::ratio&lt;<span class="number">1</span>, <span class="number">1000000000</span>&gt; nanoseconds;</span><br></pre></td></tr></table></figure>



<h4 id="æ—¶é•¿ç±»å‹"><a href="#æ—¶é•¿ç±»å‹" class="headerlink" title="æ—¶é•¿ç±»å‹"></a>æ—¶é•¿ç±»å‹</h4><p>ç±»æ¨¡æ¿ std::chrono::duration è¡¨ç¤ºæ—¶é—´é—´éš”ã€‚æœ‰äº†ratioä¹‹åï¼Œè¡¨è¾¾æ—¶é•¿å°±å¾ˆæ–¹ä¾¿äº†ï¼Œä¸‹é¢æ˜¯chronoåº“ä¸­æä¾›çš„å¾ˆå¸¸ç”¨çš„å‡ ä¸ªæ—¶é•¿å•ä½ï¼š</p>
<table>
<thead>
<tr>
<th align="left">ç±»å‹</th>
<th align="left">å®šä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">std::chrono::nanoseconds</td>
<td align="left">duration&lt;/*è‡³å°‘ 64 ä½çš„æœ‰ç¬¦å·æ•´æ•°ç±»å‹*/, std::nano&gt;</td>
</tr>
<tr>
<td align="left">std::chrono::microseconds</td>
<td align="left">duration&lt;/*è‡³å°‘ 55 ä½çš„æœ‰ç¬¦å·æ•´æ•°ç±»å‹*/, std::micro&gt;</td>
</tr>
<tr>
<td align="left">std::chrono::milliseconds</td>
<td align="left">duration&lt;/*è‡³å°‘ 45 ä½çš„æœ‰ç¬¦å·æ•´æ•°ç±»å‹*/, std::milli&gt;</td>
</tr>
<tr>
<td align="left">std::chrono::seconds</td>
<td align="left">duration&lt;/*è‡³å°‘ 35 ä½çš„æœ‰ç¬¦å·æ•´æ•°ç±»å‹*/&gt;</td>
</tr>
<tr>
<td align="left">std::chrono::minutes</td>
<td align="left">duration&lt;/*è‡³å°‘ 29 ä½çš„æœ‰ç¬¦å·æ•´æ•°ç±»å‹*/, std::ratio&lt;60Â»</td>
</tr>
<tr>
<td align="left">std::chrono::hours</td>
<td align="left">duration&lt;/*è‡³å°‘ 23 ä½çš„æœ‰ç¬¦å·æ•´æ•°ç±»å‹*/, std::ratio&lt;3600Â»</td>
</tr>
</tbody></table>
<p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨durationç±»çš„<code>count()</code>æˆå‘˜å‡½æ•°æ¥è·å–å…·ä½“æ•°å€¼ã€‚</p>
<h4 id="æ—¶é•¿è¿ç®—"><a href="#æ—¶é•¿è¿ç®—" class="headerlink" title="æ—¶é•¿è¿ç®—"></a>æ—¶é•¿è¿ç®—</h4><p>æ—¶é•¿è¿ç®—å¯ä»¥ç›´æ¥ä½¿ç”¨â€œ+â€æˆ–â€œ-â€ç›¸åŠ ç›¸å‡ã€‚chronoåº“ä¹Ÿæä¾›äº†å‡ ä¸ªå¸¸ç”¨çš„å‡½æ•°ï¼š</p>
<table>
<thead>
<tr>
<th align="left">å‡½æ•°</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">duration_cast</td>
<td align="left">è¿›è¡Œæ—¶é•¿çš„è½¬æ¢</td>
</tr>
<tr>
<td align="left">floor(C++17)</td>
<td align="left">ä»¥å‘ä¸‹å–æ•´çš„æ–¹å¼ï¼Œå°†ä¸€ä¸ªæ—¶é•¿è½¬æ¢ä¸ºå¦ä¸€ä¸ªæ—¶é•¿</td>
</tr>
<tr>
<td align="left">ceil(C++17)</td>
<td align="left">ä»¥å‘ä¸Šå–æ•´çš„æ–¹å¼ï¼Œå°†ä¸€ä¸ªæ—¶é•¿è½¬æ¢ä¸ºå¦ä¸€ä¸ªæ—¶é•¿</td>
</tr>
<tr>
<td align="left">round(C++17)</td>
<td align="left">è½¬æ¢æ—¶é•¿åˆ°å¦ä¸€ä¸ªæ—¶é•¿ï¼Œå°±è¿‘å–æ•´ï¼Œå¶æ•°ä¼˜å…ˆ</td>
</tr>
<tr>
<td align="left">abs(C++17)</td>
<td align="left">è·å–æ—¶é•¿çš„ç»å¯¹å€¼</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼šæƒ³è¦çŸ¥é“2ä¸ªå°æ—¶é›¶5åˆ†é’Ÿä¸€å…±æ˜¯å¤šå°‘ç§’ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">chrono::hours <span class="title">two_hours</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line"><span class="function">chrono::minutes <span class="title">five_minutes</span><span class="params">(<span class="number">5</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> duration = two_hours + five_minutes;</span><br><span class="line"><span class="keyword">auto</span> seconds = chrono::duration_cast&lt;chrono::seconds&gt;(duration);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;02:05 is &quot;</span> &lt;&lt; seconds.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds&quot;</span> &lt;&lt; endl;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">02:05 is 7500 seconds</span><br></pre></td></tr></table></figure>

<p>ä»C++14å¼€å§‹ï¼Œä½ ç”šè‡³å¯ä»¥ç”¨å­—é¢å€¼æ¥æè¿°å¸¸è§çš„æ—¶é•¿ã€‚è¿™åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>h</code>è¡¨ç¤ºå°æ—¶</li>
<li><code>min</code>è¡¨ç¤ºåˆ†é’Ÿ</li>
<li><code>s</code>è¡¨ç¤ºç§’</li>
<li><code>ms</code>è¡¨ç¤ºæ¯«ç§’</li>
<li><code>us</code>è¡¨ç¤ºå¾®å¦™</li>
<li><code>ns</code>è¡¨ç¤ºçº³ç§’</li>
</ul>
<p>è¿™äº›å­—é¢å€¼ä½äº<code>std::chrono_literals</code>å‘½åç©ºé—´ä¸‹ã€‚äºæ˜¯ï¼Œå¯ä»¥è¿™æ ·è¡¨è¾¾2ä¸ªå°æ—¶ä»¥åŠ5åˆ†é’Ÿï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="keyword">auto</span> two_hours = <span class="number">2</span>h;</span><br><span class="line"><span class="keyword">auto</span> five_minutes = <span class="number">5</span>min;</span><br></pre></td></tr></table></figure>



<h3 id="æ—¶é—´ç‚¹"><a href="#æ—¶é—´ç‚¹" class="headerlink" title="æ—¶é—´ç‚¹"></a>æ—¶é—´ç‚¹</h3><p>æ—¶é’Ÿçš„nowå‡½æ•°è¿”å›çš„å€¼å°±æ˜¯ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæ—¶é—´ç‚¹åŒ…å«äº†æ—¶é’Ÿå’Œæ—¶é•¿ä¸¤ä¸ªä¿¡æ¯ã€‚</p>
<p>ç±»æ¨¡æ¿<code>std::chrono::time_point</code>è¡¨ç¤ºæ—¶é—´ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Clock</span>,</span></span><br><span class="line"><span class="class">    <span class="keyword">class</span> <span class="title">Duration</span> =</span> <span class="keyword">typename</span> Clock::duration</span><br><span class="line">&gt; <span class="class"><span class="keyword">class</span> <span class="title">time_point</span>;</span></span><br></pre></td></tr></table></figure>

<p>ä¸æˆ‘ä»¬çš„å¸¸è¯†ä¸€è‡´ï¼Œæ—¶é—´ç‚¹å…·æœ‰åŠ æ³•å’Œå‡æ³•æ“ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ—¶é—´ç‚¹ + æ—¶é•¿ = æ—¶é—´ç‚¹</span><br><span class="line">æ—¶é—´ç‚¹ - æ—¶é—´ç‚¹ = æ—¶é•¿</span><br></pre></td></tr></table></figure>

<p>å› è€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ä¸ªæ—¶é—´ç‚¹ç›¸å‡æ¥è®¡ç®—ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> start = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"><span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000</span>; i++) &#123;</span><br><span class="line">    sum += <span class="built_in">sqrt</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">auto</span> end = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> time_diff = end - start;</span><br><span class="line"><span class="keyword">auto</span> duration = chrono::duration_cast&lt;chrono::milliseconds&gt;(time_diff);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;Operation cost : &quot;</span> &lt;&lt; duration.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;ms&quot;</span> &lt;&lt; endl;</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹Ÿå­˜åœ¨ç€æ¯”è¾ƒæ“ä½œï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ªæ—¶é—´ç‚¹åœ¨å¦å¤–ä¸€ä¸ªæ—¶é—´ç‚¹ä¹‹å‰è¿˜æ˜¯ä¹‹åï¼Œ<code>std::chrono::time_point</code>é‡è½½äº†<code>==</code>ï¼Œ<code>!=</code>ï¼Œ<code>&lt;</code>ï¼Œ<code>&lt;=</code>ï¼Œ<code>&gt;</code>ï¼Œ<code>&gt;=</code>æ“ä½œç¬¦æ¥å®ç°æ¯”è¾ƒæ“ä½œã€‚</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>C++11</tag>
        <tag>C++17</tag>
        <tag>å­¦ä¹ å¿ƒå¾—</tag>
        <tag>æ—¥æœŸä¸æ—¶é—´ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxä¸‹CMakeä½¿ç”¨</title>
    <url>/2020/07/21/cmake/</url>
    <content><![CDATA[<h1 id="Linuxä¸‹CMakeä½¿ç”¨æ–¹æ³•"><a href="#Linuxä¸‹CMakeä½¿ç”¨æ–¹æ³•" class="headerlink" title="Linuxä¸‹CMakeä½¿ç”¨æ–¹æ³•"></a>Linuxä¸‹CMakeä½¿ç”¨æ–¹æ³•</h1><p>åœ¨ linux å¹³å°ä¸‹ä½¿ç”¨ CMake ç”Ÿæˆ Makefile å¹¶ç¼–è¯‘çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¼–å†™ CMake é…ç½®æ–‡ä»¶ CMakeLists.txt ã€‚</li>
<li>æ‰§è¡Œå‘½ä»¤ <code>cmake PATH</code> æˆ–è€… <code>ccmake PATH</code> ç”Ÿæˆ Makefile 1 1<code>ccmake</code> å’Œ <code>cmake</code> çš„åŒºåˆ«åœ¨äºå‰è€…æä¾›äº†ä¸€ä¸ªäº¤äº’å¼çš„ç•Œé¢ã€‚ã€‚å…¶ä¸­ï¼Œ <code>PATH</code> æ˜¯ CMakeLists.txt æ‰€åœ¨çš„ç›®å½•ã€‚</li>
<li>ä½¿ç”¨ <code>make</code> å‘½ä»¤è¿›è¡Œç¼–è¯‘ã€‚</li>
</ol>
<p>æœ¬æ–‡å°†ä»å®ä¾‹å…¥æ‰‹ï¼Œä¸€æ­¥æ­¥è®²è§£ CMake çš„å¸¸è§ç”¨æ³•ï¼Œæ–‡ä¸­æ‰€æœ‰çš„å®ä¾‹ä»£ç å¯ä»¥åœ¨<a href="https://github.com/wzpan/cmake-demo">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚å¦‚æœä½ è¯»å®Œä»è§‰å¾—æ„çŠ¹æœªå°½ï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ æˆ‘åœ¨æ–‡ç« æœ«å°¾æä¾›çš„å…¶ä»–èµ„æºã€‚</p>
<span id="more"></span>

<h2 id="1-å•ä¸ªæºæ–‡ä»¶"><a href="#1-å•ä¸ªæºæ–‡ä»¶" class="headerlink" title="1.å•ä¸ªæºæ–‡ä»¶"></a>1.å•ä¸ªæºæ–‡ä»¶</h2><p>å¯¹äºç®€å•çš„é¡¹ç›®ï¼Œåªéœ€è¦å†™å‡ è¡Œä»£ç å°±å¯ä»¥äº†ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ç°åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­åªæœ‰ä¸€ä¸ªæºæ–‡ä»¶ <a href="http://main.cc/">main.c</a> ï¼Œé¦–å…ˆç¼–å†™ CMakeLists.txt æ–‡ä»¶ï¼Œå¹¶ä¿å­˜åœ¨ä¸ <a href="http://main.cc/">main.c</a> æºæ–‡ä»¶åŒä¸ªç›®å½•ä¸‹ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"><span class="comment"># é¡¹ç›®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">project</span> (Demo1)</span><br><span class="line"><span class="comment"># æŒ‡å®šç”Ÿæˆç›®æ ‡</span></span><br><span class="line"><span class="keyword">add_executable</span>(Demo1 main.cc)</span><br></pre></td></tr></table></figure>

<p>CMakeLists.txt çš„è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œç”±å‘½ä»¤ã€æ³¨é‡Šå’Œç©ºæ ¼ç»„æˆï¼Œå…¶ä¸­å‘½ä»¤æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ã€‚ç¬¦å· <code>#</code> åé¢çš„å†…å®¹è¢«è®¤ä¸ºæ˜¯æ³¨é‡Šã€‚å‘½ä»¤ç”±å‘½ä»¤åç§°ã€å°æ‹¬å·å’Œå‚æ•°ç»„æˆï¼Œå‚æ•°ä¹‹é—´ä½¿ç”¨ç©ºæ ¼è¿›è¡Œé—´éš”ã€‚</p>
<p>å¯¹äºä¸Šé¢çš„ ==CMakeLists.txt== æ–‡ä»¶ï¼Œä¾æ¬¡å‡ºç°äº†å‡ ä¸ªå‘½ä»¤ï¼š</p>
<ol>
<li><code>cmake_minimum_required</code>ï¼šæŒ‡å®šè¿è¡Œæ­¤é…ç½®æ–‡ä»¶æ‰€éœ€çš„ CMake çš„æœ€ä½ç‰ˆæœ¬ï¼›</li>
<li><code>project</code>ï¼šå‚æ•°å€¼æ˜¯ <code>Demo1</code>ï¼Œè¯¥å‘½ä»¤è¡¨ç¤ºé¡¹ç›®çš„åç§°æ˜¯ <code>Demo1</code> ã€‚</li>
<li><code>add_executable</code>ï¼š å°†åä¸º <a href="http://main.cc/">main.c</a> çš„æºæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªåç§°ä¸º Demo çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
</ol>
<p>ä¹‹åï¼Œåœ¨å½“å‰ç›®å½•æ‰§è¡Œ <strong><code>cmake .</code></strong> ï¼Œå¾—åˆ° Makefile åå†ä½¿ç”¨ <strong><code>make</code></strong> å‘½ä»¤ç¼–è¯‘å¾—åˆ° Demo1 å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<h2 id="2-å¤šä¸ªæºæ–‡ä»¶"><a href="#2-å¤šä¸ªæºæ–‡ä»¶" class="headerlink" title="2.å¤šä¸ªæºæ–‡ä»¶"></a>2.å¤šä¸ªæºæ–‡ä»¶</h2><h3 id="1-åŒä¸€ç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶"><a href="#1-åŒä¸€ç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶" class="headerlink" title="1) åŒä¸€ç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶"></a>1) åŒä¸€ç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶</h3><p>ä¸Šé¢çš„ä¾‹å­åªæœ‰å•ä¸ªæºæ–‡ä»¶ã€‚ç°åœ¨å‡å¦‚æŠŠ <code>power</code> å‡½æ•°å•ç‹¬å†™è¿›ä¸€ä¸ªåä¸º <code>MathFunctions.c</code> çš„æºæ–‡ä»¶é‡Œï¼Œä½¿å¾—è¿™ä¸ªå·¥ç¨‹å˜æˆå¦‚ä¸‹çš„å½¢å¼ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">./Demo2</span><br><span class="line">    |</span><br><span class="line">    +--- main.cc</span><br><span class="line">    |</span><br><span class="line">    +--- MathFunctions.cc</span><br><span class="line">    |</span><br><span class="line">    +--- MathFunctions.h</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™ï¼ŒCMakeLists.txt å¯ä»¥æ”¹æˆå¦‚ä¸‹çš„å½¢å¼ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"><span class="comment"># é¡¹ç›®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">project</span> (Demo2)</span><br><span class="line"><span class="comment"># æŒ‡å®šç”Ÿæˆç›®æ ‡</span></span><br><span class="line"><span class="keyword">add_executable</span>(Demo main.cc MathFunctions.cc)</span><br></pre></td></tr></table></figure>

<p>å”¯ä¸€çš„æ”¹åŠ¨åªæ˜¯åœ¨ <strong><code>add_executable</code></strong> å‘½ä»¤ä¸­å¢åŠ äº†ä¸€ä¸ª <strong><code>MathFunctions.cc</code></strong> æºæ–‡ä»¶ã€‚è¿™æ ·å†™å½“ç„¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæºæ–‡ä»¶å¾ˆå¤šï¼ŒæŠŠæ‰€æœ‰æºæ–‡ä»¶çš„åå­—éƒ½åŠ è¿›å»å°†æ˜¯ä¸€ä»¶çƒ¦äººçš„å·¥ä½œã€‚æ›´çœäº‹çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <strong><code>aux_source_directory</code></strong> å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä¼šæŸ¥æ‰¾æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶ï¼Œç„¶åå°†ç»“æœå­˜è¿›æŒ‡å®šå˜é‡åã€‚å…¶è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aux_source_directory(&lt;dir&gt; &lt;variable&gt;)</span><br></pre></td></tr></table></figure>

<p>å› æ­¤ï¼Œå¯ä»¥ä¿®æ”¹ CMakeLists.txt å¦‚ä¸‹ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"><span class="comment"># é¡¹ç›®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">project</span> (Demo2)</span><br><span class="line"><span class="comment"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_SRCS å˜é‡</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(. DIR_SRCS)</span><br><span class="line"><span class="comment"># æŒ‡å®šç”Ÿæˆç›®æ ‡</span></span><br><span class="line"><span class="keyword">add_executable</span>(Demo <span class="variable">$&#123;DIR_SRCS&#125;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼ŒCMake ä¼šå°†å½“å‰ç›®å½•æ‰€æœ‰æºæ–‡ä»¶çš„æ–‡ä»¶åèµ‹å€¼ç»™å˜é‡ <code>DIR_SRCS</code> ï¼Œå†æŒ‡ç¤ºå˜é‡ <code>DIR_SRCS</code> ä¸­çš„æºæ–‡ä»¶éœ€è¦ç¼–è¯‘æˆä¸€ä¸ªåç§°ä¸º Demo çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<h3 id="2-å¤šä¸ªç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶"><a href="#2-å¤šä¸ªç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶" class="headerlink" title="2) å¤šä¸ªç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶"></a>2) å¤šä¸ªç›®å½•ï¼Œå¤šä¸ªæºæ–‡ä»¶</h3><p>ç°åœ¨è¿›ä¸€æ­¥å°† MathFunctions.h å’Œ <a href="http://mathfunctions.cc/">MathFunctions.cc</a> æ–‡ä»¶ç§»åŠ¨åˆ° math ç›®å½•ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./Demo3</span><br><span class="line">    |</span><br><span class="line">    +--- main.cc</span><br><span class="line">    |</span><br><span class="line">    +--- math/</span><br><span class="line">          |</span><br><span class="line">          +--- MathFunctions.cc</span><br><span class="line">          |</span><br><span class="line">          +--- MathFunctions.h</span><br></pre></td></tr></table></figure>

<p>äºè¿™ç§æƒ…å†µï¼Œéœ€è¦åˆ†åˆ«åœ¨é¡¹ç›®æ ¹ç›®å½• Demo3 å’Œ math ç›®å½•é‡Œå„ç¼–å†™ä¸€ä¸ª CMakeLists.txt æ–‡ä»¶ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°† math ç›®å½•é‡Œçš„æ–‡ä»¶ç¼–è¯‘æˆé™æ€åº“å†ç”± main å‡½æ•°è°ƒç”¨ã€‚</p>
<p>æ ¹ç›®å½•ä¸­çš„ CMakeLists.txt ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"><span class="comment"># é¡¹ç›®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">project</span> (Demo3)</span><br><span class="line"><span class="comment"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_SRCS å˜é‡</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(. DIR_SRCS)</span><br><span class="line"><span class="comment"># æ·»åŠ  math å­ç›®å½•</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(<span class="keyword">math</span>)</span><br><span class="line"><span class="comment"># æŒ‡å®šç”Ÿæˆç›®æ ‡ </span></span><br><span class="line"><span class="keyword">add_executable</span>(Demo main.cc)</span><br><span class="line"><span class="comment"># æ·»åŠ é“¾æ¥åº“</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(Demo MathFunctions)</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–‡ä»¶æ·»åŠ äº†ä¸‹é¢çš„å†…å®¹: ç¬¬3è¡Œï¼Œä½¿ç”¨å‘½ä»¤ <strong><code>add_subdirectory</code></strong> æŒ‡æ˜æœ¬é¡¹ç›®åŒ…å«ä¸€ä¸ªå­ç›®å½• mathï¼Œè¿™æ · <strong>math ç›®å½•ä¸‹çš„ CMakeLists.txt æ–‡ä»¶å’Œæºä»£ç ä¹Ÿä¼šè¢«å¤„ç†</strong> ã€‚ç¬¬6è¡Œï¼Œä½¿ç”¨å‘½ä»¤ <strong><code>target_link_libraries</code></strong> æŒ‡æ˜å¯æ‰§è¡Œæ–‡ä»¶ main éœ€è¦è¿æ¥ä¸€ä¸ªåä¸º MathFunctions çš„é“¾æ¥åº“ ã€‚</p>
<p>==å­ç›®å½•ä¸­çš„ CMakeLists.txt==ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_LIB_SRCS å˜é‡</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(. DIR_LIB_SRCS)</span><br><span class="line"><span class="comment"># ç”Ÿæˆé“¾æ¥åº“</span></span><br><span class="line"><span class="keyword">add_library</span> (MathFunctions <span class="variable">$&#123;DIR_LIB_SRCS&#125;</span>)</span><br></pre></td></tr></table></figure>

<p>åœ¨è¯¥æ–‡ä»¶ä¸­ä½¿ç”¨å‘½ä»¤ <code>add_library</code> å°† src ç›®å½•ä¸­çš„æºæ–‡ä»¶ç¼–è¯‘ä¸ºé™æ€é“¾æ¥åº“ã€‚</p>
<h2 id="3-æ­£è§„ä¸€ç‚¹çš„ç»„ç»‡ç»“æ„"><a href="#3-æ­£è§„ä¸€ç‚¹çš„ç»„ç»‡ç»“æ„" class="headerlink" title="3.æ­£è§„ä¸€ç‚¹çš„ç»„ç»‡ç»“æ„"></a>3.æ­£è§„ä¸€ç‚¹çš„ç»„ç»‡ç»“æ„</h2><p>æ­£è§„ä¸€ç‚¹æ¥è¯´ï¼Œä¸€èˆ¬ä¼šæŠŠæºæ–‡ä»¶æ”¾åˆ°<strong>src</strong>ç›®å½•ä¸‹ï¼ŒæŠŠå¤´æ–‡ä»¶æ”¾å…¥åˆ°<strong>include</strong>æ–‡ä»¶ä¸‹ï¼Œç”Ÿæˆçš„å¯¹è±¡æ–‡ä»¶æ”¾å…¥åˆ°<strong>build</strong>ç›®å½•ä¸‹ï¼Œæœ€ç»ˆè¾“å‡ºçš„elfæ–‡ä»¶ä¼šæ”¾åˆ°<strong>bin</strong>ç›®å½•ä¸‹ï¼Œè¿™æ ·æ•´ä¸ªç»“æ„æ›´åŠ æ¸…æ™°ã€‚è®©æˆ‘ä»¬æŠŠå‰é¢çš„æ–‡ä»¶å†æ¬¡é‡æ–°ç»„ç»‡ä¸‹ï¼Œ</p>
<p>æˆ‘ä»¬åœ¨æœ€å¤–å±‚ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªCMakeLists.txtï¼Œå†…å®¹å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (demo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span> (src)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå‡ºç°ä¸€ä¸ªæ–°çš„å‘½ä»¤<code>add_subdirectory()</code>ï¼Œè¿™ä¸ªå‘½ä»¤==å¯ä»¥å‘å½“å‰å·¥ç¨‹æ·»åŠ å­˜æ”¾æºæ–‡ä»¶çš„å­ç›®å½•ï¼Œå¹¶å¯ä»¥æŒ‡å®šä¸­é—´äºŒè¿›åˆ¶å’Œç›®æ ‡äºŒè¿›åˆ¶çš„å­˜æ”¾ä½ç½®==ï¼Œå…·ä½“ç”¨æ³•å¯ä»¥ç™¾åº¦ã€‚<br>è¿™é‡ŒæŒ‡å®šsrcç›®å½•ä¸‹å­˜æ”¾äº†æºæ–‡ä»¶ï¼Œå½“æ‰§è¡Œcmakeæ—¶ï¼Œå°±ä¼šè¿›å…¥srcç›®å½•ä¸‹å»æ‰¾srcç›®å½•ä¸‹çš„CMakeLists.txtï¼Œæ‰€ä»¥åœ¨<strong>srcç›®å½•</strong>ä¸‹ä¹Ÿå»ºç«‹ä¸€ä¸ª<strong>CMakeLists.txt</strong>ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">aux_source_directory</span> (. SRC_LIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span> (../<span class="keyword">include</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span> (main <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> (EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/bin)</span><br></pre></td></tr></table></figure>


<p>è¿™é‡Œåˆå‡ºç°ä¸€ä¸ªæ–°çš„å‘½ä»¤<code>set</code>ï¼Œæ˜¯ç”¨äºå®šä¹‰å˜é‡çš„ï¼Œ<code>EXECUTABLE_OUT_PATH</code>å’Œ<code>PROJECT_SOURCE_DIR</code>æ˜¯CMakeè‡ªå¸¦çš„é¢„å®šä¹‰å˜é‡ï¼Œå…¶æ„ä¹‰å¦‚ä¸‹ï¼Œ</p>
<blockquote>
<p><strong>EXECUTABLE_OUTPUT_PATH</strong> ï¼šç›®æ ‡äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„å­˜æ”¾ä½ç½®<br><strong>PROJECT_SOURCE_DIR</strong>ï¼šå·¥ç¨‹çš„æ ¹ç›®å½•</p>
</blockquote>
<p>æ‰€ä»¥ï¼Œè¿™é‡Œsetçš„æ„æ€æ˜¯æŠŠå­˜æ”¾elfæ–‡ä»¶çš„ä½ç½®è®¾ç½®ä¸ºå·¥ç¨‹æ ¹ç›®å½•ä¸‹çš„binç›®å½•ã€‚</p>
<p>æ·»åŠ å¥½ä»¥ä¸Šè¿™2ä¸ªCMakeLists.txtåï¼Œæ•´ä½“æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼Œ</p>
<p>ä¸‹é¢æ¥è¿è¡Œcmakeï¼Œä¸è¿‡è¿™æ¬¡å…ˆè®©æˆ‘ä»¬åˆ‡åˆ°buildç›®å½•ä¸‹ï¼Œç„¶åè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œ<br><code>cmake ..</code><br>Makefileä¼šåœ¨buildç›®å½•ä¸‹ç”Ÿæˆï¼Œç„¶ååœ¨buildç›®å½•ä¸‹è¿è¡Œmakeï¼Œ</p>
<p>è¿è¡Œokï¼Œæˆ‘ä»¬å†åˆ‡åˆ°binç›®å½•ä¸‹ï¼Œå‘ç°mainå·²ç»ç”Ÿæˆï¼Œå¹¶è¿è¡Œæµ‹è¯•ï¼Œ</p>
<p>æµ‹è¯•OKï¼</p>
<blockquote>
<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆåœ¨buildç›®å½•ä¸‹è¿è¡Œcmakeï¼Ÿä»å‰é¢å‡ ä¸ªcaseä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¸è¿™æ ·åšï¼Œcmakeè¿è¡Œæ—¶ç”Ÿæˆçš„é™„å¸¦æ–‡ä»¶å°±ä¼šè·Ÿæºç æ–‡ä»¶æ··åœ¨ä¸€èµ·ï¼Œè¿™æ ·ä¼šå¯¹ç¨‹åºçš„ç›®å½•ç»“æ„é€ æˆæ±¡æŸ“ï¼Œè€Œåœ¨buildç›®å½•ä¸‹è¿è¡Œcmakeï¼Œç”Ÿæˆçš„é™„å¸¦æ–‡ä»¶å°±åªä¼šå¾…åœ¨buildç›®å½•ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬ä¸æƒ³è¦è¿™äº›æ–‡ä»¶äº†å°±å¯ä»¥ç›´æ¥æ¸…ç©ºbuildç›®å½•ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>
</blockquote>
<p>å¦å¤–ä¸€ç§å†™æ³•ï¼š<br>å‰é¢çš„å·¥ç¨‹ä½¿ç”¨äº†2ä¸ªCMakeLists.txtï¼Œè¿™ç§å†™æ³•æ˜¯ä¸ºäº†å¤„ç†éœ€è¦ç”Ÿæˆå¤šä¸ªelfæ–‡ä»¶çš„æƒ…å†µï¼Œæœ€å¤–å±‚çš„CMakeLists.txtç”¨äºæŒæ§å…¨å±€ï¼Œä½¿ç”¨<code>add_subdirectory</code>æ¥æ·»åŠ è¦ç”Ÿæˆelfæ–‡ä»¶çš„æºç ç›®å½•ã€‚</p>
<p>å¦‚æœåªç”Ÿæˆä¸€ä¸ªelfæ–‡ä»¶ï¼Œé‚£ä¹ˆä¸Šé¢çš„ä¾‹å­å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªCMakeLists.txtï¼Œå¯ä»¥æŠŠæœ€å¤–å±‚çš„CMakeLists.txtå†…å®¹æ”¹æˆå¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (demo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">aux_source_directory</span> (src SRC_LIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span> (<span class="keyword">include</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span> (main <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> (EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/bin)</span><br></pre></td></tr></table></figure>

<p>==åŒæ—¶ï¼Œè¿˜è¦æŠŠsrcç›®å½•ä¸‹çš„CMakeLists.txtåˆ é™¤ã€‚==</p>
<h2 id="4-åŠ¨æ€åº“å’Œé™æ€åº“çš„ç¼–è¯‘æ§åˆ¶"><a href="#4-åŠ¨æ€åº“å’Œé™æ€åº“çš„ç¼–è¯‘æ§åˆ¶" class="headerlink" title="4.åŠ¨æ€åº“å’Œé™æ€åº“çš„ç¼–è¯‘æ§åˆ¶"></a>4.åŠ¨æ€åº“å’Œé™æ€åº“çš„ç¼–è¯‘æ§åˆ¶</h2><p>æœ‰æ—¶æˆ‘ä»¬åªéœ€è¦ç¼–è¯‘å‡ºåŠ¨æ€åº“ï¼Œé™æ€åº“ï¼Œç„¶åç­‰ç€è®©å…¶å®ƒç¨‹åºå»ä½¿ç”¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹è¿™ç§æƒ…å†µè¯¥å¦‚ä½•ä½¿ç”¨cmakeã€‚é¦–å…ˆæŒ‰ç…§å¦‚ä¸‹é‡æ–°ç»„ç»‡æ–‡ä»¶ï¼Œåªç•™ä¸‹testFunc.hå’ŒTestFunc.cï¼Œ</p>
<p>æˆ‘ä»¬ä¼šåœ¨buildç›®å½•ä¸‹è¿è¡Œcmakeï¼Œå¹¶æŠŠç”Ÿæˆçš„åº“æ–‡ä»¶å­˜æ”¾åˆ°libç›®å½•ä¸‹ã€‚<br><strong>æœ€å¤–å±‚</strong>çš„CMakeLists.txtå†…å®¹å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (demo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span> (lib_testFunc)</span><br></pre></td></tr></table></figure>

<p><strong>lib_testFunc</strong>ç›®å½•ä¸‹çš„CMakeLists.txtå¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">aux_source_directory</span> (. SRC_LIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span> (testFunc_shared SHARED <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"><span class="keyword">add_library</span> (testFunc_static STATIC <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set_target_properties</span> (testFunc_shared PROPERTIES OUTPUT_NAME <span class="string">&quot;testFunc&quot;</span>)</span><br><span class="line"><span class="keyword">set_target_properties</span> (testFunc_static PROPERTIES OUTPUT_NAME <span class="string">&quot;testFunc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> (LIBRARY_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/lib)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆå‡ºç°äº†æ–°çš„å‘½ä»¤å’Œé¢„å®šä¹‰å˜é‡ï¼Œ</p>
<blockquote>
<p><strong>add_library</strong>: ç”ŸæˆåŠ¨æ€åº“æˆ–é™æ€åº“(ç¬¬1ä¸ªå‚æ•°æŒ‡å®šåº“çš„åå­—ï¼›ç¬¬2ä¸ªå‚æ•°å†³å®šæ˜¯åŠ¨æ€è¿˜æ˜¯é™æ€ï¼Œå¦‚æœæ²¡æœ‰å°±é»˜è®¤é™æ€ï¼›ç¬¬3ä¸ªå‚æ•°æŒ‡å®šç”Ÿæˆåº“çš„æºæ–‡ä»¶)<br><strong>set_target_properties</strong>: è®¾ç½®è¾“å‡ºçš„åç§°ï¼Œè¿˜æœ‰å…¶å®ƒåŠŸèƒ½ï¼Œå¦‚è®¾ç½®åº“çš„ç‰ˆæœ¬å·ç­‰ç­‰<br>LIBRARY_OUTPUT_PATH: åº“æ–‡ä»¶çš„é»˜è®¤è¾“å‡ºè·¯å¾„ï¼Œè¿™é‡Œè®¾ç½®ä¸ºå·¥ç¨‹ç›®å½•ä¸‹çš„libç›®å½•<br>å¥½äº†ï¼Œè®©æˆ‘ä»¬è¿›å…¥buildç›®å½•ä¸‹è¿è¡Œcmake ..ï¼ŒæˆåŠŸåå†è¿è¡Œmakeï¼Œ</p>
</blockquote>
<p>cdåˆ°libç›®å½•ä¸‹è¿›è¡ŒæŸ¥çœ‹ï¼Œå‘ç°å·²ç»æˆåŠŸç”Ÿæˆäº†åŠ¨æ€åº“å’Œé™æ€åº“ï¼Œ</p>
<blockquote>
<p>psï¼šå¯ä»¥çœ‹å‡ºå‰é¢ä½¿ç”¨<code>set_target_properties</code>é‡æ–°å®šä¹‰äº†åº“çš„è¾“å‡ºåå­—ï¼Œå¦‚æœä¸ç”¨<code>set_target_properties</code>ä¹Ÿå¯ä»¥ï¼Œé‚£ä¹ˆåº“çš„åå­—å°±æ˜¯<strong>add_library</strong>é‡Œå®šä¹‰çš„åå­—ï¼Œåªæ˜¯æˆ‘ä»¬è¿ç»­2æ¬¡ä½¿ç”¨add_libraryæŒ‡å®šåº“åå­—æ—¶ï¼Œè¿™ä¸ªåå­—ä¸èƒ½ç›¸åŒï¼Œè€Œ<code>set_target_properties</code>å¯ä»¥æŠŠåå­—è®¾ç½®ä¸ºç›¸åŒï¼Œåªæ˜¯æœ€ç»ˆç”Ÿæˆçš„åº“æ–‡ä»¶åç¼€ä¸åŒï¼Œè¿™æ ·ç›¸å¯¹æ¥è¯´ä¼šå¥½çœ‹ç‚¹ã€‚</p>
</blockquote>
<h2 id="5-å¯¹åº“è¿›è¡Œé“¾æ¥"><a href="#5-å¯¹åº“è¿›è¡Œé“¾æ¥" class="headerlink" title="5.å¯¹åº“è¿›è¡Œé“¾æ¥"></a>5.å¯¹åº“è¿›è¡Œé“¾æ¥</h2><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»ç”Ÿæˆäº†åº“ï¼Œé‚£ä¹ˆå°±è¿›è¡Œé“¾æ¥æµ‹è¯•ä¸‹ã€‚æŠŠbuildé‡Œçš„æ–‡ä»¶éƒ½åˆ é™¤ï¼Œç„¶ååœ¨åœ¨å·¥ç¨‹ç›®å½•ä¸‹æ–°å»ºsrcç›®å½•å’Œbinç›®å½•ï¼Œåœ¨srcç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªmain.cå’Œä¸€ä¸ªCMakeLists.txtï¼Œæ•´ä½“ç»“æ„å¦‚ä¸‹ï¼Œ</p>
<p><img src="https://img-blog.csdn.net/20180827221422465?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3doYWh1MTk4OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<p><strong>main.c</strong>å†…å®¹å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;testFunc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    func(<span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹å·¥ç¨‹ç›®å½•ä¸‹çš„CMakeLists.txt</strong>ï¼Œå¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (demo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span> (lib_testFunc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span> (src)</span><br></pre></td></tr></table></figure>

<p>åªæ˜¯ä½¿ç”¨<code>add_subdirectory</code>æŠŠ<strong>src</strong>ç›®å½•æ·»åŠ è¿›æ¥ã€‚<br><strong>src</strong>ç›®å½•ä¸‹çš„CMakeLists.txtå¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">aux_source_directory</span> (. SRC_LIST)</span><br><span class="line"><span class="comment"># find testFunc.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span> (../lib_testFunc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">link_directories</span> (<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/lib)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span> (main <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span> (main testFunc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> (EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/bin)</span><br></pre></td></tr></table></figure>


<p>è¿™é‡Œå‡ºç°2ä¸ªæ–°çš„å‘½ä»¤ï¼Œ</p>
<blockquote>
<p><code>link_directories</code>: æ·»åŠ éæ ‡å‡†çš„å…±äº«åº“æœç´¢è·¯å¾„<br><code>target_link_libraries</code>: æŠŠç›®æ ‡æ–‡ä»¶ä¸åº“æ–‡ä»¶è¿›è¡Œé“¾æ¥</p>
</blockquote>
<p>makeæˆåŠŸï¼Œè¿›å…¥åˆ°binç›®å½•ä¸‹æŸ¥çœ‹ï¼Œå‘ç°mainå·²ç»ç”Ÿæˆï¼Œå¹¶è¿è¡Œï¼Œ</p>
<p>è¿è¡ŒæˆåŠŸï¼</p>
<blockquote>
<p>psï¼šåœ¨libç›®å½•ä¸‹æœ‰testFuncçš„é™æ€åº“å’ŒåŠ¨æ€åº“ï¼Œ<code>target_link_libraries (main testFunc)</code>é»˜è®¤æ˜¯ä½¿ç”¨åŠ¨æ€åº“ï¼Œå¦‚æœlibç›®å½•ä¸‹åªæœ‰é™æ€åº“ï¼Œé‚£ä¹ˆè¿™ç§å†™æ³•å°±ä¼šå»é“¾æ¥é™æ€åº“ã€‚ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šä½¿ç”¨åŠ¨æ€åº“è¿˜æ˜¯é™æ€åº“ï¼Œå†™æ³•æ˜¯ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span> (main libtestFunc.so)</span><br><span class="line"><span class="comment">#æˆ–</span></span><br><span class="line"><span class="keyword">target_link_libraries</span> (main libtestFunc.a)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>psï¼š æŸ¥çœ‹elfæ–‡ä»¶ä½¿ç”¨äº†å“ªäº›åº“ï¼Œå¯ä»¥ä½¿ç”¨<code>readelf -d ./xx</code>æ¥æŸ¥çœ‹</p>
</blockquote>
<h2 id="6-æ·»åŠ ç¼–è¯‘é€‰é¡¹"><a href="#6-æ·»åŠ ç¼–è¯‘é€‰é¡¹" class="headerlink" title="6.æ·»åŠ ç¼–è¯‘é€‰é¡¹"></a>6.æ·»åŠ ç¼–è¯‘é€‰é¡¹</h2><p>æœ‰æ—¶ç¼–è¯‘ç¨‹åºæ—¶æƒ³æ·»åŠ ä¸€äº›ç¼–è¯‘é€‰é¡¹ï¼Œå¦‚<code>-Wall</code>ï¼Œ<code>-std=c++11</code>ç­‰ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>add_compile_options</code>æ¥è¿›è¡Œæ“ä½œã€‚<br>è¿™é‡Œä»¥ä¸€ä¸ªç®€å•ç¨‹åºæ¥åšæ¼”ç¤ºï¼Œmain.cppå¦‚ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> data = <span class="number">100</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;data: &quot;</span> &lt;&lt; data &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>CMakeLists.txtå†…å®¹å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (demo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> (EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/bin)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_compile_options</span>(-std=c++<span class="number">11</span> -Wall) </span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(main main.cpp)</span><br></pre></td></tr></table></figure>


<p>æ•´ä½“ç›®å½•ç»“æ„å¦‚ä¸‹ï¼Œ</p>
<p><img src="https://img-blog.csdnimg.cn/20190718210743197.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç„¶åcdåˆ°buildç›®å½•ä¸‹ï¼Œæ‰§è¡Œ<code>cmake .. &amp;&amp; make</code>å‘½ä»¤ï¼Œå°±å¯ä»¥åœ¨binç›®å½•ä¸‹å¾—åˆ°mainçš„elfæ–‡ä»¶</p>
<h2 id="7-æ·»åŠ æ§åˆ¶é€‰é¡¹"><a href="#7-æ·»åŠ æ§åˆ¶é€‰é¡¹" class="headerlink" title="7. æ·»åŠ æ§åˆ¶é€‰é¡¹"></a>7. æ·»åŠ æ§åˆ¶é€‰é¡¹</h2><p>æœ‰æ—¶å¸Œæœ›åœ¨<strong>ç¼–è¯‘ä»£ç æ—¶åªç¼–è¯‘ä¸€äº›æŒ‡å®šçš„æºç </strong>ï¼Œä¾‹å¦‚æœ¬æ¥è¦ç¼–è¯‘ç”Ÿæˆå¤šä¸ªbinæˆ–åº“æ–‡ä»¶ï¼Œç°åœ¨<strong>åªæƒ³ç”ŸæˆæŸäº›æŒ‡å®šçš„binæˆ–åº“æ–‡ä»¶</strong>ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨cmakeçš„<strong>option</strong>å‘½ä»¤ã€‚</p>
<p>è¿™é‡Œä»ç„¶ä½¿ç”¨ä¾‹å­æ¥è§£é‡Šï¼Œå‡è®¾æˆ‘ä»¬ç°åœ¨çš„å·¥ç¨‹ä¼šç”Ÿæˆ2ä¸ªbinæ–‡ä»¶ï¼Œmain1å’Œmain2ï¼Œç°åœ¨æ•´ä½“ç»“æ„ä½“å¦‚ä¸‹ï¼Œ</p>
<p><img src="https://img-blog.csdnimg.cn/20190811114036435.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3doYWh1MTk4OQ==,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å¤–å±‚çš„CMakeLists.txtå†…å®¹å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(demo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span>(MYDEBUG <span class="string">&quot;enable debug compilation&quot;</span> <span class="keyword">OFF</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> (EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/bin)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br></pre></td></tr></table></figure>


<p>è¿™é‡Œä½¿ç”¨äº†<code>option</code>å‘½ä»¤ï¼Œå…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¿™ä¸ªoptionçš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²ï¼Œç”¨æ¥æè¿°è¿™ä¸ªoptionæ˜¯æ¥å¹²å˜›çš„ï¼Œç¬¬ä¸‰ä¸ªæ˜¯optionçš„å€¼ï¼ŒONæˆ–OFFï¼Œä¹Ÿå¯ä»¥ä¸å†™ï¼Œä¸å†™å°±æ˜¯é»˜è®¤OFFã€‚</p>
<p>ç„¶åç¼–å†™srcç›®å½•ä¸‹çš„CMakeLists.txtï¼Œå¦‚ä¸‹</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(main1 main1.c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (MYDEBUG)</span><br><span class="line">    <span class="keyword">add_executable</span>(main2 main2.c)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    <span class="keyword">message</span>(STATUS <span class="string">&quot;Currently is not in debug mode&quot;</span>)    </span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨äº†<code>if-else</code>æ¥æ ¹æ®optionæ¥å†³å®šæ˜¯å¦ç¼–è¯‘main2.c<br>å…¶ä¸­main1.cå’Œmain2.cçš„å†…å®¹å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main1.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, this main1\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main2.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, this main2\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ç„¶åcdåˆ°buildç›®å½•ä¸‹è¾“å…¥<code>cmake .. &amp;&amp; make</code>å°±å¯ä»¥åªç¼–è¯‘å‡ºmain1ï¼Œå¦‚æœæƒ³ç¼–è¯‘å‡ºmain2ï¼Œå°±æŠŠ<code>MYDEBUG</code>è®¾ç½®ä¸º<strong>ON</strong>ï¼Œå†æ¬¡è¾“å…¥<code>cmake .. &amp;&amp; make</code>é‡æ–°ç¼–è¯‘ã€‚</p>
<p>æ¯æ¬¡æƒ³æ”¹å˜MYDEBUGæ—¶éƒ½éœ€è¦å»ä¿®æ”¹CMakeLists.txtï¼Œæœ‰ç‚¹éº»çƒ¦ï¼Œå…¶å®å¯ä»¥é€šè¿‡cmakeçš„å‘½ä»¤è¡Œå»æ“ä½œï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³æŠŠMYDEBUGè®¾ç½®ä¸ºOFFï¼Œå…ˆcdåˆ°buildç›®å½•ï¼Œç„¶åè¾“å…¥<code>cmake .. -DMYDEBUG=ON</code>ï¼Œè¿™æ ·å°±å¯ä»¥ç¼–è¯‘å‡ºmain1å’Œmain2 ï¼ˆåœ¨binç›®å½•ä¸‹ï¼‰</p>
<blockquote>
<p>æ¥æºï¼š<a href="https://blog.csdn.net/qq_28114615/article/details/90406140">https://blog.csdn.net/qq_28114615/article/details/90406140</a></p>
</blockquote>
<p><em>2020.3.29 19:01</em></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>cmake</tag>
        <tag>è½¬è½½</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºC++11å®ç°çº¿ç¨‹æ± </title>
    <url>/2021/04/23/cpp11-thread-pool/</url>
    <content><![CDATA[<h1 id="åŸºäºC-11å®ç°çº¿ç¨‹æ± "><a href="#åŸºäºC-11å®ç°çº¿ç¨‹æ± " class="headerlink" title="åŸºäºC++11å®ç°çº¿ç¨‹æ± "></a>åŸºäºC++11å®ç°çº¿ç¨‹æ± </h1><h2 id="0x00-å¯¼å…¥"><a href="#0x00-å¯¼å…¥" class="headerlink" title="0x00 å¯¼å…¥"></a>0x00 å¯¼å…¥</h2><p>å‰äº›æ—¥å­é€šè¿‡é˜…è¯»å‡ ç¯‡åšå®¢ï¼Œå¤§ä½“å­¦ä¹ äº†ä¸€ä¸‹C++çš„å¹¶å‘ç¼–ç¨‹ï¼ˆä¸»è¦æ˜¯å¤šçº¿ç¨‹ã€å¼‚æ­¥éƒ¨åˆ†ï¼‰ã€‚æ‰‹æ’¸äº†ä¸€ä¸ªå¤šç”Ÿäº§è€…-å¤šæ¶ˆè´¹è€…æ¨¡å‹ä¹‹åï¼Œæœ€ç»ˆè§‰å¾—è¿™ä¹Ÿåªæ˜¯å°æ‰“å°é—¹è€Œå·²ï¼Œéœ€è¦æ•´ä¸ªç¡¬è´§ã€‚ç»è¿‡ä¸€ç•ªæ€è€ƒä¹‹åï¼Œæ‰‹æ’¸ä¸€ä¸ªçº¿ç¨‹æ± è²Œä¼¼æ˜¯ä¸€ä¸ªéå¸¸åˆé€‚çš„ç»ƒä¹ ã€‚çº¿ç¨‹æ± å‰å‰ååä¸€å…±æŠ˜è…¾äº†å››äº”ä¸ªå°æ—¶å·¦å³ï¼Œæœ€ä»¤æˆ‘æ„å¤–çš„æ˜¯â€”â€”åŸæœ¬ä»¥ä¸ºæœ€éš¾ç†è§£çš„å¹¶å‘éƒ¨åˆ†åè€Œæ˜¯æœ€ç®€å•çš„éƒ¨åˆ†ï¼Œçº¿ç¨‹æ± å®ç°ä¸­å¤§é‡çš„CPP11è¯­æ³•ç³–æ‰æ˜¯çœŸæ­£å½±å“æˆ‘ç†è§£çš„éƒ¨åˆ†ã€‚ç»è¿‡ä¸‰å››ä¸ªå°æ—¶çš„é˜…è¯»åšæ–‡ã€æŸ¥é˜…èµ„æ–™ä»¥åŠå‘å¤§ä½¬æ±‚æ•™ä¹‹åï¼Œæˆ‘æ‰çœŸæ­£å¯¹çº¿ç¨‹æ± å®ç°æœ‰äº†æ¯”è¾ƒæ·±å…¥åœ°ç†è§£ã€‚â€œçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚â€ç»å†è¿™ä¸€ç•ªæŠ˜è…¾åæ‰æ¸…æ¥šåœ°è®¤è¯†åˆ°äº†è‡ªå·±å¯¹CPP11ç†è§£çš„è–„å¼±ï¼Œé‚å†™ä¸‹è¿™ç¯‡åšå®¢æ¥æ€»ç»“è‡ªå·±å¯¹çº¿ç¨‹æ± å®ç°ä»¥åŠæ‰€æ¶‰åŠåˆ°çš„CPP11è¯­æ³•ç³–çš„ç†è§£ï¼Œæ–¹ä¾¿è‡ªå·±ä»¥åå†æ¬¡é˜…è¯»æºç æ—¶æœ‰æ‰€è€ƒæ®ã€‚</p>
<p>æ–‡ç« å¤§é‡å€Ÿé‰´ã€èŠ‚é€‰äº†ä¼—å¤šå‚è€ƒèµ„æ–™ï¼Œå¹¶ç»“åˆè‡ªå·±çš„ç†è§£è¿›è¡Œè®²è§£ã€‚å‚è€ƒèµ„æ–™ä¼šåœ¨æœ€ååˆ—å‡ºã€‚</p>
<p>è¿™ç¯‡æ€»ç»“ä¼šå°†é‡å¿ƒæ”¾åœ¨C++11çš„è¯­æ³•ç³–ä¸Šï¼Œå¯¹äºC++11çš„å¹¶å‘ç¼–ç¨‹éƒ¨åˆ†ï¼ˆ<code>std::thread</code>, <code>std::future</code>ç­‰ï¼‰å°†ä»…è¿›è¡Œæœ€ç®€æ´æœ€å¿…è¦çš„é˜è¿°ã€‚æœ‰å…³å¹¶å‘ç¼–ç¨‹éƒ¨åˆ†å¯ä»¥ç§»æ­¥è‡³å‡ ç¯‡å¤§ä½¬æ€»ç»“çš„æ¯”è¾ƒå¥½çš„åšæ–‡ä¸­è¿›è¡Œè¡¥å……å­¦ä¹ ï¼š</p>
<ol>
<li>ã€ŠC++å¹¶å‘ç¼–ç¨‹ï¼ˆä»C++11åˆ°C++17ï¼‰ã€‹ï¼š<a href="https://paul.pub/cpp-concurrency">https://paul.pub/cpp-concurrency</a></li>
<li>ã€Šä»pthreadè½¬æ¢åˆ°std::threadã€‹ï¼š<a href="https://segmentfault.com/a/1190000002655852">https://segmentfault.com/a/1190000002655852</a></li>
<li>ã€Šè´§æ¯”ä¸‰å®¶ï¼šC++ä¸­çš„task basedå¹¶å‘ã€‹ï¼š<a href="https://segmentfault.com/a/1190000002706259">https://segmentfault.com/a/1190000002706259</a></li>
</ol>
<span id="more"></span>

<h2 id="0x01-é€æ­¥å®ç°çº¿ç¨‹æ± "><a href="#0x01-é€æ­¥å®ç°çº¿ç¨‹æ± " class="headerlink" title="0x01 é€æ­¥å®ç°çº¿ç¨‹æ± "></a>0x01 é€æ­¥å®ç°çº¿ç¨‹æ± </h2><h3 id="çº¿ç¨‹æ± åŸç†"><a href="#çº¿ç¨‹æ± åŸç†" class="headerlink" title="çº¿ç¨‹æ± åŸç†"></a>çº¿ç¨‹æ± åŸç†</h3><p><strong>C++11</strong>åŠ å…¥äº†çº¿ç¨‹åº“ï¼Œä»æ­¤å‘Šåˆ«äº†æ ‡å‡†åº“ä¸æ”¯æŒå¹¶å‘çš„å†å²ã€‚ç„¶è€ŒC++å¯¹äºå¤šçº¿ç¨‹çš„æ”¯æŒè¿˜æ˜¯æ¯”è¾ƒä½çº§ï¼Œç¨å¾®é«˜çº§ä¸€ç‚¹çš„ç”¨æ³•éƒ½éœ€è¦è‡ªå·±å»å®ç°ï¼Œæ¯”å¦‚çº¿ç¨‹æ± ã€ä¿¡å·é‡ç­‰ã€‚çº¿ç¨‹æ± ï¼ˆthread poolï¼‰è¿™ä¸ªä¸œè¥¿ï¼Œä¸€èˆ¬åœ¨é¢è¯•æ—¶çš„å›ç­”éƒ½æ˜¯ï¼šâ€œç®¡ç†ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œç„¶åæ¯æ¬¡å»ä¸€ä¸ªä»»åŠ¡åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹å»åšï¼Œå¾ªç¯å¾€å¤ã€‚â€è¿™å›ç­”è²Œä¼¼æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å†™èµ·ç¨‹åºæ¥çš„æ—¶å€™å°±å‡ºé—®é¢˜äº†ã€‚</p>
<p>æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿçº¿ç¨‹æ± ä¸€èˆ¬æ˜¯è¦å¤ç”¨çº¿ç¨‹ï¼Œæ‰€ä»¥å¦‚æœæ˜¯å–ä¸€ä¸ªtaskåˆ†é…ç»™æŸä¸€ä¸ªthreadï¼Œæ‰§è¡Œå®Œä¹‹åå†é‡æ–°åˆ†é…ï¼Œåœ¨è¯­è¨€å±‚é¢è¿™æ˜¯åŸºæœ¬ä¸èƒ½å®ç°çš„ï¼šC++çš„threadéƒ½æ˜¯æ‰§è¡Œä¸€ä¸ªå›ºå®šçš„taskå‡½æ•°ï¼Œæ‰§è¡Œå®Œä¹‹åçº¿ç¨‹ä¹Ÿå°±ç»“æŸäº†ã€‚æ‰€ä»¥è¯¥å¦‚ä½•å®ç°taskå’Œthreadçš„åˆ†é…å‘¢ï¼Ÿ</p>
<p><strong>è®©æ¯ä¸€ä¸ªthreadåˆ›å»ºåï¼Œå°±å»æ‰§è¡Œè°ƒåº¦å‡½æ•°ï¼šå¾ªç¯è·å–taskï¼Œç„¶åæ‰§è¡Œã€‚</strong></p>
<p>è¿™ä¸ªå¾ªç¯è¯¥ä»€ä¹ˆæ—¶å€™åœæ­¢å‘¢ï¼Ÿ</p>
<p>å¾ˆç®€å•ï¼Œ<strong>å½“çº¿ç¨‹æ± åœæ­¢ä½¿ç”¨æ—¶</strong>ï¼Œå¾ªç¯åœæ­¢ã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œå°±ä¿è¯äº†threadå‡½æ•°çš„å”¯ä¸€æ€§ï¼Œè€Œä¸”å¤ç”¨çº¿ç¨‹æ‰§è¡Œtaskã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„çº¿ç¨‹æ± çš„ä¸»è¦ç»„æˆéƒ¨åˆ†æœ‰äºŒï¼š</p>
<ul>
<li>ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰</li>
<li>çº¿ç¨‹æ± ï¼ˆThread Poolï¼‰</li>
</ul>
<p>çº¿ç¨‹æ± ä¸ä»»åŠ¡é˜Ÿåˆ—ä¹‹é—´çš„åŒ¹é…æ“ä½œï¼Œæ˜¯å…¸å‹çš„<em>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</em>æ¨¡å‹ï¼Œæœ¬æ¨¡å‹ä½¿ç”¨äº†ä¸¤ä¸ªå·¥å…·ï¼šä¸€ä¸ª==mutex== + ä¸€ä¸ª==æ¡ä»¶å˜é‡==ã€‚mutexå°±æ˜¯é”ï¼Œä¿è¯ä»»åŠ¡çš„æ·»åŠ å’Œç§»é™¤ï¼ˆè·å–ï¼‰çš„äº’æ–¥æ€§ï¼›ä¸€ä¸ªæ¡ä»¶å˜é‡ä¿è¯å¤šä¸ªçº¿ç¨‹è·å–taskçš„åŒæ­¥æ€§ï¼šå½“ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œçº¿ç¨‹åº”è¯¥ç­‰å¾…ï¼ˆé˜»å¡ï¼‰ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥é€æ¸å°†ä¸€å—å—ç§¯æœ¨æ‹¼æˆä¸€ä¸ªå®Œæ•´çš„ç®€æ˜“çº¿ç¨‹æ± ã€‚</p>
<h3 id="ç§¯æœ¨1ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask-Queueï¼‰"><a href="#ç§¯æœ¨1ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask-Queueï¼‰" class="headerlink" title="ç§¯æœ¨1ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰"></a>ç§¯æœ¨1ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰</h3><p>æˆ‘ä»¬ä¼šç†æ‰€å½“ç„¶åœ°å¸Œæœ›ä»»åŠ¡ä»¥å‘é€å®ƒç›¸åŒçš„é¡ºåºæ¥é€ä¸ªæ‰§è¡Œï¼Œå› æ­¤é˜Ÿåˆ—æ˜¯æœ€é€‚åˆçš„æ•°æ®ç»“æ„ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æŠŠä»»åŠ¡é˜Ÿåˆ—å•æ‹¿å‡ºæ¥ï¼Œç‹¬è‡ªä¸ºç±»ï¼Œæ–¹ä¾¿ä»¥åè¿›è¡Œå„ç§éªšæ“ä½œã€‚</p>
<p>å°†ä»»åŠ¡é˜Ÿåˆ—å•æ‹¿å‡ºæ¥ä¹‹åï¼Œæˆ‘ä»¬åº”è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šæ­£å¦‚ä¸Šä¸€èŠ‚æåˆ°çš„çº¿ç¨‹æ± taskä¸threadçš„åˆ†é…æ–¹æ³•æ‰€ç¤ºï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¼šæŒç»­æŸ¥è¯¢ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰å¯ç”¨å·¥ä½œã€‚å½“ä¸¤ä¸ªç”šè‡³å¤šä¸ªçº¿ç¨‹è¯•å›¾åŒæ—¶æ‰§è¡ŒæŸ¥è¯¢å·¥ä½œæ—¶ï¼Œè¿™ä¼šå¼•èµ·éš¾ä»¥ä¼°è®¡çš„ç¾éš¾ã€‚å› è€Œæˆ‘ä»¬éœ€è¦å¯¹C++çš„<code>std::queue</code>è¿›è¡ŒåŒ…è£…ï¼Œå®ç°ä¸€ä¸ª<strong>çº¿ç¨‹å®‰å…¨</strong>çš„<em>SafeQueue</em>ã€‚</p>
<p>å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„<em>SafeQueue</em>åŸç†å¾ˆç®€å•ï¼Œåˆ©ç”¨<strong>mutex</strong>æ¥é™åˆ¶å¹¶å‘è®¿é—®å³å¯ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<em>SafeQueue</em>ç±»ä¸­å®šä¹‰ä¸€ä¸ª<code>std::mutex</code>ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå¹¶åœ¨ç›¸åº”çš„æ“ä½œæ¥å£ï¼ˆå¦‚å…¥é˜Ÿæ¥å£<code>enqueue()</code>ï¼‰ä¸­åˆ©ç”¨äº’æ–¥ä½“åŒ…è£…å™¨æ¥ç®¡ç†è¿™ä¸ªmutexï¼Œç¡®ä¿æ²¡æœ‰å…¶ä»–äººæ­£åœ¨è®¿é—®è¯¥èµ„æºã€‚</p>
<p>ä¸‹é¢ç»™å‡ºå®Œæ•´çš„<em>SafeQueue</em>ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SafeQueue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::queue&lt;T&gt; m_queue; <span class="comment">//åˆ©ç”¨æ¨¡æ¿å‡½æ•°æ„é€ é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    std::mutex m_mutex; <span class="comment">// è®¿é—®äº’æ–¥ä¿¡å·é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SafeQueue</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">SafeQueue</span>(SafeQueue &amp;&amp;other) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">SafeQueue</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="comment">// è¿”å›é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>; <span class="comment">// äº’æ–¥ä¿¡å·å˜é‡åŠ é”ï¼Œé˜²æ­¢m_queueè¢«æ”¹å˜</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> m_queue.<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>; <span class="comment">// äº’æ–¥ä¿¡å·å˜é‡åŠ é”ï¼Œé˜²æ­¢m_queueè¢«æ”¹å˜</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> m_queue.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—æ·»åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(T &amp;t)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>;</span><br><span class="line">        m_queue.<span class="built_in">emplace</span>(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—å–å‡ºå…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">dequeue</span><span class="params">(T &amp;t)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>; <span class="comment">// é˜Ÿåˆ—åŠ é”</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_queue.<span class="built_in">empty</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        t = std::<span class="built_in">move</span>(m_queue.<span class="built_in">front</span>()); <span class="comment">// å–å‡ºé˜Ÿé¦–å…ƒç´ ï¼Œè¿”å›é˜Ÿé¦–å…ƒç´ å€¼ï¼Œå¹¶è¿›è¡Œå³å€¼å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">        m_queue.<span class="built_in">pop</span>(); <span class="comment">// å¼¹å‡ºå…¥é˜Ÿçš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="ç§¯æœ¨2ï¼šçº¿ç¨‹æ± ï¼ˆThread-Poolï¼‰"><a href="#ç§¯æœ¨2ï¼šçº¿ç¨‹æ± ï¼ˆThread-Poolï¼‰" class="headerlink" title="ç§¯æœ¨2ï¼šçº¿ç¨‹æ± ï¼ˆThread Poolï¼‰"></a>ç§¯æœ¨2ï¼šçº¿ç¨‹æ± ï¼ˆThread Poolï¼‰</h3><p>çº¿ç¨‹æ± æ˜¯çº¿ç¨‹æ± æ¨¡å‹çš„ä¸»ä½“ï¼Œæˆ‘ä»¬å°†å®ƒæ‹†æˆæ›´å°çš„éƒ¨åˆ†æ¥é€æ­¥åˆ†æï¼Œæ–¹ä¾¿ç†è§£ã€‚</p>
<h4 id="2-1-æäº¤å‡½æ•°"><a href="#2-1-æäº¤å‡½æ•°" class="headerlink" title="2-1 æäº¤å‡½æ•°"></a>2-1 æäº¤å‡½æ•°</h4><p>çº¿ç¨‹æ± æœ€é‡è¦çš„æ–¹æ³•å°±æ˜¯è´Ÿè´£å‘ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ã€‚æˆ‘ä»¬çš„æäº¤å‡½æ•°åº”è¯¥åšåˆ°ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ul>
<li>æ¥æ”¶ä»»ä½•å‚æ•°çš„ä»»ä½•å‡½æ•°ã€‚ï¼ˆæ™®é€šå‡½æ•°ï¼Œ==Lambda==ï¼Œ==æˆå‘˜å‡½æ•°==â€¦â€¦ï¼‰</li>
<li>ç«‹å³è¿”å›â€œä¸œè¥¿â€ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚è¿™é‡Œè¿”å›çš„â€œä¸œè¥¿â€æˆ–è€…è¯´â€œå¯¹è±¡â€åº”è¯¥åŒ…å«ä»»åŠ¡ç»“æŸçš„ç»“æœã€‚</li>
</ul>
<p>å®Œæ•´çš„æäº¤å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Submit a function to be executed asynchronously by the pool</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">submit</span><span class="params">(F &amp;&amp;f, Args &amp;&amp;...args)</span> -&gt; std::future&lt;<span class="title">decltype</span><span class="params">(f(args...))</span>&gt; â‘ </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Create a function with bounded parameter ready to execute</span></span><br><span class="line">        std::function&lt;<span class="keyword">decltype</span>(<span class="built_in">f</span>(args...))()&gt; func = std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...); â‘¡<span class="comment">// è¿æ¥å‡½æ•°å’Œå‚æ•°å®šä¹‰ï¼Œç‰¹æ®Šå‡½æ•°ç±»å‹ï¼Œé¿å…å·¦å³å€¼é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Encapsulate it into a shared pointer in order to be able to copy construct</span></span><br><span class="line">        <span class="keyword">auto</span> task_ptr = std::make_shared&lt;std::packaged_task&lt;<span class="keyword">decltype</span>(<span class="built_in">f</span>(args...))()&gt;&gt;(func);  â‘¢</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Warp packaged task into void function</span></span><br><span class="line">        std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; warpper_func = [task_ptr]()</span><br><span class="line">        &#123;</span><br><span class="line">            (*task_ptr)();</span><br><span class="line">        &#125;;  â‘£</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—é€šç”¨å®‰å…¨å°åŒ…å‡½æ•°ï¼Œå¹¶å‹å…¥å®‰å…¨é˜Ÿåˆ—</span></span><br><span class="line">        m_queue.<span class="built_in">enqueue</span>(warpper_func);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">        m_conditional_lock.<span class="built_in">notify_one</span>();  â‘¤</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å›å…ˆå‰æ³¨å†Œçš„ä»»åŠ¡æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">return</span> task_ptr-&gt;<span class="built_in">get_future</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>C++11ä¼—å¤šçš„è¯­æ³•ç³–æ­£å¼æ¥è¢­ã€‚ä¸‹é¢è®²ä¸€ä¸‹éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<ol>
<li><p><code>submit()</code>æ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œè¿™å¾ˆæ˜æ˜¾ã€‚<code>template&lt;typename F, typename... Args&gt;</code>ä¸­çš„<code>typename... Args</code>æ˜¯C++11å¼•å…¥çš„<strong>å¯å˜æ¨¡ç‰ˆå‚æ•°</strong>ï¼ˆvariadic templatesï¼‰ï¼Œå¾ˆå®¹æ˜“ç†è§£ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹é•¿å¾—å¥‡å¥‡æ€ªæ€ªçš„å‡½æ•°å¤´éƒ¨åˆ†ï¼Œ<code>auto submit(F &amp;&amp;f, Args &amp;&amp;...args) -&gt; std::future&lt;decltype(f(args...))&gt;</code>ï¼Œè¿™é‡Œå‡½æ•°ç±»å‹çš„å®šä¹‰ç”¨åˆ°äº†å«åš<strong>â€œå°¾è¿”å›ç±»å‹æ¨å¯¼â€</strong>çš„æŠ€å·§ã€‚</p>
<p>æŒ‰ç…§æ ‡å‡†ï¼Œ<code>auto</code>å…³é”®å­—ä¸èƒ½ç”¨äºå‡½æ•°å½¢å‚çš„ç±»å‹æ¨å¯¼ï¼Œ==åœ¨C++14ä»¥å‰==ï¼Œä¹Ÿä¸èƒ½ç›´æ¥ç”¨<code>auto func()</code>çš„å½¢å¼æ¥æ¨å¯¼å‡½æ•°çš„è¿”å›ç±»å‹ã€‚</p>
<p>å› æ­¤ä¼ ç»ŸC++ä¸­æˆ‘ä»¬å¿…é¡»è¿™ä¹ˆå†™ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span></span><br><span class="line"><span class="function">R <span class="title">add</span><span class="params">(T x, U y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x+y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å­˜åœ¨å¾ˆæ˜æ˜¾çš„ç¼ºé™·ï¼šäº‹å®ä¸Šå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸çŸ¥é“<code>add()</code>è¿™ä¸ªå‡½æ•°ä¼šè¿›è¡Œä»€ä¹ˆæ“ä½œï¼Œè·å–ä»€ä¹ˆæ ·çš„è¿”å›ç±»å‹ã€‚</p>
<p>æœ€ç»ˆåœ¨C++11ä¸­è¿™ä¸ªé—®é¢˜å¾—åˆ°äº†è§£å†³ã€‚C++11å…³é”®å­—<code>decltype</code>è§£å†³äº†<code>auto</code>å…³é”®å­—åªèƒ½å¯¹å˜é‡ç±»å‹è¿›è¡Œç±»å‹æ¨å¯¼çš„ç¼ºé™·ã€‚å®ƒçš„ç”¨æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåº”è¯¥ä¹Ÿæ˜¯çœ‹è¿‡C++11æ ‡å‡†å°±èƒ½è®°ä½çš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">decltype</span>(è¡¨è¾¾å¼)</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¸ºäº†åˆ©ç”¨<code>decltype</code>æ¥æ¨å¯¼å‡½æ•°çš„è¿”å›ç±»å‹ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥å†™å‡ºè¿™ç§å½¢å¼çš„ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">decltype</span>(x+y) <span class="built_in">add</span>(T x, U y)</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºç¼–è¯‘å™¨åœ¨è¯»åˆ°<code>decltype(x+y)</code>æ—¶ï¼Œ<code>x</code>å’Œ<code>y</code>å°šæœªå®šä¹‰ã€‚è€Œè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œæ­£æ˜¯<strong>å°¾è¿”å›ç±»å‹æ¨å¯¼</strong>ã€‚C++11å¼•å…¥äº†ä¸€ä¸ª<strong>å°¾è¿”å›ç±»å‹</strong>ï¼ˆtrailing return typeï¼‰ï¼Œåˆ©ç”¨<code>auto</code>å…³é”®å­—å°†è¿”å›ç±»å‹åç½®ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">add2</span><span class="params">(T x, U y)</span> -&gt; <span class="title">decltype</span><span class="params">(x+y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œçœ‹èµ·æ¥å¥‡å¥‡æ€ªæ€ªçš„å‡½æ•°å¤´ä¸­å…³äºå‡½æ•°çš„è¿”å›ç±»å‹çš„å®šä¹‰å·²ç»æ¸…æ¥šæ˜äº†ï¼šè¯¥å‡½æ•°çš„è¿”å›å€¼å°†ä»<code>std::future&lt;decltype(f(args...))&gt;</code>ä¸­è‡ªåŠ¨æ¨å¯¼å¾—å‡ºã€‚</p>
<p>æ¥ç€è°ˆå‡½æ•°å¤´ã€‚è¿™é‡Œæˆ‘ä»¬è°ˆä¸€ä¸‹<code>std::future</code>ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª==è®¿é—®å¼‚æ­¥æ“ä½œç»“æœ==çš„é€”å¾„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>std::future</code>çš„<code>wait()</code>æ–¹æ³•æ¥è®¾ç½®å±éšœï¼Œé˜»å¡çº¿ç¨‹ï¼Œå®ç°çº¿ç¨‹åŒæ­¥ã€‚å¹¶æœ€ç»ˆä½¿ç”¨<code>std::future</code>çš„<code>get()</code>æ–¹æ³•æ¥è·å¾—æ‰§è¡Œç»“æœã€‚</p>
<p>å¯¹äº<code>std::future</code>ï¼Œå¯ä»¥åœ¨è¿™ç¯‡æ–‡çŒ®ä¸­æ‰¾åˆ°æ›´è¯¦ç»†çš„è®²è§£ï¼š</p>
<p><a href="https://changkun.de/modern-cpp/zh-cn/07-thread/index.html#7-3-%E6%9C%9F%E7%89%A9">https://changkun.de/modern-cpp/zh-cn/07-thread/index.html#7-3-%E6%9C%9F%E7%89%A9</a></p>
<p>æ€»çš„æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼Œæœ€åå°†ä¼šè·å¾—è¿”å›ç±»å‹ä¸º å®ä¾‹åŒ–ä¸º<code>f(args...)</code>çš„<code>std::future&lt;&gt;</code> çš„<code>submit</code>å‡½æ•°ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬é˜…è¯»å…¶ä»–ä¸€äº›åšæ–‡æˆ–è€…Githubä¸Šè‘—åçš„99è¡ŒC++11å®ç°çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šçœ‹åˆ°ä»¥ä¸‹å½¢å¼çš„æ·»åŠ ä»»åŠ¡æ–¹æ³•çš„å®šä¹‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">ThreadPool::enqueue</span><span class="params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; std::future&lt;<span class="keyword">typename</span> std::result_of&lt;<span class="title">F</span><span class="params">(Args...)</span>&gt;::type&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿™é‡Œä¸é‡‡ç”¨<code>std::result_of&lt;&gt;::type</code>çš„æ–¹æ³•è€Œæ˜¯ä½¿ç”¨<code>decltype(f(args...))</code>æ–¹æ³•ï¼Œè¿™ä¸ªè¦ç»“åˆä¸‹ä¸€ç‚¹æ¥ç†è§£ã€‚</p>
</li>
<li><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†<code>std::function</code>è¿›è¡ŒåŒ…è£…ä»è€Œäº§ç”Ÿäº†ä¸€ä¸ªç‰¹æ®Šå‡½æ•°ï¼Œè¿™ä¸ªç‰¹æ®Šå‡½æ•°ä½¿ç”¨<code>std::bind</code>å°†å‡½æ•°<code>f</code>å’Œå‚æ•°<code>args</code>ç»‘å®šèµ·æ¥ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œ<code>std::function</code>å¯ä»¥å¯¹å¤šä¸ªç›¸ä¼¼çš„å‡½æ•°è¿›è¡ŒåŒ…è£…ï¼ˆå³é€šç”¨çš„æè¿°æ–¹æ³•ï¼‰ã€‚<code>std::function</code>å¯ä»¥holdä½ä»»ä½•å¯ä»¥é€šè¿‡â€œ()â€æ¥è°ƒç”¨çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>æ™®é€šå‡½æ•°</li>
<li>æˆå‘˜å‡½æ•°</li>
<li>lambda</li>
<li><code>std::bind</code></li>
</ul>
<p>è€Œ<code>std::bind</code>å¯ä»¥<strong>å°†è°ƒç”¨å‡½æ•°æ—¶çš„éƒ¨åˆ†å‚æ•°å…ˆåˆ¶å®šå¥½ï¼Œç•™ä¸‹ä¸€éƒ¨åˆ†åœ¨çœŸæ­£è°ƒç”¨æ—¶ç¡®å®š</strong>ã€‚ï¼ˆå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šå…¨éƒ¨å‚æ•°ï¼Œåœ¨è°ƒç”¨æ—¶ä¸å†æŒ‡å®šã€‚ï¼‰</p>
<p>å¯¹äº<code>std::function</code>å’Œ<code>std::bind</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç§»æ­¥è¿™ç¯‡åšå®¢è·å¾—æ›´è¯¦ç»†çš„è®²è§£ï¼š</p>
<p><a href="https://paul.pub/cpp-lambda-function-bind/">https://paul.pub/cpp-lambda-function-bind/</a></p>
<p>è¿™é‡Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°ï¼Œ<code>std::bind</code>ä¸­ï¼Œå‡ºç°äº†ä¸€ä¸ª<code>std::forward()</code>çš„ç‰¹æ®Šæ–¹æ³•ã€‚<code>std::forward()</code>åˆè¢«ç§°ä½œ<strong>å®Œç¾è½¬å‘</strong>ã€‚ç®€å•æ¥è¯´ï¼Œ<code>std::forward()</code>å°†ä¼šå®Œæ•´ä¿ç•™å‚æ•°çš„å¼•ç”¨ç±»å‹è¿›è¡Œè½¬å‘ã€‚å¦‚æœå‚æ•°æ˜¯å·¦å€¼å¼•ç”¨ï¼ˆ<em>lvalue</em>ï¼‰ï¼Œè¯¥æ–¹æ³•ä¼šå°†å‚æ•°ä¿ç•™å·¦å€¼å¼•ç”¨çš„å½¢å¼è¿›è¡Œè½¬å‘ï¼Œå¦‚æœå‚æ•°æ˜¯å³å€¼å¼•ç”¨ï¼ˆ<em>rvalue</em>ï¼‰ï¼Œè¯¥æ–¹æ³•ä¼šå°†å‚æ•°ä¿ç•™å³å€¼å¼•ç”¨çš„å½¢å¼è¿›è¡Œè½¬å‘ã€‚è€Œæˆ‘ä»¬è¿™é‡Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬ä¼šå¯¹ä¸ºä»€ä¹ˆä½¿ç”¨<code>std::forward()</code>æ–¹æ³•äº§ç”Ÿç–‘æƒ‘ï¼Œå¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬çœ‹åˆ°äº†å‡½æ•°å¤´ä¸­çš„<code>F&amp;&amp; f</code>å’Œ<code>Args&amp;&amp;... args</code>ï¼Œè¿™éš¾é“ä¸å·²ç»æŒ‡æ˜è¿™ä¸ªå‡½æ•°æ¥æ”¶çš„å‚æ•°ç±»å‹åº”ä¸ºå³å€¼å¼•ç”¨å—ï¼Ÿ<strong>å…¶å®ä¸ç„¶ã€‚</strong>è¿™é‡Œçš„<code>F&amp;&amp; f</code>å’Œ<code>Args&amp;&amp;... args</code>ä¸­çš„<code>&amp;&amp;</code>å¹¶éæ˜¯å³å€¼å¼•ç”¨æ„æ€ï¼Œè€Œæ˜¯ä¸€ç§ç‰¹æ®Šç°è±¡ï¼Œè¿™ä¸ªç°è±¡è¢«ç§°ä½œ<strong>ä¸‡èƒ½å¼•ç”¨</strong>ï¼ˆuniversal referenceï¼‰ã€‚</p>
<p><strong>ä¸‡èƒ½å¼•ç”¨</strong>å¯ä»¥ç®€å•ç†è§£ä¸ºï¼Œå½“<code>T</code>æ˜¯æ¨¡æ¿å‚æ•°æ—¶ï¼Œ<code>T&amp;&amp;</code>çš„ä½œç”¨ä¸»è¦æ˜¯ä¿æŒå€¼ç±»åˆ«è¿›è¡Œè½¬å‘ã€‚ç„¶è€Œï¼Œ<strong>ä¸€ä¸ªç»‘å®šåˆ°universial referenceä¸Šçš„å¯¹è±¡å¯èƒ½å…·æœ‰lvaluesnessæˆ–è€…rvaluenessï¼Œæ­£æ˜¯å› ä¸ºæœ‰è¿™ç§äºŒä¹‰æ€§</strong>ï¼Œæ‰€ä»¥äº§ç”Ÿäº†<code>std::forward</code>ã€‚</p>
<p>æœ‰å…³äºä¸‡èƒ½å¼•ç”¨ã€å®Œç¾è½¬å‘ä»¥åŠèƒŒåæ‰€éšè—çš„å¼•ç”¨æŠ˜å ï¼Œå¯ä»¥åœ¨è¿™ç¯‡çŸ¥ä¹å›ç­”ä¸­æ‰¾åˆ°æ›´è¯¦ç»†çš„ä»‹ç»ï¼š</p>
<p><a href="https://zhuanlan.zhihu.com/p/99524127">https://zhuanlan.zhihu.com/p/99524127</a></p>
<p>æ€»çš„æ¥è¯´ï¼Œâ‘¡ä¼šäº§ç”Ÿä¸€ä¸ªä»¥ å‡½æ•°<code>f(arg...)</code>è¿”å›ç±»å‹ ä¸ºè¿”å›ç±»å‹ã€ä¸å«å‚æ•°çš„ç‰¹æ®Šå‡½æ•°åŒ…è£…<code>func</code>ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ä¹Ÿä¸éš¾æ³¨æ„åˆ°ï¼Œåœ¨ç½‘ä¸Šå…¶ä»–çš„ç¤ºä¾‹ä¸­ï¼Œè¿™é‡Œä½¿ç”¨äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> return_type = <span class="keyword">typename</span> std::result_of&lt;<span class="built_in">F</span>(Args...)&gt;::type;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå†æ¬¡åƒè¿™äº›ç¤ºä¾‹åœ¨å‡½æ•°å¤´ä¸­ä¸€æ ·ï¼Œä½¿ç”¨äº†<code>std::result_of</code>æ–¹æ³•ï¼Œè€Œç»“åˆä¸Šæ–‡ï¼Œæˆ‘ä»¬ä¹Ÿä¸éš¾ç†è§£ä¸ºä»€ä¹ˆæœ¬æ–‡ä¼šä½¿ç”¨<code>std::function</code>æ–¹æ³•ï¼Œå³æ›´æ–¹ä¾¿åœ°å¢åŠ å¯¹å°†æˆå‘˜å‡½æ•°å’Œlambdaè¡¨è¾¾å¼ä½œä¸ºå‚æ•°çš„æ”¯æŒã€‚</p>
</li>
<li><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>std::make_shared&lt;&gt;()</code>æ–¹æ³•ï¼Œå£°æ˜äº†ä¸€ä¸ª<code>std::packaged_task&lt;decltype(f(args...))()&gt;</code>ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå¹¶å°†å‰é¢<code>std::function</code>æ–¹æ³•å£°æ˜çš„ç‰¹æ®Šå‡½æ•°åŒ…è£…<code>func</code>ä¼ å…¥ä½œä¸º<code>std::packaged_task</code>çš„å®ä¾‹åŒ–å‚æ•°ã€‚æ™ºèƒ½æŒ‡é’ˆå°†æ›´æ–¹ä¾¿æˆ‘ä»¬å¯¹è¯¥<code>std::packaged_task</code>å¯¹è±¡è¿›è¡Œç®¡ç†ã€‚</p>
<p><code>std::packaged_task</code>å¯ä»¥ç”¨æ¥å°è£…ä»»ä½•å¯ä»¥è°ƒç”¨çš„ç›®æ ‡ï¼Œä»è€Œç”¨äºå®ç°å¼‚æ­¥çš„è°ƒç”¨ã€‚</p>
</li>
<li><p>è¿™é‡Œæˆ‘ä»¬å†æ¬¡åˆ©ç”¨<code>std::function</code>ï¼Œå°†<em>task_ptr</em>æŒ‡å‘çš„<strong>std::packaged_task</strong>å¯¹è±¡å–å‡ºå¹¶åŒ…è£…ä¸ºvoidå‡½æ•°ã€‚è¿™æ ·æˆ‘ä»¬çš„ä»£ç å°†æ›´åŠ ç¾è§‚ä¼˜é›…ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åƒå…¶ä»–ç¤ºä¾‹ä¸€æ ·ï¼Œå°†è¿™ä¸€æ­¥å’Œä¸‹ä¸€æ­¥ä»»åŠ¡è¿›å…¥é˜Ÿåˆ—æ“ä½œç®€åŒ–ä¸ºä¸€æ­¥ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">m_queue.<span class="built_in">enqueue</span>([task_ptr]()&#123;</span><br><span class="line">    (*task_ptr)();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><p>è¿™é‡Œæ¡ä»¶å˜é‡ä¼šé€šçŸ¥ä¸€ä¸ªå¤„äº<em>wait</em>çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹å°†ä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å¾—ä»»åŠ¡å¹¶æ‰§è¡Œã€‚</p>
<p>è¿™é‡Œç®€è¦ä»‹ç»ä¸€ä¸‹æ¡ä»¶å˜é‡ï¼ˆ<code>std::condition_variable</code>ï¼‰ï¼š</p>
<p>æ¡ä»¶å˜é‡ <code>std::condition_variable</code> æ˜¯ä¸ºäº†è§£å†³æ­»é”è€Œç”Ÿï¼Œå½“äº’æ–¥æ“ä½œä¸å¤Ÿç”¨è€Œå¼•å…¥çš„ã€‚æ¯”å¦‚ï¼Œçº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶ä¸ºçœŸæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œè€Œä¸€ä¸ªå¿™ç­‰å¾…å¾ªç¯ä¸­å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰å…¶ä»–çº¿ç¨‹éƒ½æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºä½¿å¾—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­»é”ã€‚æ‰€ä»¥ï¼Œ<code>condition_variable</code>å®ä¾‹è¢«åˆ›å»ºå‡ºç°ä¸»è¦å°±æ˜¯ç”¨äºå”¤é†’ç­‰å¾…çº¿ç¨‹ä»è€Œé¿å…æ­»é”ã€‚<code>std::condition_variable</code>çš„<code>notify_one()</code>ç”¨äºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼›<code>notify_all()</code>åˆ™æ˜¯é€šçŸ¥æ‰€æœ‰çº¿ç¨‹ã€‚</p>
</li>
</ol>
<p>æäº¤å‡½æ•°åˆ°æ­¤ç»“æŸã€‚</p>
<hr>
<h4 id="2-2-å†…ç½®å·¥ä½œçº¿ç¨‹ç±»"><a href="#2-2-å†…ç½®å·¥ä½œçº¿ç¨‹ç±»" class="headerlink" title="2-2 å†…ç½®å·¥ä½œçº¿ç¨‹ç±»"></a>2-2 å†…ç½®å·¥ä½œçº¿ç¨‹ç±»</h4><p>æœ¬æ–‡åœ¨çº¿ç¨‹æ± ä¸­è®¾ç«‹ç§æœ‰æˆå‘˜ç±»<em>ThreadWoker</em>ä½œä¸ºå†…ç½®çº¿ç¨‹å·¥ä½œç±»ï¼Œæ‰§è¡ŒçœŸæ­£çš„å·¥ä½œã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span> // å†…ç½®çº¿ç¨‹å·¥ä½œç±»</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> m_id; <span class="comment">// å·¥ä½œid</span></span><br><span class="line"></span><br><span class="line">    ThreadPool *m_pool; <span class="comment">// æ‰€å±çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">ThreadWorker</span>(ThreadPool *pool, <span class="keyword">const</span> <span class="keyword">int</span> id) : <span class="built_in">m_pool</span>(pool), <span class="built_in">m_id</span>(id)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡è½½()æ“ä½œ</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; func; <span class="comment">// å®šä¹‰åŸºç¡€å‡½æ•°ç±»func</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> dequeued; <span class="comment">// æ˜¯å¦æ­£åœ¨å–å‡ºé˜Ÿåˆ—ä¸­å…ƒç´ </span></span><br><span class="line">		</span><br><span class="line">        <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å…³é—­ï¼Œæ²¡æœ‰å…³é—­åˆ™ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å¾ªç¯æå–ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">while</span> (!m_pool-&gt;m_shutdown)</span><br><span class="line">        &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// ä¸ºçº¿ç¨‹ç¯å¢ƒåŠ é”ï¼Œäº’è®¿é—®å·¥ä½œçº¿ç¨‹çš„ä¼‘çœ å’Œå”¤é†’</span></span><br><span class="line">                <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_pool-&gt;m_conditional_mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (m_pool-&gt;m_queue.<span class="built_in">empty</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pool-&gt;m_conditional_lock.<span class="built_in">wait</span>(lock); <span class="comment">// ç­‰å¾…æ¡ä»¶å˜é‡é€šçŸ¥ï¼Œå¼€å¯çº¿ç¨‹</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å–å‡ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å…ƒç´ </span></span><br><span class="line">                dequeued = m_pool-&gt;m_queue.<span class="built_in">dequeue</span>(func);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœæˆåŠŸå–å‡ºï¼Œæ‰§è¡Œå·¥ä½œå‡½æ•°</span></span><br><span class="line">            <span class="keyword">if</span> (dequeued)</span><br><span class="line">                <span class="built_in">func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåº”è¯¥é‡ç‚¹å…³æ³¨é‡è½½()æ“ä½œçš„<code>void operator()()</code>ï¼Œè¿™é‡Œé¢è¿›è¡Œäº†ä»»åŠ¡çš„å–å‡ºä¸æ‰§è¡Œã€‚</p>
<p>å‚ç…§æ³¨é‡Šå’Œä¸Šæ–‡ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªwhileå¾ªç¯ï¼Œåœ¨çº¿ç¨‹æ± å¤„äºå·¥ä½œæ—¶å¾ªç¯ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æå–ä»»åŠ¡ã€‚å¹¶åˆ©ç”¨æ¡ä»¶å˜é‡ï¼Œåœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…ä¸Šæ–‡ä¸­çš„æäº¤å‡½æ•°æ·»åŠ ä»»åŠ¡åå‘å‡ºçš„é€šçŸ¥ã€‚åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œæˆ‘ä»¬å°†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å–å‡ºï¼Œå¹¶æ”¾åœ¨äº‹å…ˆå£°æ˜çš„åŸºç¡€å‡½æ•°ç±»<em>func</em>ä¸­ã€‚æˆåŠŸå–å‡ºåä¾¿ç«‹å³æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚</p>
<h4 id="çº¿ç¨‹æ± å®Œæ•´ä»£ç "><a href="#çº¿ç¨‹æ± å®Œæ•´ä»£ç " class="headerlink" title="çº¿ç¨‹æ± å®Œæ•´ä»£ç "></a>çº¿ç¨‹æ± å®Œæ•´ä»£ç </h4><p>ä¸‹é¢ç»™å‡ºçº¿ç¨‹æ± çš„å®Œæ•´ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span> // å†…ç½®çº¿ç¨‹å·¥ä½œç±»</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">int</span> m_id; <span class="comment">// å·¥ä½œid</span></span><br><span class="line"></span><br><span class="line">        ThreadPool *m_pool; <span class="comment">// æ‰€å±çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">ThreadWorker</span>(ThreadPool *pool, <span class="keyword">const</span> <span class="keyword">int</span> id) : <span class="built_in">m_pool</span>(pool), <span class="built_in">m_id</span>(id)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡è½½()æ“ä½œ</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; func; <span class="comment">// å®šä¹‰åŸºç¡€å‡½æ•°ç±»func</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">bool</span> dequeued; <span class="comment">// æ˜¯å¦æ­£åœ¨å–å‡ºé˜Ÿåˆ—ä¸­å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (!m_pool-&gt;m_shutdown)</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// ä¸ºçº¿ç¨‹ç¯å¢ƒåŠ é”ï¼Œäº’è®¿é—®å·¥ä½œçº¿ç¨‹çš„ä¼‘çœ å’Œå”¤é†’</span></span><br><span class="line">                    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_pool-&gt;m_conditional_mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">                    <span class="keyword">if</span> (m_pool-&gt;m_queue.<span class="built_in">empty</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_pool-&gt;m_conditional_lock.<span class="built_in">wait</span>(lock); <span class="comment">// ç­‰å¾…æ¡ä»¶å˜é‡é€šçŸ¥ï¼Œå¼€å¯çº¿ç¨‹</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å–å‡ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å…ƒç´ </span></span><br><span class="line">                    dequeued = m_pool-&gt;m_queue.<span class="built_in">dequeue</span>(func);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœæˆåŠŸå–å‡ºï¼Œæ‰§è¡Œå·¥ä½œå‡½æ•°</span></span><br><span class="line">                <span class="keyword">if</span> (dequeued)</span><br><span class="line">                    <span class="built_in">func</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> m_shutdown; <span class="comment">// çº¿ç¨‹æ± æ˜¯å¦å…³é—­</span></span><br><span class="line"></span><br><span class="line">    SafeQueue&lt;std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt;&gt; m_queue; <span class="comment">// æ‰§è¡Œå‡½æ•°å®‰å…¨é˜Ÿåˆ—ï¼Œå³ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::thread&gt; m_threads; <span class="comment">// å·¥ä½œçº¿ç¨‹é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    std::mutex m_conditional_mutex; <span class="comment">// çº¿ç¨‹ä¼‘çœ é”äº’æ–¥å˜é‡</span></span><br><span class="line"></span><br><span class="line">    std::condition_variable m_conditional_lock; <span class="comment">// çº¿ç¨‹ç¯å¢ƒé”ï¼Œå¯ä»¥è®©çº¿ç¨‹å¤„äºä¼‘çœ æˆ–è€…å”¤é†’çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">ThreadPool</span>(<span class="keyword">const</span> <span class="keyword">int</span> n_threads = <span class="number">4</span>)</span><br><span class="line">        : <span class="built_in">m_threads</span>(std::vector&lt;std::thread&gt;(n_threads)), <span class="built_in">m_shutdown</span>(<span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ThreadPool</span>(<span class="keyword">const</span> ThreadPool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ThreadPool</span>(ThreadPool &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    ThreadPool &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> ThreadPool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    ThreadPool &amp;<span class="keyword">operator</span>=(ThreadPool &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inits thread pool</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_threads.<span class="built_in">size</span>(); ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            m_threads.<span class="built_in">at</span>(i) = std::<span class="built_in">thread</span>(<span class="built_in">ThreadWorker</span>(<span class="keyword">this</span>, i)); <span class="comment">// åˆ†é…å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Waits until threads finish their current task and shutdowns the pool</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_shutdown = <span class="literal">true</span>;</span><br><span class="line">        m_conditional_lock.<span class="built_in">notify_all</span>(); <span class="comment">// é€šçŸ¥ï¼Œå”¤é†’æ‰€æœ‰å·¥ä½œçº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_threads.<span class="built_in">size</span>(); ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_threads.<span class="built_in">at</span>(i).<span class="built_in">joinable</span>()) <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦åœ¨ç­‰å¾…</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_threads.<span class="built_in">at</span>(i).<span class="built_in">join</span>(); <span class="comment">// å°†çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Submit a function to be executed asynchronously by the pool</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">submit</span><span class="params">(F &amp;&amp;f, Args &amp;&amp;...args)</span> -&gt; std::future&lt;<span class="title">decltype</span><span class="params">(f(args...))</span>&gt;</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Create a function with bounded parameter ready to execute</span></span><br><span class="line">        std::function&lt;<span class="keyword">decltype</span>(<span class="built_in">f</span>(args...))()&gt; func = std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...); <span class="comment">// è¿æ¥å‡½æ•°å’Œå‚æ•°å®šä¹‰ï¼Œç‰¹æ®Šå‡½æ•°ç±»å‹ï¼Œé¿å…å·¦å³å€¼é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Encapsulate it into a shared pointer in order to be able to copy construct</span></span><br><span class="line">        <span class="keyword">auto</span> task_ptr = std::make_shared&lt;std::packaged_task&lt;<span class="keyword">decltype</span>(<span class="built_in">f</span>(args...))()&gt;&gt;(func);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Warp packaged task into void function</span></span><br><span class="line">        std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; warpper_func = [task_ptr]()</span><br><span class="line">        &#123;</span><br><span class="line">            (*task_ptr)();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—é€šç”¨å®‰å…¨å°åŒ…å‡½æ•°ï¼Œå¹¶å‹å…¥å®‰å…¨é˜Ÿåˆ—</span></span><br><span class="line">        m_queue.<span class="built_in">enqueue</span>(warpper_func);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">        m_conditional_lock.<span class="built_in">notify_one</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å›å…ˆå‰æ³¨å†Œçš„ä»»åŠ¡æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">return</span> task_ptr-&gt;<span class="built_in">get_future</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆæ³¨é‡Šåº”è¯¥èƒ½å¾ˆè½»æ¾çš„ç†è§£çº¿ç¨‹æ± å‰©ä½™çš„ä»£ç ã€‚</p>
<p>æ³¨æ„ä¸€ä¸‹<code>init()</code>å‡½æ•°å’Œ<code>shutdown()</code>å‡½æ•°ï¼š</p>
<ul>
<li>åœ¨çº¿ç¨‹æ± åˆå§‹åŒ–å‡½æ•°<code>init()</code>ä¸­ï¼Œæˆ‘ä»¬å£°æ˜å¹¶åˆ†é…å·¥ä½œçº¿ç¨‹ï¼Œå°†å·¥ä½œçº¿ç¨‹æ”¾å…¥å·¥ä½œçº¿ç¨‹é˜Ÿåˆ—<em>m_threads</em>ä¸­ã€‚</li>
<li>åœ¨çº¿ç¨‹æ± å…³é—­å‡½æ•°<code>shutdown()</code>ä¸­ï¼Œæˆ‘ä»¬å”¤é†’æ‰€æœ‰å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ç­‰å¾…æœŸå®Œæˆæ‰€æœ‰å·¥ä½œåå…³é—­çº¿ç¨‹æ± ã€‚</li>
</ul>
<p>è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¹è¿›ä¸€ä¸‹ä»£ç ï¼Œå°†<code>shutdown()</code>å‡½æ•°ä¸­çš„å·¥ä½œè½¬ç§»åˆ°<em>ThreadPool</em>çš„ææ„å‡½æ•°ä¸­ï¼Œä»è€Œæ›´ä¾¿åˆ©æ—¥åçš„ä½¿ç”¨ã€‚</p>
<p>è‡³æ­¤ï¼Œçº¿ç¨‹æ± å…¨æ–‡è®²è§£ç»“æŸï¼Œåé™„å®Œæ•´é¡¹ç›®ä»£ç åŠå‚è€ƒèµ„æ–™ã€‚</p>
<h2 id="0x02-é¡¹ç›®å®Œæ•´ä»£ç "><a href="#0x02-é¡¹ç›®å®Œæ•´ä»£ç " class="headerlink" title="0x02 é¡¹ç›®å®Œæ•´ä»£ç "></a>0x02 é¡¹ç›®å®Œæ•´ä»£ç </h2><h3 id="çº¿ç¨‹æ± ä»£ç "><a href="#çº¿ç¨‹æ± ä»£ç " class="headerlink" title="çº¿ç¨‹æ± ä»£ç "></a>çº¿ç¨‹æ± ä»£ç </h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//thread_pool.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> THREAD_POOL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_POOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Thread safe implementation of a Queue using a std::queue</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SafeQueue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::queue&lt;T&gt; m_queue; <span class="comment">//åˆ©ç”¨æ¨¡æ¿å‡½æ•°æ„é€ é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    std::mutex m_mutex; <span class="comment">// è®¿é—®äº’æ–¥ä¿¡å·é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SafeQueue</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">SafeQueue</span>(SafeQueue &amp;&amp;other) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">SafeQueue</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="comment">// è¿”å›é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>; <span class="comment">// äº’æ–¥ä¿¡å·å˜é‡åŠ é”ï¼Œé˜²æ­¢m_queueè¢«æ”¹å˜</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> m_queue.<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>; <span class="comment">// äº’æ–¥ä¿¡å·å˜é‡åŠ é”ï¼Œé˜²æ­¢m_queueè¢«æ”¹å˜</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> m_queue.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—æ·»åŠ å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(T &amp;t)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>;</span><br><span class="line">        m_queue.<span class="built_in">emplace</span>(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—å–å‡ºå…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">dequeue</span><span class="params">(T &amp;t)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>; <span class="comment">// é˜Ÿåˆ—åŠ é”</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_queue.<span class="built_in">empty</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        t = std::<span class="built_in">move</span>(m_queue.<span class="built_in">front</span>()); <span class="comment">// å–å‡ºé˜Ÿé¦–å…ƒç´ ï¼Œè¿”å›é˜Ÿé¦–å…ƒç´ å€¼ï¼Œå¹¶è¿›è¡Œå³å€¼å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">        m_queue.<span class="built_in">pop</span>(); <span class="comment">// å¼¹å‡ºå…¥é˜Ÿçš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span> // å†…ç½®çº¿ç¨‹å·¥ä½œç±»</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">int</span> m_id; <span class="comment">// å·¥ä½œid</span></span><br><span class="line"></span><br><span class="line">        ThreadPool *m_pool; <span class="comment">// æ‰€å±çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">ThreadWorker</span>(ThreadPool *pool, <span class="keyword">const</span> <span class="keyword">int</span> id) : <span class="built_in">m_pool</span>(pool), <span class="built_in">m_id</span>(id)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡è½½()æ“ä½œ</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; func; <span class="comment">// å®šä¹‰åŸºç¡€å‡½æ•°ç±»func</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">bool</span> dequeued; <span class="comment">// æ˜¯å¦æ­£åœ¨å–å‡ºé˜Ÿåˆ—ä¸­å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (!m_pool-&gt;m_shutdown)</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// ä¸ºçº¿ç¨‹ç¯å¢ƒåŠ é”ï¼Œäº’è®¿é—®å·¥ä½œçº¿ç¨‹çš„ä¼‘çœ å’Œå”¤é†’</span></span><br><span class="line">                    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_pool-&gt;m_conditional_mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">                    <span class="keyword">if</span> (m_pool-&gt;m_queue.<span class="built_in">empty</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_pool-&gt;m_conditional_lock.<span class="built_in">wait</span>(lock); <span class="comment">// ç­‰å¾…æ¡ä»¶å˜é‡é€šçŸ¥ï¼Œå¼€å¯çº¿ç¨‹</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å–å‡ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å…ƒç´ </span></span><br><span class="line">                    dequeued = m_pool-&gt;m_queue.<span class="built_in">dequeue</span>(func);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœæˆåŠŸå–å‡ºï¼Œæ‰§è¡Œå·¥ä½œå‡½æ•°</span></span><br><span class="line">                <span class="keyword">if</span> (dequeued)</span><br><span class="line">                    <span class="built_in">func</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> m_shutdown; <span class="comment">// çº¿ç¨‹æ± æ˜¯å¦å…³é—­</span></span><br><span class="line"></span><br><span class="line">    SafeQueue&lt;std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt;&gt; m_queue; <span class="comment">// æ‰§è¡Œå‡½æ•°å®‰å…¨é˜Ÿåˆ—ï¼Œå³ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::thread&gt; m_threads; <span class="comment">// å·¥ä½œçº¿ç¨‹é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    std::mutex m_conditional_mutex; <span class="comment">// çº¿ç¨‹ä¼‘çœ é”äº’æ–¥å˜é‡</span></span><br><span class="line"></span><br><span class="line">    std::condition_variable m_conditional_lock; <span class="comment">// çº¿ç¨‹ç¯å¢ƒé”ï¼Œå¯ä»¥è®©çº¿ç¨‹å¤„äºä¼‘çœ æˆ–è€…å”¤é†’çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">ThreadPool</span>(<span class="keyword">const</span> <span class="keyword">int</span> n_threads = <span class="number">4</span>)</span><br><span class="line">        : <span class="built_in">m_threads</span>(std::vector&lt;std::thread&gt;(n_threads)), <span class="built_in">m_shutdown</span>(<span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ThreadPool</span>(<span class="keyword">const</span> ThreadPool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ThreadPool</span>(ThreadPool &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    ThreadPool &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> ThreadPool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    ThreadPool &amp;<span class="keyword">operator</span>=(ThreadPool &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inits thread pool</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_threads.<span class="built_in">size</span>(); ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            m_threads.<span class="built_in">at</span>(i) = std::<span class="built_in">thread</span>(<span class="built_in">ThreadWorker</span>(<span class="keyword">this</span>, i)); <span class="comment">// åˆ†é…å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Waits until threads finish their current task and shutdowns the pool</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_shutdown = <span class="literal">true</span>;</span><br><span class="line">        m_conditional_lock.<span class="built_in">notify_all</span>(); <span class="comment">// é€šçŸ¥ï¼Œå”¤é†’æ‰€æœ‰å·¥ä½œçº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_threads.<span class="built_in">size</span>(); ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_threads.<span class="built_in">at</span>(i).<span class="built_in">joinable</span>()) <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦åœ¨ç­‰å¾…</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_threads.<span class="built_in">at</span>(i).<span class="built_in">join</span>(); <span class="comment">// å°†çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Submit a function to be executed asynchronously by the pool</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">submit</span><span class="params">(F &amp;&amp;f, Args &amp;&amp;...args)</span> -&gt; std::future&lt;<span class="title">decltype</span><span class="params">(f(args...))</span>&gt;</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Create a function with bounded parameter ready to execute</span></span><br><span class="line">        std::function&lt;<span class="keyword">decltype</span>(<span class="built_in">f</span>(args...))()&gt; func = std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...); <span class="comment">// è¿æ¥å‡½æ•°å’Œå‚æ•°å®šä¹‰ï¼Œç‰¹æ®Šå‡½æ•°ç±»å‹ï¼Œé¿å…å·¦å³å€¼é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Encapsulate it into a shared pointer in order to be able to copy construct</span></span><br><span class="line">        <span class="keyword">auto</span> task_ptr = std::make_shared&lt;std::packaged_task&lt;<span class="keyword">decltype</span>(<span class="built_in">f</span>(args...))()&gt;&gt;(func);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Warp packaged task into void function</span></span><br><span class="line">        std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; warpper_func = [task_ptr]()</span><br><span class="line">        &#123;</span><br><span class="line">            (*task_ptr)();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—é€šç”¨å®‰å…¨å°åŒ…å‡½æ•°ï¼Œå¹¶å‹å…¥å®‰å…¨é˜Ÿåˆ—</span></span><br><span class="line">        m_queue.<span class="built_in">enqueue</span>(warpper_func);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">        m_conditional_lock.<span class="built_in">notify_one</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å›å…ˆå‰æ³¨å†Œçš„ä»»åŠ¡æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">return</span> task_ptr-&gt;<span class="built_in">get_future</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<h3 id="æµ‹è¯•æ ·ä¾‹ä»£ç "><a href="#æµ‹è¯•æ ·ä¾‹ä»£ç " class="headerlink" title="æµ‹è¯•æ ·ä¾‹ä»£ç "></a>æµ‹è¯•æ ·ä¾‹ä»£ç </h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;random&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;thread_pool.h&quot;</span></span></span><br><span class="line">std::random_device rd; <span class="comment">// çœŸå®éšæœºæ•°äº§ç”Ÿå™¨</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::mt19937 <span class="title">mt</span><span class="params">(rd())</span></span>; <span class="comment">//ç”Ÿæˆè®¡ç®—éšæœºæ•°mt</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::uniform_int_distribution&lt;<span class="keyword">int</span>&gt; <span class="title">dist</span><span class="params">(<span class="number">-1000</span>, <span class="number">1000</span>)</span></span>; <span class="comment">//ç”Ÿæˆ-1000åˆ°1000ä¹‹é—´çš„ç¦»æ•£å‡åŒ€åˆ†å¸ƒæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> rnd = std::<span class="built_in">bind</span>(dist, mt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®çº¿ç¨‹ç¡çœ æ—¶é—´</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">simulate_hard_computation</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">2000</span> + <span class="built_in">rnd</span>()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ä¸¤ä¸ªæ•°å­—çš„ç®€å•å‡½æ•°å¹¶æ‰“å°ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">multiply</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> a, <span class="keyword">const</span> <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">simulate_hard_computation</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> res = a * b;</span><br><span class="line">    std::cout &lt;&lt; a &lt;&lt; <span class="string">&quot; * &quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot; = &quot;</span> &lt;&lt; res &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ å¹¶è¾“å‡ºç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">multiply_output</span><span class="params">(<span class="keyword">int</span> &amp;out, <span class="keyword">const</span> <span class="keyword">int</span> a, <span class="keyword">const</span> <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">simulate_hard_computation</span>();</span><br><span class="line">    out = a * b;</span><br><span class="line">    std::cout &lt;&lt; a &lt;&lt; <span class="string">&quot; * &quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot; = &quot;</span> &lt;&lt; out &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“æœè¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">multiply_return</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> a, <span class="keyword">const</span> <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">simulate_hard_computation</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> res = a * b;</span><br><span class="line">    std::cout &lt;&lt; a &lt;&lt; <span class="string">&quot; * &quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot; = &quot;</span> &lt;&lt; res &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">example</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»º3ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="function">ThreadPool <span class="title">pool</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–çº¿ç¨‹æ± </span></span><br><span class="line">    pool.<span class="built_in">init</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æäº¤ä¹˜æ³•æ“ä½œï¼Œæ€»å…±30ä¸ª</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; ++i)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= <span class="number">10</span>; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            pool.<span class="built_in">submit</span>(multiply, i, j);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨refä¼ é€’çš„è¾“å‡ºå‚æ•°æäº¤å‡½æ•°</span></span><br><span class="line">    <span class="keyword">int</span> output_ref;</span><br><span class="line">    <span class="keyword">auto</span> future1 = pool.<span class="built_in">submit</span>(multiply_output, std::<span class="built_in">ref</span>(output_ref), <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¹˜æ³•è¾“å‡ºå®Œæˆ</span></span><br><span class="line">    future1.<span class="built_in">get</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Last operation result is equals to &quot;</span> &lt;&lt; output_ref &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨returnå‚æ•°æäº¤å‡½æ•°</span></span><br><span class="line">    <span class="keyword">auto</span> future2 = pool.<span class="built_in">submit</span>(multiply_return, <span class="number">5</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¹˜æ³•è¾“å‡ºå®Œæˆ</span></span><br><span class="line">    <span class="keyword">int</span> res = future2.<span class="built_in">get</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Last operation result is equals to &quot;</span> &lt;&lt; res &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">    pool.<span class="built_in">shutdown</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">example</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="0x03-å‚è€ƒèµ„æ–™"><a href="#0x03-å‚è€ƒèµ„æ–™" class="headerlink" title="0x03 å‚è€ƒèµ„æ–™"></a>0x03 å‚è€ƒèµ„æ–™</h2><ol>
<li>ã€ŠC++åç«¯çº¿ç¨‹æ± ã€‹ï¼š<a href="https://wangpengcheng.github.io/2019/05/17/cplusplus_theadpool/">https://wangpengcheng.github.io/2019/05/17/cplusplus_theadpool/</a></li>
<li>ã€ŠåŸºäºC++11çš„çº¿ç¨‹æ± ï¼ˆthreadpoolï¼‰ï¼Œç®€ä»‹ä¸”å¯ä»¥å¸¦ä»»æ„å¤šçš„å‚æ•°ã€‹ï¼š<a href="https://www.cnblogs.com/lzpong/p/6397997.html">https://www.cnblogs.com/lzpong/p/6397997.html</a></li>
<li>ã€ŠC++å¹¶å‘ç¼–ç¨‹ï¼ˆä»C++11åˆ°C++17ï¼‰ã€‹ï¼š<a href="https://paul.pub/cpp-concurrency">https://paul.pub/cpp-concurrency</a></li>
<li>ã€Šä»pthreadè½¬æ¢åˆ°std::threadã€‹ï¼š<a href="https://segmentfault.com/a/1190000002655852">https://segmentfault.com/a/1190000002655852</a></li>
<li>ã€Šè´§æ¯”ä¸‰å®¶ï¼šC++ä¸­çš„task basedå¹¶å‘ã€‹ï¼š<a href="https://segmentfault.com/a/1190000002706259">https://segmentfault.com/a/1190000002706259</a></li>
<li>Github-99è¡Œçº¿ç¨‹æ± å®ç°ï¼š<a href="https://github.com/progschj/ThreadPool">https://github.com/progschj/ThreadPool</a></li>
<li>ã€Šç°ä»£C++ä¹‹ä¸‡èƒ½å¼•ç”¨ã€å®Œç¾è½¬å‘ã€å¼•ç”¨æŠ˜å ã€‹ï¼š<a href="https://zhuanlan.zhihu.com/p/99524127">https://zhuanlan.zhihu.com/p/99524127</a></li>
<li>ã€ŠC++11ä¸­çš„lambdaï¼Œstd::functionä»¥åŠstd:bindã€‹ï¼š<a href="https://paul.pub/cpp-lambda-function-bind/">https://paul.pub/cpp-lambda-function-bind/</a></li>
<li>ã€Šç°ä»£C++æ•™ç¨‹â€”â€”å‘Šè¯‰ä¸Šæ‰‹C++11/14/17/20ã€‹ï¼š<a href="https://changkun.de/modern-cpp/">https://changkun.de/modern-cpp/</a></li>
</ol>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++11</tag>
        <tag>C++é«˜å¹¶å‘</tag>
        <tag>C++çº¿ç¨‹æ± </tag>
      </tags>
  </entry>
  <entry>
    <title>æ¬§æ‹‰ç­›æ³•</title>
    <url>/2020/07/21/euler-prime/</url>
    <content><![CDATA[<h1 id="æ¬§æ‹‰ç­›æ³•"><a href="#æ¬§æ‹‰ç­›æ³•" class="headerlink" title="æ¬§æ‹‰ç­›æ³•"></a>æ¬§æ‹‰ç­›æ³•</h1><blockquote>
<p>åŸåˆ›ç¨‹ç”» æœ€åå‘å¸ƒäº2018-05-15 18:24:08 é˜…è¯»æ•° 4146  æ”¶è—</p>
</blockquote>
<p>æƒ³çœ‹æ¬§æ‹‰ç­›æ³•çš„å¯ç›´æ¥æ‹‰åˆ°æœ€åã€‚</p>
<p>ç›¸ä¿¡å„ä½å¯¹ç´ æ•°å¹¶ä¸é™Œç”Ÿï¼Œç´ æ•°å°±æ˜¯æŒ‡ä¸èƒ½è¢«é™¤äº†1å’Œè‡ªèº«ä»¥å¤–çš„åˆ«çš„æ•°æ•´é™¤çš„æ•°ï¼Œæ¯”å¦‚2,3,5ï¼Œè€Œä¸”æ ¹æ®æ¬§å‡ é‡Œå¾—çš„è¯æ˜æ¥çœ‹ï¼Œç´ æ•°æ˜¯æ— é™çš„ï¼Œæ™®é€šçš„ç­›é€‰ç´ æ•°çš„æ–¹æ³•å¯èƒ½å¯¹è¾ƒå°çš„æ•°æ®èƒ½åœ¨è¾ƒçŸ­æ—¶é—´å†…å®Œæˆç­›é€‰ï¼Œä½†å¯¹äºå¾ˆå¤§çš„æ•°æ®ï¼ˆæ¯”å¦‚1e9ï¼‰å°±ä¼šèŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚</p>
<span id="more"></span>

<h2 id="1-æ™®é€šçš„æ±‚ç´ æ•°æ–¹æ³•"><a href="#1-æ™®é€šçš„æ±‚ç´ æ•°æ–¹æ³•" class="headerlink" title="1.æ™®é€šçš„æ±‚ç´ æ•°æ–¹æ³•"></a>1.æ™®é€šçš„æ±‚ç´ æ•°æ–¹æ³•</h2><p>ä¾‹å¦‚ï¼Œæ™®é€šçš„æ±‚ç´ æ•°æ–¹æ³•æ—¶è¿™æ ·çš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> pri[MAXN];</span><br><span class="line"><span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prime</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cnt=<span class="number">0</span>;</span><br><span class="line">	pri[cnt++]=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">int</span> i,j;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">3</span>;i&lt;=n;++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">2</span>;j&lt;i;++j)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(i%j!=<span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(j&gt;=i)</span><br><span class="line">			pri[cnt++]=i;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ç´ æ•°çš„å®šä¹‰æ‰€å†™çš„ä»£ç å¾ˆå®¹æ˜“ç†è§£ï¼Œä½†æ˜¯è¿è¡Œçš„æ•ˆç‡æ˜¯ä¸å¤ªä¼˜ç§€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ”¹è¿›ï¼Œå½“ç„¶åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ç›¸ä¿¡å¤§å®¶ä¹Ÿæˆ–å¤šæˆ–å°‘çš„å­¦äº†äº›æ”¹è¿›æ–¹æ³•ï¼Œä¸€ä¸ªç®€å•çš„æ”¹è¿›æ–¹æ³•å°±æ˜¯å°†ç¬¬äºŒä¸ªå¾ªç¯çš„ç»“æŸæ¡ä»¶æ”¹ä¸ºj&lt;sqrt(i)ï¼Œç›¸åº”åœ°å†æ›´æ”¹åˆ¤æ–­æ¡ä»¶ï¼Œè¿™æ ·å½“ç„¶å¯ä»¥å‡å°‘æˆ‘ä»¬è¿è¡Œæ‰€éœ€è¦çš„æ—¶é—´ï¼Œä½†æ˜¯ä»»ç„¶ä¸å¤Ÿå¥½ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥ä»‹ç»ä¸€ä¸‹åŸƒå¼ç­›æ³•å’Œä»Šå¤©çš„çœŸæ­£ç›®æ ‡â€”â€”æ¬§æ‹‰ç­›æ³•ã€‚</p>
<h2 id="2-åŸƒå¼ç­›æ³•"><a href="#2-åŸƒå¼ç­›æ³•" class="headerlink" title="2.åŸƒå¼ç­›æ³•"></a>2.åŸƒå¼ç­›æ³•</h2><p>å…ˆæ¥ä»‹ç»åŸƒå¼ç­›æ³•ï¼ŒåŸƒå¼ç­›æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ï¼Œå½“æˆ‘ä»¬éå†åˆ°ä¸€ä¸ªç´ æ•°æ—¶ï¼ŒæŠŠæ‰€æœ‰è¯¥ç´ æ•°çš„å€æ•°ï¼ˆè‡ªç„¶æ˜¯åˆæ•°ï¼‰éƒ½ç­›é€‰å‡ºæ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> prime[MAXN];</span><br><span class="line"><span class="keyword">bool</span> vis[MAXN];</span><br><span class="line"><span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Era_prime</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=n;++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(!vis[i])</span><br><span class="line">			prime[cnt++]=i;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=i;j&lt;=n;j+=i)</span><br><span class="line">		&#123;</span><br><span class="line">			vis[j]=<span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬æœ‰æ²¡è¢«é€‰è¿‡çš„ç´ æ•°æ—¶ï¼ŒåŠ å…¥ç´ æ•°æ•°ç»„primeå¹¶ä¸”å°†å®ƒçš„æ‰€æœ‰nä»¥å†…çš„å€æ•°ç»™ç­›é€‰å‡ºæ¥ï¼ˆvis[j]=trueï¼‰ï¼ŒåŸƒå¼ç­›æ³•å¾ˆå®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”åœ¨æ•ˆç‡ä¸Šä¹Ÿæ¯”è¾ƒä¼˜ç§€ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(nlglgn)ï¼Œä½†æ˜¯åœ¨å¤„ç†1e8ä»¥ä¸Šçš„æ•°æ®æ—¶ï¼Œè¿˜æ˜¯ç¨ç¨åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡ä»‹ç»ä¸‹çº¿æ€§æ—¶é—´ç­›æ³•â€”â€”æ¬§æ‹‰ç­›æ³•ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥çœ‹ä¸‹ä»£ç ï¼š</p>
<h2 id="3-æ¬§æ‹‰ç­›æ³•"><a href="#3-æ¬§æ‹‰ç­›æ³•" class="headerlink" title="3.æ¬§æ‹‰ç­›æ³•"></a>3.æ¬§æ‹‰ç­›æ³•</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> prime[MAXN];</span><br><span class="line"><span class="keyword">bool</span> vis[MAXN];</span><br><span class="line"><span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Euler_prime</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=n;++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(!vis[i])</span><br><span class="line">		&#123;prime[cnt++]=i;vis[i]=<span class="literal">true</span>;&#125;<span class="comment">//vis[i]ç½®ä¸ºtrueæˆ–ä¸ç½®trueéƒ½å¯ä»¥</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;cnt;++j)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(i*prime[j]&gt;n)<span class="comment">//åˆ¤æ–­æ˜¯å¦è¶Šç•Œ</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			vis[i*prime[j]]=<span class="literal">true</span>;<span class="comment">//ç­›æ•°</span></span><br><span class="line">			<span class="keyword">if</span>(i%prime[j]==<span class="number">0</span>)<span class="comment">//æ—¶é—´å¤æ‚åº¦ä¸ºO(n)çš„å…³é”®ï¼</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œåœ¨ç”¨åŸƒå¼ç­›æ³•çš„åŒæ—¶ï¼ŒåŒä¸€ä¸ªæ•°å­—ä¹Ÿè®¸ä¼šè¢«ç­›é€‰å¤šæ¬¡ï¼Œæ¯”å¦‚6å…ˆè¢«2ç­›é€‰ä¸€æ¬¡ï¼Œå†è¢«3ç­›é€‰ä¸€æ¬¡ï¼Œè¿™æ ·å°±æµªè´¹äº†å¾ˆå¤šä¸å¿…è¦çš„æ—¶é—´ï¼Œè€Œæ¬§æ‹‰ç­›æ³•é€šè¿‡<code>if(i%prime[j]==0)break;</code>è¿™ä¸€æ­¥å°±é¿å…äº†é‡å¤ç­›é€‰çš„å‘ç”Ÿï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ï¼Œ2å…ˆç­›é€‰äº†4ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œ3ç­›é€‰6å’Œ9ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œåˆ°4çš„æ—¶å€™ï¼Œå¯ä»¥å‘ç°ï¼Œå½“<code>i==4</code>æ—¶ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œåˆ°<code>if(i%prime[j]==0)</code>è¿™ä¸€æ­¥çš„æ—¶å€™å°±ç›´æ¥<code>break;</code>æ‰äº†ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬çš„åˆæ•°è¿›å…¥å¾ªç¯æ—¶ï¼Œå…¶å®å®ƒå·²ç»è¢«ä¹‹å‰çš„æ•°ç­›é€‰è¿‡äº†ï¼Œæ‰€ä»¥å½“åˆæ•°è¿›å…¥å†…å±‚å¾ªç¯æ—¶ï¼Œå†…å±‚å¾ªç¯åªæ‰§è¡Œäº†ä¸€æ¬¡ï¼Œä»è€Œå‡å°‘äº†æ—¶é—´å¤æ‚åº¦ã€‚</p>
<p>ç»“æŸ</p>
<blockquote>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œç¨‹ç”»ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ª CC 4.0 BY-SA ç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/chczy1/java/article/details/80327323">https://blog.csdn.net/chczy1/java/article/details/80327323</a></p>
</blockquote>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>è½¬è½½</tag>
      </tags>
  </entry>
  <entry>
    <title>Qt Model/Viewï¼ˆæ¨¡å‹/è§†å›¾ï¼‰ç»“æ„ï¼ˆæ— å¸ˆè‡ªé€šï¼‰</title>
    <url>/2020/07/23/model-view/</url>
    <content><![CDATA[<h1 id="Qt-Model-Viewï¼ˆæ¨¡å‹-è§†å›¾ï¼‰ç»“æ„ï¼ˆæ— å¸ˆè‡ªé€šï¼‰"><a href="#Qt-Model-Viewï¼ˆæ¨¡å‹-è§†å›¾ï¼‰ç»“æ„ï¼ˆæ— å¸ˆè‡ªé€šï¼‰" class="headerlink" title="Qt Model/Viewï¼ˆæ¨¡å‹/è§†å›¾ï¼‰ç»“æ„ï¼ˆæ— å¸ˆè‡ªé€šï¼‰"></a>Qt Model/Viewï¼ˆæ¨¡å‹/è§†å›¾ï¼‰ç»“æ„ï¼ˆæ— å¸ˆè‡ªé€šï¼‰</h1><blockquote>
<p>æœ¬æ–‡è½¬è½½è‡ªï¼š</p>
<p><a href="http://c.biancheng.net/view/1864.html">http://c.biancheng.net/view/1864.html</a></p>
</blockquote>
<p>Model/Viewï¼ˆæ¨¡å‹/è§†å›¾ï¼‰ç»“æ„æ˜¯ <a href="http://c.biancheng.net/qt/">Qt</a> ä¸­ç”¨ç•Œé¢ç»„ä»¶æ˜¾ç¤ºä¸ç¼–è¾‘æ•°æ®çš„ä¸€ç§ç»“æ„ï¼Œè§†å›¾ï¼ˆViewï¼‰æ˜¯æ˜¾ç¤ºå’Œç¼–è¾‘æ•°æ®çš„ç•Œé¢ç»„ä»¶ï¼Œæ¨¡å‹ï¼ˆModelï¼‰æ˜¯è§†å›¾ä¸åŸå§‹æ•°æ®ä¹‹é—´çš„æ¥å£ã€‚</p>
<p>GUI åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½æ˜¯ç”±ç”¨æˆ·åœ¨ç•Œé¢ä¸Šç¼–è¾‘å’Œä¿®æ”¹æ•°æ®ï¼Œå…¸å‹çš„å¦‚æ•°æ®åº“åº”ç”¨ç¨‹åºã€‚æ•°æ®åº“åº”ç”¨ç¨‹åºä¸­ï¼Œç”¨æˆ·åœ¨ç•Œé¢ä¸Šæ‰§è¡Œå„ç§æ“ä½œï¼Œå®é™…ä¸Šæ˜¯ä¿®æ”¹äº†ç•Œé¢ç»„ä»¶æ‰€å…³è”çš„æ•°æ®åº“å†…çš„æ•°æ®ã€‚</p>
<p>å°†ç•Œé¢ç»„ä»¶ä¸æ‰€ç¼–è¾‘çš„æ•°æ®åˆ†ç¦»å¼€æ¥ï¼Œåˆé€šè¿‡æ•°æ®æºçš„æ–¹å¼è¿æ¥èµ·æ¥ï¼Œæ˜¯å¤„ç†ç•Œé¢ä¸æ•°æ®çš„ä¸€ç§è¾ƒå¥½çš„æ–¹å¼ã€‚Qt ä½¿ç”¨ Model/View ç»“æ„æ¥å¤„ç†è¿™ç§å…³ç³»ï¼ŒModel/View çš„åŸºæœ¬ç»“æ„å¦‚å›¾ 1 æ‰€ç¤ºã€‚</p>
<p><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z10316062G22.gif" alt="Model/ViewåŸºæœ¬ç»“æ„"></p>
<span id="more"></span>

<p>å…¶ä¸­å„éƒ¨åˆ†çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®ï¼ˆDataï¼‰æ˜¯å®é™…çš„æ•°æ®ï¼Œå¦‚æ•°æ®åº“çš„ä¸€ä¸ªæ•°æ®è¡¨æˆ–SQLæŸ¥è¯¢ç»“æœï¼Œå†…å­˜ä¸­çš„ä¸€ä¸ª StringListï¼Œæˆ–ç£ç›˜æ–‡ä»¶ç»“æ„ç­‰ã€‚</li>
<li>è§†å›¾æˆ–è§†å›¾ç»„ä»¶ï¼ˆViewï¼‰æ˜¯å±å¹•ä¸Šçš„ç•Œé¢ç»„ä»¶ï¼Œè§†å›¾ä»æ•°æ®æ¨¡å‹è·å¾—æ¯ä¸ªæ•°æ®é¡¹çš„æ¨¡å‹ç´¢å¼•ï¼ˆmodel indexï¼‰ï¼Œé€šè¿‡æ¨¡å‹ç´¢å¼•è·å–æ•°æ®ï¼Œç„¶åä¸ºç•Œé¢ç»„ä»¶æä¾›æ˜¾ç¤ºæ•°æ®ã€‚Qt æä¾›ä¸€äº›ç°æˆçš„æ•°æ®è§†å›¾ç»„ä»¶ï¼Œå¦‚ QListViewã€QTreeView å’Œ QTableView ç­‰ã€‚</li>
<li>æ¨¡å‹æˆ–æ•°æ®æ¨¡å‹ï¼ˆModelï¼‰ä¸å®é™…æ•°æ®é€šä¿¡ï¼Œå¹¶ä¸ºè§†å›¾ç»„ä»¶æä¾›æ•°æ®æ¥å£ã€‚å®ƒä»åŸå§‹æ•°æ®æå–éœ€è¦çš„å†…å®¹ï¼Œç”¨äºè§†å›¾ç»„ä»¶è¿›è¡Œæ˜¾ç¤ºå’Œç¼–è¾‘ã€‚Qt ä¸­æœ‰ä¸€äº›é¢„å®šä¹‰çš„æ•°æ®æ¨¡å‹ï¼Œå¦‚ QStringListModel å¯ä½œä¸º StringList çš„æ•°æ®æ¨¡å‹ï¼ŒQSqlTableModel å¯ä»¥ä½œä¸ºæ•°æ®åº“ä¸­ä¸€ä¸ªæ•°æ®è¡¨çš„æ•°æ®æ¨¡å‹ã€‚</li>
</ul>
<p>ç”±äºæ•°æ®æºä¸æ˜¾ç¤ºç•Œé¢é€šè¿‡ Model/View ç»“æ„åˆ†ç¦»å¼€æ¥ï¼Œå› æ­¤å¯ä»¥å°†ä¸€ä¸ªæ•°æ®æ¨¡å‹åœ¨ä¸åŒçš„è§†å›¾ä¸­æ˜¾ç¤ºï¼Œä¹Ÿå¯ä»¥åœ¨ä¸ä¿®æ”¹æ•°æ®æ¨¡å‹çš„æƒ…å†µä¸‹ï¼Œè®¾è®¡ç‰¹æ®Šçš„è§†å›¾ç»„ä»¶ã€‚</p>
<p>åœ¨ Model/View ç»“æ„ä¸­ï¼Œè¿˜æä¾›äº†ä»£ç†ï¼ˆDelegateï¼‰åŠŸèƒ½ï¼Œä»£ç†åŠŸèƒ½å¯ä»¥è®©ç”¨æˆ·å®šåˆ¶æ•°æ®çš„ç•Œé¢æ˜¾ç¤ºå’Œç¼–è¾‘æ–¹å¼ã€‚åœ¨æ ‡å‡†çš„è§†å›¾ç»„ä»¶ä¸­ï¼Œä»£ç†åŠŸèƒ½æ˜¾ç¤ºä¸€ä¸ªæ•°æ®ï¼Œå½“æ•°æ®è¢«ç¼–è¾‘æ—¶ï¼Œä»£ç†é€šè¿‡æ¨¡å‹ç´¢å¼•ä¸æ•°æ®æ¨¡å‹é€šä¿¡ï¼Œå¹¶ä¸ºç¼–è¾‘æ•°æ®æä¾›ä¸€ä¸ªç¼–è¾‘å™¨ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ª QLineEdit ç»„ä»¶ã€‚</p>
<p>æ¨¡å‹ã€è§†å›¾å’Œä»£ç†ä¹‹é—´ä½¿ç”¨ä¿¡å·å’Œæ§½é€šä¿¡ã€‚å½“æºæ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ•°æ®æ¨¡å‹å‘å°„ä¿¡å·é€šçŸ¥è§†å›¾ç»„ä»¶ï¼›å½“ç”¨æˆ·åœ¨ç•Œé¢ä¸Šæ“ä½œæ•°æ®æ—¶ï¼Œè§†å›¾ç»„ä»¶å‘å°„ä¿¡å·è¡¨ç¤ºè¿™äº›æ“ä½œä¿¡æ¯ï¼›å½“ç¼–è¾‘æ•°æ®æ—¶ï¼Œä»£ç†å‘å°„ä¿¡å·å‘ŠçŸ¥æ•°æ®æ¨¡å‹å’Œè§†å›¾ç»„ä»¶ç¼–è¾‘å™¨çš„çŠ¶æ€ã€‚</p>
<h2 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h2><p>æ‰€æœ‰çš„åŸºäºé¡¹æ•°æ®çš„æ•°æ®æ¨¡å‹ï¼ˆModelï¼‰éƒ½æ˜¯åŸºäº QAbstractltemModel ç±»çš„ï¼Œè¿™ä¸ªç±»å®šä¹‰äº†è§†å›¾ç»„ä»¶å’Œä»£ç†å­˜å–æ•°æ®çš„æ¥å£ã€‚æ•°æ®æ— éœ€å­˜å‚¨åœ¨æ•°æ®æ¨¡å‹é‡Œï¼Œæ•°æ®å¯ä»¥æ˜¯å…¶ä»–ç±»ã€æ–‡ä»¶ã€æ•°æ®åº“æˆ–ä»»ä½•æ•°æ®æºã€‚</p>
<p>Qt ä¸­ä¸æ•°æ®æ¨¡å‹ç›¸å…³çš„å‡ ä¸ªä¸»è¦çš„ç±»çš„å±‚æ¬¡ç»“æ„å¦‚å›¾ 2 æ‰€ç¤ºï¼š</p>
<p><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z103160KBJ.gif" alt="Qtä¸­æ¨¡å‹ç±»çš„å±‚æ¬¡ç»“æ„"></p>
<p>å›¾ 2 ä¸­çš„æŠ½è±¡ç±»æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨çš„ï¼Œéœ€è¦ç”±å­ç±»ç»§æ‰¿æ¥å®ç°ä¸€äº›çº¯è™šå‡½æ•°ã€‚Qt æä¾›äº†ä¸€äº›æ¨¡å‹ç±»ç”¨äºé¡¹æ•°æ®å¤„ç†ï¼Œå¸¸è§çš„å‡ ä¸ªè§è¡¨ 3ã€‚</p>
<table>
<thead>
<tr>
<th>Model ç±»</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td>QStringListModel</td>
<td>ç”¨äºå¤„ç†å­—ç¬¦ä¸²åˆ—è¡¨æ•°æ®çš„æ•°æ®æ¨¡å‹ç±»</td>
</tr>
<tr>
<td>QStandardltemModel</td>
<td>æ ‡å‡†çš„åŸºäºé¡¹æ•°æ®çš„æ•°æ®æ¨¡å‹ç±»ï¼Œæ¯ä¸ªé¡¹æ•°æ®å¯ä»¥æ˜¯ä»»ä½•æ•°æ®ç±»å‹</td>
</tr>
<tr>
<td>QFileSy stemModel</td>
<td>è®¡ç®—æœºä¸Šæ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®æ¨¡å‹ç±»</td>
</tr>
<tr>
<td>QSortFilterProxyModel</td>
<td>ä¸å…¶ä»–æ•°æ®æ¨¡å‹ç»“åˆï¼Œæä¾›æ’åºå’Œè¿‡æ»¤åŠŸèƒ½çš„æ•°æ®æ¨¡å‹ç±»</td>
</tr>
<tr>
<td>QSqlQueryModel</td>
<td>ç”¨äºæ•°æ®åº“SQLæŸ¥è¯¢ç»“æœçš„æ•°æ®æ¨¡å‹ç±»</td>
</tr>
<tr>
<td>QSqlTableModel</td>
<td>ç”¨äºæ•°æ®åº“çš„ä¸€ä¸ªæ•°æ®è¡¨çš„æ•°æ®æ¨¡å‹ç±»</td>
</tr>
<tr>
<td>QSqlRelationalTableModel</td>
<td>ç”¨äºå…³ç³»å‹æ•°æ®è¡¨çš„æ•°æ®æ¨¡å‹ç±»</td>
</tr>
</tbody></table>
<p>æ•°æ®åº“ç›¸å…³çš„ 3 ä¸ªæ¨¡å‹ç±»å°†åœ¨ä»‹ç»æ•°æ®åº“ç¼–ç¨‹æ—¶ä¸“é—¨è¯´æ˜ã€‚å¦‚æœè¿™äº›ç°æœ‰çš„æ¨¡å‹ç±»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œç”¨æˆ·å¯ä»¥ä» QAbstractltemModelã€QAbstractListModel æˆ– QAbstractTableModel ç»§æ‰¿ï¼Œç”Ÿæˆè‡ªå·±å®šåˆ¶çš„æ•°æ®æ¨¡å‹ç±»ã€‚</p>
<h2 id="è§†å›¾ç»„ä»¶"><a href="#è§†å›¾ç»„ä»¶" class="headerlink" title="è§†å›¾ç»„ä»¶"></a>è§†å›¾ç»„ä»¶</h2><p>è§†å›¾ç»„ä»¶ï¼ˆViewï¼‰å°±æ˜¯æ˜¾ç¤ºæ•°æ®æ¨¡å‹çš„æ•°æ®çš„ç•Œé¢ç»„ä»¶ï¼ŒQt æä¾›çš„è§†å›¾ç»„ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li>QListViewï¼šç”¨äºæ˜¾ç¤ºå•åˆ—çš„åˆ—è¡¨æ•°æ®ï¼Œé€‚ç”¨äºä¸€ç»´æ•°æ®çš„æ“ä½œã€‚</li>
<li>QTreeViewï¼šç”¨äºæ˜¾ç¤ºæ ‘çŠ¶ç»“æ„æ•°æ®ï¼Œé€‚ç”¨äºæ ‘çŠ¶ç»“æ„æ•°æ®çš„æ“ä½œã€‚</li>
<li>QTableViewï¼šç”¨äºæ˜¾ç¤ºè¡¨æ ¼çŠ¶æ•°æ®ï¼Œé€‚ç”¨äºäºŒç»´è¡¨æ ¼å‹æ•°æ®çš„æ“ä½œã€‚</li>
<li>QColumnViewï¼šç”¨å¤šä¸ªQListViewæ˜¾ç¤ºæ ‘çŠ¶å±‚æ¬¡ç»“æ„ï¼Œæ ‘çŠ¶ç»“æ„çš„ä¸€å±‚ç”¨ä¸€ä¸ªQListViewæ˜¾ç¤ºã€‚</li>
<li>QHeaderViewï¼šæä¾›è¡Œè¡¨å¤´æˆ–åˆ—è¡¨å¤´çš„è§†å›¾ç»„ä»¶ï¼Œå¦‚QTableViewçš„è¡Œè¡¨å¤´å’Œåˆ—è¡¨å¤´ã€‚</li>
</ul>
<p>è§†å›¾ç»„ä»¶åœ¨æ˜¾ç¤ºæ•°æ®æ—¶ï¼Œåªéœ€è°ƒç”¨è§†å›¾ç±»çš„ setModel() å‡½æ•°ï¼Œä¸ºè§†å›¾ç»„ä»¶è®¾ç½®ä¸€ä¸ªæ•°æ®æ¨¡å‹å°±å¯ä»¥å®ç°è§†å›¾ç»„ä»¶ä¸æ•°æ®æ¨¡å‹ä¹‹é—´çš„å…³è”ï¼Œåœ¨è§†å›¾ç»„ä»¶ä¸Šçš„ä¿®æ”¹å°†è‡ªåŠ¨ä¿å­˜åˆ°å…³è”çš„æ•°æ®æ¨¡å‹é‡Œï¼Œä¸€ä¸ªæ•°æ®æ¨¡å‹å¯ä»¥åŒæ—¶åœ¨å¤šä¸ªè§†å›¾ç»„ä»¶é‡Œæ˜¾ç¤ºæ•°æ®ã€‚</p>
<p>å‰é¢ä»‹ç»äº† QListWidgetã€QTreeWidget å’Œ QtableWidget 3ä¸ªå¯ç”¨äºæ•°æ®ç¼–è¾‘çš„ç»„ä»¶ã€‚è¿™ 3 ä¸ªç±»ç§°ä¸ºä¾¿åˆ©ç±»ï¼ˆconvenience classesï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ 3 ä¸ªè§†å›¾ç±»çš„å­ç±»ï¼Œå…¶å±‚æ¬¡å…³ç³»å¦‚å›¾ 4 æ‰€ç¤ºã€‚</p>
<p><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z103160934132.gif" alt="è§†å›¾ç›¸å…³ç±»çš„å±‚æ¬¡ç»“æ„å›¾"></p>
<p>ç”¨äº Model/View ç»“æ„çš„å‡ ä¸ªè§†å›¾ç±»ç›´æ¥ä» QAbstract ItemView ç»§æ‰¿è€Œæ¥ï¼Œè€Œä¾¿åˆ©ç±»åˆ™ä»ç›¸åº”çš„è§†å›¾ç±»ç»§æ‰¿è€Œæ¥ã€‚</p>
<p>è§†å›¾ç»„ä»¶ç±»çš„æ•°æ®é‡‡ç”¨å•ç‹¬çš„æ•°æ®æ¨¡å‹ï¼Œè§†å›¾ç»„ä»¶ä¸å­˜å‚¨æ•°æ®ã€‚ä¾¿åˆ©ç±»åˆ™ä¸ºç»„ä»¶çš„æ¯ä¸ªèŠ‚ç‚¹æˆ–å•å…ƒæ ¼åˆ›å»ºä¸€ä¸ªé¡¹ï¼ˆitemï¼‰ï¼Œç”¨é¡¹å­˜å‚¨æ•°æ®ã€æ ¼å¼è®¾ç½®ç­‰ã€‚æ‰€ä»¥ï¼Œä¾¿åˆ©ç±»æ²¡æœ‰æ•°æ®æ¨¡å‹ï¼Œå®ƒå®é™…ä¸Šæ˜¯ç”¨é¡¹çš„æ–¹å¼é›†æˆäº†æ•°æ®æ¨¡å‹çš„åŠŸèƒ½ï¼Œè¿™æ ·å°±å°†ç•Œé¢ä¸æ•°æ®ç»‘å®šäº†ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¾¿åˆ©ç±»ç¼ºä¹å¯¹å¤§å‹æ•°æ®æºè¿›è¡Œçµæ´»å¤„ç†çš„èƒ½åŠ›ï¼Œé€‚ç”¨äºå°å‹æ•°æ®çš„æ˜¾ç¤ºå’Œç¼–è¾‘ã€‚</p>
<h2 id="ä»£ç†ï¼ˆDelegateï¼‰"><a href="#ä»£ç†ï¼ˆDelegateï¼‰" class="headerlink" title="ä»£ç†ï¼ˆDelegateï¼‰"></a>ä»£ç†ï¼ˆDelegateï¼‰</h2><p>ä»£ç†å°±æ˜¯åœ¨è§†å›¾ç»„ä»¶ä¸Šä¸ºç¼–è¾‘æ•°æ®æä¾›ç¼–è¾‘å™¨ï¼Œå¦‚åœ¨è¡¨æ ¼ç»„ä»¶ä¸­ç¼–è¾‘ä¸€ä¸ªå•å…ƒæ ¼çš„æ•°æ®æ—¶ï¼Œç¼ºçœæ˜¯ä½¿ç”¨ä¸€ä¸ª QLineEdit ç¼–è¾‘æ¡†ã€‚ä»£ç†è´Ÿè´£ä»æ•°æ®æ¨¡å‹è·å–ç›¸åº”çš„æ•°æ®ï¼Œç„¶åæ˜¾ç¤ºåœ¨ç¼–è¾‘å™¨é‡Œï¼Œä¿®æ”¹æ•°æ®åï¼Œåˆå°†å…¶ä¿å­˜åˆ°æ•°æ®æ¨¡å‹ä¸­ã€‚</p>
<p>QAbstractltemDelegate æ˜¯æ‰€æœ‰ä»£ç†ç±»çš„åŸºç±»ï¼Œä½œä¸ºæŠ½è±¡ç±»ï¼Œå®ƒä¸èƒ½ç›´æ¥ä½¿ç”¨ã€‚å®ƒçš„ä¸€ä¸ªå­ç±» QStyledltemDelegateï¼Œæ˜¯ Qt çš„è§†å›¾ç»„ä»¶ç¼ºçœä½¿ç”¨çš„ä»£ç†ç±»ã€‚</p>
<p>å¯¹äºä¸€äº›ç‰¹æ®Šçš„æ•°æ®ç¼–è¾‘éœ€æ±‚ï¼Œä¾‹å¦‚åªå…è®¸è¾“å…¥æ•´å‹æ•°ï¼Œä½¿ç”¨ä¸€ä¸ª QSpinBox ä½œä¸ºä»£ç†ç»„ä»¶æ›´æ°å½“ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©æ•°æ®æ—¶ä½¿ç”¨ä¸€ä¸ª QComboBox ä½œä¸ºä»£ç†ç»„ä»¶æ›´å¥½ã€‚è¿™æ—¶ï¼Œå°±å¯ä»¥ä» QStyledltemDelegate ç»§æ‰¿åˆ›å»ºè‡ªå®šä¹‰ä»£ç†ç±»ã€‚</p>
<h2 id="Model-Viewç»“æ„çš„ä¸€äº›æ¦‚å¿µ"><a href="#Model-Viewç»“æ„çš„ä¸€äº›æ¦‚å¿µ" class="headerlink" title="Model/Viewç»“æ„çš„ä¸€äº›æ¦‚å¿µ"></a>Model/Viewç»“æ„çš„ä¸€äº›æ¦‚å¿µ</h2><p>åœ¨ Model/View ç»“æ„ä¸­ï¼Œæ•°æ®æ¨¡å‹ä¸ºè§†å›¾ç»„ä»¶å’Œä»£ç†æä¾›å­˜å–æ•°æ®çš„æ ‡å‡†æ¥å£ã€‚åœ¨ Qt ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®æ¨¡å‹ç±»éƒ½ä» QAbstractltemModel ç»§æ‰¿è€Œæ¥ï¼Œä¸ç®¡åº•å±‚çš„<a href="http://c.biancheng.net/data_structure/">æ•°æ®ç»“æ„</a>æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®çš„ï¼ŒQAbstractltemModel çš„å­ç±»éƒ½ä»¥è¡¨æ ¼çš„å±‚æ¬¡ç»“æ„è¡¨ç¤ºæ•°æ®ï¼Œè§†å›¾ç»„ä»¶é€šè¿‡è¿™ç§è§„åˆ™æ¥å­˜å–æ¨¡å‹ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯è¡¨ç°ç»™ç”¨æˆ·çš„å½¢å¼ä¸ä¸€æ ·ã€‚</p>
<p><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z1031610455L.gif" alt="æ•°æ®æ¨¡å‹çš„å‡ ç§è¡¨ç°å½¢å¼"></p>
<p>å›¾ 5 æ˜¯æ•°æ®æ¨¡å‹çš„ 3 ç§å¸¸è§è¡¨ç°å½¢å¼ã€‚ä¸ç®¡æ•°æ®æ¨¡å‹çš„è¡¨ç°å½¢å¼æ˜¯æ€ä¹ˆæ ·çš„ï¼Œæ•°æ®æ¨¡å‹ä¸­å­˜å‚¨æ•°æ®çš„åŸºæœ¬å•å…ƒéƒ½æ˜¯é¡¹ï¼ˆitemï¼‰ï¼Œæ¯ä¸ªé¡¹æœ‰ä¸€ä¸ªè¡Œå·ã€ä¸€ä¸ªåˆ—å·ï¼Œè¿˜æœ‰ä¸€ä¸ªçˆ¶é¡¹ã€‚åœ¨åˆ—è¡¨å’Œè¡¨æ ¼æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„é¡¹éƒ½æœ‰ä¸€ä¸ªç›¸åŒçš„é¡¶å±‚é¡¹ï¼›åœ¨æ ‘çŠ¶ç»“æ„ä¸­ï¼Œè¡Œå·ã€åˆ—å·ã€çˆ¶é¡¹ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯ç”±è¿™ 3 ä¸ªå‚æ•°å®Œå…¨å¯ä»¥å®šä¹‰ä¸€ä¸ªé¡¹çš„ä½ç½®ï¼Œä»è€Œå­˜å–é¡¹çš„æ•°æ®ã€‚</p>
<h4 id="æ¨¡å‹ç´¢å¼•ï¼ˆmodel-indexï¼‰"><a href="#æ¨¡å‹ç´¢å¼•ï¼ˆmodel-indexï¼‰" class="headerlink" title="æ¨¡å‹ç´¢å¼•ï¼ˆmodel indexï¼‰"></a>æ¨¡å‹ç´¢å¼•ï¼ˆmodel indexï¼‰</h4><p>ä¸ºäº†ä¿è¯æ•°æ®çš„è¡¨ç¤ºä¸æ•°æ®å­˜å–æ–¹å¼éš”ç¦»ï¼Œæ•°æ®æ¨¡å‹ä¸­å¼•å…¥äº†æ¨¡å‹ç´¢å¼•çš„æ¦‚å¿µã€‚é€šè¿‡æ•°æ®æ¨¡å‹å­˜å–çš„æ¯ä¸ªæ•°æ®éƒ½æœ‰ä¸€ä¸ªæ¨¡å‹ç´¢å¼•ï¼Œè§†å›¾ç»„ä»¶å’Œä»£ç†éƒ½é€šè¿‡æ¨¡å‹ç´¢å¼•æ¥è·å–æ•°æ®ã€‚</p>
<p>QModelIndex è¡¨ç¤ºæ¨¡å‹ç´¢å¼•çš„ç±»ã€‚æ¨¡å‹ç´¢å¼•æä¾›æ•°æ®å­˜å–çš„ä¸€ä¸ªä¸´æ—¶æŒ‡é’ˆï¼Œç”¨äºé€šè¿‡æ•°æ®æ¨¡å‹æå–æˆ–ä¿®æ”¹æ•°æ®ã€‚å› ä¸ºæ¨¡å‹å†…éƒ¨ç»„ç»‡æ•°æ®çš„ç»“æ„éšæ—¶å¯èƒ½æ”¹å˜ï¼Œæ‰€ä»¥æ¨¡å‹ç´¢å¼•æ˜¯ä¸´æ—¶çš„ã€‚å¦‚æœéœ€è¦ä½¿ç”¨æŒä¹…æ€§çš„æ¨¡å‹ç´¢å¼•ï¼Œåˆ™è¦ä½¿ç”¨ QPersistentModelIndex ç±»ã€‚</p>
<h4 id="è¡Œå·å’Œåˆ—å·"><a href="#è¡Œå·å’Œåˆ—å·" class="headerlink" title="è¡Œå·å’Œåˆ—å·"></a>è¡Œå·å’Œåˆ—å·</h4><p>æ•°æ®æ¨¡å‹çš„åŸºæœ¬å½¢å¼æ˜¯ç”¨è¡Œå’Œåˆ—å®šä¹‰çš„è¡¨æ ¼æ•°æ®ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€åº•å±‚çš„æ•°æ®æ˜¯ç”¨äºŒç»´æ•°ç»„å­˜å‚¨çš„ï¼Œä½¿ç”¨è¡Œå’Œåˆ—åªæ˜¯ä¸ºäº†ç»„ä»¶ä¹‹é—´äº¤äº’æ–¹ä¾¿çš„ä¸€ç§è§„å®šã€‚é€šè¿‡æ¨¡å‹ç´¢å¼•çš„è¡Œå·å’Œåˆ—å·å°±å¯ä»¥å­˜å–æ•°æ®ã€‚</p>
<p>è¦è·å¾—ä¸€ä¸ªæ¨¡å‹ç´¢å¼•ï¼Œå¿…é¡»æä¾› 3 ä¸ªå‚æ•°ï¼šè¡Œå·ã€åˆ—å·ã€çˆ¶é¡¹çš„æ¨¡å‹ç´¢å¼•ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå¦‚å›¾ 5 ä¸­çš„è¡¨æ ¼æ•°æ®æ¨¡å‹ä¸­çš„ 3 ä¸ªæ•°æ®é¡¹ Aã€Bã€Cï¼Œè·å–å…¶æ¨¡å‹ç´¢å¼•çš„ä»£ç æ˜¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">QModelIndex indexA = model-&gt;<span class="built_in">index</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">QModelIndex</span>());</span><br><span class="line">QModelIndex indexB = model-&gt;<span class="built_in">index</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="built_in">QModelIndex</span>());</span><br><span class="line">QModelIndex indexC = model-&gt;<span class="built_in">index</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="built_in">QModelIndex</span>());</span><br></pre></td></tr></table></figure>

<p>åœ¨åˆ›å»ºæ¨¡å‹ç´¢å¼•çš„å‡½æ•°ä¸­éœ€è¦ä¼ é€’è¡Œå·ã€åˆ—å·å’Œçˆ¶é¡¹çš„æ¨¡å‹ç´¢å¼•ã€‚å¯¹äºåˆ—è¡¨å’Œè¡¨æ ¼æ¨¡å¼çš„æ•°æ®æ¨¡å‹ï¼Œé¡¶å±‚èŠ‚ç‚¹æ€»æ˜¯ç”¨ QModelIndex() è¡¨ç¤ºã€‚</p>
<h4 id="çˆ¶é¡¹"><a href="#çˆ¶é¡¹" class="headerlink" title="çˆ¶é¡¹"></a>çˆ¶é¡¹</h4><p>å½“æ•°æ®æ¨¡å‹æ˜¯åˆ—è¡¨æˆ–è¡¨æ ¼æ—¶ï¼Œä½¿ç”¨è¡Œå·ã€åˆ—å·å­˜å‚¨æ•°æ®æ¯”è¾ƒç›´è§‚ï¼Œæ‰€æœ‰æ•°æ®é¡¹çš„çˆ¶é¡¹å°±æ˜¯é¡¶å±‚é¡¹ï¼›å½“æ•°æ®æ¨¡å‹æ˜¯æ ‘çŠ¶ç»“æ„æ—¶ï¼Œæƒ…å†µæ¯”è¾ƒå¤æ‚ï¼ˆæ ‘çŠ¶ç»“æ„ä¸­ï¼Œé¡¹ä¸€èˆ¬ä¹ æƒ¯äºç§°ä¸ºèŠ‚ç‚¹ï¼‰ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰çˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œåœ¨æ„é€ æ•°æ®é¡¹çš„æ¨¡å‹ç´¢å¼•æ—¶ï¼Œå¿…é¡»æŒ‡å®šæ­£ç¡®çš„è¡Œå·ã€åˆ—å·å’Œçˆ¶èŠ‚ç‚¹ã€‚</p>
<p>å¯¹äºå›¾ 5 ä¸­çš„æ ‘çŠ¶æ•°æ®æ¨¡å‹ï¼ŒèŠ‚ç‚¹ A å’ŒèŠ‚ç‚¹ C çš„çˆ¶èŠ‚ç‚¹æ˜¯é¡¶å±‚èŠ‚ç‚¹ï¼Œè·å–æ¨¡å‹ç´¢å¼•çš„ä»£ç æ˜¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">QModelIndex indexA = model-&gt;<span class="built_in">index</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">QModelIndex</span>());</span><br><span class="line">QModelIndex indexC = model-&gt;<span class="built_in">index</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="built_in">QModelIndex</span>());</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ï¼ŒèŠ‚ç‚¹ B çš„çˆ¶èŠ‚ç‚¹æ˜¯èŠ‚ç‚¹ Aï¼ŒèŠ‚ç‚¹ B çš„æ¨¡å‹ç´¢å¼•ç”±ä¸‹é¢çš„ä»£ç ç”Ÿæˆï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">QModelIndex indexB = model-&gt;<span class="built_in">index</span>(<span class="number">1</span>, <span class="number">0</span>, indexA);</span><br></pre></td></tr></table></figure>



<h4 id="é¡¹çš„è§’è‰²"><a href="#é¡¹çš„è§’è‰²" class="headerlink" title="é¡¹çš„è§’è‰²"></a>é¡¹çš„è§’è‰²</h4><p>åœ¨ä¸ºæ•°æ®æ¨¡å‹çš„ä¸€ä¸ªé¡¹è®¾ç½®æ•°æ®æ—¶ï¼Œå¯ä»¥èµ‹äºˆå…¶ä¸åŒé¡¹çš„è§’è‰²çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæ•°æ®æ¨¡å‹ç±» QStandardItemModel çš„é¡¹æ•°æ®ç±»æ˜¯ QStandardItemï¼Œå…¶è®¾ç½®æ•°æ®çš„å‡½æ•°æ˜¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QStandardItem::setData</span><span class="params">(<span class="keyword">const</span> QVariant &amp;value, <span class="keyword">int</span> role= Qt::UserRole + <span class="number">1</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œvalue æ˜¯éœ€è¦è®¾ç½®çš„æ•°æ®ï¼Œrole æ˜¯è®¾ç½®æ•°æ®çš„è§’è‰²ã€‚ä¸€ä¸ªé¡¹å¯ä»¥æœ‰ä¸åŒè§’è‰²çš„æ•°æ®ï¼Œç”¨äºä¸åŒçš„åœºåˆã€‚</p>
<p>role æ˜¯ <code>Qt::ItemDataRole</code> æšä¸¾ç±»å‹ï¼Œæœ‰å¤šç§å–å€¼ï¼Œå¦‚ <code>Qt::DisplayRole</code> è§’è‰²æ˜¯åœ¨è§†å›¾ç»„ä»¶ä¸­æ˜¾ç¤ºçš„å­—ç¬¦ä¸²ï¼Œ<code>Qt::ToolTipRole</code> æ˜¯é¼ æ ‡æç¤ºæ¶ˆæ¯ï¼Œ<code>Qt::UserRole</code> å¯ä»¥è‡ªå®šä¹‰æ•°æ®ã€‚é¡¹çš„æ ‡å‡†è§’è‰²æ˜¯ <code>Qt::DisplayRole</code>ã€‚</p>
<p>åœ¨è·å–ä¸€ä¸ªé¡¹çš„æ•°æ®æ—¶ä¹Ÿéœ€è¦æŒ‡å®šè§’è‰²ï¼Œä»¥è·å–ä¸åŒè§’è‰²çš„æ•°æ®ï¼š</p>
<p><code>QVariant QStandardItem::data(int role = Qt::UserRole + 1) const</code></p>
<p>ä¸ºä¸€ä¸ªé¡¹çš„ä¸åŒè§’è‰²å®šä¹‰æ•°æ®ï¼Œå¯ä»¥å‘ŠçŸ¥è§†å›¾ç»„ä»¶å’Œä»£ç†ç»„ä»¶å¦‚ä½•æ˜¾ç¤ºæ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾ 6 ä¸­ï¼Œé¡¹çš„ DisplayRole æ•°æ®æ˜¯æ˜¾ç¤ºçš„å­—ç¬¦ä¸²ï¼ŒDecorationRole æ˜¯ç”¨äºè£…é¥°æ˜¾ç¤ºçš„å±æ€§ï¼ŒToolTipRole å®šä¹‰äº†é¼ æ ‡æç¤ºä¿¡æ¯ã€‚ä¸åŒçš„è§†å›¾ç»„ä»¶å¯¹å„ç§è§’è‰²æ•°æ®çš„è§£é‡Šå’Œæ˜¾ç¤ºå¯èƒ½ä¸ä¸€æ ·ï¼Œä¹Ÿå¯èƒ½å¿½ç•¥æŸäº›è§’è‰²çš„æ•°æ®ã€‚</p>
<p><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z103161340927.gif" alt="ä¸åŒè§’è‰²æ•°æ®çš„è¡¨ç°å½¢å¼"></p>
]]></content>
      <categories>
        <category>Qt</category>
      </categories>
      <tags>
        <tag>è½¬è½½</tag>
        <tag>Qt</tag>
        <tag>Model/View</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL on Qt (1):å®‰è£… MySQL é©±åŠ¨ä»¥åŠè¿æ¥ MySQL ä¸ SQLite</title>
    <url>/2020/07/22/mysqlonqt1/</url>
    <content><![CDATA[<h1 id="MySQL-on-Qt-1-å®‰è£…-MySQL-é©±åŠ¨ä»¥åŠè¿æ¥-MySQL-ä¸-SQLite"><a href="#MySQL-on-Qt-1-å®‰è£…-MySQL-é©±åŠ¨ä»¥åŠè¿æ¥-MySQL-ä¸-SQLite" class="headerlink" title="MySQL on Qt (1): å®‰è£… MySQL é©±åŠ¨ä»¥åŠè¿æ¥ MySQL ä¸ SQLite"></a>MySQL on Qt (1): å®‰è£… MySQL é©±åŠ¨ä»¥åŠè¿æ¥ MySQL ä¸ SQLite</h1><blockquote>
<p>å†™åœ¨å‰é¢ï¼š </p>
<p>å¤§ä¸€ä¸‹å­¦æœŸçš„ CPP å¤§ä½œä¸šâ€œè‡ªä¸»è®¢é¤ç³»ç»Ÿâ€å¯çœŸæ˜¯é¢‡è´¹äº†ä¸€äº›åŠ›æ°”ï¼Œæ¯å¤©æ™šç¡æ—©èµ·æ’¸ä»£ç ï¼Œè¯¾éƒ½æ²¡å¬ï¼Œå¾ˆå¤šçŸ¥è¯†éƒ½æ˜¯ç°å­¦ç°ç”¨ã€‚</p>
<p>ä¸ºäº†é¿å…å½“æ—¶å­¦åˆ°çš„ä¸œè¥¿ç»™å…¨éƒ¨å¿˜å…‰å…‰ï¼ˆ`_&gt;`ï¼Œæˆ‘è¿™è„‘å­å•Šã€‚ã€‚ã€‚ï¼‰ï¼Œæ‰€ä»¥æˆ‘æŠŠå½“æ—¶å¤§ä½œä¸šçš„ä¸€äº›æ ¸å¿ƒéƒ¨åˆ†ï¼ˆä¸€äº›é›¶ç¢çš„å°ç»†èŠ‚ï¼Œèƒ½è®°å°±è®°ï¼‰ç»™è®°å½•ä¸€ä¸‹ï¼Œä¸€æ–¹é¢æ˜¯å¤ä¹ ï¼Œä¸€æ–¹é¢ä¹Ÿæ–¹ä¾¿ä»¥åç”¨åˆ°çš„æ—¶å€™æŸ¥é˜…ã€‚</p>
</blockquote>
<p>è¿™ç¯‡æ–‡ç« æ˜¯å¤§ä½œä¸š MySQL + SQLite æ“ä½œç›¸å…³éƒ¨åˆ†çš„ç¬¬ä¸€ç« ï¼Œä¸»è¦è®²ä¸€ä¸‹å¦‚ä½•å®‰è£… MySQL é©±åŠ¨ï¼ˆWin ä¸‹ï¼‰ä»¥åŠå¦‚ä½•è¿æ¥ MySQL åŠ SQLiteã€‚</p>
<span id="more"></span>

<h2 id="å‡†å¤‡éƒ¨åˆ†â€”â€”å®‰è£…-MySQL-é©±åŠ¨"><a href="#å‡†å¤‡éƒ¨åˆ†â€”â€”å®‰è£…-MySQL-é©±åŠ¨" class="headerlink" title="å‡†å¤‡éƒ¨åˆ†â€”â€”å®‰è£… MySQL é©±åŠ¨"></a>å‡†å¤‡éƒ¨åˆ†â€”â€”å®‰è£… MySQL é©±åŠ¨</h2><p>è¿˜è®°å¾—è·Ÿç€æ•™ç¨‹å­¦ Qt MySQL æ“ä½œçš„æ—¶å€™å…´è‡´å†²å†²åœ°è·Ÿç€æ‰“ä¸‹äº†ä¸€è¡Œè¡Œä»£ç ï¼Œç„¶åç¼–è¯‘â€”è¿è¡Œï¼Œå§æ§½ï¼ŒæŠ¥é”™ã€‚ã€‚ã€‚æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">QSqlDatabase: QMYSQL driver not loaded</span><br><span class="line"></span><br><span class="line">QSqlDatabase: available drivers: QSQLITE QPSQL QPSQL7</span><br><span class="line"></span><br><span class="line">&quot;Driver not loaded Driver not loaded&quot;</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹æŠ¥é”™ä¿¡æ¯ï¼Œå¤§ä½“çš„æ„æ€å°±æ˜¯è¯´ Qt æ²¡æœ‰è¿æ¥ MySQL çš„é©±åŠ¨ã€‚</p>
<p>æŸ¥çœ‹å½“å‰ç³»ç»Ÿç¯å¢ƒä¸­çš„ Qt æ”¯æŒå“ªäº› Sql é©±åŠ¨ï¼Œå¯ä»¥è¾“å‡ºä¸€ä¸‹ QSqlDatabase::drivers() çš„å€¼ã€‚</p>
<p>å‘çˆ¹çš„ Qt åœ¨ Win ä¸‹å¹¶æ²¡æœ‰é™„å¸¦ MySQL çš„è¿æ¥é©±åŠ¨ï¼Œéœ€è¦æˆ‘ä»¬è‡ªè¡Œç¼–è¯‘ã€‚</p>
<p>å¦‚æœåªéœ€è¦è¿æ¥è¿œç¨‹æ•°æ®åº“ï¼Œé‚£æˆ‘ä»¬æœ¬åœ°å¹¶ä¸éœ€è¦å®‰è£… MySQLï¼Œåªè¦æ‰¾åˆ° MySQL æä¾›çš„ <code>libmysql.dll</code> å’Œ <code>libmysqld.dll</code> æ‹·è´åˆ° Qt çš„å®‰è£…ç›®å½•ï¼ˆ<code>%QtDir%/migw.../bin</code>ï¼‰ã€‚ç½‘ä¸Šæœ‰æ•™ç¨‹è¯´ Qt é»˜è®¤è‡ªå¸¦å·²ç»ç¼–è¯‘å¥½çš„ <code>qsqlmysql.dll</code> å’Œ <code>qsqlmysqld.dll</code> ï¼ˆè·¯å¾„åœ¨ <code>%QtDir%/mingw.../plugins/sqldrivers</code>ï¼‰ï¼Œä½†æ˜¯å®æµ‹è¿™äº›æ•™ç¨‹éƒ½å·²ç»è€çš„ä¸èƒ½å†è€äº†ï¼Œæˆ‘çš„å®‰è£…ç›®å½•ä¸‹å°±æ²¡æœ‰è‡ªå¸¦çš„ç¼–è¯‘å¥½çš„è¿™ä¸¤ä¸ª dll æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ç€æ‰‹å®‰è£…å’Œç¼–è¯‘ MySQL é©±åŠ¨ã€‚</p>
<h3 id="ç¬¬ä¸€æ­¥ï¼šä¸‹è½½-MySQL-DLLæ–‡ä»¶"><a href="#ç¬¬ä¸€æ­¥ï¼šä¸‹è½½-MySQL-DLLæ–‡ä»¶" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šä¸‹è½½ MySQL DLLæ–‡ä»¶"></a>ç¬¬ä¸€æ­¥ï¼šä¸‹è½½ MySQL DLLæ–‡ä»¶</h3><p>æ‰”ä¸ªåœ°å€ï¼š </p>
<blockquote>
<p><a href="https://dev.mysql.com/downloads/connector/cpp/">https://dev.mysql.com/downloads/connector/cpp/</a></p>
</blockquote>
<p>ä¸‹è½½ä¸‹æ¥æ‹·è´ä¸€ä¸‹æ‰”è¿‡å»å°±å¥½äº†ã€‚ã€‚ã€‚</p>
<p>ï¼ˆæˆ‘è®°å¾—å½“æ—¶æäº†ä¸€ä¸ªè€ç‰ˆæœ¬çš„æ‰èƒ½ç”¨ã€‚ã€‚ã€‚è®°ä¸æ¸…äº†ã€‚ã€‚ã€‚éœ€è¦çš„æ—¶å€™ç°æå§ã€‚ï¼‰</p>
<h3 id="ç¬¬äºŒæ­¥ï¼š-ç¼–è¯‘-MySQL-é©±åŠ¨"><a href="#ç¬¬äºŒæ­¥ï¼š-ç¼–è¯‘-MySQL-é©±åŠ¨" class="headerlink" title="ç¬¬äºŒæ­¥ï¼š ç¼–è¯‘ MySQL é©±åŠ¨"></a>ç¬¬äºŒæ­¥ï¼š ç¼–è¯‘ MySQL é©±åŠ¨</h3><p>è¿™ä¸€æ­¥æ˜¯é‡ä¸­ä¹‹é‡ï¼Œä¸å·§çš„æ˜¯æˆ‘ä¹Ÿå¿˜çš„å·®ä¸å¤šäº†ã€‚ã€‚ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æœ‰ Qt çš„æºç ï¼Œå¯ä»¥å»ä¸‹è½½ä¸€ä¸‹ã€‚Qt å…¨éƒ¨æºç 2Gå¤§å°ï¼Œæˆ‘ä»¬å¯ä»¥ä»…é€‰æ‹©æ¨¡å—è¿›è¡Œä¸‹è½½ã€‚</p>
<p>ç”¨ Qt æ‰“å¼€æºç ç›®å½•ä¸‹çš„<code>\src\plugins\sqldrivers\mysql\mysql.pro</code>ã€‚</p>
<p>åœ¨æœ«å°¾åŠ ä¸Šä¸¤å¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INCLUDEPATH += mysqlå®‰è£…ç›®å½•\include</span><br><span class="line">LIBS += -Lmysqlå®‰è£…ç›®å½•\lib\ -llibmysql</span><br></pre></td></tr></table></figure>

<p>æ„å»ºé¡¹ç›®åä¼šç”Ÿæˆ <code>qsqlmysql.dll</code> å’Œ <code>qsqlmysqld.dll</code>ä¸¤ä¸ªæ–‡ä»¶ï¼Œç„¶åæ‹·è´åˆ°<code>%QtDir%/mingw.../plugins/sqldrivers</code>æ–‡ä»¶å¤¹ä¸­ã€‚</p>
<p>å‡†å¤‡éƒ¨åˆ†åˆ°è¿™é‡Œå°±å¤§ä½“ç»“æŸäº†ï¼Œç†è®ºä¸Š Qt å°±å·²ç»èƒ½æˆåŠŸè¿æ¥ MySQL ã€‚</p>
<h2 id="ä¸Šè·¯ï¼è¿æ¥-MySQL-å’Œ-SQLite"><a href="#ä¸Šè·¯ï¼è¿æ¥-MySQL-å’Œ-SQLite" class="headerlink" title="ä¸Šè·¯ï¼è¿æ¥ MySQL å’Œ SQLite"></a>ä¸Šè·¯ï¼è¿æ¥ MySQL å’Œ SQLite</h2><h3 id="é…ç½®å·¥ç¨‹æ–‡ä»¶"><a href="#é…ç½®å·¥ç¨‹æ–‡ä»¶" class="headerlink" title="é…ç½®å·¥ç¨‹æ–‡ä»¶"></a>é…ç½®å·¥ç¨‹æ–‡ä»¶</h3><p>è‹¥è¦ä½¿ç”¨ Qt çš„ SQL åº“ï¼Œåˆ™éœ€è¦åœ¨å·¥ç¨‹æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„å‚æ•°ã€‚</p>
<p>CMakeLists.txt:</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Qt5 Sql)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(Ordering-System-Server PRIVATE Qt5::Sql)</span><br></pre></td></tr></table></figure>

<p>.proå·¥ç¨‹æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">QT += sql</span><br></pre></td></tr></table></figure>



<h3 id="è¿æ¥æ•°æ®åº“"><a href="#è¿æ¥æ•°æ®åº“" class="headerlink" title="è¿æ¥æ•°æ®åº“"></a>è¿æ¥æ•°æ®åº“</h3><p>SQL ç”¨åˆ°çš„åº“ä¸»è¦ä¸ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlDatabase&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlError&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlRecord&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlQuery&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlIndex&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ QSqlDatabase æ˜¯æœ€é‡è¦çš„åº“ï¼Œæ•°æ®åº“çš„è¿æ¥åŠå…¶ä»–åŸºæœ¬æ“ä½œéƒ½è¦åœ¨è¿™ä¸ªç±»ä¸Šæ‰§è¡Œã€‚</p>
<p>è¿æ¥æ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦ä¼šç”¨åˆ°ä»¥ä¸‹å‡ ä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ·»åŠ æ•°æ®åº“</span></span><br><span class="line">[<span class="keyword">static</span>] <span class="function">QSqlDatabase <span class="title">QSqlDatabase::addDatabase</span><span class="params">(<span class="keyword">const</span> QString &amp;type, <span class="keyword">const</span> QString &amp;connectionName = QLatin1String(defaultConnection))</span></span></span><br><span class="line"><span class="function"><span class="comment">//è®¾ç½®æ•°æ®åº“ç›¸å…³ä¿¡æ¯</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QSqlDatabase::setHostName</span><span class="params">(<span class="keyword">const</span> QString &amp;host)</span>        <span class="comment">//ä¸»æœºåœ°å€</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QSqlDatabase::setDatabaseName</span><span class="params">(<span class="keyword">const</span> QString &amp;name)</span>    <span class="comment">//æ•°æ®åº“å</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QSqlDatabase::setUserName</span><span class="params">(<span class="keyword">const</span> QString &amp;name)</span>    	   <span class="comment">//æ•°æ®åº“ç”¨æˆ·å</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QSqlDatabase::setPassword</span><span class="params">(<span class="keyword">const</span> QString &amp;password)</span>    <span class="comment">//æ•°æ®åº“å¯†ç </span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QSqlDatabase::setPort</span><span class="params">(<span class="keyword">int</span> port)</span>                       <span class="comment">//æ•°æ®åº“ç«¯å£</span></span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹<code>addDatabase()</code>è¿™ä¸ªå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•° <em>connectionName</em> ï¼Œå¦‚æœä¸æŒ‡å®šè¿™ä¸ªå‚æ•°ï¼Œ<strong>æ¯æ¬¡æ·»åŠ çš„æ•°æ®åº“è¿æ¥éƒ½ä¼šè¢«åº”ç”¨ç¨‹åºå½“ä½œé»˜è®¤è¿æ¥</strong>ã€‚å½“åˆè¢«è¿™ä¸ªå‘äº†å¾ˆä¹…ï¼Œå› ä¸ºå¤§ä½œä¸šä¸­æœåŠ¡ç«¯åŒæ—¶æ“ä½œç€ä¸¤ä¸ªæ•°æ®åº“ï¼Œä¸€ä¸ªè¿œç¨‹ MySQL æ•°æ®åº“ï¼Œä¸€ä¸ªæœ¬åœ° SQLite æ•°æ®åº“ï¼Œæ·»åŠ ç¬¬äºŒä¸ª SQLite æ•°æ®åº“åï¼Œå°±å‡ºé”…ä¸æ–­ï¼ŒåŸå› å°±åœ¨æˆ‘æ²¡æœ‰æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<p><img src="https://gitee.com/skykeyjoker/PicCloud/raw/master/img/adddatabase.png" alt="Qt Docä¸­å…³äº addDatabaseçš„ä»‹ç»"></p>
<p>æ¥ä¸‹æ¥åˆ†åˆ«å°±ç»™ä¸€ä¸‹è¿æ¥ MySQL å’Œ SQLite æ•°æ®åº“çš„èŒƒä¾‹ï¼š</p>
<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL:"></a>MySQL:</h4><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">QSqlDatabase db = QSqlDatabase::<span class="built_in">addDatabase</span>(<span class="string">&quot;QMYSQL&quot;</span>);   <span class="comment">//æ·»åŠ ä¸€ä¸ªæ•°æ®åº“ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®æ•°æ®åº“ä¿¡æ¯</span></span><br><span class="line">db.<span class="built_in">setHostName</span>(_dbHost);</span><br><span class="line">db.<span class="built_in">setDatabaseName</span>(_dbName);</span><br><span class="line">db.<span class="built_in">setUserName</span>(_dbUser);</span><br><span class="line">db.<span class="built_in">setPassword</span>(_dbPasswd);</span><br><span class="line">db.<span class="built_in">setPort</span>(_dbPort);</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> dbRet = db.<span class="built_in">open</span>(); <span class="comment">//è¿æ¥æ•°æ®åº“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!ret)</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Can not open the DB&quot;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Open the DB successfully.&quot;</span>;</span><br></pre></td></tr></table></figure>



<p>SQLite:</p>
<p>å› ä¸º SQLite æ•°æ®åº“æ²¡æœ‰ç½‘ç»œå±‚ï¼Œæ˜¯ä¸€ç§æœ¬åœ°å‚¨å­˜çš„å…³ç³»å‹æ•°æ®åº“ï¼Œå› æ­¤è¿æ¥çš„æ—¶å€™ä¸ MySQL æœ‰å¾ˆå¤§çš„å·®åˆ«ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è®¾ç½®æ•°æ®åº“æ–‡ä»¶å</span></span><br><span class="line">QString dbPath = QDir::<span class="built_in">currentPath</span>()+<span class="string">&quot;/&quot;</span>+<span class="string">&quot;orders.db&quot;</span>;</span><br><span class="line"></span><br><span class="line">sqliteDb = QSqlDatabase::<span class="built_in">addDatabase</span>(<span class="string">&quot;QSQLITE&quot;</span>,<span class="string">&quot;LocalSqlite&quot;</span>);</span><br><span class="line">sqliteDb.<span class="built_in">setDatabaseName</span>(dbPath);</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> ret = sqliteDb.<span class="built_in">open</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!ret)</span><br><span class="line">	<span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Can not open the DB&quot;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Open the DB successfully.&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>æ•°æ®åº“è¿æ¥æˆåŠŸï¼</p>
<hr>
<p>MySQL éƒ¨åˆ†çš„ç¬¬ä¸€ç« åˆ°æ­¤ä¾¿ç»“æŸäº†ï¼Œ æ¥ä¸‹æ¥çš„ä¸€ç« ä¼šè®²è§£ä¸€äº›æ•°æ®åº“çš„åŸºæœ¬æ“ä½œã€‚</p>
<blockquote>
<p>è¡¥å……ï¼š</p>
<p>MySQL ä¸ SQLite çš„åŒºåˆ«ï¼š</p>
<p><a href="https://blog.csdn.net/zbw1185/article/details/47975965">https://blog.csdn.net/zbw1185/article/details/47975965</a></p>
</blockquote>
]]></content>
      <categories>
        <category>Qt</category>
      </categories>
      <tags>
        <tag>Qt</tag>
        <tag>Sql</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL on Qt (3):SQLçš„MVCç»“æ„åŸºç¡€çŸ¥è¯†æ€»ç»“</title>
    <url>/2020/07/24/mysqlonqt3/</url>
    <content><![CDATA[<h1 id="MySQL-on-Qt-3-SQLçš„MVCç»“æ„åŸºç¡€çŸ¥è¯†æ€»ç»“"><a href="#MySQL-on-Qt-3-SQLçš„MVCç»“æ„åŸºç¡€çŸ¥è¯†æ€»ç»“" class="headerlink" title="MySQL on Qt (3): SQLçš„MVCç»“æ„åŸºç¡€çŸ¥è¯†æ€»ç»“"></a>MySQL on Qt (3): SQLçš„MVCç»“æ„åŸºç¡€çŸ¥è¯†æ€»ç»“</h1><blockquote>
<p> å†™åœ¨å‰é¢ï¼š </p>
<p>å¤§ä¸€ä¸‹å­¦æœŸçš„ CPP å¤§ä½œä¸šâ€œè‡ªä¸»è®¢é¤ç³»ç»Ÿâ€å¯çœŸæ˜¯é¢‡è´¹äº†ä¸€äº›åŠ›æ°”ï¼Œæ¯å¤©æ™šç¡æ—©èµ·æ’¸ä»£ç ï¼Œè¯¾éƒ½æ²¡å¬ï¼Œå¾ˆå¤šçŸ¥è¯†éƒ½æ˜¯ç°å­¦ç°ç”¨ã€‚</p>
<p>ä¸ºäº†é¿å…å½“æ—¶å­¦åˆ°çš„ä¸œè¥¿ç»™å…¨éƒ¨å¿˜å…‰å…‰ï¼ˆ`_&gt;`ï¼Œæˆ‘è¿™è„‘å­å•Šã€‚ã€‚ã€‚ï¼‰ï¼Œæ‰€ä»¥æˆ‘æŠŠå½“æ—¶å¤§ä½œä¸šçš„ä¸€äº›æ ¸å¿ƒéƒ¨åˆ†ï¼ˆä¸€äº›é›¶ç¢çš„å°ç»†èŠ‚ï¼Œèƒ½è®°å°±è®°ï¼‰ç»™è®°å½•ä¸€ä¸‹ï¼Œä¸€æ–¹é¢æ˜¯å¤ä¹ ï¼Œä¸€æ–¹é¢ä¹Ÿæ–¹ä¾¿ä»¥åç”¨åˆ°çš„æ—¶å€™æŸ¥é˜…ã€‚</p>
</blockquote>
<p>è¿™ç¯‡æ–‡ç« æ˜¯å¤§ä½œä¸š MySQL + SQLite æ“ä½œç›¸å…³éƒ¨åˆ†çš„ç¬¬ä¸‰ç« ï¼Œä¸»è¦è®²ä¸€ä¸‹ Qt ä¸­ SQL çš„ MVC ç»“æ„çš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬ä¸€éƒ¨åˆ†çš„ MVC åŸç†ä»‹ç»å’ŒåŸºç¡€ä½¿ç”¨ã€‚</p>
<span id="more"></span>

<h2 id="ä»€ä¹ˆæ˜¯-MVC-ç»“æ„"><a href="#ä»€ä¹ˆæ˜¯-MVC-ç»“æ„" class="headerlink" title="ä»€ä¹ˆæ˜¯ MVC ç»“æ„"></a>ä»€ä¹ˆæ˜¯ MVC ç»“æ„</h2><p>å…³äº MVC ç»“æ„çš„å…·ä½“ä»‹ç»ï¼Œå¯ä»¥çœ‹ä¸€ä¸ªåä¸ºã€ŠQtä¸­æ–‡æ–‡æ¡£ã€‹çš„ Github é¡¹ç›®ä¸­ Qt å…³äº MVC çš„å®˜æ–¹æ–‡æ¡£çš„ä¸­æ–‡ç¿»è¯‘ç‰ˆï¼ˆè¿™é‡Œæ‰“ä¸ªå¹¿å‘Š=ã€‚=ï¼‰ï¼š</p>
<blockquote>
<p>æ¨¡å‹/è§†å›¾ ç¼–ç¨‹</p>
<p><a href="https://www.cryfeifei.cn/2020/08/08/qt-zhong-wen-wen-dang-mo-xing-shi-tu-jian-jie/">https://www.cryfeifei.cn/2020/08/08/qt-zhong-wen-wen-dang-mo-xing-shi-tu-jian-jie/</a></p>
</blockquote>
<p>ä¹Ÿå¯ä»¥çœ‹ä¸Šä¸€ç¯‡æˆ‘è½¬è½½è‡ªç½‘ç»œçš„æ–‡ç« ï¼š</p>
<blockquote>
<p>Qt Model/Viewï¼ˆæ¨¡å‹/è§†å›¾ï¼‰ç»“æ„ï¼ˆæ— å¸ˆè‡ªé€šï¼‰</p>
<p><a href="http://www.skykeyjoker.com/2020/07/23/model-view/">http://www.skykeyjoker.com/2020/07/23/model-view/</a></p>
</blockquote>
<p>ä»¥ä¸Šä¸¤ç¯‡ç½‘ç»œæ–‡ç« æˆ‘éƒ½è½¬è½½åˆ°äº†æˆ‘çš„åšå®¢ä¸­ã€‚</p>
<p>è¿™é‡Œæˆ‘å°±ä¸å†è®²å¤ªå¤šå¤ªç»†çš„çŸ¥è¯†å’ŒåŸç†ï¼Œåªæ˜¯ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ã€‚</p>
<p>GUI åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½æ˜¯ç”±ç”¨æˆ·åœ¨ç•Œé¢ä¸Šç¼–è¾‘å’Œä¿®æ”¹æ•°æ®ï¼Œå…¸å‹çš„å¦‚æ•°æ®åº“åº”ç”¨ç¨‹åºã€‚æ•°æ®åº“åº”ç”¨ç¨‹åºä¸­ï¼Œç”¨æˆ·åœ¨ç•Œé¢ä¸Šæ‰§è¡Œå„ç§æ“ä½œï¼Œå®é™…ä¸Šæ˜¯ä¿®æ”¹äº†ç•Œé¢ç»„ä»¶æ‰€å…³è”çš„æ•°æ®åº“å†…çš„æ•°æ®ã€‚</p>
<p>Model/Viewï¼ˆæ¨¡å‹/è§†å›¾ï¼‰ç»“æ„æ˜¯ Qt ä¸­ç”¨ç•Œé¢ç»„ä»¶æ˜¾ç¤ºä¸ç¼–è¾‘æ•°æ®çš„ä¸€ç§ç»“æ„ï¼Œè§†å›¾ï¼ˆViewï¼‰æ˜¯æ˜¾ç¤ºå’Œç¼–è¾‘æ•°æ®çš„ç•Œé¢ç»„ä»¶ï¼Œæ¨¡å‹ï¼ˆModelï¼‰æ˜¯è§†å›¾ä¸åŸå§‹æ•°æ®ä¹‹é—´çš„æ¥å£ã€‚</p>
<p>å°†ç•Œé¢ç»„ä»¶ä¸æ‰€ç¼–è¾‘çš„æ•°æ®åˆ†ç¦»å¼€æ¥ï¼Œåˆé€šè¿‡æ•°æ®æºçš„æ–¹å¼è¿æ¥èµ·æ¥ï¼Œæ˜¯å¤„ç†ç•Œé¢ä¸æ•°æ®çš„ä¸€ç§è¾ƒå¥½çš„æ–¹å¼ã€‚Qt ä½¿ç”¨ Model/View ç»“æ„æ¥å¤„ç†è¿™ç§å…³ç³»ï¼ŒModel/View çš„åŸºæœ¬ç»“æ„å¦‚å›¾ 1 æ‰€ç¤ºã€‚</p>
<p><a href="http://c.biancheng.net/uploads/allimg/190103/2-1Z10316062G22.gif"><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z10316062G22.gif" alt="Model/ViewåŸºæœ¬ç»“æ„"></a></p>
<p>å…¶ä¸­å„éƒ¨åˆ†çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®ï¼ˆDataï¼‰æ˜¯å®é™…çš„æ•°æ®ï¼Œå¦‚æ•°æ®åº“çš„ä¸€ä¸ªæ•°æ®è¡¨æˆ–SQLæŸ¥è¯¢ç»“æœï¼Œå†…å­˜ä¸­çš„ä¸€ä¸ª StringListï¼Œæˆ–ç£ç›˜æ–‡ä»¶ç»“æ„ç­‰ã€‚</li>
<li>è§†å›¾æˆ–è§†å›¾ç»„ä»¶ï¼ˆViewï¼‰æ˜¯å±å¹•ä¸Šçš„ç•Œé¢ç»„ä»¶ï¼Œè§†å›¾ä»æ•°æ®æ¨¡å‹è·å¾—æ¯ä¸ªæ•°æ®é¡¹çš„æ¨¡å‹ç´¢å¼•ï¼ˆmodel indexï¼‰ï¼Œé€šè¿‡æ¨¡å‹ç´¢å¼•è·å–æ•°æ®ï¼Œç„¶åä¸ºç•Œé¢ç»„ä»¶æä¾›æ˜¾ç¤ºæ•°æ®ã€‚Qt æä¾›ä¸€äº›ç°æˆçš„æ•°æ®è§†å›¾ç»„ä»¶ï¼Œå¦‚ QListViewã€QTreeView å’Œ QTableView ç­‰ã€‚</li>
<li>æ¨¡å‹æˆ–æ•°æ®æ¨¡å‹ï¼ˆModelï¼‰ä¸å®é™…æ•°æ®é€šä¿¡ï¼Œå¹¶ä¸ºè§†å›¾ç»„ä»¶æä¾›æ•°æ®æ¥å£ã€‚å®ƒä»åŸå§‹æ•°æ®æå–éœ€è¦çš„å†…å®¹ï¼Œç”¨äºè§†å›¾ç»„ä»¶è¿›è¡Œæ˜¾ç¤ºå’Œç¼–è¾‘ã€‚Qt ä¸­æœ‰ä¸€äº›é¢„å®šä¹‰çš„æ•°æ®æ¨¡å‹ï¼Œå¦‚ QStringListModel å¯ä½œä¸º StringList çš„æ•°æ®æ¨¡å‹ï¼ŒQSqlTableModel å¯ä»¥ä½œä¸ºæ•°æ®åº“ä¸­ä¸€ä¸ªæ•°æ®è¡¨çš„æ•°æ®æ¨¡å‹ã€‚</li>
</ul>
<h2 id="å¼€å¯-MVC-ä¹‹æ—…"><a href="#å¼€å¯-MVC-ä¹‹æ—…" class="headerlink" title="å¼€å¯ MVC ä¹‹æ—…"></a>å¼€å¯ MVC ä¹‹æ—…</h2><p>è®²å®Œåˆè‡­åˆé•¿çš„ç†è®ºï¼Œæˆ‘ä»¬å°±è¦è¿›å…¥ä»¤äººæ¿€åŠ¨çš„å®è·µå•¦ã€‚</p>
<p>å¤–ç”¥æ‰“ç¯ç¬¼ï¼Œè¿™æ¬¡æˆ‘ä¹Ÿæ˜¯å†™äº†ä¸€ä¸ª Demo æ¥æ¼”ç¤ºå…·ä½“çš„åº”ç”¨ã€‚</p>
<p><img src="https://gitee.com/skykeyjoker/PicCloud/raw/master/img/QQ%E5%9B%BE%E7%89%8720200724132133.png" alt="demo"></p>
<p>ä¸ä»¥å¾€ä¸åŒï¼Œè¿™æ¬¡ä¼šå…ˆæŠŠå…¨éƒ¨å·¥ç¨‹ä»£ç è´´å‡ºæ¥å†åˆ†å—è®²ã€‚</p>
<p><code>sqlmvcdemo.h</code>ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SQLMVCDEMO_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SQLMVCDEMO_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QWidget&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHBoxLayout&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVBoxLayout&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QPushButton&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QLineEdit&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QLabel&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTableView&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHeaderView&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlTableModel&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlDatabase&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlError&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlRecord&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">QT_BEGIN_NAMESPACE</span><br><span class="line"><span class="keyword">namespace</span> Ui &#123; <span class="class"><span class="keyword">class</span> <span class="title">SQLMVCDemo</span>;</span> &#125;</span><br><span class="line">QT_END_NAMESPACE</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLMVCDemo</span> :</span> <span class="keyword">public</span> QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SQLMVCDemo</span>(QWidget *parent = <span class="literal">nullptr</span>);</span><br><span class="line">    ~<span class="built_in">SQLMVCDemo</span>();</span><br><span class="line"></span><br><span class="line">    QVBoxLayout *mainLay;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sql model/view</span></span><br><span class="line">    QSqlTableModel *_tableModel;</span><br><span class="line">    QTableView *_tableView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">connectToDb</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::SQLMVCDemo *ui;</span><br><span class="line"></span><br><span class="line">    QSqlDatabase _db = QSqlDatabase::<span class="built_in">addDatabase</span>(<span class="string">&quot;QMYSQL&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// SQLMVCDEMO_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p><code>sqlmvcdemo.cpp</code>ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sqlmvcdemo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ui_sqlmvcdemo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">SQLMVCDemo::<span class="built_in">SQLMVCDemo</span>(QWidget *parent)</span><br><span class="line">    : <span class="built_in">QWidget</span>(parent)</span><br><span class="line">    , <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::SQLMVCDemo)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance</span></span><br><span class="line">    mainLay = <span class="keyword">new</span> <span class="built_in">QVBoxLayout</span>(<span class="keyword">this</span>);</span><br><span class="line">    _tableView = <span class="keyword">new</span> QTableView;</span><br><span class="line">    _tableModel = <span class="keyword">new</span> <span class="built_in">QSqlTableModel</span>(<span class="literal">nullptr</span>,_db); <span class="comment">// Construct from allocated Database</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UI</span></span><br><span class="line">    mainLay-&gt;<span class="built_in">addWidget</span>(_tableView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Connect to Db</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">connectToDb</span>())</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Connected sucessfully.&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Connected failed.&quot;</span>;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Model</span></span><br><span class="line">    _tableModel-&gt;<span class="built_in">setTable</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// Set table</span></span><br><span class="line">    _tableModel-&gt;<span class="built_in">select</span>();  <span class="comment">// Must ** SELECT ** first!</span></span><br><span class="line">    <span class="comment">//_tableModel-&gt;setEditStrategy(QSqlTableModel::OnManualSubmit);  // Manual submit</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//View</span></span><br><span class="line">    _tableView-&gt;<span class="built_in">setModel</span>(_tableModel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Init Hearders</span></span><br><span class="line"><span class="comment">    _tableView-&gt;setColumnCount(5);</span></span><br><span class="line"><span class="comment">    _tableView-&gt;setHorizontalHeader(QStringList()&lt;&lt;&quot;ID&quot;&lt;&lt;&quot;Name&quot;);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set width of cols</span></span><br><span class="line">    _tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">    _tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">1</span>,<span class="number">180</span>);</span><br><span class="line">    _tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">2</span>,<span class="number">100</span>);</span><br><span class="line">    _tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">3</span>,<span class="number">220</span>);</span><br><span class="line">    _tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">4</span>,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resize with stretch</span></span><br><span class="line">    _tableView-&gt;<span class="built_in">horizontalHeader</span>()-&gt;<span class="built_in">setSectionResizeMode</span>(<span class="number">3</span>,QHeaderView::Stretch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Color varies in rows</span></span><br><span class="line">    _tableView-&gt;<span class="built_in">setAlternatingRowColors</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Some propertis of view</span></span><br><span class="line"><span class="comment">    _tableView-&gt;setSelectionBehavior(QAbstractItemView::SelectRows);  // SelectRows</span></span><br><span class="line"><span class="comment">    _tableView-&gt;setSelectionMode(QAbstractItemView::SingleSelection); // SingleSelection</span></span><br><span class="line"><span class="comment">    _tableView-&gt;setEditTriggers(QAbstractItemView::NoEditTriggers);  // NoEditTriggers</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SQLMVCDemo::~<span class="built_in">SQLMVCDemo</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span> ui;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">SQLMVCDemo::connectToDb</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _db.<span class="built_in">setHostName</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    _db.<span class="built_in">setPort</span>(<span class="number">3306</span>);</span><br><span class="line">    _db.<span class="built_in">setDatabaseName</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    _db.<span class="built_in">setUserName</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    _db.<span class="built_in">setPassword</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> ret = _db.<span class="built_in">open</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Model-View-ç›¸å…³çš„ç±»"><a href="#Model-View-ç›¸å…³çš„ç±»" class="headerlink" title="Model/View ç›¸å…³çš„ç±»"></a>Model/View ç›¸å…³çš„ç±»</h3><p>demo å¤´æ–‡ä»¶<code>sqlmvcdemo.h</code>æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†æ˜¯å¤´æ–‡ä»¶<code>include</code>éƒ¨åˆ†ï¼Œè¿™æ¶‰åŠäº† Qt ä¸­ MVC ç›¸å…³çš„ç±»ã€‚</p>
<p>Qt ä¸­ MVC ç»“æ„ç›¸å…³ç±»åˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<p><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z103160KBJ.gif" alt="Qtä¸­æ¨¡å‹ç±»çš„å±‚æ¬¡ç»“æ„"></p>
<p><img src="http://c.biancheng.net/uploads/allimg/190103/2-1Z103160934132.gif" alt="è§†å›¾ç›¸å…³ç±»çš„å±‚æ¬¡ç»“æ„å›¾"></p>
<p>ä»å›¾é‡Œåˆ—å‡ºçš„ç±»ååŸºæœ¬ä¸Šå°±èƒ½æ¨æµ‹å‡ºæˆ‘ä»¬è¦ç”¨åˆ°å“ªäº›ç±»ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTableView&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHeaderView&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSqlTableModel&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>QHeaderView</code> ç±»æ¯”è¾ƒç‰¹æ®Šï¼Œçœ‹èµ·æ¥ä¸æˆ‘ä»¬è¦ä½¿ç”¨çš„ SQL æ¯«ä¸ç›¸å…³å¯¹ä¸å¯¹ã€‚ä½†å…¶å®å®ƒä½œç”¨å¾ˆå¤§ï¼Œåˆ°åé¢ç”¨åˆ°çš„æ—¶å€™å†æ¥è¯´ä¸€è¯´ã€‚</p>
<hr>
<h3 id="SQL-Model-View-ç»‘å®š"><a href="#SQL-Model-View-ç»‘å®š" class="headerlink" title="SQL Model/View ç»‘å®š"></a>SQL Model/View ç»‘å®š</h3><p>æ­£å¦‚å‰é¢æ‰€è¯´ï¼ŒModel ä½œä¸ºæ•°æ®æ¨¡å‹ä¸ºæ“ä½œæ•°æ®æä¾›äº†ç›¸å…³æ¥å£ï¼Œå› è€Œåœ¨ä½¿ç›¸å…³ Model æ—¶æˆ‘ä»¬è¦ç»‘å®šåˆ°å…·ä½“çš„æ•°æ®ä¸Šã€‚åœ¨æˆ‘ä»¬è¿™æ¬¡ä½¿ç”¨çš„ SQL MVC æ¨¡å‹ä¸­ï¼Œå°±æ˜¯è¦æŠŠ <code>QSqlTableModel</code> ä¸ <code>QSqlDatabase</code> å¯¹è±¡ç»‘å®šã€‚æ‰€ä»¥ä¾¿æœ‰äº†å¦‚ä¸‹å®ä¾‹åŒ–ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_tableModel = <span class="keyword">new</span> <span class="built_in">QSqlTableModel</span>(<span class="literal">nullptr</span>,_db); <span class="comment">// Construct from allocated Database</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å¾…ç»‘å®šçš„æ•°æ®åº“è¿æ¥åï¼Œ<code>QSqlTableModel</code>å¯¹è±¡å°±å¯ä»¥å¯¹æ•°æ®åº“è¿›è¡Œç›¸å…³æ“ä½œäº†ã€‚</p>
<p>è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹<code>QSqlTableModel</code>æ¨¡å‹æŒ‡å®šä¸€ä¸ªè¡¨åï¼Œè¿˜è¦æ‰§è¡Œä¸€ä¸‹<code>QSqlTableModel::select()</code>å‡½æ•°æ‰èƒ½é€‰ä¸­è¡¨ä¸­çš„æ•°æ®ã€‚ </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Model</span></span><br><span class="line">_tableModel-&gt;<span class="built_in">setTable</span>(<span class="string">&quot;user&quot;</span>); <span class="comment">// Set table</span></span><br><span class="line">_tableModel-&gt;<span class="built_in">select</span>();  <span class="comment">// Must ** SELECT ** first!</span></span><br></pre></td></tr></table></figure>

<p>å…³äºæ•°æ®æ¨¡å‹æˆ‘ä»¬è¿˜è¦è€ƒè™‘ä¸€ä¸ªå°ç»†èŠ‚ï¼š<strong>ç”¨æˆ·æäº¤ç­–ç•¥</strong></p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç”¨æˆ·å®Œæˆæ•°æ®ç¼–è¾‘åï¼Œä¼šæœ‰ä¸¤ç§æäº¤ç­–ç•¥ï¼š</p>
<ul>
<li>è‡ªåŠ¨æäº¤ï¼ˆé»˜è®¤ï¼‰ï¼Œå³ç¼–è¾‘å®Œæ•°æ®ï¼ˆ dataChanged() ï¼‰åï¼Œæ•°æ®æ¨¡å‹è‡ªåŠ¨æäº¤ã€‚</li>
<li>æ‰‹åŠ¨æäº¤ï¼Œå³ç¼–è¾‘å®Œæ•°æ®åï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨æäº¤å‡½æ•°æ–¹èƒ½æäº¤ç”¨æˆ·æ•°æ®ä¿®æ”¹ã€‚</li>
</ul>
<p>è‹¥è¦è®¾ç½®ä¸ºæ‰‹åŠ¨æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Model è¿›è¡Œå¦‚ä¸‹è®¾ç½®ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_tableModel-&gt;<span class="built_in">setEditStrategy</span>(QSqlTableModel::OnManualSubmit); <span class="comment">// Manual submit</span></span><br></pre></td></tr></table></figure>

<p>å¹¶åœ¨ç›¸åº”ä½ç½®æ‰‹åŠ¨è°ƒç”¨è¯¥å‡½æ•°æäº¤ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_tableModel-&gt;<span class="built_in">submitAll</span>()</span><br></pre></td></tr></table></figure>

<hr>
<p>å‰é¢ä¹Ÿè¯´è¿‡ï¼ŒView æ˜¯è§†å›¾ç»“æ„ï¼Œä¸æ•°æ®æ¨¡å‹ç»‘å®šï¼Œä¸ºç”¨æˆ·æ“ä½œæä¾›ç›¸åº”çš„æ¥å£ï¼Œå¹¶å°†ç”¨æˆ·æ“ä½œå…·ä½“åº”ç”¨åˆ°æ•°æ®æ¨¡å‹ï¼Œæ•°æ®æ¨¡å‹å†å°†æ“ä½œå®é™…åº”ç”¨åˆ°æ•°æ®ä¸­ã€‚åœ¨æˆ‘ä»¬è¿™æ¬¡ä½¿ç”¨çš„ SQL MVC æ¨¡å‹ä¸­ï¼Œå°±æ˜¯è¦æŠŠ <code>QTableView</code> ä¸ <code>QSqlTableModel</code>ç»‘å®šã€‚æ‰€ä»¥ä¾¿æœ‰ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_tableView-&gt;<span class="built_in">setModel</span>(_tableModel);</span><br></pre></td></tr></table></figure>

<p>å¯¹ View æ§ä»¶çš„è®¾ç½®ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ–¹é¢ï¼š</p>
<ul>
<li>è¡¨å¤´è®¾ç½®</li>
<li>ç¼–è¾‘ç­–ç•¥</li>
<li>ä»£ç†</li>
</ul>
<h4 id="View-è¡¨å¤´è®¾ç½®"><a href="#View-è¡¨å¤´è®¾ç½®" class="headerlink" title="View è¡¨å¤´è®¾ç½®"></a>View è¡¨å¤´è®¾ç½®</h4><p>å…ˆæ¥è®²ä¸€ä¸‹ View æ§ä»¶è¡¨å¤´çš„è®¾ç½®ã€‚</p>
<p>è¿˜è®°å¾—å‰é¢æåˆ°çš„<code>QHeaderView</code>ç±»å˜›ï¼Ÿè¿™é‡Œå¯¹è¡¨å¤´çš„å„ç§è®¾ç½®ï¼Œå°±å¿…é¡»å¼•ç”¨è¯¥ç±»ã€‚</p>
<p>é¦–å…ˆæ˜¯è®¾ç½®è¡¨å¤´ï¼Œè¿™é‡Œä»¥æ°´å¹³è¡¨å¤´ä¸ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Init Hearders</span></span><br><span class="line">_tableView-&gt;<span class="built_in">setColumnCount</span>(<span class="number">5</span>);</span><br><span class="line">_tableView-&gt;<span class="built_in">setHorizontalHeader</span>(<span class="built_in">QStringList</span>()&lt;&lt;<span class="string">&quot;ID&quot;</span>&lt;&lt;<span class="string">&quot;Name&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬è‚¯å®šä¼šé‡åˆ°è¦è®¾ç½®æŸä¸€åˆ—å®½åº¦çš„æƒ…å†µï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Set width of cols</span></span><br><span class="line">_tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">_tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">1</span>,<span class="number">180</span>);</span><br><span class="line">_tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">2</span>,<span class="number">100</span>);</span><br><span class="line">_tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">3</span>,<span class="number">220</span>);</span><br><span class="line">_tableView-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">4</span>,<span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜èƒ½è®¾ç½®æŸä¸€åˆ—çš„å®½åº¦éšç€ç•Œé¢ç¼©æ”¾æ¯”ä¾‹è€Œæ”¹å˜ï¼ˆå»ºè®®å¼€å¯è¯¥é€‰é¡¹ï¼Œè¿™æ ·æ‰èƒ½è®©è¡¨æ ¼å æ»¡ View æ§ä»¶ï¼Œç¾è§‚åº¦++ï¼‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Resize with stretch</span></span><br><span class="line">_tableView-&gt;<span class="built_in">horizontalHeader</span>()-&gt;<span class="built_in">setSectionResizeMode</span>(<span class="number">3</span>,QHeaderView::Stretch);</span><br></pre></td></tr></table></figure>

<p>å†æ¥è®¾ç½®ä¸€ä¸‹è®©æ•°æ®æŒ‰è¡Œäº¤æ›¿ç°å®ä¸åŒçš„é¢œè‰²ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Color varies in rows</span></span><br><span class="line">_tableView-&gt;<span class="built_in">setAlternatingRowColors</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="ç¼–è¾‘ç­–ç•¥"><a href="#ç¼–è¾‘ç­–ç•¥" class="headerlink" title="ç¼–è¾‘ç­–ç•¥"></a>ç¼–è¾‘ç­–ç•¥</h4><p>æŒ‰è¡Œé€‰ä¸­è€Œä¸æ˜¯æŒ‰å•å…ƒæ ¼é€‰ä¸­ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_tableView-&gt;<span class="built_in">setSelectionBehavior</span>(QAbstractItemView::SelectRows);  <span class="comment">// SelectRows</span></span><br></pre></td></tr></table></figure>

<p>å•é€‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_tableView-&gt;<span class="built_in">setSelectionMode</span>(QAbstractItemView::SingleSelection); <span class="comment">// SingleSelection</span></span><br></pre></td></tr></table></figure>

<p>åªè¯»ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_tableView-&gt;<span class="built_in">setEditTriggers</span>(QAbstractItemView::NoEditTriggers);  <span class="comment">// NoEditTriggers</span></span><br></pre></td></tr></table></figure>

<h4 id="ä»£ç†"><a href="#ä»£ç†" class="headerlink" title="ä»£ç†"></a>ä»£ç†</h4><p>ä¾‹å¦‚æœ¬ Demo ä¸­çš„ Gender é¡¹ï¼Œæˆ‘æƒ³ç¼–è¾‘çš„æ—¶å€™å‡ºç°ä¸€ä¸ªâ€œç”·ç”Ÿ|å¥³ç”Ÿâ€çš„ä¸‹æ‹‰æ¡†è€Œä¸æ˜¯ä»…ä»…å‡ºç°ä¸€ä¸ª0æˆ–1çš„ç¼–è¾‘æ¡†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ä»£ç†ã€‚</p>
<p>ä»£ç†è¿™é‡Œå…ˆå–ä¸€ä¸ªå…³å­ã€‚</p>
<p>å¥½å§å…¶å®ä¸æ˜¯å–å…³å­ï¼Œè€Œæ˜¯å¤ªé•¿äº†å®åœ¨æ˜¯ä¸æƒ³åœ¨è¿™ä¸€ç« è®²äº†ã€‚ã€‚ã€‚</p>
<p>ä»£ç†æ˜¯ä¸€ä¸ªå¾ˆåºå¤§çš„éƒ¨åˆ†ï¼Œæˆ‘æ‰“ç®—åœ¨ä¸‹ä¸€ç« è®²ä¸€äº›çš®æ¯›çš„ä¸œè¥¿ã€‚</p>
<hr>
<p>åˆ°è¿™é‡Œæœ¬ç« çš„å†…å®¹åŸºæœ¬ä¸Šå°±ç»“æŸäº†ï¼Œä¸‹ä¸€ç« æˆ‘ä¼šè®²ä¸€ä¸‹ä»£ç†æœ€ä¸ºçš®æ¯›çš„ä¸€äº›åŸç†å’Œåº”ç”¨ã€‚</p>
<blockquote>
<p>Qt Model/Viewï¼ˆæ¨¡å‹/è§†å›¾ï¼‰ç»“æ„ï¼ˆæ— å¸ˆè‡ªé€šï¼‰</p>
<p><a href="http://www.skykeyjoker.com/2020/07/23/model-view/">http://www.skykeyjoker.com/2020/07/23/model-view/</a></p>
</blockquote>
]]></content>
      <categories>
        <category>Qt</category>
      </categories>
      <tags>
        <tag>Qt</tag>
        <tag>Model/View</tag>
        <tag>Sql</tag>
      </tags>
  </entry>
  <entry>
    <title>Qtå®ç°ç®€æ˜“å¿ƒè·³åŒ…æœºåˆ¶</title>
    <url>/2022/01/01/tcpheart/</url>
    <content><![CDATA[<h1 id="Qtå®ç°ç®€æ˜“å¿ƒè·³åŒ…æœºåˆ¶"><a href="#Qtå®ç°ç®€æ˜“å¿ƒè·³åŒ…æœºåˆ¶" class="headerlink" title="Qtå®ç°ç®€æ˜“å¿ƒè·³åŒ…æœºåˆ¶"></a>Qtå®ç°ç®€æ˜“å¿ƒè·³åŒ…æœºåˆ¶</h1><p>å› ä¸ºç½‘ç»œé€šä¿¡çš„ä¸ç¨³å®šæ€§ï¼Œåœ¨ä¸€äº›å®æ—¶æ€§ã€ç½‘ç»œç¨³å®šæ€§è¦æ±‚è¾ƒé«˜çš„æƒ…å¢ƒä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®æ—¶æ£€æµ‹å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„è¿æ¥çŠ¶æ€å’Œé€šä¿¡åŠŸèƒ½æ˜¯å¦è¿è¡Œæ­£å¸¸çš„æœºåˆ¶ï¼Œå¿ƒè·³åŒ…æœºåˆ¶ä¾¿æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šè®²ä¸€ä¸‹åœ¨ä¹‹å‰çš„ä¸€ä¸ªå°é¡¹ç›®ä¸­ï¼Œåˆ©ç”¨Qtå®ç°çš„ç®€æ˜“å¿ƒè·³åŒ…æ£€æµ‹æœºåˆ¶ã€‚</p>
<span id="more"></span>

<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p><img src="%E5%AE%A2%E6%88%B7%E7%AB%AF.jpg" alt="å®¢æˆ·ç«¯"></p>
<p><img src="%E6%9C%8D%E5%8A%A1%E7%AB%AF.jpg" alt="æœåŠ¡ç«¯"></p>
<p>å¿ƒè·³åŒ…æ£€æµ‹çš„åŸç†æ˜¯å®¢æˆ·ç«¯å®šæ—¶å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³åŒ…ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°å¿ƒè·³åŒ…åç«‹å³å›å¤å®¢æˆ·ç«¯ã€‚æ­¤é—´å®¢æˆ·ç«¯æ£€æŸ¥å¿ƒè·³åŒ…æ˜¯å¦å‘é€æˆåŠŸä»¥åŠæ˜¯å¦è¶…æ—¶ã€‚åœ¨ä¸€äº›å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„æƒ…å¢ƒä¸‹ï¼Œæ£€æµ‹å¿ƒè·³åŒ…è¶…æ—¶æ˜¯æœ‰å¿…è¦çš„ã€‚å¯ä»¥é€šè¿‡è®°å½•ç­‰å¾…å›å¤çš„å¿ƒè·³åŒ…æ•°æ¥å®ç°æ£€æµ‹å¿ƒè·³åŒ…è¶…æ—¶ã€‚</p>
<h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><h3 id="å¯åŠ¨å®šæ—¶å™¨"><a href="#å¯åŠ¨å®šæ—¶å™¨" class="headerlink" title="å¯åŠ¨å®šæ—¶å™¨"></a>å¯åŠ¨å®šæ—¶å™¨</h3><p>å®¢æˆ·ç«¯çš„æ ¸å¿ƒåœ¨äºå®šæ—¶å‘é€å¿ƒè·³åŒ…ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ä¸€ä¸ª<em>TcpHeart</em>ç±»æ¥å®ç°å®šæ—¶å‘é€å¿ƒè·³åŒ…ã€‚</p>
<p><em>TcpHeart</em>ç±»å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTimer&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TcpHeart</span> :</span> <span class="keyword">public</span> QObject &#123;</span><br><span class="line">	Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">TcpHeart</span><span class="params">(QObject* parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">	~<span class="built_in">TcpHeart</span>() <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">startHeartTimer</span><span class="params">()</span></span>;  <span class="comment">// å¯åŠ¨å®šæ—¶å™¨</span></span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sigHeartBad</span><span class="params">()</span></span>;  <span class="comment">// å¿ƒè·³åŒ…é”™è¯¯ä¿¡å·</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sigHeartReq</span><span class="params">()</span></span>;  <span class="comment">// å‘é€å¿ƒè·³åŒ…ä¿¡å·</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slotTimeOut</span><span class="params">()</span></span>;  <span class="comment">// å®šæ—¶äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slotHeartBack</span><span class="params">()</span></span>;  <span class="comment">// æ”¶åˆ°æœåŠ¡ç«¯å¿ƒè·³åŒ…å›å¤</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	QTimer* m_heart_timer;</span><br><span class="line">	<span class="keyword">int</span> m_count;  <span class="comment">// ç­‰å¾…å›å¤å¿ƒè·³åŒ…ç´¯è®¡æ•°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><em>TcpHeart</em>æ ¸å¿ƒæ˜¯åˆ©ç”¨QTimerå®ç°ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå®šæ—¶å™¨timeOutæ¶ˆæ¯å‘å‡ºåï¼Œæ£€æµ‹å½“å‰ç­‰å¾…å›å¤çš„å¿ƒè·³åŒ…æ•°é‡ã€‚<strong>è‹¥ç­‰å¾…å›å¤çš„å¿ƒè·³åŒ…æ•°é‡â‰¤3</strong>ï¼Œåˆ™å¯ä»¥ç»§ç»­å‘é€å¿ƒè·³åŒ…ï¼Œå¹¶å¢åŠ ç­‰å¾…å›å¤çš„å¿ƒè·³åŒ…æ•°é‡ï¼›å¦åˆ™é‡‡å–å¿ƒè·³åŒ…è¶…æ—¶å¤„ç†ï¼Œåœæ­¢è®¡æ—¶å™¨å¹¶å‘é€å¿ƒè·³åŒ…é”™è¯¯æ¶ˆæ¯ã€‚</p>
<p>å®šæ—¶äº‹ä»¶<code>slotTimeOut()</code>å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpHeart::slotTimeOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_count &gt; <span class="number">2</span>) &#123;</span><br><span class="line">		m_count = <span class="number">0</span>;</span><br><span class="line">		m_heart_timer-&gt;<span class="built_in">stop</span>();</span><br><span class="line">		<span class="function">emit <span class="title">sigHeartBad</span><span class="params">()</span></span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m_count++;</span><br><span class="line">	<span class="function">emit <span class="title">sigHeartReq</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ”¶åˆ°æœåŠ¡ç«¯å¿ƒè·³åŒ…å›å¤åï¼Œæˆ‘ä»¬éœ€è¦å°†ç­‰å¾…å›å¤çš„å¿ƒè·³åŒ…è®¡æ•°æ¸…é›¶ã€‚è¿™é‡Œéœ€è¦ç›´æ¥å°†è®¡æ•°æ¸…é›¶ï¼Œå› ä¸ºæ¯æ¬¡æ”¶åˆ°å›å¤åï¼Œè¶…æ—¶æ£€æµ‹æœºåˆ¶éƒ½åº”é‡æ–°å¯åŠ¨ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpHeart::slotHeartBack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	m_count = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>TcpHeart</em>çš„å®Œæ•´å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">TcpHeart::<span class="built_in">TcpHeart</span>(QObject *parent)</span><br><span class="line">	: <span class="built_in">QObject</span>(parent) &#123;</span><br><span class="line">	m_heart_timer = <span class="keyword">new</span> <span class="built_in">QTimer</span>(<span class="keyword">this</span>);</span><br><span class="line">	m_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">connect</span>(m_heart_timer, &amp;QTimer::timeout, <span class="keyword">this</span>, &amp;TcpHeart::slotTimeOut);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TcpHeart::~<span class="built_in">TcpHeart</span>() <span class="keyword">noexcept</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpHeart::startHeartTimer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	m_heart_timer-&gt;<span class="built_in">start</span>(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpHeart::slotTimeOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_count &gt; <span class="number">2</span>) &#123;</span><br><span class="line">		m_count = <span class="number">0</span>;</span><br><span class="line">		m_heart_timer-&gt;<span class="built_in">stop</span>();</span><br><span class="line">		<span class="function">emit <span class="title">sigHeartBad</span><span class="params">()</span></span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m_count++;</span><br><span class="line">	<span class="function">emit <span class="title">sigHeartReq</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpHeart::slotHeartBack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	m_count = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å‘é€å¿ƒè·³åŒ…"><a href="#å‘é€å¿ƒè·³åŒ…" class="headerlink" title="å‘é€å¿ƒè·³åŒ…"></a>å‘é€å¿ƒè·³åŒ…</h3><p>æ­£å¼å®ç°å¿ƒè·³åŒ…æœºåˆ¶çš„ç±»æ˜¯<em>StatusClient</em>ã€‚<em>StatusClient</em>ç±»å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTcpSocket&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TcpHeart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;json.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StatusClient</span> :</span> <span class="keyword">public</span> QObject &#123;</span><br><span class="line">	Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">StatusClient</span><span class="params">(<span class="keyword">const</span> QString host, <span class="keyword">const</span> <span class="keyword">int</span> port, QObject *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">connectedToServer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sigHeartBack</span><span class="params">()</span></span>;              <span class="comment">// å¿ƒè·³åŒ…è¿”å›</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">signalDisconnectedToServer</span><span class="params">()</span></span>;<span class="comment">//  å¿ƒè·³åŒ…æ–­è¿</span></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slotStatusReadyRead</span><span class="params">()</span></span>; <span class="comment">// å®¢æˆ·ç«¯çŠ¶æ€ä¿¡é“</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slotWriteHeartSocket</span><span class="params">()</span></span>;<span class="comment">// å†™å¿ƒè·³åŒ…</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slotHeartBad</span><span class="params">()</span></span>;        <span class="comment">// å¿ƒè·³åŒ…æ‰çº¿å¤„ç†</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// å®¢æˆ·ç«¯çŠ¶æ€ä¿¡é“</span></span><br><span class="line">	QTcpSocket *_statusSocket;<span class="comment">// å®¢æˆ·ç«¯çŠ¶æ€ä¿¡é“</span></span><br><span class="line">	TcpHeart *heart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	QString m_host;</span><br><span class="line">	<span class="keyword">int</span> m_port;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨æˆ‘ä¹‹å‰çš„é‚£ä¸ªå°é¡¹ç›®ä¸­ï¼Œå®¢æˆ·ç«¯æœåŠ¡ç«¯åˆ©ç”¨JSONè¿›è¡Œé€šä¿¡ï¼Œå®šä¹‰äº†ä¸€äº›åŒæ–¹ä¹‹é—´é€šä¿¡çš„ä¸€äº›æ¶ˆæ¯æ ¼å¼ï¼Œå¦‚codeå­—æ®µåŒºåˆ†æ­£å¸¸æ¶ˆæ¯ä¸å¿ƒè·³åŒ…æ¶ˆæ¯ã€‚</p>
<p><em>StatusClient</em>é¦–å…ˆä¸å¿ƒè·³åŒ…æœåŠ¡å™¨å»ºç«‹é“¾æ¥ï¼Œåœ¨æ”¶åˆ°æœåŠ¡å™¨ç«¯çš„â€OKâ€æ¶ˆæ¯åï¼Œä¾¿åˆ©ç”¨<em>TcpHeart</em>ç±»å¼€å¯å®šæ—¶å™¨ï¼Œå®šæ—¶å‘æœåŠ¡å™¨å‘é€å¿ƒè·³åŒ…ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::slotStatusReadyRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// æ”¶åˆ°æœåŠ¡ç«¯å‘æ¥çš„å®¢æˆ·ç«¯çŠ¶æ€æŸ¥è¯¢</span></span><br><span class="line">	QByteArray data;</span><br><span class="line">	data = _statusSocket-&gt;<span class="built_in">readAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">using</span> Json = nlohmann::json;</span><br><span class="line">	<span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºçŠ¶æ€æŸ¥è¯¢</span></span><br><span class="line">	QString dataStr = QString::<span class="built_in">fromUtf8</span>(data);</span><br><span class="line">	Json json = Json::<span class="built_in">parse</span>(dataStr.<span class="built_in">toUtf8</span>(), <span class="literal">nullptr</span>, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">int</span> code = json[<span class="string">&quot;code&quot;</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (code == <span class="number">2</span>) &#123;</span><br><span class="line">		QString msgStr = QString::<span class="built_in">fromStdString</span>(json[<span class="string">&quot;Msg&quot;</span>].get&lt;std::string&gt;());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (msgStr == <span class="string">&quot;OK&quot;</span>)<span class="comment">// æœåŠ¡å™¨è¿”å›&quot;OK&quot;ï¼Œå¼€å¯å¿ƒè·³åŒ…æ£€æµ‹</span></span><br><span class="line">		&#123;</span><br><span class="line">			heart = <span class="keyword">new</span> TcpHeart;</span><br><span class="line">			<span class="comment">// å¼€å§‹å¿ƒè·³æ£€æµ‹</span></span><br><span class="line">			heart-&gt;<span class="built_in">startHeartTimer</span>();</span><br><span class="line">			<span class="built_in">connect</span>(heart, &amp;TcpHeart::sigHeartReq, <span class="keyword">this</span>, &amp;StatusClient::slotWriteHeartSocket);<span class="comment">// å‘é€å¿ƒè·³åŒ…</span></span><br><span class="line">			<span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;StatusClient::sigHeartBack, heart, &amp;TcpHeart::slotHeartBack);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¤„ç†å¿ƒè·³åŒ…å¼‚å¸¸</span></span><br><span class="line">			<span class="built_in">connect</span>(heart, &amp;TcpHeart::sigHeartBad, <span class="keyword">this</span>, &amp;StatusClient::slotHeartBad);</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		...</span><br><span class="line">           </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘æœåŠ¡ç«¯å®šæ—¶å‘é€å¿ƒè·³åŒ…æ¶ˆæ¯ï¼Œè‹¥å‘é€å¤±è´¥ï¼Œè¿›è¡Œå¿ƒè·³åŒ…æ‰çº¿å¤„ç†ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::slotWriteHeartSocket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	QByteArray data;</span><br><span class="line">	<span class="comment">// æ„å»ºçŠ¶æ€è¿”å›</span></span><br><span class="line">	<span class="keyword">using</span> Json = nlohmann::json;</span><br><span class="line">	Json jsonValue;</span><br><span class="line">	jsonValue[<span class="string">&quot;code&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">	jsonValue[<span class="string">&quot;Msg&quot;</span>] = <span class="string">&quot;Heart&quot;</span>;</span><br><span class="line">	data = QString::<span class="built_in">fromStdString</span>(jsonValue.<span class="built_in">dump</span>(<span class="number">2</span>)).<span class="built_in">toUtf8</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// çŠ¶æ€ä¿¡é“ï¼Œå‘æœåŠ¡ç«¯å‘é€å¿ƒè·³åŒ…</span></span><br><span class="line">	<span class="built_in">qDebug</span>() &lt;&lt; <span class="keyword">this</span>-&gt;<span class="built_in">thread</span>() &lt;&lt; <span class="string">&quot;å‘é€ä¸€æ¬¡å¿ƒè·³åŒ…&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// çŠ¶æ€ä¿¡é“</span></span><br><span class="line">	<span class="keyword">bool</span> ret = _statusSocket-&gt;<span class="built_in">write</span>(data);</span><br><span class="line">	_statusSocket-&gt;<span class="built_in">waitForBytesWritten</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">		<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;å‘é€å¿ƒè·³åŒ…å¤±è´¥&quot;</span>;</span><br><span class="line">		<span class="function">emit <span class="title">signalDisconnectedToServer</span><span class="params">()</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è‹¥ä»å®¢æˆ·ç«¯æ”¶åˆ°å¿ƒè·³åŒ…å›å¤ï¼Œåˆ™é‡å¯<em>TcpHeart</em>å¯¹è±¡çš„è¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::slotStatusReadyRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// æ”¶åˆ°æœåŠ¡ç«¯å‘æ¥çš„å®¢æˆ·ç«¯çŠ¶æ€æŸ¥è¯¢</span></span><br><span class="line">	QByteArray data;</span><br><span class="line">	data = _statusSocket-&gt;<span class="built_in">readAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">using</span> Json = nlohmann::json;</span><br><span class="line">	<span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºçŠ¶æ€æŸ¥è¯¢</span></span><br><span class="line">	QString dataStr = QString::<span class="built_in">fromUtf8</span>(data);</span><br><span class="line">	Json json = Json::<span class="built_in">parse</span>(dataStr.<span class="built_in">toUtf8</span>(), <span class="literal">nullptr</span>, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">int</span> code = json[<span class="string">&quot;code&quot;</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (code == <span class="number">2</span>) &#123;</span><br><span class="line">		QString msgStr = QString::<span class="built_in">fromStdString</span>(json[<span class="string">&quot;Msg&quot;</span>].get&lt;std::string&gt;());</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¿ƒè·³åé¦ˆ</span></span><br><span class="line">		<span class="keyword">if</span> (msgStr == <span class="string">&quot;HEART_BACK&quot;</span>) &#123;</span><br><span class="line">			<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;HEART BACK ONCE&quot;</span>;</span><br><span class="line">			<span class="function">emit <span class="title">sigHeartBack</span><span class="params">()</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å¿ƒè·³åŒ…æ‰çº¿å¤„ç†"><a href="#å¿ƒè·³åŒ…æ‰çº¿å¤„ç†" class="headerlink" title="å¿ƒè·³åŒ…æ‰çº¿å¤„ç†"></a>å¿ƒè·³åŒ…æ‰çº¿å¤„ç†</h3><p>æ”¶åˆ°<em>TcpHeart</em>çš„å¿ƒè·³åŒ…è¶…æ—¶æ¶ˆæ¯åï¼Œè¿›è¡Œç›¸åº”çš„æ‰çº¿å¤„ç†ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::slotHeartBad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// æ–­çº¿å¤„ç†</span></span><br><span class="line">	<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;å¿ƒè·³åŒ…æ–­çº¿&quot;</span>;</span><br><span class="line">	_statusSocket-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">	<span class="function">emit <span class="title">signalDisconnectedToServer</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å®Œæ•´å®ç°"><a href="#å®Œæ•´å®ç°" class="headerlink" title="å®Œæ•´å®ç°"></a>å®Œæ•´å®ç°</h3><p>å®¢æˆ·ç«¯å®Œæ•´å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">StatusClient::<span class="built_in">StatusClient</span>(<span class="keyword">const</span> QString host, <span class="keyword">const</span> <span class="keyword">int</span> port, QObject *parent)</span><br><span class="line">	: <span class="built_in">m_host</span>(host),</span><br><span class="line">	  <span class="built_in">m_port</span>(port),</span><br><span class="line">	  <span class="built_in">QObject</span>(parent) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::connectedToServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	_statusSocket = <span class="keyword">new</span> QTcpSocket;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">connect</span>(_statusSocket, &amp;QTcpSocket::readyRead, <span class="keyword">this</span>, &amp;StatusClient::slotStatusReadyRead);</span><br><span class="line">	<span class="built_in">connect</span>(_statusSocket, &amp;QTcpSocket::disconnected, <span class="keyword">this</span>, &amp;StatusClient::signalDisconnectedToServer);</span><br><span class="line"></span><br><span class="line">	_statusSocket-&gt;<span class="built_in">connectToHost</span>(m_host, m_port);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!_statusSocket-&gt;<span class="built_in">waitForConnected</span>()) &#123;</span><br><span class="line">		<span class="function">emit <span class="title">signalDisconnectedToServer</span><span class="params">()</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::slotStatusReadyRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// æ”¶åˆ°æœåŠ¡ç«¯å‘æ¥çš„å®¢æˆ·ç«¯çŠ¶æ€æŸ¥è¯¢</span></span><br><span class="line">	QByteArray data;</span><br><span class="line">	data = _statusSocket-&gt;<span class="built_in">readAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">using</span> Json = nlohmann::json;</span><br><span class="line">	<span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºçŠ¶æ€æŸ¥è¯¢</span></span><br><span class="line">	QString dataStr = QString::<span class="built_in">fromUtf8</span>(data);</span><br><span class="line">	Json json = Json::<span class="built_in">parse</span>(dataStr.<span class="built_in">toUtf8</span>(), <span class="literal">nullptr</span>, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">int</span> code = json[<span class="string">&quot;code&quot;</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (code == <span class="number">2</span>) &#123;</span><br><span class="line">		QString msgStr = QString::<span class="built_in">fromStdString</span>(json[<span class="string">&quot;Msg&quot;</span>].get&lt;std::string&gt;());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (msgStr == <span class="string">&quot;OK&quot;</span>)<span class="comment">// æœåŠ¡å™¨è¿”å›&quot;OK&quot;ï¼Œå¼€å¯å¿ƒè·³åŒ…æ£€æµ‹</span></span><br><span class="line">		&#123;</span><br><span class="line">			heart = <span class="keyword">new</span> TcpHeart;</span><br><span class="line">			<span class="comment">// å¼€å§‹å¿ƒè·³æ£€æµ‹</span></span><br><span class="line">			heart-&gt;<span class="built_in">startHeartTimer</span>();</span><br><span class="line">			<span class="built_in">connect</span>(heart, &amp;TcpHeart::sigHeartReq, <span class="keyword">this</span>, &amp;StatusClient::slotWriteHeartSocket);<span class="comment">// å‘é€å¿ƒè·³åŒ…</span></span><br><span class="line">			<span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;StatusClient::sigHeartBack, heart, &amp;TcpHeart::slotHeartBack);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¤„ç†å¿ƒè·³åŒ…å¼‚å¸¸</span></span><br><span class="line">			<span class="built_in">connect</span>(heart, &amp;TcpHeart::sigHeartBad, <span class="keyword">this</span>, &amp;StatusClient::slotHeartBad);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¿ƒè·³åé¦ˆ</span></span><br><span class="line">		<span class="keyword">if</span> (msgStr == <span class="string">&quot;HEART_BACK&quot;</span>) &#123;</span><br><span class="line">			<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;HEART BACK ONCE&quot;</span>;</span><br><span class="line">			<span class="function">emit <span class="title">sigHeartBack</span><span class="params">()</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::slotWriteHeartSocket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	QByteArray data;</span><br><span class="line">	<span class="comment">// æ„å»ºçŠ¶æ€è¿”å›</span></span><br><span class="line">	<span class="keyword">using</span> Json = nlohmann::json;</span><br><span class="line">	Json jsonValue;</span><br><span class="line">	jsonValue[<span class="string">&quot;code&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">	jsonValue[<span class="string">&quot;Msg&quot;</span>] = <span class="string">&quot;Heart&quot;</span>;</span><br><span class="line">	data = QString::<span class="built_in">fromStdString</span>(jsonValue.<span class="built_in">dump</span>(<span class="number">2</span>)).<span class="built_in">toUtf8</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// çŠ¶æ€ä¿¡é“ï¼Œå‘æœåŠ¡ç«¯å‘é€å¿ƒè·³åŒ…</span></span><br><span class="line">	<span class="built_in">qDebug</span>() &lt;&lt; <span class="keyword">this</span>-&gt;<span class="built_in">thread</span>() &lt;&lt; <span class="string">&quot;å‘é€ä¸€æ¬¡å¿ƒè·³åŒ…&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// çŠ¶æ€ä¿¡é“</span></span><br><span class="line">	<span class="keyword">bool</span> ret = _statusSocket-&gt;<span class="built_in">write</span>(data);</span><br><span class="line">	_statusSocket-&gt;<span class="built_in">waitForBytesWritten</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">		<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;å‘é€å¿ƒè·³åŒ…å¤±è´¥&quot;</span>;</span><br><span class="line">		<span class="function">emit <span class="title">signalDisconnectedToServer</span><span class="params">()</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusClient::slotHeartBad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// æ–­çº¿å¤„ç†</span></span><br><span class="line">	<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;å¿ƒè·³åŒ…æ–­çº¿&quot;</span>;</span><br><span class="line">	_statusSocket-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">	<span class="function">emit <span class="title">signalDisconnectedToServer</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h2><p>æœåŠ¡ç«¯<em>StatusServer</em>å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTcpServer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTcpSocket&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;json.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StatusServer</span> :</span> <span class="keyword">public</span> QObject &#123;</span><br><span class="line">	Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">StatusServer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> statusPort, QObject *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverEstablished</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverError</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">establishServer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slotNewStatusConnection</span><span class="params">()</span></span>;<span class="comment">// çŠ¶æ€ä¿¡é“é“¾æ¥</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slotStatusReadyRead</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// çŠ¶æ€ä¿¡é“</span></span><br><span class="line">	QTcpServer *_tcpStatusServer;</span><br><span class="line">	QList&lt;QTcpSocket *&gt; _tcpStatusClients;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> m_statusPort;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡ç«¯é€»è¾‘å¾ˆç®€å•ï¼Œå¯åŠ¨ç›‘å¬ï¼Œä¿å­˜å®¢æˆ·ç«¯çš„é“¾æ¥ï¼Œå‘å®¢æˆ·ç«¯å‘é€å¿ƒè·³åˆå§‹åŒ–æ¶ˆæ¯å¹¶å›å¤å®¢æˆ·ç«¯çš„å¿ƒè·³åŒ…ã€‚å®Œæ•´å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">StatusServer::<span class="built_in">StatusServer</span>(<span class="keyword">const</span> <span class="keyword">int</span> statusPort, QObject *parent)</span><br><span class="line">	: <span class="built_in">m_statusPort</span>(statusPort),</span><br><span class="line">	  <span class="built_in">QObject</span>(parent) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusServer::establishServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	_tcpStatusServer = <span class="keyword">new</span> QTcpServer;</span><br><span class="line">	<span class="keyword">bool</span> ret = _tcpStatusServer-&gt;<span class="built_in">listen</span>(QHostAddress::Any, m_statusPort);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">		<span class="function">emit <span class="title">serverError</span><span class="params">()</span></span>;</span><br><span class="line">		<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;çŠ¶æ€æœåŠ¡å™¨å»ºç«‹å¤±è´¥&quot;</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		emit <span class="built_in">serverEstablished</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">connect</span>(_tcpStatusServer, &amp;QTcpServer::newConnection, <span class="keyword">this</span>, &amp;StatusServer::slotNewStatusConnection);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusServer::slotNewStatusConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// å¤„ç†çŠ¶æ€ä¿¡é“çš„æ–°è¿æ¥</span></span><br><span class="line">	QTcpSocket *currentSocket = _tcpStatusServer-&gt;<span class="built_in">nextPendingConnection</span>();</span><br><span class="line">	_tcpStatusClients.<span class="built_in">push_back</span>(currentSocket);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å‘å®¢æˆ·ç«¯å‘é€åˆå§‹åŒ–æ¶ˆæ¯ï¼Œå¯åŠ¨å¿ƒè·³åŒ…</span></span><br><span class="line">	<span class="keyword">using</span> Json = nlohmann::json;</span><br><span class="line">	QByteArray sendData;</span><br><span class="line">	Json sendJsonData;</span><br><span class="line">	sendJsonData[<span class="string">&quot;code&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">	sendJsonData[<span class="string">&quot;Msg&quot;</span>] = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">	sendData = QString::<span class="built_in">fromStdString</span>(sendJsonData.<span class="built_in">dump</span>(<span class="number">2</span>)).<span class="built_in">toUtf8</span>();</span><br><span class="line">	currentSocket-&gt;<span class="built_in">write</span>(sendData);</span><br><span class="line">	currentSocket-&gt;<span class="built_in">flush</span>();</span><br><span class="line">	currentSocket-&gt;<span class="built_in">waitForBytesWritten</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">connect</span>(currentSocket, &amp;QTcpSocket::readyRead, <span class="keyword">this</span>, &amp;StatusServer::slotStatusReadyRead);</span><br><span class="line">	<span class="built_in">connect</span>(currentSocket, &amp;QTcpSocket::disconnected, [=, <span class="keyword">this</span>]() &#123;</span><br><span class="line">		_tcpStatusClients.<span class="built_in">removeAll</span>(currentSocket);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StatusServer::slotStatusReadyRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;å¿ƒè·³åŒ…thread&quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;<span class="built_in">thread</span>();</span><br><span class="line">	<span class="comment">// çŠ¶æ€ä¿¡é“ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„å¿ƒè·³åŒ…</span></span><br><span class="line">	QTcpSocket *currentSocket = (QTcpSocket *) <span class="built_in">sender</span>();</span><br><span class="line">	QByteArray msgData = currentSocket-&gt;<span class="built_in">readAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">using</span> Json = nlohmann::json;</span><br><span class="line">	Json jsonData = Json::<span class="built_in">parse</span>(msgData.<span class="built_in">data</span>(), <span class="literal">nullptr</span>, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">int</span> code = jsonData[<span class="string">&quot;code&quot;</span>].get&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (code == <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">qDebug</span>() &lt;&lt; currentSocket &lt;&lt; <span class="string">&quot;æ”¶åˆ°ä¸€æ¬¡å¿ƒè·³åŒ…&quot;</span>;</span><br><span class="line">		QString msg = QString::<span class="built_in">fromStdString</span>(jsonData[<span class="string">&quot;Msg&quot;</span>].get&lt;std::string&gt;());</span><br><span class="line">		<span class="keyword">if</span> (msg == <span class="string">&quot;Heart&quot;</span>) &#123;</span><br><span class="line">			QByteArray sendData;</span><br><span class="line">			Json sendJsonData;</span><br><span class="line">			sendJsonData[<span class="string">&quot;code&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">			sendJsonData[<span class="string">&quot;Msg&quot;</span>] = <span class="string">&quot;HEART_BACK&quot;</span>;</span><br><span class="line">			sendData = QString::<span class="built_in">fromStdString</span>(sendJsonData.<span class="built_in">dump</span>(<span class="number">2</span>)).<span class="built_in">toUtf8</span>();</span><br><span class="line">			currentSocket-&gt;<span class="built_in">write</span>(sendData);</span><br><span class="line">			currentSocket-&gt;<span class="built_in">flush</span>();</span><br><span class="line">			currentSocket-&gt;<span class="built_in">waitForBytesWritten</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Qt</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>å­¦ä¹ å¿ƒå¾—</tag>
        <tag>Qt</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL on Qt (2):SQLçš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹åŸºæœ¬æ“ä½œ</title>
    <url>/2020/07/23/mysqlonqt2/</url>
    <content><![CDATA[<h1 id="MySQL-on-Qt-2-SQLçš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹åŸºæœ¬æ“ä½œ"><a href="#MySQL-on-Qt-2-SQLçš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹åŸºæœ¬æ“ä½œ" class="headerlink" title="MySQL on Qt (2): SQLçš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹åŸºæœ¬æ“ä½œ"></a>MySQL on Qt (2): SQLçš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹åŸºæœ¬æ“ä½œ</h1><blockquote>
<p>å†™åœ¨å‰é¢ï¼š </p>
<p>å¤§ä¸€ä¸‹å­¦æœŸçš„ CPP å¤§ä½œä¸šâ€œè‡ªä¸»è®¢é¤ç³»ç»Ÿâ€å¯çœŸæ˜¯é¢‡è´¹äº†ä¸€äº›åŠ›æ°”ï¼Œæ¯å¤©æ™šç¡æ—©èµ·æ’¸ä»£ç ï¼Œè¯¾éƒ½æ²¡å¬ï¼Œå¾ˆå¤šçŸ¥è¯†éƒ½æ˜¯ç°å­¦ç°ç”¨ã€‚</p>
<p>ä¸ºäº†é¿å…å½“æ—¶å­¦åˆ°çš„ä¸œè¥¿ç»™å…¨éƒ¨å¿˜å…‰å…‰ï¼ˆ`_&gt;`ï¼Œæˆ‘è¿™è„‘å­å•Šã€‚ã€‚ã€‚ï¼‰ï¼Œæ‰€ä»¥æˆ‘æŠŠå½“æ—¶å¤§ä½œä¸šçš„ä¸€äº›æ ¸å¿ƒéƒ¨åˆ†ï¼ˆä¸€äº›é›¶ç¢çš„å°ç»†èŠ‚ï¼Œèƒ½è®°å°±è®°ï¼‰ç»™è®°å½•ä¸€ä¸‹ï¼Œä¸€æ–¹é¢æ˜¯å¤ä¹ ï¼Œä¸€æ–¹é¢ä¹Ÿæ–¹ä¾¿ä»¥åç”¨åˆ°çš„æ—¶å€™æŸ¥é˜…ã€‚</p>
</blockquote>
<p>è¿™ç¯‡æ–‡ç« æ˜¯å¤§ä½œä¸š MySQL + SQLite æ“ä½œç›¸å…³éƒ¨åˆ†çš„ç¬¬äºŒç« ï¼Œä¸»è¦è®²ä¸€ä¸‹ Qt ä¸­ MySQL å’Œ SQLite è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹çš„åŸºæœ¬æ“ä½œã€‚</p>
<span id="more"></span>

<h2 id="Qt-SQL-ç±»"><a href="#Qt-SQL-ç±»" class="headerlink" title="Qt SQL ç±»"></a>Qt SQL ç±»</h2><p><img src="https://gitee.com/skykeyjoker/PicCloud/raw/master/img/sqlmoudles.png" alt="Qt ä¸­ SQl ç›¸å…³ç±»"></p>
<ul>
<li>ç”¨æˆ·æ¥å£å±‚ï¼šå®ç°å°†æ•°æ®åº“ä¸­çš„æ•°æ®é“¾æ¥åˆ°çª—å£éƒ¨ä»¶ä¸Š</li>
<li>SQLæ¥å£å±‚ï¼šæä¾›å¯¹æ•°æ®åº“çš„è®¿é—®</li>
<li>é©±åŠ¨å±‚ï¼šä¸ºå…·ä½“çš„æ•°æ®åº“å’ŒSQLæ¥å£å±‚ä¹‹é—´æä¾›äº†åº•å±‚çš„æ¡¥æ¢</li>
</ul>
<p>è¦ä½¿ç”¨Qt SQLçš„ç±»ï¼Œéœ€è¦åœ¨é¡¹ç›®æ–‡ä»¶ï¼ˆ.proæ–‡ä»¶ï¼‰ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">QT += sql</span><br></pre></td></tr></table></figure>



<h2 id="Qt-SQL-çš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹æ“ä½œ"><a href="#Qt-SQL-çš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹æ“ä½œ" class="headerlink" title="Qt SQL çš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹æ“ä½œ"></a>Qt SQL çš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹æ“ä½œ</h2><p>ä¸‹é¢ç”¨ä¸€ä¸ª demo æ¥æ¼”ç¤º Qt ä¸­ SQL çš„è¿æ¥ã€æ–­å¼€ä¸å¢åˆ æŸ¥æ”¹æ“ä½œã€‚</p>
<img src="https://gitee.com/skykeyjoker/PicCloud/raw/master/img/demo.png" alt="demo" style="zoom:80%;" />



<hr>
<p>å…ˆæ¥è®²æ•°æ®åº“çš„è¿æ¥ä¸æ–­å¼€ã€‚</p>
<h3 id="è¿æ¥æ•°æ®åº“"><a href="#è¿æ¥æ•°æ®åº“" class="headerlink" title="è¿æ¥æ•°æ®åº“"></a>è¿æ¥æ•°æ®åº“</h3><p>ä¸Šä¸€ç« å·²ç»è®²è¿‡å¦‚ä½•è¿æ¥ SQL æ•°æ®åº“ï¼Œè¿™é‡Œå°±ç®€ç®€å•å•æ”¾ä¸€ä¸‹ä»£ç ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Connect to db</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Widget::connectToDb</span><span class="params">(<span class="keyword">const</span> QString &amp; hostName, <span class="keyword">const</span> <span class="keyword">int</span> &amp; port, <span class="keyword">const</span> QString &amp; databaseName, <span class="keyword">const</span> QString &amp; username, <span class="keyword">const</span> QString &amp; password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;hostName;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;port;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;databaseName;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;username;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set info</span></span><br><span class="line">    _db.<span class="built_in">setHostName</span>(hostName);</span><br><span class="line">    _db.<span class="built_in">setPort</span>(port);</span><br><span class="line">    _db.<span class="built_in">setDatabaseName</span>(databaseName);</span><br><span class="line">    _db.<span class="built_in">setUserName</span>(username);</span><br><span class="line">    _db.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open Db</span></span><br><span class="line">    <span class="keyword">bool</span> ret = _db.<span class="built_in">open</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Info</span></span><br><span class="line">    QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line">    <span class="keyword">if</span>(error.<span class="built_in">type</span>() != QSqlError::NoError)</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¦æ³¨æ„ä¸‹æ‰“å°å‡ºé”™ä¿¡æ¯çš„æŠ€å·§ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿æŸ¥é”™ã€‚</p>
<h3 id="æ–­å¼€æ•°æ®åº“"><a href="#æ–­å¼€æ•°æ®åº“" class="headerlink" title="æ–­å¼€æ•°æ®åº“"></a>æ–­å¼€æ•°æ®åº“</h3><p>å•Šè¿™ï¼Œæ›´ç®€å•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Close Db</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Widget::closeDb</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _db.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>æ¥ä¸‹æ¥è®²æ•°æ®åº“çš„å¢åˆ æŸ¥æ”¹æ“ä½œã€‚è¿™äº›æ“ä½œä¸»è¦æ˜¯å¯¹ Query è¯­å¥çš„ç®€å•åˆ©ç”¨ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong> MySQL ä¸ SQLite çš„ SQL è¯­æ³•å­˜åœ¨ä¸€å®šåŒºåˆ«ï¼Œè¦æ³¨æ„åŒºåˆ†ä½¿ç”¨ã€‚</p>
<h3 id="åˆ›å»ºæ•°æ®è¡¨"><a href="#åˆ›å»ºæ•°æ®è¡¨" class="headerlink" title="åˆ›å»ºæ•°æ®è¡¨"></a>åˆ›å»ºæ•°æ®è¡¨</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create Table</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Widget::createTable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Query</span></span><br><span class="line">    QSqlQuery query;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create table</span></span><br><span class="line">    query.<span class="built_in">exec</span>(<span class="string">&quot;CREATE TABLE `runoob_tbl` \</span></span><br><span class="line"><span class="string">                   (`runoob_id` INT UNSIGNED AUTO_INCREMENT, \</span></span><br><span class="line"><span class="string">                   `runoob_title` VARCHAR(100) NOT NULL,\</span></span><br><span class="line"><span class="string">                   `runoob_author` VARCHAR(40) NOT NULL,\</span></span><br><span class="line"><span class="string">                   `submission_date` DATE,\</span></span><br><span class="line"><span class="string">                   PRIMARY KEY ( `runoob_id`)) &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Info</span></span><br><span class="line">    QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line">    <span class="keyword">if</span>(error.<span class="built_in">type</span>() != QSqlError::NoError)</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å¢åŠ å­—æ®µ"><a href="#å¢åŠ å­—æ®µ" class="headerlink" title="å¢åŠ å­—æ®µ"></a>å¢åŠ å­—æ®µ</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Add new column</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Widget::addNewcolumn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Query</span></span><br><span class="line">    QSqlQuery query;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add column</span></span><br><span class="line">    query.<span class="built_in">exec</span>(<span class="string">&quot;ALTER TABLE runoob_tbl ADD COLUMN new1 VARCHAR(20) DEFAULT NULL;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Info</span></span><br><span class="line">    QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line">    <span class="keyword">if</span>(error.<span class="built_in">type</span>() != QSqlError::NoError)</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="æ£€éªŒè¡¨æ˜¯å¦å­˜åœ¨"><a href="#æ£€éªŒè¡¨æ˜¯å¦å­˜åœ¨" class="headerlink" title="æ£€éªŒè¡¨æ˜¯å¦å­˜åœ¨"></a>æ£€éªŒè¡¨æ˜¯å¦å­˜åœ¨</h3><p>æ£€éªŒæ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨æŸè¡¨ï¼Œå¯ä»¥åˆ©ç”¨ QSqlDatabase æä¾›çš„ <code>QSqlDatabase::tables()</code>å‡½æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Is Table Exists</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Widget::isTableExists</span><span class="params">(<span class="keyword">const</span> QString &amp;)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(_db.<span class="built_in">tables</span>().<span class="built_in">contains</span>(<span class="string">&quot;user&quot;</span>))</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Table exists&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Table not exists&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _db.<span class="built_in">tables</span>().<span class="built_in">contains</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>QSqlDatabase::tables()</code>å‡½æ•°è¿”å›ä¸€ä¸ª <em>QStringList</em> ç±»å‹çš„æ•°æ®ï¼Œé‡Œé¢å‚¨å­˜ç€æ‰€æœ‰è¡¨åï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„è°ƒç”¨ <code>QStringList::contains()</code> å‡½æ•°äº†æ¥æ£€éªŒè¡¨æ˜¯å¦å­˜åœ¨ã€‚</p>
<h3 id="æŸ¥è¯¢ã€éå†æ•°æ®è¡¨"><a href="#æŸ¥è¯¢ã€éå†æ•°æ®è¡¨" class="headerlink" title="æŸ¥è¯¢ã€éå†æ•°æ®è¡¨"></a>æŸ¥è¯¢ã€éå†æ•°æ®è¡¨</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Query Table</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Widget::queryTable</span><span class="params">(<span class="keyword">const</span> QString &amp;)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Query</span></span><br><span class="line">    QSqlQuery query;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Query the database</span></span><br><span class="line">    query.<span class="built_in">exec</span>(<span class="string">&quot;SELECT * FROM user WHERE 1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get record</span></span><br><span class="line">    <span class="keyword">while</span>(query.<span class="built_in">next</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        QSqlRecord record = query.<span class="built_in">record</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;record.<span class="built_in">value</span>(<span class="number">0</span>)&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;record.<span class="built_in">value</span>(<span class="number">1</span>)&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;record.<span class="built_in">value</span>(<span class="number">2</span>)&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;record.<span class="built_in">value</span>(<span class="number">3</span>)&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;record.<span class="built_in">value</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Info</span></span><br><span class="line">    QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line">    <span class="keyword">if</span>(error.<span class="built_in">type</span>() != QSqlError::NoError)</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•°æ®è¡¨çš„éå†æŠ€å·§è¦è®°ä½ã€‚</p>
<h3 id="æ’å…¥æ•°æ®"><a href="#æ’å…¥æ•°æ®" class="headerlink" title="æ’å…¥æ•°æ®"></a>æ’å…¥æ•°æ®</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Insert Data</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Widget::insertData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Query</span></span><br><span class="line">    QSqlQuery query;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare</span></span><br><span class="line">    query.<span class="built_in">prepare</span>(<span class="string">&quot;INSERT INTO user VALUES (:ID, :Name, :Age, :Type, :Gender)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bind value</span></span><br><span class="line">    query.<span class="built_in">bindValue</span>(<span class="string">&quot;:ID&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    query.<span class="built_in">bindValue</span>(<span class="string">&quot;:Name&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    query.<span class="built_in">bindValue</span>(<span class="string">&quot;:Age&quot;</span>,<span class="number">22</span>);</span><br><span class="line">    query.<span class="built_in">bindValue</span>(<span class="string">&quot;:Type&quot;</span>,<span class="string">&quot;testType&quot;</span>);</span><br><span class="line">    query.<span class="built_in">bindValue</span>(<span class="string">&quot;:Gender&quot;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Exec inserting</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;query.<span class="built_in">exec</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Info</span></span><br><span class="line">    QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line">    <span class="keyword">if</span>(error.<span class="built_in">type</span>() != QSqlError::NoError)</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ’å…¥æ•°æ®æ—¶ä½¿ç”¨äº†<code>QSqlDatabase::prepare()</code> ä¸ <code>QSqlDatabase::bindValue()</code>æ–¹æ³•ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ <code>QSqlDatabase::exec()</code>ï¼Œä½¿ç”¨<code>tr(&quot;%1&quot;).arg(arg1)</code>æ–¹æ³•æ¥æŒ‡å®šå‚æ•°ã€‚</p>
<h3 id="æ›´æ–°æ•°æ®"><a href="#æ›´æ–°æ•°æ®" class="headerlink" title="æ›´æ–°æ•°æ®"></a>æ›´æ–°æ•°æ®</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Update Data</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Widget::updateData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Query</span></span><br><span class="line">    QSqlQuery query;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;query.<span class="built_in">exec</span>(<span class="string">&quot;UPDATE user SET Age=233 WHERE Name=&#x27;Joker&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Info</span></span><br><span class="line">    QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line">    <span class="keyword">if</span>(error.<span class="built_in">type</span>() != QSqlError::NoError)</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="åˆ é™¤æ•°æ®"><a href="#åˆ é™¤æ•°æ®" class="headerlink" title="åˆ é™¤æ•°æ®"></a>åˆ é™¤æ•°æ®</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Delete Data</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Widget::deleteData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Query</span></span><br><span class="line">    QSqlQuery query;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delete</span></span><br><span class="line">    query.<span class="built_in">exec</span>(<span class="string">&quot;DELETE FROM user WHERE Name=&#x27;test&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error Info</span></span><br><span class="line">    QSqlError error = _db.<span class="built_in">lastError</span>();</span><br><span class="line">    <span class="keyword">if</span>(error.<span class="built_in">type</span>() != QSqlError::NoError)</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;error.<span class="built_in">text</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>è‡³æ­¤æœ¬ç« çš„å†…å®¹åŸºæœ¬ç»“æŸã€‚ä¸‹ä¸€ç« å°†è®²è§£ Qt SQL æ“ä½œä¸­æœ€ä¸ºç²¾å½©çš„éƒ¨åˆ†ï¼šModel/View æ¨¡å¼ã€‚</p>
<blockquote>
<p>ç®€å•çš„ MySQL å’Œ SQLite æ•™ç¨‹ï¼š</p>
<p>MySQL: <a href="https://www.runoob.com/mysql/mysql-tutorial.html">https://www.runoob.com/mysql/mysql-tutorial.html</a></p>
<p>SQLite: <a href="https://www.runoob.com/sqlite/sqlite-tutorial.html">https://www.runoob.com/sqlite/sqlite-tutorial.html</a></p>
</blockquote>
]]></content>
      <categories>
        <category>Qt</category>
      </categories>
      <tags>
        <tag>Qt</tag>
        <tag>Sql</tag>
      </tags>
  </entry>
  <entry>
    <title>äºŒå…ƒè¿ç®—ç¬¦é‡è½½</title>
    <url>/2020/07/21/%E4%BA%8C%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD/</url>
    <content><![CDATA[<h1 id="C-äºŒå…ƒè¿ç®—ç¬¦é‡è½½"><a href="#C-äºŒå…ƒè¿ç®—ç¬¦é‡è½½" class="headerlink" title="C++ äºŒå…ƒè¿ç®—ç¬¦é‡è½½"></a>C++ äºŒå…ƒè¿ç®—ç¬¦é‡è½½</h1><p>äºŒå…ƒè¿ç®—ç¬¦éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä¸‹é¢æ˜¯äºŒå…ƒè¿ç®—ç¬¦çš„å®ä¾‹ã€‚æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„åŠ è¿ç®—ç¬¦ï¼ˆ + ï¼‰ã€å‡è¿ç®—ç¬¦ï¼ˆ - ï¼‰ã€ä¹˜è¿ç®—ç¬¦ï¼ˆ * ï¼‰å’Œé™¤è¿ç®—ç¬¦ï¼ˆ / ï¼‰éƒ½å±äºäºŒå…ƒè¿ç®—ç¬¦ã€‚å°±åƒåŠ (+)è¿ç®—ç¬¦ã€‚</p>
<p>ä¸‹é¢çš„å®ä¾‹æ¼”ç¤ºäº†å¦‚ä½•é‡è½½åŠ è¿ç®—ç¬¦ï¼ˆ + ï¼‰ã€‚ç±»ä¼¼åœ°ï¼Œæ‚¨ä¹Ÿå¯ä»¥å°è¯•é‡è½½å‡è¿ç®—ç¬¦ï¼ˆ - ï¼‰å’Œé™¤è¿ç®—ç¬¦ï¼ˆ / ï¼‰ã€‚</p>
<span id="more"></span>

<h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span> &#123;</span>   </span><br><span class="line">    <span class="keyword">double</span> length;      <span class="comment">// é•¿åº¦   </span></span><br><span class="line">    <span class="keyword">double</span> breadth;     <span class="comment">// å®½åº¦   </span></span><br><span class="line">    <span class="keyword">double</span> height;      <span class="comment">// é«˜åº¦ </span></span><br><span class="line">    <span class="keyword">public</span>:    </span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getVolume</span><span class="params">(<span class="keyword">void</span>)</span>   </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">return</span> length * breadth * height;   </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setLength</span><span class="params">( <span class="keyword">double</span> len )</span>   </span></span><br><span class="line"><span class="function">    </span>&#123;       </span><br><span class="line">        length = len;   </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setBreadth</span><span class="params">( <span class="keyword">double</span> bre )</span>   </span></span><br><span class="line"><span class="function">    </span>&#123;       </span><br><span class="line">        breadth = bre;   </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setHeight</span><span class="params">( <span class="keyword">double</span> hei )</span>   </span></span><br><span class="line"><span class="function">    </span>&#123;       </span><br><span class="line">        height = hei;   </span><br><span class="line">    &#125;   <span class="comment">// é‡è½½ + è¿ç®—ç¬¦ï¼Œç”¨äºæŠŠä¸¤ä¸ª Box å¯¹è±¡ç›¸åŠ    </span></span><br><span class="line">    Box <span class="keyword">operator</span>+(<span class="keyword">const</span> Box&amp; b)   </span><br><span class="line">    &#123;      </span><br><span class="line">        Box box;      </span><br><span class="line">        box.length = <span class="keyword">this</span>-&gt;length + b.length;      </span><br><span class="line">        box.breadth = <span class="keyword">this</span>-&gt;breadth + b.breadth;      </span><br><span class="line">        box.height = <span class="keyword">this</span>-&gt;height + b.height;      </span><br><span class="line">        <span class="keyword">return</span> box;   &#125; &#125;; </span><br><span class="line"><span class="comment">// ç¨‹åºçš„ä¸»å‡½æ•° </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( )</span> </span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    Box Box1;                <span class="comment">// å£°æ˜ Box1ï¼Œç±»å‹ä¸º Box   </span></span><br><span class="line">    Box Box2;                <span class="comment">// å£°æ˜ Box2ï¼Œç±»å‹ä¸º Box   </span></span><br><span class="line">    Box Box3;                <span class="comment">// å£°æ˜ Box3ï¼Œç±»å‹ä¸º Box   </span></span><br><span class="line">    <span class="keyword">double</span> volume = <span class="number">0.0</span>;     <span class="comment">// æŠŠä½“ç§¯å­˜å‚¨åœ¨è¯¥å˜é‡ä¸­    </span></span><br><span class="line">    <span class="comment">// Box1 è¯¦è¿°  </span></span><br><span class="line">    Box1.<span class="built_in">setLength</span>(<span class="number">6.0</span>);    </span><br><span class="line">    Box1.<span class="built_in">setBreadth</span>(<span class="number">7.0</span>);    </span><br><span class="line">    Box1.<span class="built_in">setHeight</span>(<span class="number">5.0</span>);    </span><br><span class="line">    <span class="comment">// Box2 è¯¦è¿°   </span></span><br><span class="line">    Box2.<span class="built_in">setLength</span>(<span class="number">12.0</span>);    </span><br><span class="line">    Box2.<span class="built_in">setBreadth</span>(<span class="number">13.0</span>);    </span><br><span class="line">    Box2.<span class="built_in">setHeight</span>(<span class="number">10.0</span>);    </span><br><span class="line">    <span class="comment">// Box1 çš„ä½“ç§¯   </span></span><br><span class="line">    volume = Box1.<span class="built_in">getVolume</span>();   </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Volume of Box1 : &quot;</span> &lt;&lt; volume &lt;&lt;endl;    </span><br><span class="line">    <span class="comment">// Box2 çš„ä½“ç§¯   </span></span><br><span class="line">    volume = Box2.<span class="built_in">getVolume</span>();   </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Volume of Box2 : &quot;</span> &lt;&lt; volume &lt;&lt;endl;    </span><br><span class="line">    <span class="comment">// æŠŠä¸¤ä¸ªå¯¹è±¡ç›¸åŠ ï¼Œå¾—åˆ° Box3   </span></span><br><span class="line">    Box3 = Box1 + Box2;    <span class="comment">// Box3 çš„ä½“ç§¯   </span></span><br><span class="line">    volume = Box3.<span class="built_in">getVolume</span>();   </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Volume of Box3 : &quot;</span> &lt;&lt; volume &lt;&lt;endl;    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>å½“ä¸Šé¢çš„ä»£ç è¢«ç¼–è¯‘å’Œæ‰§è¡Œæ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸‹åˆ—ç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Volume of Box1 : 210</span><br><span class="line">Volume of Box2 : 1560</span><br><span class="line">Volume of Box3 : 5400</span><br></pre></td></tr></table></figure>





<h2 id="éæˆå‘˜å‡½æ•°ä¸ç±»æˆå‘˜äºŒå…ƒè¿ç®—-å‹å…ƒå‡½æ•°"><a href="#éæˆå‘˜å‡½æ•°ä¸ç±»æˆå‘˜äºŒå…ƒè¿ç®—-å‹å…ƒå‡½æ•°" class="headerlink" title="éæˆå‘˜å‡½æ•°ä¸ç±»æˆå‘˜äºŒå…ƒè¿ç®—(å‹å…ƒå‡½æ•°)"></a>éæˆå‘˜å‡½æ•°ä¸ç±»æˆå‘˜äºŒå…ƒè¿ç®—(å‹å…ƒå‡½æ•°)</h2><p>å½“ 2 ä¸ªå¯¹è±¡ç›¸åŠ æ—¶æ˜¯æ²¡æœ‰é¡ºåºè¦æ±‚çš„ï¼Œ<strong>ä½†è¦é‡è½½ â€˜+â€™è®©å…¶ä¸ä¸€ä¸ªæ•°å­—ç›¸åŠ åˆ™æœ‰é¡ºåºè¦æ±‚ï¼Œå¯ä»¥é€šè¿‡åŠ ä¸€ä¸ª</strong>å‹å…ƒå‡½æ•°<strong>ä½¿å¦ä¸€ä¸ªé¡ºåºçš„è¾“å…¥åˆæ³•ã€‚</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">A</span>();</span><br><span class="line">            <span class="built_in">A</span>(<span class="keyword">int</span> n);</span><br><span class="line">            A <span class="keyword">operator</span>+(<span class="keyword">const</span> A &amp; obj);</span><br><span class="line">            A <span class="keyword">operator</span>+(<span class="keyword">const</span> <span class="keyword">int</span> b);</span><br><span class="line">    		<span class="keyword">friend</span> A <span class="keyword">operator</span>+(<span class="keyword">const</span> <span class="keyword">int</span> b, A obj); </span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>; </span><br><span class="line">&#125; ;</span><br><span class="line">A::<span class="built_in">A</span>()</span><br><span class="line">&#123;</span><br><span class="line">    a=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">A::<span class="built_in">A</span>(<span class="keyword">int</span> n)<span class="comment">//æ„é€ å‡½æ•° </span></span><br><span class="line">&#123;</span><br><span class="line">    a=n;</span><br><span class="line">&#125;</span><br><span class="line">A A::<span class="keyword">operator</span> +(<span class="keyword">const</span> A&amp; obj)<span class="comment">//é‡è½½+å·ç”¨äº å¯¹è±¡ç›¸åŠ  </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;a+obj.a;</span><br><span class="line">&#125;</span><br><span class="line">A A::<span class="keyword">operator</span>+(<span class="keyword">const</span> <span class="keyword">int</span> b)<span class="comment">//é‡è½½+å·ç”¨äº  å¯¹è±¡ä¸æ•°ç›¸åŠ </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">A</span>(a+b);</span><br><span class="line">&#125;</span><br><span class="line">A <span class="keyword">operator</span>+(<span class="keyword">const</span> <span class="keyword">int</span> b,  A obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> obj+b;<span class="comment">//å‹å…ƒå‡½æ•°è°ƒç”¨ç¬¬äºŒä¸ªé‡è½½+çš„æˆå‘˜å‡½æ•°  ç›¸å½“äº obj.operator+(b); </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">A::display</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout&lt;&lt;a&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">A <span class="title">a1</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">    <span class="function">A <span class="title">a2</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">    A a3,a4,a5;</span><br><span class="line">    a1.<span class="built_in">display</span>();</span><br><span class="line">    a2.<span class="built_in">display</span>();</span><br><span class="line">    <span class="keyword">int</span> m=<span class="number">1</span>;</span><br><span class="line">    a3=a1+a2;<span class="comment">//å¯ä»¥äº¤æ¢é¡ºåºï¼Œç›¸å½“æœˆa3=a1.operator+(a2); </span></span><br><span class="line">    a3.<span class="built_in">display</span>();</span><br><span class="line">    a4=a1+m;<span class="comment">//å› ä¸ºåŠ äº†ä¸ªå‹å…ƒå‡½æ•°æ‰€ä»¥ä¹Ÿå¯ä»¥äº¤æ¢é¡ºåºäº†ã€‚</span></span><br><span class="line">    a4.<span class="built_in">display</span>();</span><br><span class="line">    a5=m+a1;</span><br><span class="line">    a5.<span class="built_in">display</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>è½¬è½½</tag>
      </tags>
  </entry>
  <entry>
    <title>å½“æˆ‘è°ˆçº¿ç¨‹æ± æ—¶æˆ‘è°ˆäº›ä»€ä¹ˆ</title>
    <url>/2021/12/12/%E5%BD%93%E6%88%91%E8%B0%88%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%97%B6%E6%88%91%E8%B0%88%E4%BA%9B%E4%BB%80%E4%B9%88/</url>
    <content><![CDATA[<h1 id="å½“æˆ‘è°ˆçº¿ç¨‹æ± æ—¶æˆ‘è°ˆäº›ä»€ä¹ˆ"><a href="#å½“æˆ‘è°ˆçº¿ç¨‹æ± æ—¶æˆ‘è°ˆäº›ä»€ä¹ˆ" class="headerlink" title="å½“æˆ‘è°ˆçº¿ç¨‹æ± æ—¶æˆ‘è°ˆäº›ä»€ä¹ˆ"></a>å½“æˆ‘è°ˆçº¿ç¨‹æ± æ—¶æˆ‘è°ˆäº›ä»€ä¹ˆ</h1><p>æœ€è¿‘è·Ÿç€purecppç¤¾åŒºé‡Œçš„ä¸¤ç¯‡åšæ–‡å¤ä¹ äº†ä¸€ä¸‹ä¸¤ç§çº¿ç¨‹æ± çš„C++å®ç°ï¼ˆå•ä»»åŠ¡é˜Ÿåˆ—ã€å¤šä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼Œç›¸æ¯”äºä¹‹å‰é‚£ç¯‡C++11å®ç°çº¿ç¨‹æ± çš„åšæ–‡ï¼Œè¯­è¨€ç‰ˆæœ¬è¿›è¡Œäº†ä¸€ç‚¹å°æ›´æ–°ï¼ˆC++14-C++17ï¼‰ã€‚åœ¨è¿™é‡Œç»“åˆä»£ç è®°å½•ä¸€ä¸‹å­¦ä¹ å¿ƒå¾—ã€‚</p>
<blockquote>
<p>12.12ï¼Œç„¶ç„¶é¦–æ’­ä¸€å‘¨å¹´è¾£ï¼ˆå˜‰ç„¶å°å§é¦–æ’­å‘¨å¹´å¿«ä¹ï¼‰</p>
</blockquote>
<span id="more"></span>

<h2 id="å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± "><a href="#å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± " class="headerlink" title="å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± "></a>å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± </h2><p>ç”¨ç°ä»£çš„C++æ ‡å‡†åº“ï¼ˆçº¿ç¨‹+é”+æ¡ä»¶å˜é‡ï¼‰å®ç°ä¸€ä¸ªå•ä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹æ± éå¸¸ç®€å•ã€‚å°±åƒä¹‹å‰é‚£ç¯‡åšæ–‡é‡Œé¢è®²çš„ä¸€æ ·ï¼ŒåŸç†éå¸¸ç®€å•ï¼Œå¯¹æ–°æ‰‹è€Œè¨€æœ€å¤æ‚çš„å…¶å®å°±æ˜¯C++11ä¼—å¤šçš„æ–°è¯­è¨€ç‰¹æ€§ç½¢äº†ã€‚</p>
<p>ä¸€ä¸ªç®€æ˜“çš„å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± çš„å®ç°æ€è·¯ï¼šåœ¨çº¿ç¨‹æ± æ„é€ æ—¶åˆå§‹åŒ–çº¿ç¨‹æ•°ï¼Œåœ¨ææ„æ—¶åœæ­¢çº¿ç¨‹æ± ã€‚å¯¹å¤–ä¹Ÿåªéœ€è¦æä¾›æäº¤ä»»åŠ¡çš„æ¥å£å°±å¤Ÿäº†ã€‚</p>
<h3 id="æ¥å£è®¾è®¡"><a href="#æ¥å£è®¾è®¡" class="headerlink" title="æ¥å£è®¾è®¡"></a>æ¥å£è®¾è®¡</h3><h4 id="è¿”å›ç±»å‹"><a href="#è¿”å›ç±»å‹" class="headerlink" title="è¿”å›ç±»å‹"></a>è¿”å›ç±»å‹</h4><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">ThreadPool</span><span class="params">(<span class="keyword">size_t</span> threads = std::thread::hardware_concurrency())</span></span>;  <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">enqueue</span><span class="params">(F &amp;&amp;f, Args &amp;&amp;...args)</span></span>; <span class="comment">// å…¥é˜Ÿæ¥å£</span></span><br></pre></td></tr></table></figure>

<p>å…¥é˜Ÿæ¥å£<code>enqueue()</code>è¿™ä¸ªæ¨¡æ¿å‡½æ•°è¿”å›å€¼ä½¿ç”¨äº†<code>auto</code>å…³é”®å­—è¿›è¡Œæ¨å¯¼ï¼Œå®é™…ä¸Šçš„è¿”å›å€¼å…¶å®æ˜¯ä¸€ä¸ªfutureã€‚futureçš„ç±»å‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> return_type = std::<span class="keyword">invoke_result_t</span>&lt;F, Args...&gt;;</span><br><span class="line">std::future&lt;return_type&gt; res;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªfutureè¿”å›çš„ç±»å‹å®é™…ä¸Šæ˜¯ä»»åŠ¡çš„è¿”å›ç±»å‹ã€‚</p>
<h4 id="è¾“å…¥å‚æ•°"><a href="#è¾“å…¥å‚æ•°" class="headerlink" title="è¾“å…¥å‚æ•°"></a>è¾“å…¥å‚æ•°</h4><p>è¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡å’Œå®ƒçš„å‚æ•°ï¼Œè¿™é‡Œåˆ©ç”¨äº†C++11çš„å¯å˜å‚æ•°æ¨¡æ¿æ¥å®ç°ä¼ é€’ä»»æ„æ•°é‡çš„å¯è°ƒç”¨å¯¹è±¡çš„å‚æ•°ã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">ThreadPool</span><span class="params">(<span class="keyword">size_t</span> threads = std::thread::hardware_concurrency())</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">auto</span> <span class="title">enqueue</span><span class="params">(F &amp;&amp;f, Args &amp;&amp;...args)</span></span>;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">ThreadPool</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	std::vector&lt;std::thread&gt; workers;</span><br><span class="line">	std::queue&lt;std::function&lt;<span class="keyword">void</span>()&gt;&gt; tasks;</span><br><span class="line">	std::mutex queue_mutex;</span><br><span class="line">	std::condition_variable condition;</span><br><span class="line">	<span class="keyword">bool</span> stop;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç®€æ˜“å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± çš„æˆå‘˜åªæœ‰ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚ä¸ºäº†ä¿è¯ä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹å®‰å…¨ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†ä¸€ä¸ªé”ã€‚åŒæ—¶æˆ‘ä»¬è¿˜æä¾›äº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œåˆ©ç”¨é”å’Œæ¡ä»¶å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°çº¿ç¨‹é€šçŸ¥æœºåˆ¶ã€‚çº¿ç¨‹é€šçŸ¥æœºåˆ¶æŒ‡çš„æ˜¯ï¼Œåˆšå¼€å§‹æ—¶çº¿ç¨‹æ± ä¸­æ˜¯æ²¡æœ‰ä»»åŠ¡çš„ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½ç­‰å¾…ä»»åŠ¡çš„åˆ°æ¥ï¼Œå½“ä¸€ä¸ªä»»åŠ¡è¿›å…¥åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå°±ä¼šé€šçŸ¥<strong>ä¸€ä¸ª</strong>çº¿ç¨‹å»å¤„ç†åˆ°æ¥çš„ä»»åŠ¡ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬åˆæä¾›äº†ä¸€ä¸ªstopå˜é‡ï¼Œç”¨æ¥åœ¨ææ„çš„æ—¶å€™åœæ­¢å’Œæ¸…ç†ä»»åŠ¡å’Œçº¿ç¨‹ã€‚å› ä¸ºæ‡’ï¼ˆé«˜æƒ…å•†ï¼šRAIIé£æ ¼çº¿ç¨‹æ± ï¼Œç”Ÿå‘½å‘¨æœŸåŸºæœ¬ä¸Šä¸åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼‰ï¼Œæ²¡æœ‰æä¾›stopæ¥å£ã€‚</p>
<p>ä¸‹é¢æ˜¯å…·ä½“å®ç°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Diana &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// * ç®€æ˜“å¤šçº¿ç¨‹å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± ï¼Œä½¿ç”¨çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œæ¥å£æ›´äººæ€§åŒ–ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="keyword">explicit</span> <span class="title">ThreadPool</span><span class="params">(<span class="keyword">size_t</span> threads = std::thread::hardware_concurrency())</span> : stop(false) &#123;</span></span><br><span class="line">			<span class="comment">// æ ¹æ®threadsæ•°é‡åˆ›å»ºå¤šä¸ªçº¿ç¨‹</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; threads; ++i) &#123;</span><br><span class="line">				workers.<span class="built_in">emplace_back</span>([<span class="keyword">this</span>]() &#123;</span><br><span class="line">					<span class="keyword">for</span> (;;) &#123;<span class="comment">// å·¥ä½œçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸åœæŸ¥è¯¢ä»»åŠ¡é˜Ÿåˆ—å¹¶å–å‡ºä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">						std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; task;</span><br><span class="line"></span><br><span class="line">						&#123;</span><br><span class="line">							std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(<span class="keyword">this</span>-&gt;queue_mutex);</span><br><span class="line">							<span class="keyword">this</span>-&gt;condition.<span class="built_in">wait</span>(lock,</span><br><span class="line">												 [<span class="keyword">this</span>]() &#123;</span><br><span class="line">													 <span class="keyword">return</span> <span class="keyword">this</span>-&gt;stop || !<span class="keyword">this</span>-&gt;tasks.<span class="built_in">empty</span>();<span class="comment">// æ¡ä»¶å˜é‡ç­‰å¾…çº¿ç¨‹æ± ä¸ä¸ºç©ºæˆ–è€…stop</span></span><br><span class="line">												 &#125;);</span><br><span class="line">							<span class="keyword">if</span> (<span class="keyword">this</span>-&gt;stop &amp;&amp; <span class="keyword">this</span>-&gt;tasks.<span class="built_in">empty</span>())<span class="comment">// çº¿ç¨‹æ± ä¸ºç©ºä¸”stopï¼Œè¯æ˜çº¿ç¨‹æ± ç»“æŸï¼Œé€€å‡ºçº¿ç¨‹</span></span><br><span class="line">								<span class="keyword">return</span>;</span><br><span class="line">							task = std::<span class="built_in">move</span>(<span class="keyword">this</span>-&gt;tasks.<span class="built_in">front</span>());<span class="comment">// å–å‡ºä»»åŠ¡</span></span><br><span class="line">							<span class="keyword">this</span>-&gt;tasks.<span class="built_in">pop</span>();</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="built_in">task</span>();<span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);<span class="comment">// lambdaè¡¨è¾¾å¼æ„å»º</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function">		<span class="keyword">auto</span> <span class="title">enqueue</span><span class="params">(F &amp;&amp;f, Args &amp;&amp;...args)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">using</span> return_type = std::<span class="keyword">invoke_result_t</span>&lt;F, Args...&gt;;</span><br><span class="line">			<span class="keyword">auto</span> task = std::make_shared&lt;std::packaged_task&lt;<span class="built_in">return_type</span>()&gt;&gt;(</span><br><span class="line">					std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...));<span class="comment">// å®Œç¾è½¬å‘ï¼Œæ„é€ ä»»åŠ¡ä»¿å‡½æ•°çš„æŒ‡é’ˆ</span></span><br><span class="line">			std::future&lt;return_type&gt; res = task-&gt;<span class="built_in">get_future</span>();                  <span class="comment">// è·å¾—å‡½æ•°æ‰§è¡Œçš„futureè¿”å›</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (stop) &#123;</span><br><span class="line">					<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;enqueue on stopped Thread pool&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				tasks.<span class="built_in">emplace</span>([task = std::<span class="built_in">move</span>(task)]() &#123; (*task)(); &#125;);<span class="comment">// å¡å…¥ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">			&#125;                                                            <span class="comment">// å…¥é˜Ÿåˆ—åå³å¯è§£é”</span></span><br><span class="line">			condition.<span class="built_in">notify_one</span>();                                      <span class="comment">// ä»…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œé¿å…æ— æ„ä¹‰çš„ç«äº‰</span></span><br><span class="line">			<span class="keyword">return</span> res;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		~<span class="built_in">ThreadPool</span>() &#123;</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line">				stop = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			condition.<span class="built_in">notify_all</span>();<span class="comment">// å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œæ¸…ç†ä»»åŠ¡</span></span><br><span class="line">			<span class="keyword">for</span> (std::thread &amp;worker: workers)</span><br><span class="line">				worker.<span class="built_in">join</span>();<span class="comment">// é˜»å¡ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç»“æŸ</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		std::vector&lt;std::thread&gt; workers;</span><br><span class="line">		std::queue&lt;std::function&lt;<span class="keyword">void</span>()&gt;&gt; tasks;</span><br><span class="line">		std::mutex queue_mutex;</span><br><span class="line">		std::condition_variable condition;</span><br><span class="line">		<span class="keyword">bool</span> stop;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;<span class="comment">// namespace Diana</span></span><br></pre></td></tr></table></figure>

<p>ç»†èŠ‚ä¸Šçš„ä¸œè¥¿ï¼Œæ³¨é‡Šå·²ç»å†™å®Œäº†ã€‚</p>
<p>æ³¨æ„åœ¨æœ‰é˜Ÿä¼è¿›å…¥é˜Ÿåˆ—æ—¶ï¼Œä»…éœ€è¦notify_one()ï¼Œé¿å…æ— æ„ä¹‰çš„çº¿ç¨‹ç«äº‰ï¼›åœ¨åœæ­¢çº¿ç¨‹æ± æ—¶ï¼Œè¦notify_all()å”¤é†’æ‰€æœ‰è¿›ç¨‹ã€‚ç”±äºçº¿ç¨‹åœ¨ç­‰å¾…stopæ ‡å¿—ï¼Œæ‰€ä»¥å½“å”¤é†’ä¹‹åæ‰ä¼šæŠŠé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å–å‡ºæ‰§è¡Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™æ‰ä¼šé€€å‡ºçº¿ç¨‹ã€‚</p>
<h3 id="é‡æ„ï¼šåˆ†ç¦»é˜Ÿåˆ—ä»£ç ï¼Œç¼–å†™çº¿ç¨‹å®‰å…¨ä»»åŠ¡é˜Ÿåˆ—"><a href="#é‡æ„ï¼šåˆ†ç¦»é˜Ÿåˆ—ä»£ç ï¼Œç¼–å†™çº¿ç¨‹å®‰å…¨ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="é‡æ„ï¼šåˆ†ç¦»é˜Ÿåˆ—ä»£ç ï¼Œç¼–å†™çº¿ç¨‹å®‰å…¨ä»»åŠ¡é˜Ÿåˆ—"></a>é‡æ„ï¼šåˆ†ç¦»é˜Ÿåˆ—ä»£ç ï¼Œç¼–å†™çº¿ç¨‹å®‰å…¨ä»»åŠ¡é˜Ÿåˆ—</h3><p>è¿™é‡Œè¿›è¡Œä¸€æ¬¡é‡æ„ï¼Œåƒä¹‹å‰é‚£ç‰‡åšæ–‡ä¸€æ ·ï¼Œå°è£…ä¸€ä¸ªçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Diana &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// * çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—</span></span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">SafeQueue</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">const</span> T &amp;item)</span> </span>&#123;</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="function">std::scoped_lock <span class="title">lock</span><span class="params">(mtx_)</span></span>;</span><br><span class="line">				queue_.<span class="built_in">push</span>(item);</span><br><span class="line">			&#125;</span><br><span class="line">			cond_.<span class="built_in">notify_one</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(T &amp;&amp;item)</span> </span>&#123;<span class="comment">// ä¸¤ä¸ªpushæ–¹æ³•ï¼Œæ­¤å¤„ä¸æ˜¯ä¸‡èƒ½å¼•ç”¨è€Œæ˜¯å•çº¯å³å€¼</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="function">std::scoped_lock <span class="title">lock</span><span class="params">(mtx_)</span></span>;</span><br><span class="line">				queue_.<span class="built_in">push</span>(std::<span class="built_in">move</span>(item));</span><br><span class="line">			&#125;</span><br><span class="line">			cond_.<span class="built_in">notify_one</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">bool</span> <span class="title">pop</span><span class="params">(T &amp;item)</span> </span>&#123;</span><br><span class="line">			<span class="function">std::unique_lock <span class="title">lock</span><span class="params">(mtx_)</span></span>;</span><br><span class="line">			cond_.<span class="built_in">wait</span>(lock, [&amp;]() &#123;</span><br><span class="line">				<span class="keyword">return</span> !queue_.<span class="built_in">empty</span>() || stop_;</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="keyword">if</span> (queue_.<span class="built_in">empty</span>())</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			item = std::<span class="built_in">move</span>(queue_.<span class="built_in">front</span>());</span><br><span class="line">			queue_.<span class="built_in">pop</span>();</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function">std::<span class="keyword">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">			<span class="function">std::scoped_lock <span class="title">lock</span><span class="params">(mtx_)</span></span>;</span><br><span class="line">			<span class="keyword">return</span> queue_.<span class="built_in">size</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">			<span class="function">std::scoped_lock <span class="title">lock</span><span class="params">(mtx_)</span></span>;</span><br><span class="line">			<span class="keyword">return</span> queue_.<span class="built_in">empty</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="function">std::scoped_lock <span class="title">lock</span><span class="params">(mtx_)</span></span>;</span><br><span class="line">				stop_ = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			cond_.<span class="built_in">notify_all</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		std::condition_variable cond_;</span><br><span class="line">		<span class="keyword">mutable</span> std::mutex mtx_;</span><br><span class="line">		std::queue&lt;T&gt; queue_;</span><br><span class="line">		<span class="keyword">bool</span> stop_ = <span class="literal">false</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;<span class="comment">// namespace Diana</span></span><br></pre></td></tr></table></figure>

<p>çº¿ç¨‹å®‰å…¨ä»»åŠ¡é˜Ÿåˆ—éœ€è¦æ³¨æ„çš„ç»†èŠ‚ä¸å¤šã€‚æ³¨æ„ä¸€ä¸‹è¿™é‡Œå†™äº†ä¸¤ä¸ªpushæ–¹æ³•ï¼ŒåŸå› æ˜¯åœ¨è¯¥æ¨¡æ¿ç±»ç‰¹åŒ–åï¼ŒTå·²ç»æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»å‹ï¼ŒT&amp;&amp;å°±ä¸å†æ˜¯æ³›å‹ç¼–ç¨‹ä¸­å¸¸è§çš„ä¸‡èƒ½å¼•ç”¨ï¼Œè€Œæ˜¯ä¸€ä¸ªå•çº¯çš„å³å€¼äº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å†æ·»åŠ ä¸€ä¸ªæ¨¡æ¿æˆå‘˜å‡½æ•°æ¥åˆå¹¶ä¸¤ä¸ªpushï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(U&amp;&amp; item)</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in"><span class="keyword">static_assert</span></span>(std::is_same&lt;U,T&gt;::value==<span class="literal">true</span>);</span><br><span class="line">        <span class="function">std::scoped_lock <span class="title">lock</span><span class="params">(mtx_)</span></span>;</span><br><span class="line">        queue_.<span class="built_in">push</span>(std::forward(item));</span><br><span class="line">    &#125;</span><br><span class="line">    cond_.<span class="built_in">notify_one</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦æ³¨æ„çš„æ˜¯ï¼Œè®°å¾—åˆ¤æ–­ä¸€ä¸‹Uå’ŒTçš„ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>åˆ©ç”¨è¿™ä¸ªå®‰å…¨é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™ä¸€ä¸‹å•ä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹æ± ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Diana &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">using</span> WorkItem = std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt;;</span><br><span class="line">	<span class="comment">// * ç®€æ˜“å¤šçº¿ç¨‹å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± ï¼Œä½¿ç”¨SafeQueueçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">SimplePool</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="keyword">explicit</span> <span class="title">SimplePool</span><span class="params">(<span class="keyword">size_t</span> threads = std::thread::hardware_concurrency())</span> </span>&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; threads; ++i) &#123;</span><br><span class="line">				workers_.<span class="built_in">emplace_back</span>([<span class="keyword">this</span>]() &#123;</span><br><span class="line">					<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">						std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt; task;</span><br><span class="line">						<span class="keyword">if</span> (!queue_.<span class="built_in">pop</span>(task))</span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (task)</span><br><span class="line">							<span class="built_in">task</span>();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(WorkItem item)</span> </span>&#123;</span><br><span class="line">			queue_.<span class="built_in">push</span>(std::<span class="built_in">move</span>(item));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		~<span class="built_in">SimplePool</span>() &#123;</span><br><span class="line">			queue_.<span class="built_in">stop</span>();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; thd: workers_)</span><br><span class="line">				thd.<span class="built_in">join</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		SafeQueue&lt;WorkItem&gt; queue_;</span><br><span class="line">		std::vector&lt;std::thread&gt; workers_;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;<span class="comment">// namespace Diana</span></span><br></pre></td></tr></table></figure>

<p>å…¥é˜Ÿæ¥å£enqueue()å²è¯—çº§ç®€åŒ–ã€‚å½“ç„¶ï¼Œè¿™ç§ç®€åŒ–ä¹Ÿå¸¦æ¥ä¸€äº›ä¸ä¾¿ï¼šä½¿ç”¨std::function&lt;void()&gt;ä½œä¸ºå‚æ•°ï¼Œä¸æƒ³å‰é¢çš„é‚£ä¸ªä¼ å…¥å¯è°ƒç”¨å¯¹è±¡åŠå…¶å‚æ•°ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶éœ€è¦ç”¨æˆ·è¿›è¡ŒåŒ…è£…ï¼Œè¿™ä¸ªä¼šåœ¨åé¢åŠŸèƒ½æµ‹è¯•çš„æ—¶å€™è®²ã€‚</p>
<hr>
<h2 id="å¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± "><a href="#å¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± " class="headerlink" title="å¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± "></a>å¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± </h2><p>å…¶å®å¤šä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹æ± çš„è®¾è®¡æ€è·¯ä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼šæ¯ä¸ªçº¿ç¨‹å¯¹åº”ç€ä¸€ä¸ªè‡ªå·±çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚å› ä¸ºå‰é¢å¯¹ä»»åŠ¡é˜Ÿåˆ—è¿›è¡Œäº†æŠ½å–é‡æ„ï¼Œç¼–å†™ä¸€ä¸ªå¤šä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹æ± ä¹Ÿéå¸¸ç®€å•ã€‚</p>
<p>æˆ‘ä»¬å¯¹åŸæœ¬å•ä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹æ± çš„å…¥é˜Ÿæ¥å£è¿›è¡Œæ”¹é€ ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">schedule_by_id</span><span class="params">(WorkItem fn, <span class="keyword">size_t</span> id = <span class="number">-1</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>å½“æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå®ƒæ”¾åˆ°ä»»æ„ä¸€ä¸ªçº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚åœ¨ç”¨æˆ·æ²¡æœ‰æŒ‡å®šä»»åŠ¡é˜Ÿåˆ—æ—¶ï¼Œå°±ä¸ºè¯¥ä»»åŠ¡éšæœºé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹æ‰€å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<h3 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>ç®€å•å¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Diana &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">using</span> WorkItem = std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt;;</span><br><span class="line">	<span class="comment">// * ç®€æ˜“å¤šçº¿ç¨‹å¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± ï¼Œä½¿ç”¨SafeQueueçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">MultiplePool</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="keyword">explicit</span> <span class="title">MultiplePool</span><span class="params">(<span class="keyword">size_t</span> thread_num = std::thread::hardware_concurrency())</span></span></span><br><span class="line"><span class="function">			: queues_(thread_num),</span></span><br><span class="line"><span class="function">			  thread_num_(thread_num) &#123;</span></span><br><span class="line">			<span class="keyword">auto</span> worker = [<span class="keyword">this</span>](<span class="keyword">size_t</span> id) &#123;</span><br><span class="line">				<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">					WorkItem task&#123;&#125;;</span><br><span class="line">					<span class="keyword">if</span> (!queues_[id].<span class="built_in">pop</span>(task))</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (task)</span><br><span class="line">						<span class="built_in">task</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			workers_.<span class="built_in">reserve</span>(thread_num_);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; thread_num_; ++i) &#123;</span><br><span class="line">				workers_.<span class="built_in">emplace_back</span>(worker, i);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">schedule_by_id</span><span class="params">(WorkItem fn, <span class="keyword">size_t</span> id = <span class="number">-1</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (fn == <span class="literal">nullptr</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (id == <span class="number">-1</span>) &#123;</span><br><span class="line">				id = <span class="built_in">rand</span>() % thread_num_;<span class="comment">// éšæœºæ’å…¥åˆ°ä¸€ä¸ªçº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">				queues_[id].<span class="built_in">push</span>(std::<span class="built_in">move</span>(fn));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="built_in">assert</span>(id &lt; thread_num_);<span class="comment">// æ’å…¥æŒ‡å®šçº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">				queues_[id].<span class="built_in">push</span>(std::<span class="built_in">move</span>(fn));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		~<span class="built_in">MultiplePool</span>() &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; queue: queues_) &#123;</span><br><span class="line">				queue.<span class="built_in">stop</span>();<span class="comment">// åœæ­¢æ¯ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; worker: workers_) &#123;</span><br><span class="line">				worker.<span class="built_in">join</span>();<span class="comment">// é˜»å¡ï¼Œç­‰å¾…æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸ</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		std::vector&lt;Diana::SafeQueue&lt;WorkItem&gt;&gt; queues_;<span class="comment">// æ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">		<span class="keyword">size_t</span> thread_num_;</span><br><span class="line">		std::vector&lt;std::thread&gt; workers_;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;<span class="comment">// namespace Diana</span></span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„ç»†èŠ‚ä¹Ÿåœ¨ä»£ç æ³¨é‡Šä¸­å†™æ˜äº†ã€‚</p>
<hr>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æˆ‘ä»¬ç¼–å†™å¦‚ä¸‹æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_thread_pool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;test_thread_pool()&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	Diana::ThreadPool threadPool;</span><br><span class="line">	threadPool.<span class="built_in">enqueue</span>([] &#123; std::cout &lt;&lt; <span class="string">&quot;hello\n&quot;</span>; &#125;);</span><br><span class="line">	<span class="keyword">auto</span> future = threadPool.<span class="built_in">enqueue</span>([](std::string str) &#123; <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span> + str; &#125;, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">	std::cout &lt;&lt; future.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">funA</span><span class="params">(std::string str)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;hello&quot;</span> + str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_simple_thread_pool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;test_simple_thread_pool()&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	Diana::SimplePool threadPool;</span><br><span class="line">	threadPool.<span class="built_in">enqueue</span>([] &#123; std::cout &lt;&lt; <span class="string">&quot;hello\n&quot;</span>; &#125;);</span><br><span class="line">	<span class="comment">// * æ­¤å¤„å¿…é¡»ä½¿ç”¨shared_ptrè¿›è¡ŒåŒ…è£…ï¼Œ</span></span><br><span class="line">	<span class="comment">// * å¦åˆ™åœ¨std::function&lt;void()&gt;ä¸­ä¼šå°è¯•ç”Ÿæˆstd::packaged_taskçš„æ‹·è´æ„é€ å‡½æ•°ï¼Œ</span></span><br><span class="line">	<span class="comment">// ! std::packaged_taskç¦æ­¢æ‹·è´æ“ä½œ</span></span><br><span class="line">	<span class="keyword">auto</span> task = std::make_shared&lt;std::packaged_task&lt;std::<span class="built_in">string</span>()&gt;&gt;(std::<span class="built_in">bind</span>(funA, <span class="string">&quot;world&quot;</span>));</span><br><span class="line">	std::future&lt;std::string&gt; res = task-&gt;<span class="built_in">get_future</span>();</span><br><span class="line">	threadPool.<span class="built_in">enqueue</span>([task = std::<span class="built_in">move</span>(task)] &#123; (*task)(); &#125;);</span><br><span class="line">    <span class="comment">// ! ä»¥ä¸‹å®ç°æ–¹æ³•æ˜¯é”™è¯¯çš„</span></span><br><span class="line">	<span class="comment">//	auto task = std::packaged_task&lt;std::string()&gt;(std::bind(funA, &quot;world&quot;));</span></span><br><span class="line">	<span class="comment">//	std::future&lt;std::string&gt; res = task.get_future();</span></span><br><span class="line">	<span class="comment">//	threadPool.enqueue(std::move(task));</span></span><br><span class="line">	std::cout &lt;&lt; res.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_multiple_thread_pool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;test_multiple_thread_pool&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	Diana::MultiplePool threadPool;</span><br><span class="line">	threadPool.<span class="built_in">schedule_by_id</span>([] &#123; std::cout &lt;&lt; <span class="string">&quot;hello\n&quot;</span>; &#125;);</span><br><span class="line">	<span class="keyword">auto</span> task = std::make_shared&lt;std::packaged_task&lt;std::<span class="built_in">string</span>()&gt;&gt;(std::<span class="built_in">bind</span>(funA, <span class="string">&quot;world&quot;</span>));</span><br><span class="line">	std::future&lt;std::string&gt; res = task-&gt;<span class="built_in">get_future</span>();</span><br><span class="line">	threadPool.<span class="built_in">schedule_by_id</span>([task = std::<span class="built_in">move</span>(task)] &#123; (*task)(); &#125;);</span><br><span class="line">	std::cout &lt;&lt; res.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ†åˆ«ä¸ºä¸‰ä¸ªç‰ˆæœ¬çš„çº¿ç¨‹æ± ï¼ˆæœªé‡æ„çš„å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± +é‡æ„åçš„å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± +å¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± ï¼‰ç¼–å†™äº†æ¥å£æµ‹è¯•ã€‚</p>
<p>æœªé‡æ„çš„å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± ï¼Œå› ä¸ºæ¥å£ç®€å•ï¼Œæ²¡æœ‰ä»€ä¹ˆéœ€è¦ç‰¹åˆ«æ³¨æ„çš„ä¸œè¥¿ã€‚</p>
<p>é‡æ„åçš„å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± å’Œå¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘å†™äº†ä¸€äº›æ³¨é‡Šï¼Œè¿˜æ³¨é‡Šäº†ä¸€äº›é”™è¯¯çš„ä»»åŠ¡æäº¤æ–¹å¼ã€‚è¿˜è®°å¾—å‰é¢é‡æ„æ—¶ï¼Œæˆ‘ä»¬æŠŠæäº¤ä»»åŠ¡çš„æ¥å£å‚æ•°æ”¹æˆäº†std::function&lt;void()&gt;å˜›ï¼Ÿä¸ºäº†é…åˆè¿™ä¸ªå‚æ•°æ ¼å¼ï¼Œä»¥åŠåˆ©ç”¨futureè¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å¼‚æ­¥è·å–ç»“æœçš„æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼ˆä¹‹å‰çš„ç‰ˆæœ¬åœ¨å…¥é˜Ÿæ¥å£ä¸­ä¸ºç”¨æˆ·åšäº†è¿™äº›äº‹æƒ…ï¼‰ã€‚æ¯”è¾ƒéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯æˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ªshared_ptræ™ºèƒ½æŒ‡é’ˆæ¥å¯¹packaged_taskè¿›è¡ŒåŒ…è£…ï¼Œè¿™æ˜¯å› ä¸ºåœ¨std::function&lt;void()&gt;ä¸­ä¼šå°è¯•ç”Ÿæˆstd::packaged_taskçš„æ‹·è´æ„é€ å‡½æ•°ï¼Œè€Œstd::packaged_taskæ˜¯ç¦æ­¢è¿›è¡Œæ‹·è´æ“ä½œçš„ï¼Œè¿™ä¼šå¼•èµ·ç¼–è¯‘å™¨çš„æŠ¥é”™ï¼ˆæ„Ÿè°¢ç¾¤é‡Œçš„å¤§ä½¬å¸®æˆ‘æ•´æ˜ç™½äº†è¿™ä¸ªäº‹æƒ…ï¼‰ã€‚</p>
<blockquote>
<p><a href="https://zh.cppreference.com/w/cpp/utility/functional/function">cppreference-std::funtionï¼š</a></p>
<p>ç±»æ¨¡æ¿ <code>std::function</code> æ˜¯é€šç”¨å¤šæ€å‡½æ•°åŒ…è£…å™¨ã€‚ <code>std::function</code> çš„å®ä¾‹èƒ½å­˜å‚¨ã€å¤åˆ¶åŠè°ƒç”¨ä»»ä½•<a href="https://zh.cppreference.com/w/cpp/named_req/CopyConstructible"><em>å¯å¤åˆ¶æ„é€ </em> <em>(CopyConstructible)</em> </a>çš„<a href="https://zh.cppreference.com/w/cpp/named_req/Callable"><em>å¯è°ƒç”¨</em> <em>(Callable)</em> </a><em>ç›®æ ‡</em>â€”â€”å‡½æ•°ã€ <a href="https://zh.cppreference.com/w/cpp/language/lambda">lambda è¡¨è¾¾å¼</a>ã€ <a href="https://zh.cppreference.com/w/cpp/utility/functional/bind">bind è¡¨è¾¾å¼</a>æˆ–å…¶ä»–å‡½æ•°å¯¹è±¡ï¼Œè¿˜æœ‰æŒ‡å‘æˆå‘˜å‡½æ•°æŒ‡é’ˆå’ŒæŒ‡å‘æ•°æ®æˆå‘˜æŒ‡é’ˆã€‚</p>
<p>å­˜å‚¨çš„å¯è°ƒç”¨å¯¹è±¡è¢«ç§°ä¸º <code>std::function</code> çš„<em>ç›®æ ‡</em>ã€‚è‹¥ <code>std::function</code> ä¸å«ç›®æ ‡ï¼Œåˆ™ç§°å®ƒä¸º<em>ç©º</em>ã€‚è°ƒç”¨<em>ç©º</em> <code>std::function</code> çš„<em>ç›®æ ‡</em>å¯¼è‡´æŠ›å‡º <a href="https://zh.cppreference.com/w/cpp/utility/functional/bad_function_call">std::bad_function_call</a> å¼‚å¸¸ã€‚</p>
<p><code>std::function</code> æ»¡è¶³<a href="https://zh.cppreference.com/w/cpp/named_req/CopyConstructible"><em>å¯å¤åˆ¶æ„é€ </em> <em>(CopyConstructible)</em> </a>å’Œ<a href="https://zh.cppreference.com/w/cpp/named_req/CopyAssignable"><em>å¯å¤åˆ¶èµ‹å€¼</em> <em>(CopyAssignable)</em> </a>ã€‚</p>
</blockquote>
<blockquote>
<p><a href="https://zh.cppreference.com/w/cpp/thread/packaged_task/packaged_task">cppreference-std::packaged_taskæ„é€ å‡½æ•°ï¼š</a></p>
<p>æ„é€ æ–°çš„ <code>std::packaged_task</code> å¯¹è±¡ã€‚</p>
<ol>
<li><p>â€¦</p>
</li>
<li><p>å¤åˆ¶æ„é€ å‡½æ•°è¢«åˆ é™¤ï¼Œ <code>std::packaged_task</code> ä»…å¯ç§»åŠ¨ã€‚</p>
</li>
<li><p>â€¦</p>
</li>
</ol>
</blockquote>
<h2 id="æ€§èƒ½æ¯”è¾ƒ"><a href="#æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="æ€§èƒ½æ¯”è¾ƒ"></a>æ€§èƒ½æ¯”è¾ƒ</h2><p>æ ¹æ®æ€§èƒ½æµ‹è¯•ï¼Œé‡æ„å’Œæœªé‡æ„ç‰ˆæœ¬çš„å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± æœ‰ç€ç»†å¾®çš„æ€§èƒ½å·®åˆ«ï¼ˆæœªé‡æ„ç‰ˆæœ¬ç•¥ä¼˜ï¼‰ã€‚è€Œåœ¨æ•°æ®é‡è¶³å¤Ÿå¤§çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºå¤šä»»åŠ¡é˜Ÿåˆ—çš„è®¾è®¡ï¼Œå¤šä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± æ€§èƒ½ç”šè‡³è¾¾åˆ°äº†å•ä»»åŠ¡é˜Ÿåˆ—çº¿ç¨‹æ± çš„ä¸¤å€ã€‚</p>
<h2 id="å†™åœ¨åé¢"><a href="#å†™åœ¨åé¢" class="headerlink" title="å†™åœ¨åé¢"></a>å†™åœ¨åé¢</h2><p>åé¢å¤§æ¦‚è¿˜ä¼šç»§ç»­ç ”ç©¶ä¸€ä¸‹work stealçº¿ç¨‹æ± ï¼Œä¹Ÿä¼šå†™ç¯‡å­¦ä¹ å¿ƒå¾—=ã€‚=</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ol>
<li><a href="http://www.purecpp.org/detail?id=2260">Purecppï¼šèŠèŠçº¿ç¨‹æ± ï¼ˆä¸€ï¼‰</a></li>
<li><a href="http://www.purecpp.org/detail?id=2261">Purecppï¼šèŠèŠçº¿ç¨‹æ± ï¼ˆäºŒï¼‰</a></li>
</ol>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>C++11</tag>
        <tag>C++14</tag>
        <tag>C++17</tag>
        <tag>C++å¹¶å‘</tag>
        <tag>å­¦ä¹ å¿ƒå¾—</tag>
      </tags>
  </entry>
  <entry>
    <title>æ„é€ å‡½æ•°</title>
    <url>/2020/07/21/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="ã€C-ã€‘ç±»æ„é€ å‡½æ•°ï¼ˆæ·±æ‹·è´ä¸æµ…æ‹·è´ï¼‰"><a href="#ã€C-ã€‘ç±»æ„é€ å‡½æ•°ï¼ˆæ·±æ‹·è´ä¸æµ…æ‹·è´ï¼‰" class="headerlink" title="ã€C++ã€‘ç±»æ„é€ å‡½æ•°ï¼ˆæ·±æ‹·è´ä¸æµ…æ‹·è´ï¼‰"></a>ã€C++ã€‘ç±»æ„é€ å‡½æ•°ï¼ˆæ·±æ‹·è´ä¸æµ…æ‹·è´ï¼‰</h1><blockquote>
<p>åŸåˆ›Jacky_Feng æœ€åå‘å¸ƒäº2019-11-29 19:56:28 é˜…è¯»æ•° 16  æ”¶è—</p>
</blockquote>
<h2 id="1-ä»€ä¹ˆæ˜¯ç±»çš„æ„é€ å‡½æ•°"><a href="#1-ä»€ä¹ˆæ˜¯ç±»çš„æ„é€ å‡½æ•°" class="headerlink" title="1.ä»€ä¹ˆæ˜¯ç±»çš„æ„é€ å‡½æ•°"></a>1.ä»€ä¹ˆæ˜¯ç±»çš„æ„é€ å‡½æ•°</h2><p>ç±»çš„æ„é€ å‡½æ•°æ˜¯ç±»çš„ä¸€ç§ç‰¹æ®Šçš„æˆå‘˜å‡½æ•°ï¼Œå®ƒä¼šåœ¨æ¯æ¬¡åˆ›å»ºç±»çš„æ–°å¯¹è±¡æ—¶è¢«è‡ªåŠ¨è°ƒç”¨ã€‚æ²¡åˆ›å»ºä¸€ä¸ªå¯¹è±¡éƒ½å¿…é¡»è°ƒç”¨ä¸€æ¬¡æ„é€ å‡½æ•°ã€‚</p>
<p>æ„é€ å‡½æ•°çš„åç§°ä¸ç±»çš„åç§°æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¹¶ä¸”ä¸ä¼šè¿”å›ä»»ä½•ç±»å‹ï¼Œä¹Ÿä¸ä¼šè¿”å›voidã€‚æ„é€ å‡½æ•°å¯ç”¨äºä¸ºæŸäº›æˆå‘˜å˜é‡è®¾ç½®åˆå§‹å€¼ã€‚</p>
<span id="more"></span>

<p>å®ä¾‹æ¼”ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ç±»Counterçš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="comment">// ç‰¹ç‚¹ï¼šä»¥ç±»åä½œä¸ºå‡½æ•°åï¼Œæ— è¿”å›ç±»å‹</span></span><br><span class="line">    <span class="built_in">Counter</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;object is being created&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// æ•°æ®æˆå‘˜</span></span><br><span class="line">    <span class="keyword">int</span> m_value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Counter obj1;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä»¥ä¸Šä»£ç ç¼–è¯‘å’Œæ‰§è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<p><strong>object is being created</strong></p>
</blockquote>
<p> è¯¥ç±»å¯¹è±¡obj1è¢«åˆ›å»ºæ—¶ï¼Œç¼–è¯‘ç³»ç»Ÿä¸ºå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶è‡ªåŠ¨è°ƒç”¨æ„é€ å‡½æ•°Counter()å®Œæˆå¯¹è±¡æˆå‘˜å˜é‡çš„åˆå§‹åŒ–å·¥ä½œã€‚</p>
<h2 id="2-æ„é€ å‡½æ•°çš„åˆ†ç±»"><a href="#2-æ„é€ å‡½æ•°çš„åˆ†ç±»" class="headerlink" title="2.æ„é€ å‡½æ•°çš„åˆ†ç±»"></a>2.æ„é€ å‡½æ•°çš„åˆ†ç±»</h2><h3 id="1ï¼‰æŒ‰å‡½æ•°æœ‰æ— å‚æ•°åˆ†ç±»"><a href="#1ï¼‰æŒ‰å‡½æ•°æœ‰æ— å‚æ•°åˆ†ç±»" class="headerlink" title="1ï¼‰æŒ‰å‡½æ•°æœ‰æ— å‚æ•°åˆ†ç±»"></a>1ï¼‰æŒ‰å‡½æ•°æœ‰æ— å‚æ•°åˆ†ç±»</h3><img src="https://img-blog.csdnimg.cn/20191129164917429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0phY2t5X0Zlbmc=,size_16,color_FFFFFF,t_70" alt="æœ‰æ— å‚æ•°åˆ†ç±»" style="zoom:80%;" />

<p> å…¶ä¸­æ‰€æœ‰å¸¦æœ‰é»˜è®¤å€¼çš„æœ‰å‚æ„é€ å‡½æ•°ä¼šè½¬å˜æˆé»˜è®¤æ„é€ å‡½æ•°ã€‚</p>
<h3 id="2ï¼‰æŒ‰å‚æ•°çš„ç±»å‹åˆ†ç±»"><a href="#2ï¼‰æŒ‰å‚æ•°çš„ç±»å‹åˆ†ç±»" class="headerlink" title="2ï¼‰æŒ‰å‚æ•°çš„ç±»å‹åˆ†ç±»"></a>2ï¼‰æŒ‰å‚æ•°çš„ç±»å‹åˆ†ç±»</h3><img src="https://img-blog.csdnimg.cn/20191129165633658.png" alt="æŒ‰å‚æ•°çš„ç±»å‹åˆ†ç±»" style="zoom:80%;" />

<p> ä¸€ä¸ªç±»ä¸­è‡³å°‘æœ‰ä¸Šè¿°ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œå¯ä»¥æœ‰æ›´å¤šçš„æ„é€ å‡½æ•°ï¼ˆæ„é€ å‡½æ•°å…è®¸é‡è½½ï¼‰ï¼Œä»¥å®ç°ä¸åŒå½¢å¼å¯¹è±¡çš„åˆ›å»ºã€‚</p>
<h2 id="3-æ„é€ å‡½æ•°çš„é‡è½½"><a href="#3-æ„é€ å‡½æ•°çš„é‡è½½" class="headerlink" title="3.æ„é€ å‡½æ•°çš„é‡è½½"></a>3.æ„é€ å‡½æ•°çš„é‡è½½</h2><p>å’Œæ™®é€šæˆå‘˜å‡½æ•°ä¸€æ ·ï¼Œæ„é€ å‡½æ•°æ˜¯å…è®¸é‡è½½çš„ã€‚ä¸€ä¸ªç±»ä¸­å¯ä»¥æœ‰å¤šä¸ªé‡è½½çš„æ„é€ å‡½æ•°ï¼Œåˆ›å»ºå¯¹è±¡æ—¶æ ¹æ®ä¼ é€’çš„å®å‚æ¥åˆ¤æ–­è°ƒç”¨å“ªä¸ªæ„é€ å‡½æ•°ã€‚åˆ›å»ºå¯¹è±¡æ„é€ å‡½æ•°çš„è°ƒç”¨æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä¸€æ—¦åœ¨ç±»ä¸­å®šä¹‰äº†æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆåˆ›å»ºå¯¹è±¡æ—¶å°±ä¸€å®šè¦è°ƒç”¨ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">String</span>(<span class="keyword">const</span> <span class="keyword">char</span> *str = <span class="literal">NULL</span>); <span class="comment">// æ™®é€šæ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">String</span>(<span class="keyword">const</span> String &amp;other);    <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    ~ <span class="built_in">String</span>(<span class="keyword">void</span>);                 <span class="comment">// ææ„å‡½æ•°</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">char</span> *m_data; <span class="comment">// ç”¨äºä¿å­˜å­—ç¬¦ä¸²</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// String çš„ææ„å‡½æ•°</span></span><br><span class="line">String::~<span class="built_in">String</span>(<span class="keyword">void</span>) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span> [] m_data;</span><br><span class="line">    <span class="comment">// ç”±äºm_data æ˜¯å†…éƒ¨æ•°æ®ç±»å‹ï¼Œä¹Ÿå¯ä»¥å†™æˆ delete m_data;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// String çš„æ™®é€šæ„é€ å‡½æ•°</span></span><br><span class="line">String::<span class="built_in">String</span>(<span class="keyword">const</span> <span class="keyword">char</span> *str) </span><br><span class="line">&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;Ordinary constructor is running&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">String::<span class="built_in">String</span>(<span class="keyword">const</span> String &amp;other) </span><br><span class="line">&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;Copy constructor is running&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	String  str1; </span><br><span class="line">	<span class="function">String  <span class="title">str2</span><span class="params">(<span class="string">&quot;hello&quot;</span>)</span></span>; </span><br><span class="line">	<span class="function">String  <span class="title">str3</span><span class="params">(str2)</span></span>; </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p> ä¸Šé¢ä»£ç ç¼–è¯‘å’Œæ‰§è¡Œç»“æœä¸ºï¼š</p>
<img src="https://img-blog.csdnimg.cn/20191129172558212.png" alt="ç»“æœ" style="zoom:80%;" />

 

<h2 id="4-å¸¸è§çš„æ„é€ å‡½æ•°"><a href="#4-å¸¸è§çš„æ„é€ å‡½æ•°" class="headerlink" title="4.å¸¸è§çš„æ„é€ å‡½æ•°"></a>4.å¸¸è§çš„æ„é€ å‡½æ•°</h2><h3 id="1ï¼‰é»˜è®¤æ„é€ å‡½æ•°"><a href="#1ï¼‰é»˜è®¤æ„é€ å‡½æ•°" class="headerlink" title="1ï¼‰é»˜è®¤æ„é€ å‡½æ•°"></a>1ï¼‰é»˜è®¤æ„é€ å‡½æ•°</h3><p>å¦‚æœç”¨æˆ·è‡ªå·±æ²¡æœ‰å®šä¹‰æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé»˜è®¤æ„é€ å‡½æ•°ï¼Œåªæ˜¯è¿™ä¸ªæ„é€ å‡½æ•°æ²¡æœ‰å½¢å‚ï¼Œå‡½æ•°ä½“ä¹Ÿæ˜¯ç©ºçš„ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä¾‹å¦‚ï¼šStudentç±»çš„é»˜è®¤ç”Ÿæˆçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<p>â€‹       <code> Student()&#123;&#125;</code></p>
<p>==ä¸€ä¸ªç±»ä¸­å¿…é¡»æœ‰æ„é€ å‡½æ•°ï¼Œè¦ä¹ˆç”¨æˆ·è‡ªå·±å®šä¹‰ï¼Œè¦ä¹ˆç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆã€‚ä¸€æ—¦ç”¨æˆ·è‡ªå·±å®šä¹‰äº†æ„é€ å‡½æ•°ï¼Œä¸ç®¡å‡ ä¸ªï¼Œä¹Ÿä¸ç®¡å½¢å‚å¦‚ä½•ï¼Œç¼–è¯‘å™¨éƒ½ä¸å†è‡ªåŠ¨ç”Ÿæˆã€‚==</p>
<p>è°ƒç”¨ä¸å¸¦å‚æ•°çš„æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥çœç•¥æ‹¬å·ã€‚å³åˆ›å»ºå¯¹è±¡Student stu()å’ŒStudent stuæ˜¯ç­‰ä»·çš„ã€‚</p>
<h3 id="2ï¼‰-æ‹·è´æ„é€ å‡½æ•°"><a href="#2ï¼‰-æ‹·è´æ„é€ å‡½æ•°" class="headerlink" title="2ï¼‰ æ‹·è´æ„é€ å‡½æ•°"></a>2ï¼‰ æ‹·è´æ„é€ å‡½æ•°</h3><p>å½“ä»¥æ‹·è´çš„æ–¹å¼åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ„é€ å‡½æ•°ï¼Œå°±æ˜¯æ‹·è´æ„é€ å‡½æ•°ã€‚æ‹·è´æ„é€ å‡½æ•°çš„åç§°ä¸ç±»çš„åç§°ä¸€è‡´ï¼Œå®ƒå¿…é¡»çš„ä¸€ä¸ªå‚æ•°æ˜¯æœ¬ç±»å‹çš„ä¸€ä¸ªå¼•ç”¨å˜é‡ã€‚</p>
<p>æ³¨æ„ï¼Œé»˜è®¤æ„é€ å‡½æ•°ï¼ˆå³æ— å‚æ„é€ å‡½æ•°ï¼‰ä¸ä¸€å®šå­˜åœ¨ï¼Œä½†æ˜¯æ‹·è´æ„é€ å‡½æ•°æ€»æ˜¯ä¼šå­˜åœ¨ã€‚</p>
<blockquote>
<p>æ‹·è´æ„é€ å‡½æ•°å¸¸ç”¨çš„ä¸‰ç§æƒ…å†µï¼š</p>
<p>==â‘ å½“ç”¨ä¸€ä¸ªå¯¹è±¡å»åˆå§‹åŒ–åŒç±»çš„å¦ä¸€ä¸ªå¯¹è±¡==ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<p>â€‹    A test_b(test_a);<br>â€‹    A test_b = test_a;//è¿™ä¸¤æ¡è¯­å¥æ˜¯ç­‰ä»·çš„<br><strong>ã€æ³¨æ„ã€‘ç¬¬äºŒæ¡è¯­å¥æ˜¯åˆå§‹åŒ–è¯­å¥ï¼Œä¸æ˜¯èµ‹å€¼è¯­å¥ã€‚èµ‹å€¼è¯­å¥çš„ç­‰å·å·¦è¾¹æ˜¯ä¸€ä¸ªæ—©å·²æœ‰å®šä¹‰çš„å˜é‡ï¼Œèµ‹å€¼è¯­å¥ä¸ä¼šå¼•å‘æ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨ã€‚</strong></p>
<pre><code>A test_a,test_b;
 test_b = test_a;//è¿™å¥ä¸ä¼šå¼•å‘æ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨ï¼Œå› ä¸ºtest_bæ—©å·²ç”Ÿæˆï¼Œå·²ç»åˆå§‹åŒ–è¿‡äº†
</code></pre>
<p>â‘¡==ä¸€ä¸ªå¯¹è±¡ä»¥å€¼ä¼ é€’çš„æ–¹å¼ä¼ å…¥å‡½æ•°ä½“==ï¼Œè€Œè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°æ—¶çš„å‚æ•°ï¼Œå°±æ˜¯è°ƒç”¨å‡½æ•°æ—¶æ‰€ç»™çš„å®å‚ã€‚</p>
<p>â‘¢==ä¸€ä¸ªå¯¹è±¡ä»¥å€¼ä¼ é€’çš„æ–¹å¼ä»å‡½æ•°ä¸­è¿”å›==ï¼Œè€Œè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œå°±æ˜¯returnè¯­å¥æ‰€è¿”å›çš„å¯¹è±¡ã€‚</p>
</blockquote>
<h4 id="æµ…æ‹·è´"><a href="#æµ…æ‹·è´" class="headerlink" title="æµ…æ‹·è´"></a>æµ…æ‹·è´</h4><p>æµ…æ‹·è´æ˜¯æŒ‡åœ¨å¯¹è±¡æ‹·è´æ—¶ï¼Œåªå¯¹å¯¹è±¡ä¸­çš„æ•°æ®æˆå‘˜è¿›è¡Œç®€å•çš„èµ‹å€¼ï¼Œé»˜è®¤æ‹·è´æ„é€ å‡½æ•°æ‰§è¡Œçš„ä¹Ÿæ˜¯æµ…æ‹·è´ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹â€œæµ…æ‹·è´â€å¯ä»¥å¾ˆå¥½çš„å·¥ä½œï¼Œä½†ä¸€æ—¦å¯¹è±¡å­˜åœ¨åŠ¨æ€æˆå‘˜ï¼Œé‚£ä¹ˆæµ…æ‹·è´å°±ä¼šå‡ºé—®é¢˜ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rect</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rect</span>()</span><br><span class="line">    &#123;</span><br><span class="line">     p=<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	~<span class="built_in">Rect</span>()</span><br><span class="line">	&#123;</span><br><span class="line"> 		<span class="built_in">assert</span>(p!=<span class="literal">NULL</span>);</span><br><span class="line">    	<span class="keyword">delete</span> p;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> width;</span><br><span class="line">    <span class="keyword">int</span> height;</span><br><span class="line">    <span class="keyword">int</span> *p;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Rect rect1;</span><br><span class="line">    <span class="function">Rect <span class="title">rect2</span><span class="params">(rect1)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; è¿™æ®µä»£ç è¿è¡Œç»“æŸåï¼Œä¼šå‡ºç°è¿è¡Œé”™è¯¯ã€‚åŸå› å°±åœ¨äºåœ¨è¿›è¡Œå¯¹è±¡æ‹·è´æ—¶ï¼Œå¯¹äºåŠ¨æ€åˆ†é…çš„å†…å®¹æ²¡æœ‰æ­£ç¡®çš„æ“ä½œã€‚</span><br></pre></td></tr></table></figure>

<p>åŸå› åˆ†æï¼š</p>
<p>åœ¨ä½¿ç”¨rect1å¤åˆ¶rect2æ—¶ï¼Œç”±äºæ‰§è¡Œçš„æ˜¯æµ…æ‹·è´ï¼Œåªæ˜¯å°†æˆå‘˜çš„å€¼è¿›è¡Œèµ‹å€¼ï¼Œè¿™æ—¶ rect1.p = rect2.pï¼Œä¹Ÿå³è¿™ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘äº†å †é‡Œçš„åŒä¸€ä¸ªç©ºé—´ã€‚</p>
<img src="https://img-blog.csdnimg.cn/20191129194029601.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0phY2t5X0Zlbmc=,size_16,color_FFFFFF,t_70" alt="åŸå› " style="zoom:80%;" />

<p> åœ¨é”€æ¯å¯¹è±¡æ—¶ï¼Œä¸¤ä¸ªå¯¹è±¡çš„ææ„å‡½æ•°å°†å¯¹åŒä¸€ä¸ªå†…å­˜ç©ºé—´é‡Šæ”¾ä¸¤æ¬¡ï¼Œè¿™å°±æ˜¯é”™è¯¯å‡ºç°çš„åŸå› ã€‚æˆ‘ä»¬éœ€è¦çš„ä¸æ˜¯ä¸¤ä¸ªpæœ‰ç›¸åŒçš„å€¼ï¼Œè€Œæ˜¯ä¸¤ä¸ªpæŒ‡å‘çš„ç©ºé—´æœ‰ç›¸åŒçš„å€¼ï¼Œè§£å†³åŠæ³•å°±æ˜¯ä½¿ç”¨â€œæ·±æ‹·è´â€ã€‚</p>
<h4 id="æ·±æ‹·è´"><a href="#æ·±æ‹·è´" class="headerlink" title="æ·±æ‹·è´"></a>æ·±æ‹·è´</h4><p>æ·±æ‹·è´å¯¹äºåŠ¨æ€æˆå‘˜ï¼Œå¹¶ä¸æ˜¯ç®€å•åœ°å¤åˆ¶ï¼Œè€Œæ˜¯é‡æ–°åŠ¨æ€åˆ†é…ç©ºé—´ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rect</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rect</span>()</span><br><span class="line">    &#123;</span><br><span class="line">     p=<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ·±æ‹·è´</span></span><br><span class="line">    <span class="built_in">Rect</span>(<span class="keyword">const</span> Rect&amp; r)</span><br><span class="line">    &#123;</span><br><span class="line">     width=r.width;</span><br><span class="line">        height=r.height;</span><br><span class="line">     p=<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">100</span>);</span><br><span class="line">        *p=*(r.p);</span><br><span class="line">    &#125;</span><br><span class="line">~<span class="built_in">Rect</span>()</span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">assert</span>(p!=<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">delete</span> p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> width;</span><br><span class="line">    <span class="keyword">int</span> height;</span><br><span class="line">    <span class="keyword">int</span> *p;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Rect rect1;</span><br><span class="line">    <span class="function">Rect <span class="title">rect2</span><span class="params">(rect1)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®Œæˆå¯¹è±¡æ‹·è´åœ°è¿‡ç¨‹ä¸º:</p>
<img src="https://img-blog.csdnimg.cn/2019112919463854.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0phY2t5X0Zlbmc=,size_16,color_FFFFFF,t_70" alt="è¿‡ç¨‹" style="zoom:80%;" />

<p> æ­¤æ—¶rect1çš„på’Œrect2çš„på„è‡ªæŒ‡å‘ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œä½†å®ƒä»¬æŒ‡å‘çš„ç©ºé—´å…·æœ‰ç›¸åŒçš„å†…å®¹ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæ·±æ‹·è´â€ã€‚</p>
<blockquote>
<p>å°ç»“ï¼š</p>
<p><strong>æ‹·è´æ„é€ å‡½æ•°æœ‰ä¸¤ç§ï¼šæ·±æ‹·è´å’Œæµ…æ‹·è´</strong></p>
<p>å½“å‡ºç°ç±»çš„ç­‰å·èµ‹å€¼æ—¶ï¼Œä¼šè°ƒç”¨æ‹·è´å‡½æ•°ï¼Œåœ¨æœªå®šä¹‰æ˜¾ç¤ºæ‹·è´æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šè°ƒç”¨é»˜è®¤çš„æ‹·è´å‡½æ•°â€”â€”å³æµ…æ‹·è´ï¼Œå®ƒèƒ½å¤Ÿå®Œæˆæˆå‘˜çš„ä¸€ä¸€å¤åˆ¶ã€‚å½“æ•°æ®æˆå‘˜ä¸­æ²¡æœ‰æŒ‡é’ˆæ—¶ï¼Œæµ…æ‹·è´æ˜¯å¯è¡Œçš„ã€‚ä½†<strong>å½“æ•°æ®æˆå‘˜ä¸­æœ‰æŒ‡é’ˆ</strong>æ—¶ï¼Œå¦‚æœé‡‡ç”¨ç®€å•çš„æµ…æ‹·è´ï¼Œåˆ™ä¸¤ç±»ä¸­çš„ä¸¤ä¸ªæŒ‡é’ˆå°†æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œå½“å¯¹è±¡å¿«ç»“æŸæ—¶ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡ææ„å‡½æ•°ï¼Œè€Œå¯¼è‡´æŒ‡é’ˆæ‚¬æŒ‚ç°è±¡ã€‚æ‰€ä»¥ï¼Œè¿™æ—¶ï¼Œå¿…é¡»é‡‡ç”¨æ·±æ‹·è´.</p>
<p>æ·±æ‹·è´ä¸æµ…æ‹·è´çš„åŒºåˆ«å°±åœ¨äºæ·±æ‹·è´ä¼šåœ¨å †å†…å­˜ä¸­å¦å¤–ç”³è¯·ç©ºé—´æ¥å‚¨å­˜æ•°æ®ï¼Œä»è€Œä¹Ÿå°±è§£å†³äº†æŒ‡é’ˆæ‚¬æŒ‚çš„é—®é¢˜ã€‚<strong>ç®€è€Œè¨€ä¹‹ï¼Œå½“æ•°æ®æˆå‘˜ä¸­æœ‰æŒ‡é’ˆæ—¶ï¼Œå¿…é¡»è¦ç”¨æ·±æ‹·è´ã€‚</strong></p>
</blockquote>
<h2 id="5-ç»¼åˆå®ä¾‹åˆ†æ"><a href="#5-ç»¼åˆå®ä¾‹åˆ†æ" class="headerlink" title="5.ç»¼åˆå®ä¾‹åˆ†æ"></a>5.ç»¼åˆå®ä¾‹åˆ†æ</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CPoint</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//ç¼ºçœæ„é€ å‡½æ•°,å¦‚æœå®šä¹‰ç±»æ—¶æœªæŒ‡å®šä»»ä½•æ„é€ å‡½æ•°ï¼Œ</span></span><br><span class="line">    <span class="comment">//ç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆä¸å¸¦å‚æ•°çš„ç¼ºçœæ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">CPoint</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;é»˜è®¤æ„é€ å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        y = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//å¸¦ä¸€ä¸ªå‚æ•°çš„å¯ç”¨äºç±»å‹è½¬æ¢çš„æ„é€ å‡½æ•°</span></span><br><span class="line">	<span class="comment">//  explicit    //åŠ ä¸Š explicit å¯é˜²æ­¢ CPoint pt1 = 1; è¿™ç§éšæ€§è½¬æ¢</span></span><br><span class="line">    <span class="built_in">CPoint</span>(<span class="keyword">int</span> ix)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1å‚æ•°æ„é€ å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        x = ix;</span><br><span class="line">        y = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//å¸¦å‚æ•°çš„æ„é€ å‡½æ•°</span></span><br><span class="line">	<span class="built_in">CPoint</span>(<span class="keyword">int</span> ix, <span class="keyword">int</span> iy)</span><br><span class="line">	&#123;</span><br><span class="line">    	cout &lt;&lt; <span class="string">&quot;2å‚æ•°æ„é€ å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    	x = ix;</span><br><span class="line">   	 y = iy;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//æ‹·è´æ„é€ å‡½æ•°,å¦‚æœæ­¤å‡½æ•°ä¸å®šä¹‰ï¼Œç³»ç»Ÿå°†ç”Ÿæˆç¼ºçœæ‹·è´æ„é€ å‡½æ•°åŠŸèƒ½,</span></span><br><span class="line">	<span class="comment">//ç¼ºçœæ‹·è´æ„é€ å‡½æ•°çš„è¡Œä¸ºæ˜¯ï¼šç”¨ä¼ å…¥çš„å¯¹è±¡å‚æ•°çš„æˆå‘˜åˆå§‹åŒ–æ­£è¦å»ºç«‹çš„å¯¹è±¡çš„ç›¸åº”æˆå‘˜</span></span><br><span class="line">	<span class="comment">//  explicit    //åŠ ä¸Š explicit å¯é˜²æ­¢ CPoint pt2 = pt1; è¿™ç§éšæ€§è½¬æ¢</span></span><br><span class="line">    <span class="built_in">CPoint</span>(<span class="keyword">const</span> CPoint &amp;cp)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;æ‹·è´æ„é€ å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        x = cp.x;</span><br><span class="line">        y = cp.y;</span><br><span class="line">    &#125;</span><br><span class="line">    CPoint &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> CPoint &amp;cp)</span><br><span class="line">	&#123;</span><br><span class="line">    	cout &lt;&lt; <span class="string">&quot;èµ‹å€¼é‡è½½å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    	<span class="keyword">if</span> (<span class="keyword">this</span> != &amp;cp)</span><br><span class="line">    	&#123;</span><br><span class="line">       	 	x = cp.x;</span><br><span class="line">       	 	y = cp.y;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> (*<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//ææ„å‡½æ•°ï¼Œä¸€ä¸ªç±»ä¸­åªèƒ½æœ‰ä¸€ä¸ªææ„å‡½æ•°,å¦‚æœç”¨æˆ·æ²¡æœ‰å®šä¹‰ææ„å‡½æ•°ï¼Œ</span></span><br><span class="line">	<span class="comment">//ç³»ç»Ÿä¼šè‡ªåŠ¨æœªç±»ç”Ÿæˆä¸€ä¸ªç¼ºçœçš„ææ„å‡½æ•°</span></span><br><span class="line">	~<span class="built_in">CPoint</span>()</span><br><span class="line">	&#123;</span><br><span class="line">    	cout &lt;&lt; <span class="string">&quot;ææ„å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	CPoint &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> CPoint &amp;cp)</span><br><span class="line">	&#123;</span><br><span class="line">    	cout &lt;&lt; <span class="string">&quot;èµ‹å€¼é‡è½½å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    	<span class="keyword">if</span> (<span class="keyword">this</span> != &amp;cp)</span><br><span class="line">    	&#123;</span><br><span class="line">        	x = cp.x;</span><br><span class="line">        	y = cp.y;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> (*<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//ææ„å‡½æ•°ï¼Œä¸€ä¸ªç±»ä¸­åªèƒ½æœ‰ä¸€ä¸ªææ„å‡½æ•°,å¦‚æœç”¨æˆ·æ²¡æœ‰å®šä¹‰ææ„å‡½æ•°ï¼Œ</span></span><br><span class="line">	<span class="comment">//ç³»ç»Ÿä¼šè‡ªåŠ¨æœªç±»ç”Ÿæˆä¸€ä¸ªç¼ºçœçš„ææ„å‡½æ•°</span></span><br><span class="line">	~<span class="built_in">CPoint</span>()</span><br><span class="line">	&#123;</span><br><span class="line">    	cout &lt;&lt; <span class="string">&quot;ææ„å‡½æ•° &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">CPoint <span class="title">p0</span><span class="params">()</span></span>;        <span class="comment">//è¿™æ˜¯å‡½æ•°çš„å£°æ˜ï¼Œä¸æ˜¯å®ä¾‹åŒ–ç±»</span></span><br><span class="line">    cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;CPoint pt1;\t\t&quot;</span>;</span><br><span class="line">	CPoint pt1;         <span class="comment">//ç¼ºçœæ„é€ å‡½æ•°</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;CPoint pt2(1);\t\t&quot;</span>;</span><br><span class="line">	<span class="function">CPoint <span class="title">pt2</span><span class="params">(<span class="number">1</span>)</span></span>;      <span class="comment">//ä¸€ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;CPoint pt3(1, 2);\t&quot;</span>;</span><br><span class="line">	<span class="function">CPoint <span class="title">pt3</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;   <span class="comment">//ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;CPoint pt4 = 1;\t\t&quot;</span>;</span><br><span class="line">	CPoint pt4 = <span class="number">1</span>;     <span class="comment">//ç­‰ä»·äºCPoint t4(1);  //explicit</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;CPoint pt5 = t1;\t&quot;</span>;</span><br><span class="line">	CPoint pt5 = pt1;   <span class="comment">//CPoint(t1);</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;CPoint pt6 = CPoint();\t&quot;</span>;</span><br><span class="line">	CPoint pt6 = <span class="built_in">CPoint</span>();  <span class="comment">//CPoint(1); CPoint(1,2);</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;pt6 = CPoint(1);\t&quot;</span>;</span><br><span class="line">	pt6 = <span class="built_in">CPoint</span>(<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;pt6 = 1;\t\t&quot;</span>;</span><br><span class="line">	pt6 = <span class="number">1</span>;            <span class="comment">//é¦–å…ˆè°ƒç”¨å•ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œç”Ÿæˆä¸´æ—¶å¯¹è±¡CPoint(1), ç„¶åè°ƒç”¨èµ‹å€¼è¿ç®—ç¬¦å‡½æ•°</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;pt6 = t1;\t\t&quot;</span>;</span><br><span class="line">	pt6 = pt1;          <span class="comment">//è°ƒç”¨èµ‹å€¼è¿ç®—ç¬¦å‡½æ•°</span></span><br><span class="line"> </span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç ç¼–è¯‘å’Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<img src="https://img-blog.csdnimg.cn/2019112918062265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0phY2t5X0Zlbmc=,size_16,color_FFFFFF,t_70" alt="æ‰§è¡Œç»“æœ" style="zoom:80%;" />



<blockquote>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒJacky_Fengã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ª CC 4.0 BY-SA ç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/Jacky_Feng/article/details/103313208">https://blog.csdn.net/Jacky_Feng/article/details/103313208</a></p>
</blockquote>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>è½¬è½½</tag>
      </tags>
  </entry>
</search>
